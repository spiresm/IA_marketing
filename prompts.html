<!-- ... <head> inchangé ... -->

<body>
  <div class="header">
    <h1>Espace IA Marketing</h1>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="profil.html">Mon profil</a>
    <a href="outils.html">Outils IA</a>
    <a href="prompts.html">Prompts</a>
    <a href="cas-usages.html">Cas d’usage</a>
    <a href="creer-tip.html">Créer un tip</a>
    <a href="veille.html">Veille</a>
    <a href="equipe.html">Équipe</a>
    <a href="galerie.html">Galerie</a>
  </nav>

  <div id="app"></div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { ref, createApp } = Vue;

    const PromptForm = {
      template: `
        <div class="container">
          <h2>Partager un prompt</h2>
          <form @submit.prevent="submitForm">
            <label for="auteur">Votre nom</label>
            <input id="auteur" v-model="auteur" required />

            <label for="outil">Outil IA utilisé</label>
            <select id="outil" v-model="outil">
              <option>Midjourney</option>
              <option>DALL·E</option>
              <option>Stable Diffusion</option>
              <option>Adobe Firefly</option>
              <option>Runway</option>
            </select>

            <label for="categorie">Catégorie</label>
            <select id="categorie" v-model="categorie">
              <option>Portrait</option>
              <option>Paysage</option>
              <option>Concept Art</option>
              <option>Produit</option>
              <option>Architecture</option>
            </select>

            <label for="texte">Prompt</label>
            <textarea id="texte" v-model="texte" rows="4" required></textarea>

            <label>Image</label>
            <div id="drop-zone" @click="triggerFile" @dragover.prevent="onDragOver" @dragleave="onDragLeave" @drop.prevent="onDrop">
              Déposez ou cliquez
            </div>
            <input type="file" ref="fileInput" accept="image/*" style="display:none" @change="onFileChange" />
            <img v-if="imagePreviewUrl" :src="imagePreviewUrl" id="image-preview" />

            <button type="submit">Partager</button>
          </form>

          <div class="confirmation" v-if="confirmationVisible">
            <p>✅ Prompt partagé !</p>
            <img v-if="confirmationImageUrl" :src="confirmationImageUrl" />
            <p>{{ confirmationTexte }}</p>
          </div>
        </div>
      `,
      setup() {
        const auteur = ref('');
        const outil = ref('Midjourney');
        const categorie = ref('Portrait');
        const texte = ref('');
        const fileInput = ref(null);
        const imagePreviewUrl = ref('');
        const confirmationVisible = ref(false);
        const confirmationImageUrl = ref('');
        const confirmationTexte = ref('');

        function triggerFile() {
          fileInput.value?.click();
        }

        function onDragOver(e) {
          e.currentTarget.classList.add('dragover');
        }

        function onDragLeave(e) {
          e.currentTarget.classList.remove('dragover');
        }

        function onDrop(e) {
          e.currentTarget.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if (files && files.length) {
            fileInput.value.files = files;
            handleFile(files[0]);
          }
        }

        function onFileChange(e) {
          const file = e.target.files[0];
          if (file) handleFile(file);
        }

        function handleFile(file) {
          if (!window.FileReader) return alert("Navigateur incompatible");
          const reader = new FileReader();
          reader.onload = () => {
            imagePreviewUrl.value = reader.result;
          };
          reader.readAsDataURL(file);
        }

        function getBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject(new Error("Erreur conversion base64"));
            reader.readAsDataURL(file);
          });
        }

        async function submitForm() {
          confirmationVisible.value = false;
          let imageUrl = '';
          const file = fileInput.value?.files?.[0];

          if (file) {
            try {
              const base64 = await getBase64(file);
              const payload = { fileBase64: base64, fileName: file.name };
              const resp = await fetch('/.netlify/functions/uploadImage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!resp.ok) throw new Error(`Upload failed: ${resp.status}`);
              const data = await resp.json();
              if (!data.url) throw new Error('Aucune URL retournée');
              imageUrl = data.url;
            } catch (err) {
              alert('Échec upload image');
              return;
            }
          }

          try {
            const promptResp = await fetch('/.netlify/functions/pushPrompt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ auteur: auteur.value, outil: outil.value, categorie: categorie.value, texte: texte.value, imageUrl })
            });
            if (!promptResp.ok) throw new Error(`Prompt failed: ${promptResp.status}`);

            confirmationImageUrl.value = imageUrl;
            confirmationTexte.value = texte.value;
            confirmationVisible.value = true;

            auteur.value = '';
            outil.value = 'Midjourney';
            categorie.value = 'Portrait';
            texte.value = '';
            imagePreviewUrl.value = '';
            fileInput.value.value = null;
          } catch (err) {
            alert('Échec envoi prompt');
          }
        }

        return {
          auteur, outil, categorie, texte, fileInput,
          imagePreviewUrl, confirmationVisible,
          confirmationImageUrl, confirmationTexte,
          triggerFile, onDragOver, onDragLeave, onDrop, onFileChange, submitForm
        };
      }
    };

    createApp(PromptForm).mount('#app');
  </script>
</body>
</html>
