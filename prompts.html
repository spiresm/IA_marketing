<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Partager un Prompt - Espace IA</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      visibility: hidden;
    }
    main {
      display: none;
      padding: 40px 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 30px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      background: #f9fafb;
    }
    #drop-zone {
      border: 2px dashed #0077b6;
      padding: 20px;
      text-align: center;
      color: #777;
      margin-top: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #drop-zone.dragover {
      background: #e0f7ff;
    }
    #image-preview {
      display: block;
      max-width: 80%;
      margin: 15px auto;
      border-radius: 10px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #0077b6;
      color: #fff;
      border: none;
      border-radius: 8px;
      margin-top: 25px;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: #005f8a;
    }
    .confirmation {
      margin-top: 30px;
      padding: 20px;
      background: #e6ffed;
      border: 1px solid #b7eb8f;
      border-radius: 10px;
      text-align: center;
    }
    .confirmation img {
      max-width: 80%;
      margin-top: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>
  <main>
    <div id="app"></div>
  </main>

  <script>
    fetch("header.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;
        document.body.style.visibility = "visible";
        document.querySelector("main").style.display = "block";
      });
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { ref, createApp } = Vue;

    const PromptForm = {
      template: `
        <div class="container">
          <h2 style="text-align:center; color:#0077b6;">Partager un prompt</h2>
          <form @submit.prevent="submitForm">
            <label for="auteur">Votre nom</label>
            <input id="auteur" v-model="auteur" required />

            <label for="outil">Outil IA utilisé</label>
            <select id="outil" v-model="outil">
              <option>Midjourney</option>
              <option>DALL·E</option>
              <option>Stable Diffusion</option>
              <option>Adobe Firefly</option>
              <option>Runway</option>
            </select>

            <label for="categorie">Catégorie</label>
            <select id="categorie" v-model="categorie">
              <option>Portrait</option>
              <option>Paysage</option>
              <option>Concept Art</option>
              <option>Produit</option>
              <option>Architecture</option>
            </select>

            <label for="texte">Prompt</label>
            <textarea id="texte" v-model="texte" rows="4" required></textarea>

            <label>Image</label>
            <div id="drop-zone"
                 @click="triggerFile"
                 @dragover.prevent="onDragOver"
                 @dragleave="onDragLeave"
                 @drop.prevent="onDrop">
              Déposez ou cliquez
            </div>
            <input type="file" ref="fileInput" accept="image/*" style="display:none" @change="onFileChange" />
            <img v-if="imagePreviewUrl" :src="imagePreviewUrl" id="image-preview" />

            <button type="submit">Partager</button>
          </form>

          <div class="confirmation" v-if="confirmationVisible">
            <p>✅ Votre prompt a bien été envoyé vers la galerie !</p>
            <img v-if="confirmationImageUrl" :src="confirmationImageUrl" />
            <p>{{ confirmationTexte }}</p>
          </div>
        </div>
      `,
      setup() {
        const auteur = ref('');
        const outil = ref('Midjourney');
        const categorie = ref('Portrait');
        const texte = ref('');
        const fileInput = ref(null);
        const imagePreviewUrl = ref('');
        const confirmationVisible = ref(false);
        const confirmationImageUrl = ref('');
        const confirmationTexte = ref('');

        function triggerFile() {
          fileInput.value?.click();
        }
        function onDragOver(e) {
          e.currentTarget.classList.add('dragover');
        }
        function onDragLeave(e) {
          e.currentTarget.classList.remove('dragover');
        }
        function onDrop(e) {
          e.currentTarget.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if (files.length) {
            fileInput.value.files = files;
            handleFile(files[0]);
          }
        }
        function onFileChange(e) {
          const file = e.target.files[0];
          if (file) handleFile(file);
        }
        function handleFile(file) {
          const reader = new FileReader();
          reader.onload = () => { imagePreviewUrl.value = reader.result; };
          reader.readAsDataURL(file);
        }
        function getBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject();
            reader.readAsDataURL(file);
          });
        }
        async function submitForm() {
          confirmationVisible.value = false;
          let imageUrl = '';
          const file = fileInput.value?.files?.[0];

          if (file) {
            try {
              const base64 = await getBase64(file);
              const payload = { fileBase64: base64, fileName: file.name };
              const resp = await fetch('/.netlify/functions/uploadImage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!resp.ok) throw new Error(`Upload failed: ${resp.status}`);
              const data = await resp.json();
              if (!data.url) throw new Error('Aucune URL retournée');
              imageUrl = data.url;
            } catch (err) {
              alert('Échec upload image');
              return;
            }
          }

          try {
            const promptResp = await fetch('/.netlify/functions/pushPrompt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                auteur: auteur.value,
                outil: outil.value,
                categorie: categorie.value,
                texte: texte.value,
                imageUrl
              })
            });
            if (!promptResp.ok) throw new Error(`Prompt failed: ${promptResp.status}`);
            confirmationImageUrl.value = imageUrl;
            confirmationTexte.value = texte.value;
            confirmationVisible.value = true;

            // Reset form
            auteur.value = '';
            outil.value = 'Midjourney';
            categorie.value = 'Portrait';
            texte.value = '';
            imagePreviewUrl.value = '';
            fileInput.value.value = null;
          } catch (err) {
            alert('Échec envoi prompt');
          }
        }

        return {
          auteur, outil, categorie, texte, fileInput,
          imagePreviewUrl, confirmationVisible,
          confirmationImageUrl, confirmationTexte,
          triggerFile, onDragOver, onDragLeave, onDrop, onFileChange, submitForm
        };
      }
    };

    createApp(PromptForm).mount('#app');
  </script>
</body>
</html>
