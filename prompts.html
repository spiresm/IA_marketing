<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Partager un Prompt - Espace IA</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    body.show {
      opacity: 1;
    }

    main {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    main.show {
      opacity: 1;
    }

    main {
      padding: 40px 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 30px;
      position: relative;
    }

    .retour-lien {
      display: inline-block;
      margin-bottom: 20px;
      color: #0077b6;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.05em;
    }

    .retour-lien:hover {
      text-decoration: underline;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      background: #f9fafb;
    }

    #drop-zone {
      border: 2px dashed #0077b6;
      padding: 20px;
      text-align: center;
      color: #777;
      margin-top: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #drop-zone.dragover {
      background: #e0f7ff;
    }

    #image-preview {
      display: block;
      max-width: 80%;
      margin: 15px auto;
      border-radius: 10px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #0077b6;
      color: #fff;
      border: none;
      border-radius: 8px;
      margin-top: 25px;
      font-size: 1em;
      cursor: pointer;
    }

    button:hover {
      background: #005f8a;
    }

    .confirmation {
      margin-top: 30px;
      padding: 20px;
      background: #e6ffed;
      border: 1px solid #b7eb8f;
      border-radius: 10px;
      text-align: center;
    }

    .confirmation img {
      max-width: 80%;
      margin-top: 15px;
      border-radius: 10px;
    }

    .loader {
      display: block;
      margin: 20px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #0077b6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>
  <main>
    <div id="app"></div>
  </main>

  <script>
    // Charger le header et gérer l'apparition progressive du body et main
    fetch("header.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;

        // Appliquer le fondu une fois le header chargé
        document.body.classList.add("show");
        document.querySelector("main").classList.add("show");

        // Une fois le header chargé et le main visible, charger Vue et monter l'application
        const vueScript = document.createElement('script');
        vueScript.src = "https://unpkg.com/vue@3/dist/vue.global.prod.js";
        vueScript.onload = () => {
          // --- TOUT LE CODE VUE.JS EST DÉSORMAIS ICI DEDANS ---
          const { ref, createApp } = Vue;

          const PromptForm = {
            template: `
              <div class="container">
                <a href="galerie.html" class="retour-lien">← Retour</a>
                <h2 style="text-align:center; color:#0077b6;">Partager un prompt</h2>
                <form @submit.prevent="submitForm">
                  <label for="auteur">Votre nom</label>
                  <input id="auteur" v-model="auteur" required />

                  <label for="outil">Outil IA utilisé</label>
                  <select id="outil" v-model="outil">
                    <option>Midjourney</option>
                    <option>DALL·E</option>
                    <option>Stable Diffusion</option>
                    <option>Adobe Firefly</option>
                    <option>Runway</option>
                    <option>ChatGPT</option>
                  </select>

                  <label for="chaine">Chaîne</label>
                  <select id="chaine" v-model="chaine">
                    <option>La Une</option>
                    <option>Tipik</option>
                    <option>La Trois</option>
                    <option>La Première</option>
                    <option>Classic 21</option>
                    <option>Vivacité</option>
                    <option>Musiq3</option>
                    <option>Auvio</option>
                  </select>

                  <label for="texte">Prompt</label>
                  <textarea id="texte" v-model="texte" rows="4" required></textarea>

                  <label>Image</label>
                  <div id="drop-zone"
                        @click="triggerFile"
                        @dragover.prevent="onDragOver"
                        @dragleave="onDragLeave"
                        @drop.prevent="onDrop">
                    Déposez ou cliquez
                  </div>
                  <input type="file" ref="fileInput" accept="image/*" style="display:none" @change="onFileChange" />
                  <img v-if="imagePreviewUrl" :src="imagePreviewUrl" id="image-preview" />

                  <div v-if="isLoading" class="loader"></div>
                  <button v-else type="submit">Partager</button>
                </form>

                <div class="confirmation" v-if="confirmationVisible">
                  <p>✅ Prompt partagé avec succès vers la <strong>galerie</strong> !</p>
                  <img v-if="confirmationImageUrl" :src="confirmationImageUrl" />
                  <p style="white-space: pre-wrap;">{{ confirmationTexte }}</p>
                  <p style="margin-top: 15px; color: #0077b6;">Redirection vers la galerie dans 5 secondes...</p>
                </div>
              </div>
            `,
            setup() {
              const auteur = ref('');
              const outil = ref('Midjourney');
              const chaine = ref('La Une');
              const texte = ref('');
              const fileInput = ref(null);
              const imagePreviewUrl = ref('');
              const confirmationVisible = ref(false);
              const confirmationImageUrl = ref('');
              const confirmationTexte = ref('');
              const isLoading = ref(false);

              function triggerFile() {
                fileInput.value?.click();
              }

              function onDragOver(e) {
                e.currentTarget.classList.add('dragover');
              }

              function onDragLeave(e) {
                e.currentTarget.classList.remove('dragover');
              }

              function onDrop(e) {
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length) {
                  fileInput.value.files = files;
                  handleFile(files[0]);
                }
              }

              function onFileChange(e) {
                const file = e.target.files[0];
                if (file) handleFile(file);
              }

              function handleFile(file) {
                const reader = new FileReader();
                reader.onload = () => { imagePreviewUrl.value = reader.result; };
                reader.readAsDataURL(file);
              }

              function getBase64(file) {
                return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result.split(',')[1]);
                  reader.onerror = () => reject();
                  reader.readAsDataURL(file);
                });
              }

              async function submitForm() {
                confirmationVisible.value = false;
                isLoading.value = true;

                let imageUrl = '';
                const file = fileInput.value?.files?.[0];

                try {
                  if (file) {
                    const base64 = await getBase64(file);
                    const payload = { fileBase64: base64, fileName: file.name };
                    const resp = await fetch('/.netlify/functions/uploadImage', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(payload)
                    });
                    if (!resp.ok) throw new Error(`Upload failed: ${resp.status}`);
                    const data = await resp.json();
                    imageUrl = data.url;
                  }

                  const promptResp = await fetch('/.netlify/functions/pushPrompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      auteur: auteur.value,
                      outil: outil.value,
                      chaine: chaine.value,
                      texte: texte.value,
                      imageUrl
                    })
                  });

                  if (!promptResp.ok) throw new Error(`Prompt failed: ${promptResp.status}`);

                  confirmationImageUrl.value = imageUrl;
                  confirmationTexte.value = texte.value;
                  confirmationVisible.value = true;

                  setTimeout(() => {
                    window.location.href = "/galerie.html";
                  }, 3000);

                  auteur.value = '';
                  outil.value = 'Midjourney';
                  chaine.value = 'La Une';
                  texte.value = '';
                  imagePreviewUrl.value = '';
                  fileInput.value.value = null;
                } catch (err) {
                  alert('Échec envoi prompt');
                } finally {
                  isLoading.value = false;
                }
              }

              return {
                auteur, outil, chaine, texte, fileInput,
                imagePreviewUrl, confirmationVisible,
                confirmationImageUrl, confirmationTexte,
                isLoading,
                triggerFile, onDragOver, onDragLeave, onDrop, onFileChange, submitForm
              };
            }
          };

          createApp(PromptForm).mount('#app');
          // --- FIN DU CODE VUE.JS ---
        };
        document.body.appendChild(vueScript); // Ajoutez le script Vue au body
      })
      .catch(error => console.error("Erreur lors du chargement du header:", error));
  </script>
</body>
</html>
