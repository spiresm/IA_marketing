<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partager un Workflow - iMarketing</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Styles conservés de votre original pour les formulaires Tips/Prompts */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.05);
            --success-bg: #d4edda;
            --success-text: #155724;
            --border-color: #ddd;
            --grey-text: #555;
        }
        main { 
            padding: 40px 20px; 
            flex-grow: 1; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
        }
        
        .container { 
            max-width: 960px;
            width: 100%; 
            margin: 0 auto; 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
            padding: 30px; 
            box-sizing: border-box; 
            position: relative; 
        }
        
        .retour-lien {
            display: inline-block;
            margin-bottom: 20px;
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .retour-lien:hover {
            background-color: var(--dark-blue);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        label { 
            font-weight: 600; 
            display: block; 
            margin-bottom: 5px;
            color: #333; 
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 1em; 
            background: #f9fafb; 
            box-sizing: border-box; 
            color: #333; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary-blue); 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(0, 119, 182, 0.2); 
        }
        
        textarea { resize: vertical; }
        #description { min-height: 120px; }
        #promptText { min-height: 150px; } /* Correction ID pour promptText */
        
        .post-it-highlight {
            background-color: #FFFF00;
            border-radius: 8px;
            padding: 15px;
            margin-top: 5px;
            border: 1px solid #E6E600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-style: italic;
            color: #333;
        }
        
        .checkbox-group { 
            height: 120px;
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 10px 15px; 
            background-color: #f9fafb; 
        }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 8px; }
        .checkbox-item input[type="checkbox"] { width: auto; margin: 0 10px 0 0; }
        .checkbox-item label { font-weight: 400; margin: 0; cursor: pointer; }
        
        .url-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .url-input-group input { margin-bottom: 0; } /* Ajuster la marge */
        .url-action-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        .add-url-button, .remove-url-button { padding: 8px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; color: white; }
        .add-url-button { background-color: #28a745; }
        .remove-url-button { background-color: #dc3545; }
        
        #drop-zone { border: 2px dashed var(--primary-blue); padding: 20px; text-align: center; color: #777; border-radius: 10px; cursor: pointer; height: 100%; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        #drop-zone.dragover { background: #e0f7ff; } 

        .file-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .file-preview-item { position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .file-preview-item img.image-preview { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        .file-preview-item .file-icon { font-size: 40px; color: var(--primary-blue); }

        .file-name-overlay { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0,0,0,0.6); color: white; font-size: 0.7em; padding: 3px 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-file-button { position: absolute; top: 5px; right: 5px; background-color: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; display: flex; justify-content: center; align-items: center; cursor: pointer; padding: 0; line-height: 1; transition: background-color 0.2s ease; }
        .remove-file-button:hover { background-color: red; }
        
        button[type="submit"] { width: 100%; padding: 12px; background: var(--primary-blue); color: #fff; border: none; border-radius: 8px; margin-top: 25px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
        button[type="submit"]:hover { background: var(--dark-blue); }
        button[type="submit"]:disabled { background-color: #cccccc; cursor: not-allowed; }

        /* Loader interne au formulaire */
        .loader {
            display: block; 
            margin: 20px auto;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Confirmation de soumission */
        .confirmation {
            margin-top: 30px;
            padding: 20px;
            background: var(--success-bg);
            border: 1px solid var(--success-text);
            border-radius: 10px;
            text-align: center;
            color: var(--success-text);
        }
        .confirmation img {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .confirmation img:hover {
            transform: scale(1.05);
        }

        /* Lightbox pour les images de confirmation */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            background-color: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            z-index: 1001;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        .lightbox-close:hover {
            color: #f00;
            background-color: rgba(0,0,0,0.7);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div id="app">
            <div class="container">
                <a href="/cas-usages.html" class="retour-lien">← Retour</a>
                <h2 style="text-align:center; color:var(--primary-blue);">{{ formTitle }}</h2>

                <form @submit.prevent="submitForm" v-if="!isLoading && !confirmationVisible">
                    <div class="form-grid">
                        
                        <div class="form-group">
                            <label for="auteur">Votre nom</label>
                            <select id="auteur" v-model="auteur" required>
                                <option value="" disabled>Sélectionnez un nom</option>
                                <option v-for="profilNom in profilsAuteurs" :key="profilNom" :value="profilNom">{{ profilNom }}</option>
                            </select>
                            <p v-if="profilsAuteurs.length === 0 && !isLoadingProfils" style="color: var(--grey-text); font-size: 0.9em; margin-top: 5px;">
                                Aucun profil trouvé. Assurez-vous d'avoir créé des profils dans la section "Équipe" et que la fonction proxy est configurée.
                            </p>
                            <p v-if="isLoadingProfils" style="color: var(--primary-blue); font-size: 0.9em; margin-top: 5px;">Chargement des noms de profils...</p>
                        </div>
                        <div class="form-group">
                            <label for="titre">Titre du Tip / Workflow</label>
                            <input type="text" id="titre" v-model="titre" required />
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" v-model="description" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="previewText">Post-it</label>
                            <textarea id="previewText" v-model="previewText" placeholder="Un court extrait..."></textarea>
                            <div class="post-it-highlight">
                                Ce texte apparaîtra comme un post-it sur la carte principale pour attirer l'attention.
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="commentaireUrl">Commentaire / workflow</label>
                            <textarea id="commentaireUrl" v-model="commentaireUrl" placeholder="Ajoutez un commentaire, une explication du workflow..."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="promptText">Prompt (optionnel)</label>
                            <textarea id="promptText" v-model="promptText" placeholder="Collez le prompt exact ici..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Plateforme(s) / Outil(s)</label>
                            <div class="checkbox-group" role="group">
                                <div v-for="(tool, index) in toolsList" :key="index" class="checkbox-item">
                                    <input type="checkbox" :id="'tool-' + index" name="outils[]" :value="tool.name" v-model="outils">
                                    <label :for="'tool-' + index">{{ tool.name }}</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tool-autre" name="outils[]" value="Autre" v-model="outils">
                                    <label for="tool-autre">Autre</label>
                                </div>
                            </div>
                            <input type="text" v-if="outils.includes('Autre')" name="customOutil" v-model="customOutil" placeholder="Spécifiez l'outil..." style="margin-top: 10px;" />
                        </div>
                        
                        <div class="form-group">
                            <label>Lien(s) associé(s) - archive chatGPT/Gemini :</label>
                            <div v-for="(url, index) in urls" :key="index" class="url-input-group">
                                <input type="url" :name="`url-${index}`" v-model="urls[index]" :placeholder="`Lien ${index + 1}`" />
                                <button type="button" @click="removeUrlField(index)" class="remove-url-button">X</button>
                            </div>
                            <div class="url-action-buttons">
                                <button type="button" @click="addUrlField" class="add-url-button">Ajouter un lien</button>
                            </div>
                        </div>

                        <div class="form-group full-width">
                               <label>Image principale du Workflow</label>
                               <div id="drop-zone"
                                        @click="triggerFile"
                                        @dragover.prevent="onDragOver"
                                        @dragleave="onDragLeave"
                                        @drop.prevent="onDrop">
                                       Déposez ou cliquez pour {{ isEditMode && imagePreviewUrl ? 'changer' : 'ajouter' }} l'image
                               </div>
                               <input type="file" ref="fileInput" accept="image/*" style="display:none" @change="onFileChange" />
                               <img v-if="imagePreviewUrl" :src="imagePreviewUrl" id="image-preview" />
                               <button v-if="imagePreviewUrl" @click.prevent="removeImage" style="background-color: #dc3545; margin-top: 10px;">Supprimer l'image</button>
                        </div>

                        <div class="form-group full-width">
                               <div v-if="isLoadingFormSubmission" class="loader"></div> <button v-else type="submit" :disabled="!titre || !auteur || !description || isLoadingFormSubmission">{{ submitButtonText }}</button>
                        </div>
                    </div>
                </form>
                <div v-else-if="isLoading" class="loader"></div> <div class="confirmation" v-if="confirmationVisible" role="status" aria-live="assertive">
                    <p>{{ confirmationMessage }}</p>
                    <template v-if="confirmationImageUrls && confirmationImageUrls.length > 0">
                        <img v-for="(url, index) in confirmationImageUrls" :key="'conf-img-' + index" :src="url" @click="openLightbox(url)" style="margin: 5px;" :alt="`Image de confirmation ${index + 1}`"/>
                    </template>
                    <template v-if="confirmationUrls && confirmationUrls.length > 0 && confirmationUrls[0].trim() !== ''">
                        <h4 style="margin-top: 15px; margin-bottom: 5px; color: #333;">Lien(s) enregistré(s):</h4>
                        <ul>
                            <li v-for="(url, index) in confirmationUrls" :key="'conf-url-' + index" style="list-style-type: disc; margin-left: 20px;">
                                <a :href="url" target="_blank" style="color: var(--primary-blue); word-break: break-all;">{{ url }}</a>
                            </li>
                        </ul>
                    </template>
                    <p v-if="confirmationCommentaireUrl && confirmationCommentaireUrl.trim()" style="white-space: pre-wrap; font-style: italic; font-size: 0.9em; color: var(--grey-text); margin-top: 10px;">{{ confirmationCommentaireUrl }}</p>
                    <p style="white-space: pre-wrap; font-weight: bold;">{{ confirmationTitre }}</p>
                    <p style="white-space: pre-wrap;">{{ confirmationDescription }}</p>
                    <p v-if="confirmationPreviewText && confirmationPreviewText.trim()" style="white-space: pre-wrap; font-family: monospace; background-color: #f0f0f0; padding: 10px; border-radius: 5px;">{{ confirmationPreviewText }}</p>
                    <p v-if="confirmationPromptText && confirmationPromptText.trim()" style="white-space: pre-wrap; font-family: monospace; background-color: #f0f0f0; padding: 10px; border-radius: 5px;">{{ confirmationPromptText }}</p>
                    <p style="margin-top: 15px; color: var(--primary-blue);">Redirection vers les cas d'usages dans 5 secondes...</p>
                </div>
            </div>

            <div class="lightbox-overlay" v-if="lightboxVisible" @click.self="closeLightbox" role="dialog" aria-modal="true" :aria-label="`Aperçu de l'image ${lightboxImageUrl.split('/').pop()}`">
                <span class="lightbox-close" @click="closeLightbox" role="button" tabindex="0" aria-label="Fermer l'aperçu de l'image">&times;</span>
                <div class="lightbox-content">
                    <img :src="lightboxImageUrl" :alt="`Image en grand format : ${lightboxImageUrl.split('/').pop()}`" />
                </div>
            </div>

        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="tools-data.js"></script>
    
    <script>
        // Définitions des URL pour les fonctions Netlify
        const GET_TIPS_URL = "/.netlify/functions/get-tips"; 
        const PUSH_TIP_URL = "/.netlify/functions/push-tip"; 
        const UPDATE_TIP_URL = "/.netlify/functions/update-tip"; 
        const GET_PROFILS_URL = "/.netlify/functions/getProfils"; // Assurez-vous que cette URL est correcte
        const UPLOAD_IMAGE_URL = "/.netlify/functions/uploadImage"; // URL pour l'upload d'image

        // Fonction utilitaire pour charger des composants HTML (Header et Footer)
        async function loadComponent(url, placeholderId) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const errorDetail = await res.text();
                    throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}. URL: ${url}. Response: ${errorDetail.substring(0, 200)}...`);
                }
                document.getElementById(placeholderId).innerHTML = await res.text();
            } catch (error) {
                console.error(`Erreur lors du chargement de ${url}:`, error);
                document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>Erreur de chargement du composant: ${url}. (${error.message})</p>`;
            }
        }

        const { ref, createApp, onMounted, onUnmounted, computed } = Vue;

        const TipForm = {
            setup() {
                // Propriétés du formulaire
                const auteur = ref('');
                const titre = ref('');
                const description = ref('');
                const previewText = ref('');
                const promptText = ref('');
                
                const outils = ref([]); 
                const customOutil = ref('');
                const urls = ref(['']); // Correctement initialisé pour la boucle v-for
                
                const commentaireUrl = ref('');
                const fileInput = ref(null); // Pour l'input type="file" de l'image principale
                const fileUploadError = ref(''); // Erreur spécifique à l'upload de l'image principale

                // Déclaration de imageFile comme une ref
                const imageFile = ref(null); // <--- C'EST LA LIGNE CORRIGÉE/AJOUTÉE

                const isLoading = ref(false); // Loader général de la page (pour le chargement initial des données en mode édition)
                const isLoadingFormSubmission = ref(false); // Nouveau loader pour la soumission du formulaire
                const profilsAuteurs = ref([]);
                const isLoadingProfils = ref(true); 

                // État de la confirmation post-soumission
                const confirmationVisible = ref(false);
                const confirmationImageUrls = ref([]); 
                const confirmationUrls = ref([]);
                const confirmationCommentaireUrl = ref('');
                const confirmationTitre = ref('');
                const confirmationDescription = ref('');
                const confirmationPreviewText = ref('');
                const confirmationPromptText = ref('');

                // État de la lightbox
                const lightboxVisible = ref(false);
                const lightboxImageUrl = ref('');

                const toolsList = typeof toolsData !== 'undefined' ? toolsData.sort((a, b) => a.name.localeCompare(b.name)) : [];

                // Variables pour l'édition
                const isEditMode = ref(false);
                const workflowId = ref(null);
                const workflowSha = ref(null); 

                // Propriétés calculées pour le template
                const formTitle = computed(() => isEditMode.value ? 'Éditer un Workflow' : 'Partager un Workflow');
                const submitButtonText = computed(() => isLoadingFormSubmission.value ? 'Envoi en cours...' : (isEditMode.value ? 'Mettre à jour le Workflow' : 'Partager le Workflow'));
                const confirmationMessage = computed(() => isEditMode.value ? '✅ Workflow mis à jour avec succès !' : '✅ Workflow partagé avec succès !');

                // Fonctions de gestion de l'image principale (pour le champ unique du formulaire)
                const imagePreviewUrl = ref('');
                const originalImageUrl = ref(''); 

                function triggerFile() { fileInput.value?.click(); }
                function onDragOver(e) { e.currentTarget.classList.add('dragover'); }
                function onDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
                function onDrop(e) {
                    e.currentTarget.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length) {
                        handleImageFile(files[0]); 
                    }
                }
                function onFileChange(e) {
                    const file = e.target.files[0];
                    if (file) handleImageFile(file);
                }
                function handleImageFile(file) {
                    if (!file.type.startsWith('image/')) {
                        fileUploadError.value = "Seules les images sont acceptées pour l'image principale.";
                        return;
                    }
                    imageFile.value = file; // C'est ici que l'erreur se produisait
                    const reader = new FileReader();
                    reader.onload = () => { imagePreviewUrl.value = reader.result; };
                    reader.readAsDataURL(file);
                    fileUploadError.value = ''; 
                }
                function removeImage() {
                    imageFile.value = null;
                    imagePreviewUrl.value = '';
                    originalImageUrl.value = ''; 
                    if (fileInput.value) {
                        fileInput.value.value = null; 
                    }
                }

                // Fonctions de gestion des URLs dynamiques
                function addUrlField() {
                    urls.value.push('');
                }
                function removeUrlField(index) {
                    urls.value.splice(index, 1);
                    if (urls.value.length === 0) {
                        urls.value.push(''); 
                    }
                }
                
                // Fonctions de gestion de la lightbox
                function openLightbox(imageUrl) {
                    lightboxImageUrl.value = imageUrl;
                    lightboxVisible.value = true;
                }

                function closeLightbox() {
                    lightboxVisible.value = false;
                    lightboxImageUrl.value = '';
                }

                function handleKeydown(event) {
                    if (event.key === 'Escape' && lightboxVisible.value) {
                        closeLightbox();
                    }
                }

                onMounted(async () => { // Ajout de 'async' ici
                    await fetchProfils(); // Assurez-vous que les profils sont chargés en premier

                    const urlParams = new URLSearchParams(window.location.search);
                    const mode = urlParams.get('mode');
                    const id = urlParams.get('id');
                    const sha = urlParams.get('sha');

                    console.log("URL Params au montage:", { mode, id, sha }); // Log pour vérifier les params URL

                    if (mode === 'edit' && id && sha) {
                        isEditMode.value = true;
                        workflowId.value = id;
                        workflowSha.value = sha;
                        isLoading.value = true; // Active le loader pendant le chargement des données
                        console.log("Mode édition détecté. Chargement du workflow:", id);
                        await fetchWorkflowForEdit(id); // Appel asynchrone
                        isLoading.value = false; // Désactive le loader après le chargement des données
                    } else {
                        // Mode création par défaut: initialise les champs
                        titre.value = '';
                        auteur.value = profilsAuteurs.value.length === 1 ? profilsAuteurs.value[0] : '';
                        description.value = '';
                        previewText.value = '';
                        promptText.value = '';
                        commentaireUrl.value = '';
                        urls.value = ['']; // Assure un champ vide pour les URLs
                        outils.value = [];
                        customOutil.value = '';
                        imagePreviewUrl.value = '';
                        originalImageUrl.value = '';
                        imageFile.value = null;
                        if (fileInput.value) fileInput.value.value = null;
                        isLoading.value = false; // S'assure que le loader est désactivé en mode création
                    }
                    window.addEventListener('keydown', handleKeydown);
                });

                onUnmounted(() => {
                    window.removeEventListener('keydown', handleKeydown);
                });

                // Fonction pour charger les profils d'auteurs
                async function fetchProfils() {
                    isLoadingProfils.value = true;
                    try {
                        const response = await fetch(`${GET_PROFILS_URL}`);
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error lors de la récupération des profils: ${response.status} - ${errorText}`);
                        }
                        const data = await response.json();
                        const profilsList = Array.isArray(data) ? data : (data.profils || []);
                        const names = [...new Set(profilsList.map(p => typeof p === 'string' ? p : p.name).filter(Boolean))].sort();
                        profilsAuteurs.value = names;

                        if (names.length === 1 && !isEditMode.value) { 
                            auteur.value = names[0];
                        }
                    } catch (error) {
                        console.error("Erreur lors du chargement des profils:", error);
                        alert("Impossible de charger la liste des auteurs. Vérifiez la console pour plus de détails.");
                    } finally {
                        isLoadingProfils.value = false;
                    }
                }

                // Fonction pour récupérer un workflow spécifique pour l'édition
                async function fetchWorkflowForEdit(id) {
                    console.log("Tentative de récupération du workflow pour l'édition avec ID:", id);
                    try {
                        const response = await fetch(GET_TIPS_URL);
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Erreur HTTP lors de la récupération de tous les workflows: ${response.status} - ${errorText}`);
                        }
                        const allWorkflows = await response.json();
                        console.log("Workflows reçus du backend:", allWorkflows); // Vérifiez le contenu ici
                        const workflowToEdit = allWorkflows.find(w => w.id === id);

                        if (workflowToEdit) {
                            console.log("Workflow trouvé pour édition:", workflowToEdit); // Vérifiez l'objet du workflow
                            titre.value = workflowToEdit.titre || '';
                            auteur.value = workflowToEdit.auteur || '';
                            description.value = workflowToEdit.description || '';
                            previewText.value = workflowToEdit.previewText || '';
                            promptText.value = workflowToEdit.promptText || '';
                            commentaireUrl.value = workflowToEdit.commentaireUrl || '';
                            
                            // Gérer les outils (checkboxes et champ custom)
                            if (workflowToEdit.outil) {
                                const toolsArray = workflowToEdit.outil.split(',').map(s => s.trim()).filter(Boolean);
                                outils.value = toolsArray.filter(o => toolsList.some(tl => tl.name === o));
                                const customToolFound = toolsArray.find(o => !toolsList.some(tl => tl.name === o));
                                if (customToolFound) {
                                    outils.value.push('Autre'); // Coche "Autre"
                                    customOutil.value = customToolFound; // Met le nom dans le champ custom
                                }
                            } else {
                                outils.value = [];
                                customOutil.value = '';
                            }
                            
                            // Gérer les URLs (liens additionnels) - CORRECTION ICI
                            // On peuple le tableau 'urls' directement avec les URLs du workflow.
                            urls.value = (Array.isArray(workflowToEdit.urls) && workflowToEdit.urls.length > 0) 
                                ? workflowToEdit.urls.filter(Boolean) 
                                : ['']; // Assure qu'il y a au moins un champ vide si pas d'URLs

                            // Image principale
                            imagePreviewUrl.value = workflowToEdit.imageUrl || (Array.isArray(workflowToEdit.fileUrls) && workflowToEdit.fileUrls[0] ? workflowToEdit.fileUrls[0] : '');
                            originalImageUrl.value = imagePreviewUrl.value; 
                            console.log("Image preview URL:", imagePreviewUrl.value); // Vérifiez l'URL de l'image
                        } else {
                            console.error("Workflow non trouvé avec l'ID:", id);
                            alert("Workflow non trouvé pour édition. Redirection vers la liste des workflows.");
                            window.location.href = "/cas-usages.html"; 
                        }
                    } catch (error) {
                        console.error("Erreur lors du chargement du workflow pour édition:", error);
                        alert(`Impossible de charger le workflow pour édition: ${error.message}.`);
                        window.location.href = "/cas-usages.html";
                    } finally {
                        // isLoading.value est géré dans onMounted pour le chargement initial
                    }
                }
                
                // Fonction utilitaire pour convertir un fichier en Base64
                function getBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(file);
                    });
                }

                async function submitForm() {
                    // Validation
                    if (!titre.value.trim() || !auteur.value || !description.value.trim()) {
                        alert("Veuillez remplir les champs obligatoires : Titre, Votre nom, et Description.");
                        return;
                    }
                    if (outils.value.includes('Autre') && !customOutil.value.trim()) {
                        alert("Veuillez spécifier le nom de l'outil personnalisé.");
                        return;
                    }

                    isLoadingFormSubmission.value = true; // Active le loader pour la soumission
                    confirmationVisible.value = false;

                    let finalImageUrl = originalImageUrl.value; 

                    try {
                        // 1. Upload de l'image principale (si nouvelle ou changée)
                        if (imageFile.value) { // Utilise imageFile.value car c'est une ref
                            const base64 = await getBase64(imageFile.value);
                            const uploadPayload = { fileContent: base64, fileName: imageFile.value.name };
                            const uploadResp = await fetch(UPLOAD_IMAGE_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(uploadPayload)
                            });
                            if (!uploadResp.ok) {
                                const errorText = await uploadResp.text();
                                throw new Error(`Échec de l'upload d'image: ${uploadResp.status} - ${errorText}`);
                            }
                            const uploadData = await uploadResp.json();
                            finalImageUrl = uploadData.url;
                            console.log("Image principale uploadée avec succès:", finalImageUrl);
                        } else if (!imagePreviewUrl.value) { 
                            finalImageUrl = ''; 
                        }

                        // 2. Préparation des URLs additionnelles - UTILISE urls.value DIRECTEMENT
                        const additionalUrls = urls.value.filter(url => url.trim() !== '');

                        // 3. Préparation des outils
                        const finalOutils = outils.value.filter(o => o !== 'Autre');
                        if (outils.value.includes('Autre') && customOutil.value.trim()) {
                            finalOutils.push(customOutil.value.trim());
                        }

                        // 4. Construction du payload du workflow
                        const workflowPayload = {
                            titre: titre.value,
                            auteur: auteur.value,
                            description: description.value,
                            previewText: previewText.value,
                            promptText: promptText.value,
                            commentaireUrl: commentaireUrl.value,
                            outil: finalOutils.join(', '), 
                            urls: additionalUrls, 
                            imageUrl: finalImageUrl, 
                            fileUrls: finalImageUrl ? [finalImageUrl] : [] 
                        };

                        let apiResponse;
                        if (isEditMode.value) {
                            const updatePayload = {
                                id: workflowId.value,
                                sha: workflowSha.value,
                                ...workflowPayload
                            };
                            console.log("Envoi de la requête PUT pour mise à jour:", updatePayload);
                            apiResponse = await fetch(UPDATE_TIP_URL, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatePayload)
                            });
                        } else {
                            console.log("Envoi de la requête POST pour création:", workflowPayload);
                            apiResponse = await fetch(PUSH_TIP_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(workflowPayload)
                            });
                        }

                        if (!apiResponse.ok) {
                            const errorText = await apiResponse.text();
                            throw new Error(`${isEditMode.value ? 'Mise à jour' : 'Création'} échouée: ${apiResponse.status} - ${errorText}`);
                        }

                        const result = await apiResponse.json();
                        console.log("Réponse de l'API:", result);

                        // Mise à jour des variables de confirmation
                        confirmationImageUrls.value = finalImageUrl ? [finalImageUrl] : []; 
                        confirmationUrls.value = result.urls || additionalUrls; 
                        confirmationCommentaireUrl.value = result.commentaireUrl || commentaireUrl.value;
                        confirmationTitre.value = titre.value;
                        confirmationDescription.value = description.value;
                        confirmationPreviewText.value = previewText.value;
                        confirmationPromptText.value = promptText.value;
                        confirmationVisible.value = true;

                        setTimeout(() => {
                            window.location.href = "/cas-usages.html"; 
                        }, 5000);

                        // Réinitialisation des champs après succès (uniquement en mode création)
                        if (!isEditMode.value) {
                            titre.value = '';
                            auteur.value = profilsAuteurs.value.length === 1 ? profilsAuteurs.value[0] : '';
                            description.value = '';
                            previewText.value = '';
                            promptText.value = '';
                            commentaireUrl.value = '';
                            urls.value = ['']; // Réinitialise le tableau 'urls'
                            outils.value = [];
                            customOutil.value = '';
                            imagePreviewUrl.value = '';
                            originalImageUrl.value = '';
                            imageFile.value = null;
                            if (fileInput.value) fileInput.value.value = null;
                        }

                    } catch (err) {
                        console.error(`Erreur lors de l'opération (${isEditMode.value ? 'mise à jour' : 'création'}) du workflow:`, err);
                        alert(`Échec de l'opération du workflow: ${err.message || err}. Vérifiez la console.`);
                    } finally {
                        isLoadingFormSubmission.value = false; 
                    }
                }

                return {
                    // Exposed properties and methods for the template
                    auteur, titre, description, previewText, promptText, outils, customOutil,
                    urls, addUrlField, removeUrlField, commentaireUrl,
                    fileInput, imagePreviewUrl, fileUploadError,
                    isLoading, isLoadingFormSubmission, profilsAuteurs, isLoadingProfils, toolsList,
                    confirmationVisible, confirmationImageUrls, confirmationUrls,
                    confirmationCommentaireUrl, confirmationTitre, confirmationDescription,
                    confirmationPreviewText, confirmationPromptText,
                    lightboxVisible, lightboxImageUrl,
                    isEditMode, formTitle, submitButtonText, confirmationMessage,
                    triggerFile, onDragOver, onDragLeave, onDrop, onFileChange,
                    removeImage, submitForm, openLightbox, closeLightbox
                };
            }
        };

        // --- Initialisation globale au chargement du DOM ---
        document.addEventListener("DOMContentLoaded", async () => {
            const bodyElement = document.body;
            const mainElement = document.querySelector("main");

            bodyElement.style.overflow = 'hidden';

            await loadComponent("header.html", "header-placeholder");
            // Le footer n'est pas dans le template HTML que vous avez fourni, je le retire ici.
            // Si vous avez un footer, décommentez la ligne et assurez-vous de son existence:
            // await loadComponent("footer.html", "footer-placeholder"); 

            // Mettre à jour l'état actif du menu après le chargement du header
            const currentPath = window.location.pathname.split('/').pop();
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop() : '';
                if (linkFileName === currentPath || (currentPath === "" && linkFileName === "index.html") || linkFileName === "creer-tip.html" || linkFileName === "cas-usages.html") {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // Monter l'application Vue.js sur l'élément #app
            createApp(TipForm).mount('#app');

            bodyElement.classList.add("show");
            if (mainElement) mainElement.classList.add("show");
            bodyElement.style.overflow = '';
        });
    </script>
</body>
</html>
