<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partager un Tip / Prompt - iMarketing</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.05);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-text: #dc3545;
            --grey-text: #555;
            --border-color: #ddd;
        }
        html, body { height: 100%; -webkit-overflow-scrolling: touch; }
        body { opacity: 0; transition: opacity 0.5s ease; margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-grey); display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
        body.show { opacity: 1; }
        main { opacity: 0; transition: opacity 0.5s ease; padding: 40px 20px; flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; overflow-y: auto; }
        main.show { opacity: 1; }
        .container { max-width: 600px; width: 100%; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); padding: 30px; box-sizing: border-box; position: relative; }
        label { font-weight: 600; display: block; margin-top: 15px; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; background: #f9fafb; box-sizing: border-box; color: #333; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-blue); outline: none; box-shadow: 0 0 0 2px rgba(0, 119, 182, 0.2); }
        .checkbox-group { max-height: 180px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-top: 5px; background-color: #f9fafb; }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 8px; }
        .checkbox-item:last-child { margin-bottom: 0; }
        .checkbox-item input[type="checkbox"] { width: auto; margin: 0 10px 0 0; flex-shrink: 0; }
        .checkbox-item label { font-weight: 400; margin: 0; cursor: pointer; }
        .url-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .url-action-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; margin-bottom: 15px; }
        .add-url-button, .remove-url-button { padding: 8px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: none; color: white; }
        .add-url-button { background-color: #28a745; }
        .add-url-button:hover { background-color: #218838; }
        .remove-url-button { background-color: #dc3545; }
        .remove-url-button:hover { background-color: #c82333; }
        #drop-zone { border: 2px dashed var(--primary-blue); padding: 20px; text-align: center; color: #777; margin-top: 10px; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
        #drop-zone.dragover { background: #e0f7ff; }
        .file-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .file-preview-item { position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; }
        .file-preview-item img.image-preview { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        .file-preview-item .file-icon { font-size: 40px; color: var(--primary-blue); }
        .file-name-overlay { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.6); color: white; font-size: 0.7em; padding: 3px 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-file-button { position: absolute; top: 5px; right: 5px; background-color: rgba(255, 0, 0, 0.7); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s ease; line-height: 1; padding: 0; }
        .remove-file-button:hover { background-color: red; }
        button[type="submit"] { width: 100%; padding: 12px; background: var(--primary-blue); color: #fff; border: none; border-radius: 8px; margin-top: 25px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
        button[type="submit"]:hover { background: var(--dark-blue); }
        button[type="submit"]:disabled { background-color: #cccccc; cursor: not-allowed; }
        .confirmation { margin-top: 30px; padding: 20px; background: var(--success-bg); border: 1px solid var(--success-text); border-radius: 10px; text-align: center; color: var(--success-text); }
        .loader { display: block; margin: 20px auto; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; }
        .lightbox-content img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        .lightbox-close { position: absolute; top: 10px; right: 10px; color: #fff; font-size: 30px; cursor: pointer; z-index: 1001; background-color: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; line-height: 1; }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>
    <main>
        <div id="app">
            <div class="container">
                <a href="/cas-usages.html" class="retour-lien">← Retour</a>
                <h2 style="text-align:center; color:var(--primary-blue);">Partager un Tip / workflow</h2>

                <div v-if="globalError" style="color: red; background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                    <strong>Erreur de chargement :</strong> {{ globalError }}
                </div>

                <form @submit.prevent="submitForm" v-else>
                    <label for="auteur">Votre nom</label>
                    <select id="auteur" v-model="auteur" required>
                        <option value="" disabled>Sélectionnez un nom</option>
                        <option v-for="profilNom in profilsAuteurs" :key="profilNom" :value="profilNom">{{ profilNom }}</option>
                    </select>
                    <p v-if="isLoadingProfils" style="color: var(--primary-blue);">Chargement des profils...</p>

                    <label for="titre">Titre du Tip / Workflow</label>
                    <input type="text" id="titre" v-model="titre" required />

                    <label for="description">Description</label>
                    <textarea id="description" v-model="description" rows="4" required></textarea>

                    <label for="previewText">Post-it</label>
                    <textarea id="previewText" v-model="previewText" rows="2" placeholder="Un court extrait ou un résumé..."></textarea>

                    <label for="prompt">Prompt</label>
                    <textarea id="prompt" v-model="promptText" rows="6" placeholder="Collez le prompt exact ici..."></textarea>

                    <label for="categorie">Catégorie</label>
                    <select id="categorie" v-model="categorie">
                         <option>Marketing Digital</option>
                         <option>Stratégie</option>
                         <option>Communication & Image de Marque</option>
                         <option>Réseaux Sociaux</option>
                         <option>SEO & Positionnement</option>
                         <option>Publicité Digitale</option>
                         <option>Contenu & Rédaction</option>
                         <option>Graphisme & Design Visuel</option>
                         <option>Montage Vidéo & Audio</option>
                         <option>Gestion de la Relation Client (CRM)</option>
                         <option>Ventes & Prospection</option>
                         <option>Partenariats & Affiliation</option>
                         <option>Analyse de Données & Reporting</option>
                         <option>Automatisation & Productivité</option>
                         <option>Autres IA</option>
                         <option>Autre</option>
                    </select>

                    <label>Plateforme(s) / Outil(s)</label>
                    <div class="checkbox-group" role="group">
                        <div v-for="(tool, index) in toolsList" :key="index" class="checkbox-item">
                            <input type="checkbox" :id="'tool-' + index" :value="tool.name" v-model="outils">
                            <label :for="'tool-' + index">{{ tool.name }}</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tool-autre" value="Autre" v-model="outils">
                            <label for="tool-autre">Autre</label>
                        </div>
                    </div>
                    <input type="text" v-if="outils.includes('Autre')" v-model="customOutil" placeholder="Spécifiez l'outil..." style="margin-top: 10px;" />

                    <label>Lien(s) associé(s) - archive chatGPT/Gemini :</label>
                    <div v-for="(url, index) in urls" :key="index" class="url-input-group">
                        <input type="url" v-model="urls[index]" :placeholder="`Lien ${index + 1}`" />
                        <button type="button" @click="removeUrlField(index)" class="remove-url-button">X</button>
                    </div>
                    <div class="url-action-buttons">
                        <button type="button" @click="addUrlField" class="add-url-button">Ajouter un lien</button>
                    </div>

                    <label for="commentaireUrl">Commentaire / workflow</label>
                    <textarea id="commentaireUrl" v-model="commentaireUrl" rows="2" placeholder="Ajoutez un commentaire sur les liens..."></textarea>

                    <label>Images / Documents (optionnel)</label>
                    <div id="drop-zone" @click="triggerFile" @dragover.prevent="onDragOver" @dragleave="onDragLeave" @drop.prevent="onDrop">
                        Déposez ou cliquez pour ajouter des fichiers
                    </div>
                    <input type="file" ref="fileInput" @change="onFileChange" multiple style="display:none" accept="image/*,.txt,.pdf" />
                    <p v-if="fileUploadError" style="color: red;">{{ fileUploadError }}</p>
                    <div class="file-preview-grid">
                        <div v-for="fileObj in selectedFiles" :key="fileObj.id" class="file-preview-item">
                            <img v-if="fileObj.type.startsWith('image/')" :src="fileObj.previewUrl" class="image-preview" :alt="fileObj.name" />
                            <span v-else class="file-icon">📄</span>
                            <span class="file-name-overlay">{{ fileObj.name }}</span>
                            <button type="button" @click="removeFile(fileObj.id)" class="remove-file-button">&times;</button>
                        </div>
                    </div>

                    <div v-if="isLoading" class="loader"></div>
                    <button v-else type="submit" :disabled="!auteur || !titre || !description || isLoading">Partager le Tip / Prompt</button>
                </form>

                <div class="confirmation" v-if="confirmationVisible">
                    <p>✅ Tip / Prompt partagé avec succès !</p>
                    <p>Redirection dans 5 secondes...</p>
                </div>
            </div>

            <div class="lightbox-overlay" v-if="lightboxVisible" @click.self="closeLightbox">
                <span class="lightbox-close" @click="closeLightbox">&times;</span>
                <div class="lightbox-content">
                    <img :src="lightboxImageUrl" alt="Aperçu image" />
                </div>
            </div>
        </div>
    </main>
    <div id="footer-placeholder"></div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="tools-data.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const SAVE_TIP_URL = "/.netlify/functions/pushTip";
            const GET_PROFILS_URL = "/.netlify/functions/getProfils";
            
            const { ref, createApp, onMounted, onUnmounted } = Vue;

            if (typeof toolsData === 'undefined' || !Array.isArray(toolsData)) {
                console.error("Erreur critique : 'toolsData' est manquant ou invalide.");
                createApp({ setup: () => ({ globalError: ref("Impossible de charger la liste des outils.") }) }).mount('#app');
                return;
            }

            const TipForm = {
                setup() {
                    // --- Refs pour les données du formulaire ---
                    const auteur = ref('');
                    const titre = ref('');
                    const description = ref('');
                    const previewText = ref('');
                    const promptText = ref('');
                    const categorie = ref('Marketing Digital');
                    const outils = ref([]);
                    const customOutil = ref('');
                    const urls = ref(['']);
                    const commentaireUrl = ref('');
                    const selectedFiles = ref([]);
                    const fileInput = ref(null);
                    const fileUploadError = ref('');
                    const toolsList = ref([...toolsData].sort((a, b) => a.name.localeCompare(b.name)));
                    
                    // --- Refs pour l'état de l'interface ---
                    const isLoading = ref(false);
                    const isLoadingProfils = ref(true);
                    const profilsAuteurs = ref([]);
                    const globalError = ref(null);
                    const confirmationVisible = ref(false);
                    const lightboxVisible = ref(false);
                    const lightboxImageUrl = ref('');
                    let fileIdCounter = 0;

                    // --- Fonctions de gestion du formulaire ---
                    const addUrlField = () => urls.value.push('');
                    const removeUrlField = (index) => {
                        urls.value.splice(index, 1);
                        if (urls.value.length === 0) urls.value.push('');
                    };

                    // --- Fonctions pour l'upload de fichiers ---
                    const triggerFile = () => fileInput.value.click();
                    const onDragOver = (e) => e.currentTarget.classList.add('dragover');
                    const onDragLeave = (e) => e.currentTarget.classList.remove('dragover');
                    const onDrop = (e) => {
                        onDragLeave(e);
                        addFiles(e.dataTransfer.files);
                    };
                    const onFileChange = (e) => addFiles(e.target.files);
                    const addFiles = (files) => {
                        fileUploadError.value = '';
                        for (const file of files) {
                            const newFileObj = { id: fileIdCounter++, file, name: file.name, type: file.type, previewUrl: null };
                            if (file.type.startsWith('image/')) {
                                newFileObj.previewUrl = URL.createObjectURL(file);
                            }
                            selectedFiles.value.push(newFileObj);
                        }
                    };
                    const removeFile = (fileId) => {
                        const fileObj = selectedFiles.value.find(f => f.id === fileId);
                        if (fileObj && fileObj.previewUrl) {
                            URL.revokeObjectURL(fileObj.previewUrl);
                        }
                        selectedFiles.value = selectedFiles.value.filter(f => f.id !== fileId);
                    };

                    // --- Fonctions diverses ---
                    const openLightbox = (url) => { lightboxVisible.value = true; lightboxImageUrl.value = url; };
                    const closeLightbox = () => lightboxVisible.value = false;
                    const handleKeydown = (e) => { if (e.key === 'Escape') closeLightbox(); };

                    // --- Logique métier ---
                    const fetchProfils = async () => {
                        isLoadingProfils.value = true;
                        try {
                            const response = await fetch(GET_PROFILS_URL);
                            if (!response.ok) throw new Error('Réponse réseau non OK');
                            const data = await response.json();
                            profilsAuteurs.value = [...new Set((Array.isArray(data) ? data : data.profils || []).map(p => p.name).filter(Boolean))].sort();
                        } catch (error) {
                            console.error("Erreur de chargement des profils:", error);
                        } finally {
                            isLoadingProfils.value = false;
                        }
                    };

                    const submitForm = async () => {
                        isLoading.value = true;
                        try {
                            const formData = new FormData();
                            const finalOutils = outils.value.filter(o => o !== 'Autre').concat(outils.value.includes('Autre') && customOutil.value ? [customOutil.value.trim()] : []).filter(Boolean);
                            
                            formData.append('auteur', auteur.value);
                            formData.append('titre', titre.value);
                            formData.append('description', description.value);
                            formData.append('previewText', previewText.value);
                            formData.append('promptText', promptText.value);
                            formData.append('categorie', categorie.value);
                            formData.append('outil', finalOutils.join(', '));
                            formData.append('urls', JSON.stringify(urls.value.filter(u => u.trim())));
                            formData.append('commentaireUrl', commentaireUrl.value);

                            selectedFiles.value.forEach(fileObj => formData.append('files', fileObj.file, fileObj.name));

                            const response = await fetch(SAVE_TIP_URL, { method: 'POST', body: formData });
                            if (!response.ok) throw new Error('Échec de la soumission du formulaire');
                            
                            const result = await response.json();
                            console.log('Succès:', result);
                            confirmationVisible.value = true;
                            setTimeout(() => window.location.href = "cas-usages.html?success=1", 5000);

                        } catch (error) {
                            console.error("Erreur lors de la soumission:", error);
                            alert("Une erreur est survenue.");
                        } finally {
                            isLoading.value = false;
                        }
                    };

                    // --- Hooks de cycle de vie ---
                    onMounted(() => {
                        fetchProfils();
                        window.addEventListener('keydown', handleKeydown);
                    });
                    onUnmounted(() => {
                        window.removeEventListener('keydown', handleKeydown);
                        selectedFiles.value.forEach(fileObj => {
                            if (fileObj.previewUrl) URL.revokeObjectURL(fileObj.previewUrl);
                        });
                    });

                    return {
                        auteur, titre, description, previewText, promptText, categorie, outils, customOutil, urls, commentaireUrl, selectedFiles, fileInput, fileUploadError, toolsList,
                        isLoading, isLoadingProfils, profilsAuteurs, globalError, confirmationVisible, lightboxVisible, lightboxImageUrl,
                        addUrlField, removeUrlField, triggerFile, onDragOver, onDragLeave, onDrop, onFileChange, removeFile, openLightbox, closeLightbox, submitForm
                    };
                }
            };
            createApp(TipForm).mount('#app');
            document.body.classList.add('show');
            document.querySelector('main').classList.add('show');
        });
    </script>
</body>
</html>
