<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Créer un Tip - Espace IA</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Styles pour la transition d'apparition du corps et du main */
    body {
      opacity: 0;
      transition: opacity 0.5s ease;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
    }
    body.show {
      opacity: 1;
    }
    main {
      opacity: 0;
      transition: opacity 0.5s ease;
      padding: 40px 20px;
    }
    main.show {
      opacity: 1;
    }

    /* Styles du conteneur principal du formulaire */
    .container {
      max-width: 800px; /* Taille augmentée pour un meilleur agencement */
      margin: 0 auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      position: relative;
    }

    /* Styles du titre du formulaire */
    h1 {
      text-align: center;
      font-size: 1.8em;
      color: #0077b6;
      margin-bottom: 20px;
    }

    /* Styles des labels des champs */
    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      color: #333;
    }

    /* Styles des champs de saisie (input, textarea, select) */
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      background-color: #f9f9f9;
      box-sizing: border-box; /* Inclut le padding et la bordure dans la largeur totale */
      color: #333;
    }
    input:focus, select:focus, textarea:focus {
        border-color: #0077b6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 119, 182, 0.2);
    }

    /* Styles du bouton d'enregistrement */
    button {
      margin-top: 30px;
      padding: 12px 20px;
      border: none;
      background-color: #0077b6;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s;
      width: 100%; /* Bouton pleine largeur */
    }
    button:hover {
      background-color: #005f8a;
    }
    button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Styles des messages de succès et d'erreur */
    .success {
      margin-top: 20px;
      color: green;
      font-weight: 600;
      text-align: center;
    }
    .error {
        margin-top: 20px;
        color: red;
        font-weight: 600;
        text-align: center;
    }

    /* Styles de la prévisualisation du tip */
    .preview {
      margin-top: 30px;
      padding: 15px 20px;
      background: #e3f2fd;
      border-left: 5px solid #0077b6;
      border-radius: 10px;
    }
    .preview h2 {
      margin: 0 0 10px;
      color: #005f8a;
    }
    .preview p {
      margin: 0 0 10px;
    }
    .preview .meta {
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }

    /* Styles de l'indicateur de chargement (loader) */
    .loader {
        display: block;
        margin: 20px auto;
        width: 40px;
        height: 40px;
        border: 4px solid #ccc;
        border-top: 4px solid #0077b6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>
  <script>
    // Chargement du header et gestion de l'apparition progressive du body et main
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;
        document.body.classList.add("show");
        document.querySelector("main").classList.add("show");
      })
      .catch(error => console.error("Erreur lors du chargement du header:", error));
  </script>

  <main>
    <div id="app"></div>
  </main>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { ref, createApp, onMounted, computed } = Vue;

    // URL de votre fonction Netlify 'proxy' qui gérera les requêtes
    // Assurez-vous que cette URL est correcte pour votre déploiement Netlify
    const PROXY_URL = "/.netlify/functions/proxy";

    const TipForm = {
      template: `
        <div class="container">
          <h1>Créer un Tip & Cas d’usage</h1>

          <label for="auteur">Auteur du Tip</label>
          <select id="auteur" v-model="auteur" required>
            <option value="" disabled>Sélectionnez un auteur</option>
            <option v-for="profilNom in profilsAuteurs" :key="profilNom" :value="profilNom">{{ profilNom }}</option>
          </select>
          <p v-if="profilsAuteurs.length === 0 && !isLoadingProfils" style="color: #888; font-size: 0.9em; margin-top: 5px;">
            Aucun profil trouvé. Assurez-vous d'avoir créé des profils dans la section "Équipe".
          </p>
          <p v-if="isLoadingProfils" style="color: #0077b6; font-size: 0.9em; margin-top: 5px;">Chargement des noms de profils...</p>

          <label for="titre">Titre</label>
          <input type="text" id="titre" v-model="titre" placeholder="Ex : Créer un visuel pour réseaux sociaux" required>

          <label for="description">Description</label>
          <textarea id="description" v-model="description" rows="3" placeholder="Décrivez brièvement l’usage ou le contexte" required></textarea>

          <label for="prompt">Prompt</label>
          <textarea id="prompt" v-model="prompt" rows="4" placeholder="Exemple de prompt utilisable par l’IA" required></textarea>

          <label for="outil">Outil IA utilisé</label>
          <select id="outil" v-model="outil" required>
            <option value="">-- Sélectionnez --</option>
            <option>ChatGPT</option>
            <option>Claude</option>
            <option>Midjourney</option>
            <option>Firefly</option>
            <option>Perplexity</option>
            <option>Notion AI</option>
          </select>

          <label for="categorie">Catégorie</label>
          <select id="categorie" v-model="categorie" required>
            <option value="">-- Sélectionnez --</option>
            <option>Productivité</option>
            <option>Marketing Digital</option>
            <option>Graphisme</option>
            <option>Communication</option>
            <option>CRM</option>
            <option>Com. Presse & Influenceurs</option>
            <option>Partenariats & Évènements</option>
            <option>Positionnement</option>
            <option>Pôle Créa</option>
          </select>

          <div v-if="isLoading" class="loader"></div>
          <button v-else @click="validerTip" :disabled="!isFormValid || isLoading">Enregistrer le tip</button>

          <div class="success" id="message-success" v-show="messageSuccessVisible">Tip enregistré avec succès ✅</div>
          <div class="error" id="message-error" v-show="messageErrorVisible">{{ errorMessage }}</div>

          <div id="preview-container" v-if="previewVisible">
            <div class="preview">
              <h2>{{ titrePreview }}</h2>
              <p>{{ descriptionPreview }}</p>
              <div class="prompt-box">
                <code>{{ promptPreview }}</code>
              </div>
              <p class="meta">Outil : {{ outilPreview }} • Catégorie : {{ categoriePreview }} • Auteur : {{ auteurPreview }}</p>
            </div>
          </div>
        </div>
      `,
      setup() {
        // Données du formulaire, réactives avec ref()
        const titre = ref('');
        const description = ref('');
        const prompt = ref('');
        const outil = ref('');
        const categorie = ref('');
        const auteur = ref(''); // Modèle pour le champ select de l'auteur

        // États de l'interface utilisateur
        const messageSuccessVisible = ref(false);
        const messageErrorVisible = ref(false);
        const errorMessage = ref('');
        const previewVisible = ref(false);
        const isLoading = ref(false);

        // Données pour la prévisualisation (pour capturer l'état au moment de l'enregistrement)
        const titrePreview = ref('');
        const descriptionPreview = ref('');
        const promptPreview = ref('');
        const outilPreview = ref('');
        const categoriePreview = ref('');
        const auteurPreview = ref('');

        // Données et état pour le filtre des profils d'auteur
        const profilsAuteurs = ref([]);
        const isLoadingProfils = ref(true);

        // Propriété calculée pour vérifier si le formulaire est valide (tous les champs requis sont remplis)
        const isFormValid = computed(() => {
            return titre.value.trim() !== '' &&
                   description.value.trim() !== '' &&
                   prompt.value.trim() !== '' &&
                   outil.value !== '' &&
                   categorie.value !== '' &&
                   auteur.value !== '';
        });

        /**
         * Fonction asynchrone pour charger les noms des profils d'équipe
         * depuis votre backend (fonction Netlify).
         */
        async function fetchProfils() {
            isLoadingProfils.value = true; // Active l'indicateur de chargement des profils
            try {
                // Appel à la fonction Netlify 'proxy' avec l'action 'getProfils'
                const response = await fetch(`${PROXY_URL}?action=getProfils`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();
                // Extrait les noms uniques et les trie par ordre alphabétique
                // Assure que 'data' est un tableau ou contient une propriété 'profils'
                const profilesList = Array.isArray(data) ? data : (data.profils || []);
                const names = [...new Set(profilesList.map(p => p.name).filter(Boolean))].sort();
                profilsAuteurs.value = names;

                // Sélectionne le premier profil par défaut si un seul est disponible, sinon réinitialise
                if (names.length === 1) {
                    auteur.value = names[0];
                } else {
                    auteur.value = '';
                }
                console.log("Noms de profils chargés:", profilsAuteurs.value);

            } catch (error) {
                console.error("Erreur lors du chargement des profils:", error);
                errorMessage.value = "Impossible de charger la liste des auteurs. Vérifiez la console.";
                messageErrorVisible.value = true;
            } finally {
                isLoadingProfils.value = false; // Désactive l'indicateur de chargement des profils
            }
        }

        /**
         * Fonction asynchrone pour valider le formulaire et envoyer le tip
         * à votre backend (fonction Netlify) pour la sauvegarde sur GitHub.
         */
        async function validerTip() {
            // Réinitialise les messages d'état et la prévisualisation
            messageSuccessVisible.value = false;
            messageErrorVisible.value = false;
            errorMessage.value = '';
            previewVisible.value = false;
            isLoading.value = true; // Active l'indicateur de chargement du tip

            // Vérifie la validité du formulaire avant l'envoi
            if (!isFormValid.value) {
                errorMessage.value = "Merci de remplir tous les champs obligatoires.";
                messageErrorVisible.value = true;
                isLoading.value = false; // Désactive l'indicateur si le formulaire est invalide
                return;
            }

            // Construit l'objet du nouveau tip
            const nouveauTip = {
                titre: titre.value,
                description: description.value,
                prompt: prompt.value,
                outil: outil.value,
                categorie: categorie.value,
                auteur: auteur.value,
                date: new Date().toISOString().split('T')[0] // Ajoute la date actuelle au format YYYY-MM-DD
            };

            try {
                // Envoi des données du tip à la fonction Netlify 'proxy' avec l'action 'saveTip'
                const response = await fetch(`${PROXY_URL}?action=saveTip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nouveauTip),
                });

                if (response.ok) {
                    messageSuccessVisible.value = true; // Affiche le message de succès

                    // Capture les valeurs pour la prévisualisation avant de réinitialiser le formulaire
                    titrePreview.value = titre.value;
                    descriptionPreview.value = description.value;
                    promptPreview.value = prompt.value;
                    outilPreview.value = outil.value;
                    categoriePreview.value = categorie.value;
                    auteurPreview.value = auteur.value;
                    previewVisible.value = true; // Affiche la prévisualisation

                    // Réinitialise les champs du formulaire
                    titre.value = '';
                    description.value = '';
                    prompt.value = '';
                    outil.value = '';
                    categorie.value = '';
                    // Recharge les profils pour réinitialiser le sélecteur d'auteur (et sélectionner si un seul)
                    fetchProfils();

                    // Masque le message de succès et la prévisualisation après 5 secondes
                    setTimeout(() => {
                        messageSuccessVisible.value = false;
                        previewVisible.value = false;
                    }, 5000);

                } else {
                    const errorData = await response.json(); // Tente de lire l'erreur du serveur
                    errorMessage.value = `Erreur lors de l'enregistrement du tip : ${errorData.message || response.statusText}`;
                    messageErrorVisible.value = true;
                    console.error("Erreur serveur :", errorData);
                }
            } catch (error) {
                // Gère les erreurs réseau ou les problèmes avec la fonction Netlify
                errorMessage.value = "Impossible de se connecter au serveur. Vérifiez votre connexion ou l'URL du backend.";
                messageErrorVisible.value = true;
                console.error("Erreur réseau ou du backend :", error);
            } finally {
                isLoading.value = false; // Désactive l'indicateur de chargement du tip
            }
        }

        // Appel de fetchProfils au moment où le composant est monté (chargement de la page)
        onMounted(fetchProfils);

        return {
          // Données du formulaire
          titre, description, prompt, outil, categorie, auteur,
          // États de l'interface utilisateur
          messageSuccessVisible, messageErrorVisible, errorMessage, previewVisible, isLoading,
          // Données de prévisualisation (pour qu'elles restent affichées après réinitialisation du formulaire)
          titrePreview, descriptionPreview, promptPreview, outilPreview, categoriePreview, auteurPreview,
          // Profils et leur état de chargement
          profilsAuteurs, isLoadingProfils,
          // Propriété calculée pour la validation du formulaire
          isFormValid,
          // Méthodes
          validerTip
        };
      }
    };

    // Monte l'application Vue.js sur l'élément avec l'id 'app'
    createApp(TipForm).mount('#app');
  </script>
</body>
</html>
