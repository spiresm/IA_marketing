<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Créer ou éditer un profil</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      opacity: 0;
      transition: opacity 0.3s ease-in;
    }
    main {
      display: none;
    }
    .container {
      max-width: 600px;
      background: white;
      margin: 40px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #0077b6;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    input, select, textarea {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      padding: 12px;
      background: #0077b6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    .dropzone {
      padding: 20px;
      text-align: center;
      border: 2px dashed #ccc;
      border-radius: 10px;
      background: #fafafa;
      color: #666;
      cursor: pointer;
    }
    .dropzone.dragover {
      background: #e0f7fa;
      border-color: #0077b6;
      color: #0077b6;
    }
    #image-preview {
      max-width: 100px;
      margin: auto;
      display: block;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <main>
    <div class="container">
      <h1 id="form-title">Créer un profil</h1>
      <form id="profil-form">
        <input type="text" id="name" placeholder="Nom complet" required />
        <select id="pole" required>
          <option value="">-- Sélectionner un pôle --</option>
          <option value="Pôle créa.">Pôle créa.</option>
          <option value="CRM">CRM</option>
          <option value="Communication">Communication</option>
          <option value="Partenariats">Partenariats</option>
          <option value="Marketing digital">Marketing digital</option>
        </select>
        <input type="url" id="photo" placeholder="URL de la photo" />
        <div class="dropzone" id="dropzone">Glisser-déposer une image ici ou cliquer</div>
        <img id="image-preview" style="display:none;" alt="Aperçu image" />
        <label>Outils IA maîtrisés :</label>
        <div id="tools-list"></div>
        <button type="submit" id="submit-btn">Créer</button>
      </form>
    </div>
  </main>

  <script>
    const allTools = [
      "ChatGPT", "Claude", "Midjourney", "DALL·E", "Stable Diffusion", "Firefly",
      "Runway ML", "Perplexity", "Notion AI", "Gemini", "Copilot", "Bard",
      "Pika", "Sora", "Luma AI", "Kling AI", "Genny by Lovo", "ElevenLabs",
      "Murf", "Voicemaker", "Suno.ai", "MusicFX", "Boomy", "Riffusion",
      "Jules", "Devstral", "Codeium", "Bolt"
    ];

    function mettreAJourBulleDemandes() {
      const notif = document.getElementById("notif-count");
      if (!notif) return;
      const demandes = JSON.parse(localStorage.getItem("demandesIA") || "[]");
      notif.textContent = demandes.length;
      notif.style.display = demandes.length > 0 ? "inline-block" : "none";
    }

    fetch("header.html")
      .then(response => response.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
        requestAnimationFrame(() => {
          document.body.style.opacity = "1";
          document.querySelector("main").style.display = "block";
          mettreAJourBulleDemandes();
        });
      });

    const params = new URLSearchParams(window.location.search);
    const editName = decodeURIComponent(params.get("edit") || "");
    const profils = JSON.parse(localStorage.getItem("profilsEquipe") || "[]");
    let editingProfil = profils.find(p => p.name === editName);

    const nameInput = document.getElementById("name");
    const poleSelect = document.getElementById("pole");
    const photoInput = document.getElementById("photo");
    const toolsDiv = document.getElementById("tools-list");
    const title = document.getElementById("form-title");
    const submitBtn = document.getElementById("submit-btn");
    const dropzone = document.getElementById("dropzone");
    const imagePreview = document.getElementById("image-preview");

    allTools.forEach(tool => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = tool;
      label.appendChild(checkbox);
      label.append(" " + tool);
      toolsDiv.appendChild(label);
      toolsDiv.appendChild(document.createElement("br"));
    });

    if (editingProfil) {
      title.textContent = "Modifier le profil";
      submitBtn.textContent = "Mettre à jour";
      nameInput.value = editingProfil.name;
      poleSelect.value = editingProfil.pole || "";
      photoInput.value = editingProfil.photo || "";
      if (editingProfil.photo) {
        imagePreview.src = editingProfil.photo;
        imagePreview.style.display = "block";
      }
      (editingProfil.tools || []).forEach(t => {
        const cb = [...toolsDiv.querySelectorAll("input")].find(c => c.value === t);
        if (cb) cb.checked = true;
      });
    }

    dropzone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = e => handleFileUpload(e.target.files[0]);
      input.click();
    });

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("dragover");
    });

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      if (e.dataTransfer.files.length) {
        handleFileUpload(e.dataTransfer.files[0]);
      }
    });

    function handleFileUpload(file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        photoInput.value = evt.target.result;
        imagePreview.src = evt.target.result;
        imagePreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }

    document.getElementById("profil-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const updatedProfil = {
        name: nameInput.value.trim(),
        pole: poleSelect.value,
        photo: photoInput.value,
        tools: [...toolsDiv.querySelectorAll("input:checked")].map(c => c.value)
      };

      if (!updatedProfil.name) {
        alert("Le nom ne peut pas être vide.");
        return;
      }

      const index = profils.findIndex(p => p.name === updatedProfil.name);
      if (index !== -1) {
        profils[index] = updatedProfil;
      } else {
        profils.push(updatedProfil);
      }

      localStorage.setItem("profilsEquipe", JSON.stringify(profils));
      window.location.href = "equipe.html";
    });
  </script>
</body>
</html>
