<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Gestion des Licences IA</title>
    <style>
        /* CSS INTÉGRÉ DIRECTEMENT ICI POUR ASSURER SA PRÉSENCE */
        body {
            /* Couleurs de fond du modèle Demande IA */
            opacity: 0; /* Garde cet élément pour la transition JS si utilisée */
            margin: 0;
            font-family: sans-serif; /* Police du modèle Demande IA */
            background-color: #f0f2f5;
            transition: opacity 0.3s ease-in;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            /* Styles du modèle Demande IA */
            background: white;
            border-radius: 14px; /* Rayon de bordure plus prononcé */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05); /* Ombre plus douce */
            padding: 40px 35px; /* Padding similaire */
            position: relative;
            z-index: 1;
        }
        h1 {
            text-align: center;
            color: #0077b6; /* Couleur de titre du modèle Demande IA */
            margin-bottom: 5px;
        }
        .titre-description {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 25px;
            display: block;
        }
        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px; /* Espace plus grand comme dans Demande IA */
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        label {
            /* Styles du modèle Demande IA */
            font-weight: 600;
            color: #444;
            display: block;
            margin-bottom: 6px; /* Ajusté pour cohérence avec inputs */
        }
        select, input {
            /* Styles du modèle Demande IA */
            width: 100%;
            padding: 12px 14px; /* Padding plus grand */
            border: 1px solid #ccc;
            border-radius: 8px; /* Rayon de bordure plus prononcé */
            font-size: 1em;
            background-color: #f9fafb; /* Couleur de fond plus claire */
            box-sizing: border-box;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        select.highlight-field {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M283.5%2C197.8L146.7%2C59.9c-4-4.2-10.4-4.2-14.4%2C0L0.5%2C197.8c-4%2C4.2-4%2C11.1%2C0%2C15.3l14.4%2C14.8c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0L146.7%2C98.4c4-4.2%2C10.4-4.2%2C14.4%2C0l117.2%2C129.5c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0l14.4-14.8c4-4.2%2C4-11.1%2C0-15.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
        }
        /* Style focus pour les inputs/selects */
        select:focus, input:focus {
            border-color: #0077b6 !important;
            box-shadow: 0 0 5px rgba(0, 119, 182, 0.5) !important;
            outline: none;
        }

        .full {
            grid-column: span 2;
            position: relative;
            z-index: 10;
        }
        button {
            /* Styles du modèle Demande IA */
            background-color: #0077b6;
            color: white;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #005f8a;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        button:disabled:hover {
            background-color: #a0a0a0;
        }
        #subscribeButton {
            background-color: #4CAF50; /* Bouton de souscription vert */
            margin-left: 10px;
        }
        #subscribeButton:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee; /* Lignes plus claires */
        }
        th {
            background-color: #0077b6; /* Entête de tableau bleu du modèle Demande IA */
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) { /* Bandes alternées pour la lisibilité */
            background-color: #f8f8f8;
        }
        tr:hover {
            background-color: #eef2f5;
        }
        #totalAchatsContainer {
            grid-column: span 2; /* Conserve la mise en page full-width */
            text-align: right; /* Conserve l'alignement à droite */
            margin-top: 25px;
            margin-bottom: 20px;
            padding: 15px;
            /* Styles de recap du modèle Demande IA appliqués ici */
            background-color: rgba(0, 119, 182, 0.9); /* Couleur de fond du récapitulatif avec opacité */
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            color: white; /* Texte en blanc pour le récap */
        }
        #totalAchats {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffffff; /* Couleur du total en blanc */
            margin-top: 5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #totalAchatsLabel {
            font-size: 0.9em;
            color: #e0e0e0; /* Couleur du label en gris clair */
            display: block;
        }
        /* Style pour les totaux par pôle */
        #poleTotalsList {
            font-size: 0.9em;
            color: #e0e0e0; /* Texte en gris clair */
            margin-top: 15px;
            list-style: none;
            padding: 0;
            text-align: right; /* Aligner le texte de la liste à droite */
        }
        #poleTotalsList li {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        #poleTotalsList strong {
            color: #ffffff;
        }

        .cout-rouge-gras {
            font-weight: bold;
            color: #dc3545; /* Rouge pour le coût négatif ou nul */
        }
        input[type="text"].cout-input-rouge {
            font-weight: bold !important;
            color: #dc3545 !important;
            border-color: #dc3545 !important;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5) !important;
        }
        .highlight-field {
            border-color: #0077b6 !important; /* Couleur de surbrillance du modèle */
            box-shadow: 0 0 5px rgba(0, 119, 182, 0.5) !important;
        }
        .table-link {
            color: #0077b6; /* Liens dans le tableau de la couleur principale */
            text-decoration: none;
        }
        .table-link:hover {
            text-decoration: underline;
        }
        #footer-signature {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.85em;
            color: #555;
            border-top: 1px solid #eee;
        }
        #footer-signature strong {
            color: #333;
        }
        /* Style pour le filtre du tableau */
        .table-filter-container {
            margin-bottom: 15px;
            text-align: right;
            padding-right: 10px; /* Pour aligner avec le padding du conteneur */
        }
        .table-filter-container label {
            display: inline-block;
            margin-right: 10px;
            font-weight: 600;
            color: #444;
        }
        .table-filter-container select {
            width: auto;
            min-width: 180px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #f9fafb;
            font-size: 1em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M283.5%2C197.8L146.7%2C59.9c-4-4.2-10.4-4.2-14.4%2C0L0.5%2C197.8c-4%2C4.2-4%2C11.1%2C0%2C15.3l14.4%2C14.8c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0L146.7%2C98.4c4-4.2%2C10.4-4.2%2C14.4%2C0l117.2%2C129.5c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0l14.4-14.8c4-4.2%2C4-11.1%2C0-15.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
        }

        /* Styles pour les messages Toast */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }
        .toast-message {
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 250px;
            text-align: center;
            font-weight: bold;
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-message.success {
            background-color: rgba(40, 167, 69, 0.9);
        }
        .toast-message.error {
            background-color: rgba(220, 53, 69, 0.9);
        }
        /* Style pour le bouton supprimer dans le tableau (icône) */
        .btn-supprimer { /* Nouvelle classe pour le bouton supprimer du tableau */
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 4px;
            color: #dc3545; /* Couleur rouge pour l'icône */
            transition: transform 0.2s ease;
        }
        .btn-supprimer:hover {
            transform: scale(1.2); /* Effet d'agrandissement au survol */
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="container">
            <h1>Outil de Gestion des Licences IA</h1>
            <span class="titre-description"></span>

            <form id="licenseForm">
                <div class="full">
                    <label for="pole">Pôle :</label>
                    <select id="pole" required="">
                        <option value="">-- Sélectionner un pôle --</option>
                        <option>Pôle créa.</option>
                        <option>CRM</option>
                        <option>Communication</option>
                        <option>Partenariats</option>
                        <option>Marketing digital</option>
                        <option>Positionnement</option>
                        <option>Staff</option>
                    </select>
                </div>

                <div>
                    <label for="collaborateur">Collaborateur :</label>
                    <select id="collaborateur" required="">
                        <option value="">-- Sélectionner --</option>
                    </select>
                </div>
                <div>
                    <label for="licence">Licence :</label>
                    <select id="licence" required="">
                        <option value="">-- Sélectionner --</option>
                        <option>Midjourney</option>
                        <option>ChatGPT</option>
                        <option>Runway</option>
                        <option>Netlify</option>
                        <option>VEO3</option>
                        <option>Gemini</option>
                        <option>Kling AI</option>
                        <option>ElevenLabs</option>
                    </select>
                </div>
                <div class="full">
                    <label for="description">Description :</label>
                    <input id="description" readonly="readonly" type="text"/>
                </div>
                <div>
                    <label for="type">Type de licence :</label>
                    <select id="type" required=""></select>
                </div>
                <div>
                    <label for="cout">Coût (EUR) :</label>
                    <input id="cout" required="" type="text"/>
                </div>
                <div>
                    <label for="periodeCout">Période du coût :</label>
                    <select id="periodeCout" required="">
                        <option value="">-- Sélectionner --</option>
                        <option value="mois">Par mois</option>
                        <option value="annee">Par année</option>
                    </select>
                </div>
                <div>
                    <label for="dateAchat">Date d'achat :</label>
                    <input id="dateAchat" required="" type="date"/>
                </div>
                <div>
                    <label for="dateRenouvellement">Date de renouvellement :</label>
                    <input id="dateRenouvellement" type="text" readonly="readonly"/>
                </div>

                <div class="full">
                    <button type="submit" id="addButton" disabled>Ajouter</button>
                    <button type="button" id="downloadButton">Télécharger la liste</button>
                    <button id="subscribeButton" type="button" style="display: none;">Souscrire à la Licence</button>
                </div>

                <div id="totalAchatsContainer">
                    <span id="totalAchatsLabel">Coût Annuel Estimé des Licences :</span>
                    <div id="totalAchats">0,00 EUR</div>
                    <ul id="poleTotalsList"></ul>
                </div>
            </form>

            <div class="table-filter-container">
                <label for="tablePoleFilter">Filtrer par Pôle :</label>
                <select id="tablePoleFilter">
                    <option value="all">Tout</option>
                </select>
            </div>

            <table id="listeLicences">
                <thead>
                    <tr>
                        <th>Pôle</th>
                        <th>Collaborateur</th>
                        <th>Licence</th>
                        <th>Type</th>
                        <th>Coût</th>
                        <th>Période</th>
                        <th>Date d'achat</th>
                        <th>Date de renouvellement</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <div id="toast-container"></div>

    <div id="footer-signature">
        Développé par <strong>Steeve PIRES MADEIRA</strong><br>
        Chargé(e) de projets - R&D format • Médias - Marketing & Communication
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script>
        console.log("Script JavaScript chargé et démarré.");

        const TAUX_DE_CONVERSION_USD_EUR = 0.93;

        const collaborateursParPole = {
            "Pôle créa.": [
                "Anne-Françoise LELEUX", "Baptiste TARTAS", "Béatrice MARLIER",
                "Boris TEIRLYNCK", "Charlotte DELWARTE", "Céline DELENTREE", "Delphine BENROUBI",
                "Faiza BOUMEDIAN", "Geneviève DE BEAUFFORT", "Giovanni CASCONE",
                "Gregory KEPPENS", "Isabelle MARCHAL", "Isabelle VERTUONGEN",
                "Jimmy DEGRÈVE", "Joel VAN HOEF", "Jonathan LACROIX",
                "Jose ROJO", "Jose-Luis PENAFUERTE", "Mehdi HUSAIN",
                "Michael EVRARD", "Patricia DAVIA", "Pierre LERMIER",
                "Pierre-Jean GILOUX", "Steeve PIRES MADEIRA",
                "Susana GONCALVES VALERIO",
                "Tyan HOOGSTOEL", "Vinciane LE MEN",
                "Sabrina LECLERCQ",
                "Nathalie AUBRY",
                "Jeremy DEHERTOGH",
                "Dominique LEFEVRE",
                "Virginie LONGE"
            ].sort(),

            "CRM": [
                "Frédéric CARTON", "Inès BERNOUX", "Noémie ROSSEY",
                "Yasmine AIT MASKOUR"
            ].sort(),

            "Communication": [
                "Aurore CRABBE", "Elvis TCHANA", "Fabienne CULLUS",
                "Marie NAUWELAERTS", "Régine CARPENTIER"
            ].sort(),

            "Partenariats": [
                "Alinoe VANHAUDENHUYSE", "Catherine CARA", "Dominique CAFFIERS",
                "Fiona KOPEINIG", "Isabelle DELENS",
                "Laura DONATELLO", "Marie-Rose ANGE", "Naïm EL BOHALI",
                "Nathalie DE RIJCKE"
            ].sort(),

            "Marketing digital": [
                "Elise FONCK", "Gaëlle DEGEYE",
                "Mathilde ARMILLAC", "Morgane CARLY", "Yasmine GHAZOUANE",
                "Sara GARCIA"
            ].sort(),

            "Positionnement": [
                "Amelie DE LANGE", "Philippe BLANJEAN",
                "Samuel LALOUX"
            ].sort(),

            "Staff": [
                "Meltem SIVLIN", "Nadia CURTO", "Vincent CRABBE",
                "Olivier LEIDGENS", "Pierre DUBOIS", "Vitold GRAND'HENRY",
                "Romain DELECOUR", "Noemie GORISSEN"
            ].sort()
        };


        const typesParOutil = {
            "Midjourney": [
                {"type": "Basic", "description": "Accès limité aux générations, usage individuel", "cout_mois": 10, "cout_annee": 96, "url": "https://www.midjourney.com/account"},
                {"type": "Standard", "description": "Usage modéré pour un utilisateur", "cout_mois": 30, "cout_annee": 288, "url": "https://www.midjourney.com/account"},
                {"type": "Pro", "description": "Usage illimité, 1 utilisateur", "cout_mois": 60, "cout_annee": 576, "url": "https://www.midjourney.com/account"}
            ],
            "ChatGPT": [
                {"type": "Free", "description": "Accès limité à GPT-3.5, usage individuel", "cout_mois": 0, "cout_annee": 0, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Plus", "description": "Accès GPT-4 pour 1 utilisateur", "cout_mois": 20, "cout_annee": 192, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Teams", "description": "Collaboration pour 3 à 10 utilisateurs", "cout_mois": 150, "cout_annee": 1440, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Enterprise", "description": "Solution entreprise pour +100 utilisateurs", "cout_mois": 300, "cout_annee": 2880, "url": "https://openai.com/chatgpt/pricing/"}
            ],
            "Runway": [
                {"type": "Standard", "description": "Fonctionnalités de base, 1 utilisateur", "cout_mois": 15, "cout_annee": 144, "url": "https://runwayml.com/"},
                {"type": "Pro", "description": "Fonctionnalités avancées pour 1-3 utilisateurs", "cout_mois": 35, "cout_annee": 336, "url": "https://runwayml.com/"},
                {"type": "Unlimited", "description": "Utilisation illimitée, jusqu'à 5 utilisateurs", "cout_mois": 912/12, "cout_annee": 912, "url": "https://runwayml.com/"}
            ],
            "Netlify": [
                {"type": "Free", "description": "Pour développeurs individuels", "cout_mois": 0, "cout_annee": 0, "url": "https://www.netlify.com/"},
                {"type": "Pro", "description": "Projets avancés, 1 utilisateur", "cout_mois": 19, "cout_annee": 182, "url": "https://www.netlify.com/"},
                {"type": "Business", "description": "Collaboration pour équipes de 5 à 10", "cout_mois": 99, "cout_annee": 950, "url": "https://www.netlify.com/"},
                {"type": "Enterprise", "description": "Grandes organisations (+25 utilisateurs)", "cout_mois": 300, "cout_annee": 2880, "url": "https://www.netlify.com/"}
            ],
            "VEO3": [
                {"type": "Crédits gratuits", "description": "Crédits de base gratuits", "cout_mois": 0, "cout_annee": 0, "url": "https://www.veo3.com/"},
                {"type": "Basic", "description": "Plan personnel standard", "cout_mois": 19.99, "cout_annee": 219.90, "url": "https://www.veo3.com/"},
                {"type": "Standard", "description": "Plan avancé, plus de crédits", "cout_mois": 49.99, "cout_annee": 549.90, "url": "https://www.veo3.com/"},
                {"type": "Enterprise", "description": "Solution entreprise, personnalisée", "cout_mois": 71.99, "cout_annee": 863.90, "url": "https://www.veo3.com/"}
            ],
            "Gemini": [
                {"type": "Version gratuite", "description": "Accès de base à Gemini", "cout_mois": 0, "cout_annee": 0, "url": "https://gemini.google.com/"},
                {"type": "AI Pro", "description": "Pour utilisateurs personnels et petites entreprises", "cout_mois": 19.99, "cout_annee": 192, "url": "https://gemini.google.com/advanced"},
                {"type": "AI Ultra", "description": "Accès premium complet", "cout_mois": 249.99, "cout_annee": 2749.90, "url": "https://gemini.google.com/ultra"},
                {"type": "Cloud Code Assist Std", "description": "Assistance code dans le cloud", "cout_mois": 22.80, "cout_annee": 19, "url": "https://cloud.google.com/code-assist"}
            ],
            "Kling AI": [
                {"type": "Crédits gratuits", "description": "Crédits de base pour démarrer", "cout_mois": 0, "cout_annee": 0, "url": "https://kling.ai/"},
                {"type": "Pro", "description": "Accès Pro avec plus de fonctionnalités", "cout_mois": 10, "cout_annee": Math.round(10 * 12 * 0.66), "url": "https://kling.ai/pro"},
                {"type": "Avancé", "description": "Plan avancé avec support prioritaire", "cout_mois": 25, "cout_annee": Math.round(25 * 12 * 0.66), "url": "https://kling.ai/advanced"}
            ],
            "ElevenLabs": [
                {"type": "Gratuit", "description": "10k crédits, usage limité", "cout_mois": 0, "cout_annee": 0, "url": "https://elevenlabs.io/"},
                {"type": "Starter", "description": "Voix TTS, usage commercial", "cout_mois": 5, "cout_annee": 5 * 12, "url": "https://elevenlabs.io/pricing"},
                {"type": "Creator", "description": "Plus de crédits, fonctionnalités avancées", "cout_mois": 100, "cout_annee": 100 * 12, "url": "https://elevenlabs.io/pricing"}
            ]
        };

        const LOCAL_STORAGE_KEY = 'licencesListCharlotte';
        let licencesData = [];

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            void toast.offsetWidth;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        }

        const formatDate = (date) => {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        };

        function updateRenewalDate(dateAchatStr, periodeCout) {
            const dateRenouvellementInput = document.getElementById('dateRenouvellement');
            if (!dateRenouvellementInput) return;

            dateRenouvellementInput.value = '';

            if (!dateAchatStr) {
                dateRenouvellementInput.value = "Date d'achat requise";
                return;
            }

            const dateAchat = new Date(dateAchatStr);
            if (isNaN(dateAchat.getTime())) {
                dateRenouvellementInput.value = "Date d'achat invalide";
                return;
            }

            let renewalDate = new Date(dateAchat);

            if (periodeCout === 'mois') {
                renewalDate.setMonth(renewalDate.getMonth() + 1);
                const currentYear = new Date().getFullYear();
                const nextMonthYear = renewalDate.getFullYear();
                const yearText = (nextMonthYear === currentYear) ? '' : ` (${nextMonthYear})`;
                dateRenouvellementInput.value = `Le mois prochain, le ${renewalDate.getDate()} ${formatDate(renewalDate).split(' ')[1]}${yearText}`;
            } else if (periodeCout === 'annee') {
                renewalDate.setFullYear(renewalDate.getFullYear() + 1);
                dateRenouvellementInput.value = `L'année prochaine, le ${formatDate(renewalDate)}`;
            }
        }

        function updateCostInput(selectedOption, periodeCout) {
            const costInput = document.getElementById('cout');
            if (!costInput) return;

            let costInUsd = 0;
            if (selectedOption && selectedOption.hasAttribute('data-cout-mois')) {
                if (periodeCout === 'mois') {
                    costInUsd = parseFloat(selectedOption.getAttribute('data-cout-mois'));
                } else if (periodeCout === 'annee') {
                    costInUsd = parseFloat(selectedOption.getAttribute('data-cout-annee'));
                }
            }
            costInput.value = (costInUsd * TAUX_DE_CONVERSION_USD_EUR).toFixed(2).replace('.', ',');

            const coutValue = parseFloat(costInput.value.replace(',', '.'));
            if (isNaN(coutValue) || coutValue <= 0) {
                costInput.classList.add('cout-input-rouge');
            } else {
                costInput.classList.remove('cout-input-rouge');
            }
        }

        function updateCollaborators(pole) {
            const collaborateurSelect = document.getElementById('collaborateur');
            if (!collaborateurSelect) return;

            collaborateurSelect.innerHTML = '<option value="">-- Sélectionner --</option>';

            if (pole && collaborateursParPole[pole]) {
                collaborateursParPole[pole].sort().forEach(collab => {
                    const option = document.createElement('option');
                    option.value = collab;
                    option.textContent = collab;
                    collaborateurSelect.appendChild(option);
                });
            }
            checkFormValidity();
        }

        function updateTypes(licence) {
            const typeSelect = document.getElementById('type');
            const descBox = document.getElementById('description');
            const costInput = document.getElementById('cout');
            const periodeCoutSelect = document.getElementById('periodeCout');
            const dateAchatInput = document.getElementById('dateAchat');

            if (!typeSelect || !descBox || !costInput || !periodeCoutSelect || !dateAchatInput) return;

            typeSelect.innerHTML = '';
            descBox.value = '';
            costInput.value = '';
            periodeCoutSelect.value = '';

            if (typesParOutil[licence]) {
                typesParOutil[licence].forEach(obj => {
                    const option = document.createElement('option');
                    option.value = obj.type;
                    option.textContent = obj.type;
                    option.setAttribute('data-description', obj.description);
                    option.setAttribute('data-cout-mois', obj.cout_mois);
                    option.setAttribute('data-cout-annee', obj.cout_annee);
                    if (obj.url) {
                        option.setAttribute('data-url', obj.url);
                    }
                    typeSelect.appendChild(option);
                });
                const first = typeSelect.options[0];
                if (first) {
                    typeSelect.value = first.value;
                    descBox.value = first.getAttribute('data-description');
                }
            }
            updateRenewalDate(dateAchatInput.value, periodeCoutSelect.value);
            checkFormValidity();
        }

        function loadLicences() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                licencesData = JSON.parse(storedData);
                renderLicencesTable();
            }
        }

        function saveLicences() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(licencesData));
        }

        function renderLicencesTable() {
            const tableBody = document.querySelector('#listeLicences tbody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            licencesData.forEach((licence, index) => {
                const newRow = tableBody.insertRow();
                newRow.insertCell().textContent = licence.pole;
                newRow.insertCell().textContent = licence.collaborateur;

                const licenceCell = newRow.insertCell();
                const licenceLink = document.createElement('a');
                licenceLink.href = licence.url || '#';
                licenceLink.textContent = licence.licence;
                licenceLink.target = '_blank';
                licenceLink.classList.add('table-link');
                licenceCell.appendChild(licenceLink);

                newRow.insertCell().textContent = licence.type;

                const coutCell = newRow.insertCell();
                coutCell.innerHTML = `<span class="cout-rouge-gras">${parseFloat(licence.cout).toFixed(2).replace('.', ',')} EUR</span>`;

                newRow.insertCell().textContent = licence.periodeCout === 'mois' ? 'Par mois' : 'Par année';
                newRow.insertCell().textContent = licence.dateAchat;
                newRow.insertCell().textContent = licence.dateRenouvellementAffichee;

                const actionCell = newRow.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '🗑️'; // Icône de poubelle
                deleteButton.title = 'Supprimer';
                deleteButton.classList.add('btn-supprimer'); // Utilisation de la nouvelle classe CSS
                deleteButton.addEventListener('click', function() {
                    if (confirm("Êtes-vous sûr de vouloir supprimer cette licence ?")) {
                        deleteLicence(index);
                        showToast('Licence supprimée avec succès !', 'success');
                    }
                });
                actionCell.appendChild(deleteButton);
            });
            calculateTotal();
            filterTableByPole();
        }

        function deleteLicence(index) {
            licencesData.splice(index, 1);
            saveLicences();
            renderLicencesTable();
            checkFormValidity();
        }

        function calculateTotal() {
            const totalAchatsElement = document.getElementById('totalAchats');
            const poleTotalsList = document.getElementById('poleTotalsList');
            if (!totalAchatsElement || !poleTotalsList) return;

            let totalGlobalCostEUR = 0;
            let totauxParPole = {};

            licencesData.forEach(licence => {
                let cost = parseFloat(licence.cout);
                let annualCost = (licence.periodeCout === 'mois') ? cost * 12 : cost;

                totalGlobalCostEUR += annualCost;

                if (!totauxParPole[licence.pole]) {
                    totauxParPole[licence.pole] = 0;
                }
                totauxParPole[licence.pole] += annualCost;
            });

            totalAchatsElement.textContent = `${totalGlobalCostEUR.toFixed(2).replace('.', ',')} EUR`;

            poleTotalsList.innerHTML = '';
            const sortedPoles = Object.keys(totauxParPole).sort();
            sortedPoles.forEach(pole => {
                const listItem = document.createElement('li');
                listItem.textContent = `${pole}: `;
                const span = document.createElement('strong');
                span.textContent = `${totauxParPole[pole].toFixed(2).replace('.', ',')} EUR`;
                listItem.appendChild(span);
                poleTotalsList.appendChild(listItem);
            });
        }

        function checkFormValidity() {
            const pole = document.getElementById('pole');
            const collaborateur = document.getElementById('collaborateur');
            const licence = document.getElementById('licence');
            const type = document.getElementById('type');
            const cout = document.getElementById('cout');
            const periodeCout = document.getElementById('periodeCout');
            const dateAchat = document.getElementById('dateAchat');
            const addButton = document.getElementById('addButton');
            const subscribeButton = document.getElementById('subscribeButton');

            if (!pole || !collaborateur || !licence || !type || !cout || !periodeCout || !dateAchat || !addButton || !subscribeButton) {
                console.warn("Certains éléments du formulaire sont manquants pour la vérification de validité.");
                return;
            }

            const coutValue = cout.value.replace(',', '.');
            const isCoutValid = !isNaN(parseFloat(coutValue)) && parseFloat(coutValue) > 0;

            const isPoleSelected = pole.value !== "" && !pole.options[pole.selectedIndex].textContent.startsWith('-- Sélectionner');
            const isCollaborateurSelected = collaborateur.value !== "" && !collaborateur.options[collaborateur.selectedIndex].textContent.startsWith('-- Sélectionner');
            const isLicenceSelected = licence.value !== "" && !licence.options[licence.selectedIndex].textContent.startsWith('-- Sélectionner');
            const isTypeSelected = type.options.length > 0 && type.value !== "" && !type.options[type.selectedIndex].textContent.startsWith('-- Sélectionner');
            const isPeriodeCoutSelected = periodeCout.value !== "" && !periodeCout.options[periodeCout.selectedIndex].textContent.startsWith('-- Sélectionner');
            const isDateAchatValid = !!dateAchat.value;

            const isFormCompletelyValid = isPoleSelected && isCollaborateurSelected && isLicenceSelected && isTypeSelected && isCoutValid && isPeriodeCoutSelected && isDateAchatValid;

            if (isFormCompletelyValid) {
                addButton.disabled = false;
                subscribeButton.style.display = 'inline-block';
            } else {
                addButton.disabled = true;
                subscribeButton.style.display = 'none';
            }
        }

        function goToSubscriptionPage() {
            const licenceName = document.getElementById('licence').value;
            const typeName = document.getElementById('type').value;
            const collaborateurName = document.getElementById('collaborateur').value;
            const poleName = document.getElementById('pole').value;

            let toolUrl = '';
            const selectedLicenceData = typesParOutil[licenceName];
            if (selectedLicenceData) {
                const specificTypeData = selectedLicenceData.find(item => item.type === typeName);
                if (specificTypeData && specificTypeData.url) {
                    toolUrl = specificTypeData.url;
                } else if (selectedLicenceData[0] && selectedLicenceData[0].url) {
                    toolUrl = selectedLicenceData[0].url;
                }
            }
            if (!toolUrl) {
                toolUrl = 'https://example.com/souscription';
                console.warn(`URL non trouvée pour ${licenceName} - ${typeName}. Utilisation d'une URL générique.`);
            }

            const url = `${toolUrl}?type=${encodeURIComponent(typeName)}&collaborateur=${encodeURIComponent(collaborateurName)}&pole=${encodeURIComponent(poleName)}`;

            alert(`Redirection vers la page de souscription pour ${licenceName} (${typeName}) pour ${collaborateurName} du pôle ${poleName}...\nURL simulée: ${url}`);
            window.open(url, '_blank');
        }

        function telecharger() {
            const headers = ['Pôle', 'Collaborateur', 'Licence', 'Type', 'Coût', 'Période', 'Date d\'achat', 'Date de renouvellement'];
            const data = licencesData.map(licence => [
                licence.pole,
                licence.collaborateur,
                licence.licence,
                licence.type,
                `${parseFloat(licence.cout).toFixed(2).replace('.', ',')} EUR`,
                licence.periodeCout === 'mois' ? 'Par mois' : 'Par année',
                licence.dateAchat,
                licence.dateRenouvellementAffichee
            ]);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'A4');

            doc.setFontSize(18);
            doc.text("Liste des Licences IA - Charlotte DELWARTE", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, 14, 30);


            doc.autoTable({
                startY: 40,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [0, 119, 182] },
                styles: {
                    font: 'helvetica',
                    fontSize: 9,
                    cellPadding: 3,
                    valign: 'middle',
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 20, halign: 'right' },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 30 },
                    8: { cellWidth: 15 }
                },
                didParseCell: function(data) {
                    if (data.column.index === 4 && data.cell.section === 'body') {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [220, 53, 69];
                    }
                }
            });

            doc.save('liste_licences_ia.pdf');
            console.log('PDF généré et téléchargé.');
        }

        function filterTableByPole() {
            const filterValue = document.getElementById('tablePoleFilter').value;
            const tableRows = document.querySelectorAll('#listeLicences tbody tr');

            tableRows.forEach(row => {
                const poleCell = row.cells[0];
                if (filterValue === 'all' || poleCell.textContent === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM entièrement chargé. Début de l'initialisation des écouteurs d'événements...");

            const poleSelect = document.getElementById('pole');
            const collaborateurSelect = document.getElementById('collaborateur');
            const licenceSelect = document.getElementById('licence');
            const typeSelect = document.getElementById('type');
            const periodeCoutSelect = document.getElementById('periodeCout');
            const dateAchatInput = document.getElementById('dateAchat');
            const coutInput = document.getElementById('cout');
            const licenseForm = document.getElementById('licenseForm');
            const downloadButton = document.getElementById('downloadButton');
            const subscribeButton = document.getElementById('subscribeButton');
            const addButton = document.getElementById('addButton');
            const tablePoleFilter = document.getElementById('tablePoleFilter');

            // Simuler l'affichage de la page après chargement (si vous n'avez pas de header.html)
            // Si vous utilisez un header.html et un JS pour charger le main, supprimez ceci.
            document.body.style.opacity = "1";
            const mainElement = document.querySelector("main");
            if (mainElement) {
                mainElement.style.display = "block";
            }
            // Fin de simulation

            if (addButton) {
                addButton.disabled = true;
            } else {
                console.error('Erreur: Élément #addButton non trouvé!');
            }

            if (poleSelect) {
                poleSelect.addEventListener('change', function() {
                    console.log('Événement: Pôle changed');
                    updateCollaborators(this.value);
                    checkFormValidity();
                });
                console.log('Écouteur pôle attaché.');
            } else { console.error('Erreur: Élément #pole non trouvé!'); }

            if (collaborateurSelect) {
                collaborateurSelect.addEventListener('change', function() {
                    console.log('Événement: Collaborateur changed');
                    checkFormValidity();
                });
                console.log('Écouteur collaborateur attaché.');
            } else { console.error('Erreur: Élément #collaborateur non trouvé!'); }

            if (licenceSelect) {
                licenceSelect.addEventListener('change', function() {
                    console.log('Événement: Licence changed');
                    updateTypes(this.value);
                });
                console.log('Écouteur licence attaché.');
            } else { console.error('Erreur: Élément #licence non trouvé!'); }

            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    console.log('Événement: Type changed');
                    const selected = this.selectedOptions[0];
                    const periodeCout = periodeCoutSelect.value;
                    if (selected) {
                        document.getElementById('description').value = selected.getAttribute('data-description');
                        updateCostInput(selected, periodeCout);
                    }
                    updateRenewalDate(dateAchatInput.value, periodeCout);
                    checkFormValidity();
                });
                console.log('Écouteur type attaché.');
            } else { console.error('Erreur: Élément #type non trouvé!'); }

            if (periodeCoutSelect) {
                periodeCoutSelect.addEventListener('change', function() {
                    console.log('Événement: PeriodeCout changed');
                    const selectedTypeOption = typeSelect.options.length > 0 ? typeSelect.selectedOptions[0] : null;
                    const currentPeriod = this.value;
                    updateCostInput(selectedTypeOption, currentPeriod);
                    updateRenewalDate(dateAchatInput.value, currentPeriod);
                    checkFormValidity();
                });
                console.log('Écouteur periodeCout attaché.');
            } else { console.error('Erreur: Élément #periodeCout non trouvé!'); }

            if (dateAchatInput) {
                dateAchatInput.addEventListener('change', function() {
                    console.log('Événement: DateAchat changed');
                    const periodeCout = periodeCoutSelect.value;
                    updateRenewalDate(this.value, periodeCout);
                    checkFormValidity();
                });
                console.log('Écouteur dateAchat attaché.');
            } else { console.error('Erreur: Élément #dateAchat non trouvé!'); }

            if (coutInput) {
                coutInput.addEventListener('input', function() {
                    console.log('Événement: Cout input');
                    checkFormValidity();
                    const coutValue = parseFloat(this.value.replace(',', '.'));
                    if (isNaN(coutValue) || coutValue <= 0) {
                        this.classList.add('cout-input-rouge');
                    } else {
                        this.classList.remove('cout-input-rouge');
                    }
                });
                coutInput.addEventListener('change', function() {
                    console.log('Événement: Cout changed');
                    const coutValue = parseFloat(this.value.replace(',', '.'));
                    if (isNaN(coutValue) || coutValue <= 0) {
                        this.classList.add('cout-input-rouge');
                    } else {
                        this.classList.remove('cout-input-rouge');
                    }
                });
                console.log('Écouteur cout (input/change) attaché.');
            } else { console.error('Erreur: Élément #cout non trouvé!'); }


            if (licenseForm) {
                licenseForm.addEventListener('submit', function(event) {
                    console.log('Événement: Form submitted (Ajouter button clicked)');
                    event.preventDefault();

                    const pole = document.getElementById('pole').value;
                    const collaborateur = document.getElementById('collaborateur').value;
                    const licence = document.getElementById('licence').value;
                    const type = document.getElementById('type').value;
                    let coutValue = document.getElementById('cout').value.replace(',', '.');
                    const cout = parseFloat(coutValue);
                    const periodeCout = document.getElementById('periodeCout').value;
                    const dateAchat = document.getElementById('dateAchat').value;
                    const dateRenouvellementAffichee = document.getElementById('dateRenouvellement').value;

                    console.log('--- Vérification des valeurs du formulaire pour Ajout ---');
                    console.log('  Pôle:', pole, ' (Valid:', !!pole, ')');
                    console.log('  Collaborateur:', collaborateur, ' (Valid:', !!collaborateur, ')');
                    console.log('  Licence:', licence, ' (Valid:', !!licence, ')');
                    console.log('  Type:', type, ' (Valid:', !!type, ')');
                    console.log('  Coût (parsed):', cout, ' (Valid: ', !isNaN(cout) && cout > 0, ')');
                    console.log('  Période Coût:', periodeCout, ' (Valid:', !!periodeCout, ')');
                    console.log('  Date Achat:', dateAchat, ' (Valid:', !!dateAchat, ')');
                    console.log('  Date Renouvellement Affichee:', dateRenouvellementAffichee);
                    console.log('----------------------------------------------------');

                    const isPoleSelected = pole !== "" && !document.getElementById('pole').options[document.getElementById('pole').selectedIndex].textContent.startsWith('-- Sélectionner');
                    const isCollaborateurSelected = collaborateur !== "" && !document.getElementById('collaborateur').options[document.getElementById('collaborateur').selectedIndex].textContent.startsWith('-- Sélectionner');
                    const isLicenceSelected = licence !== "" && !document.getElementById('licence').options[document.getElementById('licence').selectedIndex].textContent.startsWith('-- Sélectionner');
                    const isTypeSelected = type !== "" && document.getElementById('type').options.length > 0 && !document.getElementById('type').options[document.getElementById('type').selectedIndex].textContent.startsWith('-- Sélectionner');
                    const isPeriodeCoutSelected = periodeCout !== "" && !document.getElementById('periodeCout').options[document.getElementById('periodeCout').selectedIndex].textContent.startsWith('-- Sélectionner');
                    const isCoutValid = !isNaN(cout) && cout > 0;
                    const isDateAchatValid = !!dateAchat;

                    const isValid = isPoleSelected && isCollaborateurSelected && isLicenceSelected && isTypeSelected && isCoutValid && isPeriodeCoutSelected && isDateAchatValid;

                    if (isValid) {
                        console.log('Condition de validité remplie. Ajout de la licence...');
                        const newLicence = {
                            pole,
                            collaborateur,
                            licence,
                            type,
                            cout,
                            periodeCout,
                            dateAchat,
                            dateRenouvellementAffichee,
                            url: typesParOutil[licence]?.find(item => item.type === type)?.url || typesParOutil[licence]?.[0]?.url || '#'
                        };

                        licencesData.push(newLicence);
                        saveLicences();
                        renderLicencesTable();
                        showToast('Licence ajoutée avec succès !', 'success');

                        document.getElementById('pole').value = '';
                        document.getElementById('collaborateur').value = '';
                        document.getElementById('licence').value = '';
                        document.getElementById('type').innerHTML = '';
                        document.getElementById('description').value = '';
                        document.getElementById('cout').value = '';
                        document.getElementById('periodeCout').value = '';
                        document.getElementById('dateAchat').value = '';
                        document.getElementById('dateRenouvellement').value = '';
                        updateTypes('');
                        updateCollaborators('');
                    } else {
                        console.warn('Condition de validité NON remplie. Affichage de l\'alerte.');
                        showToast("Veuillez remplir tous les champs obligatoires (Pôle, Collaborateur, Licence, Type, Coût, Période du coût, Date d'achat). Assurez-vous que le coût est un nombre valide et non négatif.", 'error');
                    }
                    checkFormValidity();
                });
                console.log('Écouteur formulaire submit (Ajouter) attaché.');
            } else { console.error('Erreur: Élément #licenseForm non trouvé!'); }

            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                    console.log('Événement: Télécharger la liste button clicked');
                    telecharger();
                });
                console.log('Écouteur downloadButton attaché.');
            } else { console.error('Erreur: Élément #downloadButton non trouvé!'); }

            if (subscribeButton) {
                subscribeButton.addEventListener('click', function() {
                    console.log('Événement: Souscrire à la Licence button clicked');
                    goToSubscriptionPage();
                });
                console.log('Écouteur subscribeButton attaché.');
            } else { console.error('Erreur: Élément #subscribeButton non trouvé!'); }

            loadLicences();
            updateCollaborators(poleSelect.value || '');
            if (licenceSelect) {
                updateTypes(licenceSelect.value || '');
            }
            checkFormValidity();

            if (tablePoleFilter) {
                tablePoleFilter.addEventListener('change', filterTableByPole);
                console.log('Écouteur tablePoleFilter attaché.');
            } else { console.error('Erreur: Élément #tablePoleFilter non trouvé!'); }

            const availablePoles = Object.keys(collaborateursParPole).sort();
            tablePoleFilter.innerHTML = '<option value="all">Tout</option>';
            availablePoles.forEach(pole => {
                const option = document.createElement('option');
                option.value = pole;
                option.textContent = pole;
                tablePoleFilter.appendChild(option);
            });
            filterTableByPole();
        });
    </script>
</body>
</html>
