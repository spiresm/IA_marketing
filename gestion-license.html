<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestion des Licences IA</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <link rel="preload" href="header.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="footer.html" as="fetch" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Variables CSS unifi√©es pour l'ensemble du site --- */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --grey-text: #555;
            --border-color: #ddd;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Plus douce, comme dans la FAQ */
            --light-border: #e0e0e0; /* Bordures claires pour les cartes/d√©tails */
        }

        /* --- Styles G√©n√©raux du Corps --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-grey);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- Conteneur Principal --- */
        main {
            padding: 40px 20px;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
        }
        .main-container {
            max-width: 960px;
            margin: 25px auto;
            padding: 25px;
            box-sizing: border-box;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        /* --- Styles Sp√©cifiques √† la page Licences --- */
        h1 {
            text-align: center;
            color: var(--dark-blue);
            font-size: 2rem;
            margin-bottom: 30px;
            margin-top: 0;
        }
        .titre-description {
            text-align: center;
            color: var(--grey-text);
            font-size: 0.9em;
            margin-bottom: 25px;
            display: block;
        }
        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        label {
            font-weight: 600;
            color: var(--grey-text);
            display: block;
            margin-bottom: 6px;
        }
        select, input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f9fafb;
            box-sizing: border-box;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        select.highlight-field {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M283.5%2C197.8L146.7%2C59.9c-4-4.2-10.4-4.2-14.4%2C0L0.5%2C197.8c-4%2C4.2-4%2C11.1%2C0%2C15.3l14.4%2C14.8c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0L146.7%2C98.4c4-4.2%2C10.4-4.2%2C14.4%2C0l117.2%2C129.5c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0l14.4-14.8c4-4.2%2C4-11.1%2C0-15.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
        }
        select:focus, input:focus {
            border-color: var(--primary-blue) !important;
            box-shadow: 0 0 5px rgba(0, 119, 182, 0.5) !important;
            outline: none;
        }

        .full {
            grid-column: span 2;
            position: relative;
            z-index: 10;
        }
        button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: var(--dark-blue);
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }
        #subscribeButton {
            background-color: #4CAF50; /* Bouton de souscription vert */
            margin-left: 10px;
        }
        #subscribeButton:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        tr:hover {
            background-color: #eef2f5;
        }
        #totalAchatsContainer {
            grid-column: span 2;
            text-align: right;
            margin-top: 25px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--primary-blue);
            border-radius: 14px;
            box-shadow: var(--card-shadow);
            color: white;
        }
        #totalAchats {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffffff;
            margin-top: 5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #totalAchatsLabel {
            font-size: 0.9em;
            color: #e0e0e0;
            display: block;
        }
        #poleTotalsList {
            font-size: 0.9em;
            color: #e0e0e0;
            margin-top: 15px;
            list-style: none;
            padding: 0;
            text-align: right;
        }
        #poleTotalsList li {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        #poleTotalsList strong {
            color: #ffffff;
        }

        .cout-rouge-gras {
            font-weight: bold;
            color: #dc3545; /* Rouge pour le co√ªt n√©gatif ou nul */
        }
        input[type="text"].cout-input-rouge {
            font-weight: bold !important;
            color: #dc3545 !important;
            border-color: #dc3545 !important;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5) !important;
        }
        .highlight-field {
            border-color: var(--primary-blue) !important;
            box-shadow: 0 0 5px rgba(0, 119, 182, 0.5) !important;
        }
        .table-link {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: normal; /* Chang√© de bold pour un lien standard */
        }
        .table-link:hover {
            text-decoration: underline;
        }
        
        /* --- Footer --- */
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            width: 100%;
        }

        /* --- Style pour le filtre du tableau --- */
        .table-filter-container {
            margin-bottom: 15px;
            text-align: right;
            padding-right: 10px;
        }
        .table-filter-container label {
            display: inline-block;
            margin-right: 10px;
            font-weight: 600;
            color: #444;
        }
        .table-filter-container select {
            width: auto;
            min-width: 180px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #f9fafb;
            font-size: 1em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M283.5%2C197.8L146.7%2C59.9c-4-4.2-10.4-4.2-14.4%2C0L0.5%2C197.8c-4%2C4.2-4%2C11.1%2C0%2C15.3l14.4%2C14.8c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0L146.7%2C98.4c4-4.2%2C10.4-4.2%2C14.4%2C0l117.2%2C129.5c4%2C4.2%2C10.4%2C4.2%2C14.4%2C0l14.4-14.8c4-4.2%2C4-11.1%2C0-15.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
        }

        /* --- Styles pour les messages Toast --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }
        .toast-message {
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 250px;
            text-align: center;
            font-weight: bold;
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-message.success {
            background-color: rgba(40, 167, 69, 0.9);
        }
        .toast-message.error {
            background-color: rgba(220, 53, 69, 0.9);
        }
        /* Style pour le bouton supprimer dans le tableau (ic√¥ne) */
        .btn-supprimer {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 4px;
            color: #dc3545;
            transition: transform 0.2s ease;
        }
        .btn-supprimer:hover {
            transform: scale(1.2);
        }

        /* --- Media Queries pour la responsivit√© --- */
        @media (max-width: 1024px) {
            .header-buttons-container { font-size: 0.75em; padding: 4px 8px; }
            nav a { font-size: 0.95em; padding: 7px 10px; margin: 5px 8px; }
        }

        @media (max-width: 768px) {
            .header-buttons-container {
                top: 5px;
                right: 5px;
                flex-direction: column;
                gap: 2px;
            }
            .dev-button-header { font-size: 0.7em; padding: 3px 6px; }
            nav { padding: 5px; }
            nav a { font-size: 0.85em; padding: 5px 7px; margin: 3px 5px; }
            form { grid-template-columns: 1fr; gap: 15px; }
            .full { grid-column: span 1; }
            .main-container { padding: 20px; margin: 20px auto; }
            .table-filter-container { text-align: left; padding: 0; }
            .table-filter-container select { width: 100%; min-width: unset; }
            
            /* Responsive Table */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-blue);
            }
            td:nth-of-type(1):before { content: "P√¥le:"; }
            td:nth-of-type(2):before { content: "Collaborateur:"; }
            td:nth-of-type(3):before { content: "Licence:"; }
            td:nth-of-type(4):before { content: "Type:"; }
            td:nth-of-type(5):before { content: "Co√ªt:"; }
            td:nth-of-type(6):before { content: "P√©riode:"; }
            td:nth-of-type(7):before { content: "Date d'achat:"; }
            td:nth-of-type(8):before { content: "Date de renouvellement:"; }
            td:nth-of-type(9):before { content: "Action:"; }

            td:last-child { border-bottom: 0; }
            .cout-rouge-gras { font-size: 1.1em; }
            #totalAchatsContainer { text-align: center; }
            #poleTotalsList { text-align: center; }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p>Chargement des donn√©es...</p>
    </div>

    <div id="header-placeholder"></div>

    <main>
        <div class="main-container">
            <h1>Outil de Gestion des Licences IA</h1>
            <span class="titre-description">G√©rez et suivez facilement les licences de vos outils IA.</span>

            <form id="licenseForm">
                <div class="full">
                    <label for="pole">P√¥le :</label>
                    <select id="pole" required="">
                        <option value="">-- S√©lectionner un p√¥le --</option>
                        </select>
                </div>

                <div>
                    <label for="collaborateur">Collaborateur :</label>
                    <select id="collaborateur" required="">
                        <option value="">-- S√©lectionner --</option>
                        </select>
                </div>
                <div>
                    <label for="licence">Licence :</label>
                    <select id="licence" required="">
                        <option value="">-- S√©lectionner --</option>
                        </select>
                </div>
                <div class="full">
                    <label for="description">Description :</label>
                    <input id="description" readonly="readonly" type="text"/>
                </div>
                <div>
                    <label for="type">Type de licence :</label>
                    <select id="type" required=""></select>
                </div>
                <div>
                    <label for="cout">Co√ªt (EUR) :</label>
                    <input id="cout" required="" type="text" placeholder="Ex: 20,50"/>
                </div>
                <div>
                    <label for="periodeCout">P√©riode du co√ªt :</label>
                    <select id="periodeCout" required="">
                        <option value="">-- S√©lectionner --</option>
                        <option value="mois">Par mois</option>
                        <option value="annee">Par ann√©e</option>
                    </select>
                </div>
                <div>
                    <label for="dateAchat">Date d'achat :</label>
                    <input id="dateAchat" required="" type="date"/>
                </div>
                <div>
                    <label for="dateRenouvellement">Date de renouvellement :</label>
                    <input id="dateRenouvellement" type="text" readonly="readonly"/>
                </div>

                <div class="full">
                    <button type="submit" id="addButton" disabled>Ajouter</button>
                    <button type="button" id="downloadButton">T√©l√©charger la liste (PDF)</button>
                    <button id="subscribeButton" type="button" style="display: none;">Souscrire √† la Licence</button>
                </div>

                <div id="totalAchatsContainer">
                    <span id="totalAchatsLabel">Co√ªt Annuel Estim√© des Licences :</span>
                    <div id="totalAchats">0,00 EUR</div>
                    <ul id="poleTotalsList"></ul>
                </div>
            </form>

            <div class="table-filter-container">
                <label for="tablePoleFilter">Filtrer par P√¥le :</label>
                <select id="tablePoleFilter">
                    <option value="all">Tout</option>
                    </select>
            </div>

            <table id="listeLicences">
                <thead>
                    <tr>
                        <th>P√¥le</th>
                        <th>Collaborateur</th>
                        <th>Licence</th>
                        <th>Type</th>
                        <th>Co√ªt</th>
                        <th>P√©riode</th>
                        <th>Date d'achat</th>
                        <th>Date de renouvellement</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <div id="toast-container"></div>

    <div id="footer-placeholder"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Fonction utilitaire pour charger les composants externes (header/footer)
        async function loadComponent(url, placeholderId) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    console.error(`Could not load ${url}, status: ${res.status}`);
                    document.getElementById(placeholderId).innerHTML = `<p style="color:red; text-align:center;">Erreur chargement: ${url}</p>`;
                    return;
                }
                document.getElementById(placeholderId).innerHTML = await res.text();
                // console.log(`Component ${url} loaded successfully into #${placeholderId}.`);
            } catch (error) {
                console.error(`Error loading ${url}:`, error);
                document.getElementById(placeholderId).innerHTML = `<p style="color:red; text-align:center;">Error loading: ${url}</p>`;
            }
        }

        // Nouvelle fonction pour initialiser le dropdown, appel√©e APR√àS l'injection du header
        function initializeHeaderDropdown() {
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');

            if (toolsResourcesBtn && toolsResourcesContent) {
                toolsResourcesBtn.removeEventListener('click', handleDropdownClick); 
                window.removeEventListener('click', handleWindowClick);

                toolsResourcesBtn.addEventListener('click', handleDropdownClick);
                window.addEventListener('click', handleWindowClick);

                toolsResourcesContent.style.display = 'none';
                toolsResourcesBtn.setAttribute('aria-expanded', 'false');

            } else {
                console.warn("√âl√©ments du dropdown 'Outils & Ressources' non trouv√©s apr√®s injection. Le script ne peut pas initialiser le menu.");
            }
        }

        // Gestionnaire d'√©v√©nement pour le clic sur le bouton du dropdown
        function handleDropdownClick(event) {
            event.preventDefault(); 
            const toolsResourcesBtn = event.currentTarget; 
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');

            if (toolsResourcesContent.style.display === 'block') {
                toolsResourcesContent.style.display = 'none';
                toolsResourcesBtn.setAttribute('aria-expanded', 'false');
                toolsResourcesBtn.classList.remove('active');
            } else {
                toolsResourcesContent.style.display = 'block';
                toolsResourcesBtn.setAttribute('aria-expanded', 'true');
                toolsResourcesBtn.classList.add('active');
            }
        }

        // Gestionnaire d'√©v√©nement pour le clic sur la fen√™tre pour fermer le dropdown
        function handleWindowClick(event) {
            const toolsResourcesDropdown = document.getElementById('toolsResourcesDropdown'); 
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');

            if (toolsResourcesDropdown && !toolsResourcesDropdown.contains(event.target)) {
                if (toolsResourcesContent && toolsResourcesContent.style.display === 'block') {
                    toolsResourcesContent.style.display = 'none';
                    if (toolsResourcesBtn) { 
                        toolsResourcesBtn.setAttribute('aria-expanded', 'false');
                        toolsResourcesBtn.classList.remove('active');
                    }
                }
            }
        }

        // Fonction pour g√©rer la classe 'active' sur les liens de navigation (appel√©e apr√®s l'injection)
        function updateActiveNavLinks() {
            const currentPath = window.location.pathname.split('/').pop();

            document.querySelectorAll('#header-placeholder nav > a').forEach(link => { 
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : ''; 
                const currentFileName = currentPath.replace('.html', '');

                const isCurrentPage = (linkFileName === currentFileName) || 
                                      (linkFileName === '' && currentFileName === 'index');

                if (isCurrentPage) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            const toolsResourcesContent = document.getElementById('toolsResourcesContent');
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');
            const dropdownLinks = toolsResourcesContent ? toolsResourcesContent.querySelectorAll('a') : [];

            let dropdownHasActiveLink = false;
            dropdownLinks.forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : '';
                const currentFileName = currentPath.replace('.html', '');

                const isCurrentSubPage = (linkFileName === currentFileName);

                if (isCurrentSubPage) {
                    link.classList.add('active'); 
                    dropdownHasActiveLink = true;
                } else {
                    link.classList.remove('active');
                }
            });

            if (toolsResourcesBtn) {
                if (dropdownHasActiveLink) {
                    toolsResourcesBtn.classList.add('active');
                } else {
                    if (toolsResourcesContent && toolsResourcesContent.style.display !== 'block') {
                        toolsResourcesBtn.classList.remove('active');
                    }
                }
            }
        }

        // =========================================================================
        // DEBUT DU CODE SPECIFIQUE A GESTION-LICENSE.HTML
        // =========================================================================

        const TAUX_DE_CONVERSION_USD_EUR = 0.93;

        const collaborateursParPole = {
            "P√¥le cr√©a.": [
                "Anne-Fran√ßoise LELEUX", "Baptiste TARTAS", "B√©atrice MARLIER",
                "Boris TEIRLYNCK", "Charlotte DELWARTE", "C√©line DELENTREE", "Delphine BENROUBI",
                "Faiza BOUMEDIAN", "Genevi√®ve DE BEAUFFORT", "Giovanni CASCONE",
                "Gregory KEPPENS", "Isabelle MARCHAL", "Isabelle VERTUONGEN",
                "Jimmy DEGR√àVE", "Joel VAN HOEF", "Jonathan LACROIX",
                "Jose ROJO", "Jose-Luis PENAFUERTE", "Mehdi HUSAIN",
                "Michael EVRARD", "Patricia DAVIA", "Pierre LERMIER",
                "Pierre-Jean GILOUX", "Steeve PIRES MADEIRA",
                "Susana GONCALVES VALERIO",
                "Tyan HOOGSTOEL", "Vinciane LE MEN",
                "Sabrina LECLERCQ",
                "Nathalie AUBRY",
                "Jeremy DEHERTOGH",
                "Dominique LEFEVRE",
                "Virginie LONGE"
            ].sort(),

            "CRM": [
                "Fr√©d√©ric CARTON", "In√®s BERNOUX", "No√©mie ROSSEY",
                "Yasmine AIT MASKOUR", "Meltem SIVLIN", "Nadia CURTO", "Noemie GORISSEN",
                "Olivier LEIDGENS", "Pierre DUBOIS", "Romain DELECOUR", "Vincent CRABBE", "Vitold GRAND'HENRY"
            ].sort(),

            "Communication": [
                "Aurore CRABBE", "Elvis TCHANA", "Fabienne CULLUS",
                "Marie NAUWELAERTS", "R√©gine CARPENTIER"
            ].sort(),

            "Partenariats": [
                "Alinoe VANHAUDENHUYSE", "Catherine CARA", "Dominique CAFFIERS",
                "Fiona KOPEINIG", "Isabelle DELENS",
                "Laura DONATELLO", "Marie-Rose ANGE", "Na√Øm EL BOHALI",
                "Nathalie DE RIJCKE"
            ].sort(),

            "Marketing digital": [
                "Elise FONCK", "Ga√´lle DEGEYE",
                "Mathilde ARMILLAC", "Morgane CARLY", "Yasmine GHAZOUANE",
                "Sara GARCIA"
            ].sort(),

            "Positionnement": [
                "Amelie DE LANGE", "Philippe BLANJEAN",
                "Samuel LALOUX"
            ].sort(),

            "Staff": [
                "Meltem SIVLIN", "Nadia CURTO", "Vincent CRABBE",
                "Olivier LEIDGENS", "Pierre DUBOIS", "Vitold GRAND'HENRY",
                "Romain DELECOUR", "Noemie GORISSEN"
            ].sort()
        };


        const typesParOutil = {
            "Midjourney": [
                {"type": "Basic", "description": "Acc√®s limit√© aux g√©n√©rations, usage individuel", "cout_mois": 10, "cout_annee": 96, "url": "https://www.midjourney.com/account"},
                {"type": "Standard", "description": "Usage mod√©r√© pour un utilisateur", "cout_mois": 30, "cout_annee": 288, "url": "https://www.midjourney.com/account"},
                {"type": "Pro", "description": "Usage illimit√©, 1 utilisateur", "cout_mois": 60, "cout_annee": 576, "url": "https://www.midjourney.com/account"}
            ],
            "ChatGPT": [
                {"type": "Free", "description": "Acc√®s limit√© √† GPT-3.5, usage individuel", "cout_mois": 0, "cout_annee": 0, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Plus", "description": "Acc√®s GPT-4 pour 1 utilisateur", "cout_mois": 20, "cout_annee": 192, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Teams", "description": "Collaboration pour 3 √† 10 utilisateurs", "cout_mois": 150, "cout_annee": 1440, "url": "https://openai.com/chatgpt/pricing/"},
                {"type": "Enterprise", "description": "Solution entreprise pour +100 utilisateurs", "cout_mois": 300, "cout_annee": 2880, "url": "https://openai.com/chatgpt/pricing/"}
            ],
            "Runway": [
                {"type": "Standard", "description": "Fonctionnalit√©s de base, 1 utilisateur", "cout_mois": 15, "cout_annee": 144, "url": "https://runwayml.com/"},
                {"type": "Pro", "description": "Fonctionnalit√©s avanc√©es pour 1-3 utilisateurs", "cout_mois": 35, "cout_annee": 336, "url": "https://runwayml.com/"},
                {"type": "Unlimited", "description": "Utilisation illimit√©e, jusqu'√† 5 utilisateurs", "cout_mois": 912/12, "cout_annee": 912, "url": "https://runwayml.com/"}
            ],
            "Netlify": [
                {"type": "Free", "description": "Pour d√©veloppeurs individuels", "cout_mois": 0, "cout_annee": 0, "url": "https://www.netlify.com/"},
                {"type": "Pro", "description": "Projets avanc√©s, 1 utilisateur", "cout_mois": 19, "cout_annee": 182, "url": "https://www.netlify.com/"},
                {"type": "Business", "description": "Collaboration pour √©quipes de 5 √† 10", "cout_mois": 99, "cout_annee": 950, "url": "https://www.netlify.com/"},
                {"type": "Enterprise", "description": "Grandes organisations (+25 utilisateurs)", "cout_mois": 300, "cout_annee": 2880, "url": "https://www.netlify.com/"}
            ],
            "VEO3": [
                {"type": "Cr√©dits gratuits", "description": "Cr√©dits de base gratuits", "cout_mois": 0, "cout_annee": 0, "url": "https://www.veo3.com/"},
                {"type": "Basic", "description": "Plan personnel standard", "cout_mois": 19.99, "cout_annee": 219.90, "url": "https://www.veo3.com/"},
                {"type": "Standard", "description": "Plan avanc√©, plus de cr√©dits", "cout_mois": 49.99, "cout_annee": 549.90, "url": "https://www.veo3.com/"},
                {"type": "Enterprise", "description": "Solution entreprise, personnalis√©e", "cout_mois": 71.99, "cout_annee": 863.90, "url": "https://www.veo3.com/"}
            ],
            "Gemini": [
                {"type": "Version gratuite", "description": "Acc√®s de base √† Gemini", "cout_mois": 0, "cout_annee": 0, "url": "https://gemini.google.com/"},
                {"type": "AI Pro", "description": "Pour utilisateurs personnels et petites entreprises", "cout_mois": 19.99, "cout_annee": 192, "url": "https://gemini.google.com/advanced"},
                {"type": "AI Ultra", "description": "Acc√®s premium complet", "cout_mois": 249.99, "cout_annee": 2749.90, "url": "https://gemini.google.com/ultra"},
                {"type": "Cloud Code Assist Std", "description": "Assistance code dans le cloud", "cout_mois": 22.80, "cout_annee": 19, "url": "https://cloud.google.com/code-assist"}
            ],
            "Kling AI": [
                {"type": "Cr√©dits gratuits", "description": "Cr√©dits de base pour d√©marrer", "cout_mois": 0, "cout_annee": 0, "url": "https://kling.ai/"},
                {"type": "Pro", "description": "Acc√®s Pro avec plus de fonctionnalit√©s", "cout_mois": 10, "cout_annee": Math.round(10 * 12 * 0.66), "url": "https://kling.ai/pro"},
                {"type": "Avanc√©", "description": "Plan avanc√© avec support prioritaire", "cout_mois": 25, "cout_annee": Math.round(25 * 12 * 0.66), "url": "https://kling.ai/advanced"}
            ],
            "ElevenLabs": [
                {"type": "Gratuit", "description": "10k cr√©dits, usage limit√©", "cout_mois": 0, "cout_annee": 0, "url": "https://elevenlabs.io/"},
                {"type": "Starter", "description": "Voix TTS, usage commercial", "cout_mois": 5, "cout_annee": 5 * 12, "url": "https://elevenlabs.io/pricing"},
                {"type": "Creator", "description": "Plus de cr√©dits, fonctionnalit√©s avanc√©es", "cout_mois": 100, "cout_annee": 100 * 12, "url": "https://elevenlabs.io/pricing"}
            ]
        };

        const LOCAL_STORAGE_KEY = 'licencesListCharlotte';
        let licencesData = [];

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            void toast.offsetWidth; // Force reflow
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        }

        const formatDate = (date) => {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        };

        function updateRenewalDate(dateAchatStr, periodeCout) {
            const dateRenouvellementInput = document.getElementById('dateRenouvellement');
            if (!dateRenouvellementInput) return;

            dateRenouvellementInput.value = '';

            if (!dateAchatStr) {
                dateRenouvellementInput.value = "Date d'achat requise";
                return;
            }

            const dateAchat = new Date(dateAchatStr);
            if (isNaN(dateAchat.getTime())) {
                dateRenouvellementInput.value = "Date d'achat invalide";
                return;
            }

            let renewalDate = new Date(dateAchat);

            if (periodeCout === 'mois') {
                renewalDate.setMonth(renewalDate.getMonth() + 1);
                const currentYear = new Date().getFullYear();
                const nextMonthYear = renewalDate.getFullYear();
                const yearText = (nextMonthYear === currentYear) ? '' : ` (${nextMonthYear})`;
                dateRenouvellementInput.value = `Le mois prochain, le ${renewalDate.getDate()} ${formatDate(renewalDate).split(' ')[1]}${yearText}`;
            } else if (periodeCout === 'annee') {
                renewalDate.setFullYear(renewalDate.getFullYear() + 1);
                dateRenouvellementInput.value = `L'ann√©e prochaine, le ${formatDate(renewalDate)}`;
            }
        }

        function updateCostInput(selectedOption, periodeCout) {
            const costInput = document.getElementById('cout');
            if (!costInput) return;

            let costInUsd = 0;
            if (selectedOption && selectedOption.hasAttribute('data-cout-mois')) {
                if (periodeCout === 'mois') {
                    costInUsd = parseFloat(selectedOption.getAttribute('data-cout-mois'));
                } else if (periodeCout === 'annee') {
                    costInUsd = parseFloat(selectedOption.getAttribute('data-cout-annee'));
                }
            }
            costInput.value = (costInUsd * TAUX_DE_CONVERSION_USD_EUR).toFixed(2).replace('.', ',');

            const coutValue = parseFloat(costInput.value.replace(',', '.'));
            if (isNaN(coutValue) || coutValue <= 0) {
                costInput.classList.add('cout-input-rouge');
            } else {
                costInput.classList.remove('cout-input-rouge');
            }
        }

        function updateCollaborators(pole) {
            const collaborateurSelect = document.getElementById('collaborateur');
            if (!collaborateurSelect) return;

            collaborateurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

            if (pole && collaborateursParPole[pole]) {
                collaborateursParPole[pole].sort().forEach(collab => {
                    const option = document.createElement('option');
                    option.value = collab;
                    option.textContent = collab;
                    collaborateurSelect.appendChild(option);
                });
            }
            checkFormValidity();
        }

        function updateTypes(licence) {
            const typeSelect = document.getElementById('type');
            const descBox = document.getElementById('description');
            const costInput = document.getElementById('cout');
            const periodeCoutSelect = document.getElementById('periodeCout');
            const dateAchatInput = document.getElementById('dateAchat');
            const subscribeButton = document.getElementById('subscribeButton');

            if (!typeSelect || !descBox || !costInput || !periodeCoutSelect || !dateAchatInput || !subscribeButton) return;

            typeSelect.innerHTML = '';
            descBox.value = '';
            costInput.value = '';
            periodeCoutSelect.value = '';
            subscribeButton.style.display = 'none';

            if (typesParOutil[licence]) {
                typesParOutil[licence].forEach(obj => {
                    const option = document.createElement('option');
                    option.value = obj.type;
                    option.textContent = obj.type;
                    option.setAttribute('data-description', obj.description);
                    option.setAttribute('data-cout-mois', obj.cout_mois);
                    option.setAttribute('data-cout-annee', obj.cout_annee);
                    if (obj.url) {
                        option.setAttribute('data-url', obj.url);
                    }
                    typeSelect.appendChild(option);
                });
                const first = typeSelect.options[0];
                if (first) {
                    typeSelect.value = first.value;
                    descBox.value = first.getAttribute('data-description');
                    updateCostInput(first, periodeCoutSelect.value);
                    if (first.getAttribute('data-url')) {
                        subscribeButton.style.display = 'inline-block';
                    }
                }
            }
            updateRenewalDate(dateAchatInput.value, periodeCoutSelect.value);
            checkFormValidity();
        }

        function loadLicences() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                licencesData = JSON.parse(storedData);
                renderLicencesTable();
            }
        }

        function saveLicences() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(licencesData));
        }

        function renderLicencesTable() {
            const tableBody = document.querySelector('#listeLicences tbody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            const filterValue = document.getElementById('tablePoleFilter').value;

            licencesData.forEach((licence, index) => {
                if (filterValue !== 'all' && licence.pole !== filterValue) {
                    return;
                }

                const newRow = tableBody.insertRow();
                newRow.insertCell().setAttribute('data-label', 'P√¥le:'); newRow.cells[0].textContent = licence.pole;
                newRow.insertCell().setAttribute('data-label', 'Collaborateur:'); newRow.cells[1].textContent = licence.collaborateur;

                const licenceCell = newRow.insertCell();
                licenceCell.setAttribute('data-label', 'Licence:');
                const licenceLink = document.createElement('a');
                licenceLink.href = licence.url || '#';
                licenceLink.textContent = licence.licence;
                licenceLink.target = '_blank';
                licenceLink.classList.add('table-link');
                licenceCell.appendChild(licenceLink);

                newRow.insertCell().setAttribute('data-label', 'Type:'); newRow.cells[3].textContent = licence.type;

                const coutCell = newRow.insertCell();
                coutCell.setAttribute('data-label', 'Co√ªt:');
                coutCell.innerHTML = `<span class="cout-rouge-gras">${parseFloat(licence.cout).toFixed(2).replace('.', ',')} EUR</span>`;

                newRow.insertCell().setAttribute('data-label', 'P√©riode:'); newRow.cells[5].textContent = licence.periodeCout === 'mois' ? 'Par mois' : 'Par ann√©e';
                newRow.insertCell().setAttribute('data-label', 'Date d\'achat:'); newRow.cells[6].textContent = licence.dateAchat;
                newRow.insertCell().setAttribute('data-label', 'Date de renouvellement:'); newRow.cells[7].textContent = licence.dateRenouvellementAffichee;

                const actionCell = newRow.insertCell();
                actionCell.setAttribute('data-label', 'Action:');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'üóëÔ∏è';
                deleteButton.title = 'Supprimer';
                deleteButton.classList.add('btn-supprimer');
                deleteButton.addEventListener('click', function() {
                    if (confirm("√ätes-vous s√ªr de vouloir supprimer cette licence ?")) {
                        const originalIndex = licencesData.indexOf(licence); 
                        if (originalIndex > -1) {
                            deleteLicence(originalIndex);
                            showToast('Licence supprim√©e avec succ√®s !', 'success');
                        } else {
                            showToast('Erreur lors de la suppression de la licence.', 'error');
                        }
                    }
                });
                actionCell.appendChild(deleteButton);
            });
            calculateTotal();
        }

        function deleteLicence(index) {
            licencesData.splice(index, 1);
            saveLicences();
            renderLicencesTable();
            checkFormValidity();
        }

        function calculateTotal() {
            const totalAchatsElement = document.getElementById('totalAchats');
            const poleTotalsList = document.getElementById('poleTotalsList');
            if (!totalAchatsElement || !poleTotalsList) return;

            let totalGlobalCostEUR = 0;
            let totauxParPole = {};

            licencesData.forEach(licence => {
                let cost = parseFloat(licence.cout);
                let annualCost = (licence.periodeCout === 'mois') ? cost * 12 : cost;

                totalGlobalCostEUR += annualCost;

                if (!totauxParPole[licence.pole]) {
                    totauxParPole[licence.pole] = 0;
                }
                totauxParPole[licence.pole] += annualCost;
            });

            totalAchatsElement.textContent = `${totalGlobalCostEUR.toFixed(2).replace('.', ',')} EUR`;

            poleTotalsList.innerHTML = '';
            const sortedPoles = Object.keys(totauxParPole).sort();
            sortedPoles.forEach(pole => {
                const listItem = document.createElement('li');
                listItem.textContent = `${pole}: `;
                const span = document.createElement('strong');
                span.textContent = `${totauxParPole[pole].toFixed(2).replace('.', ',')} EUR`;
                listItem.appendChild(span);
                poleTotalsList.appendChild(listItem);
            });
        }

        function checkFormValidity() {
            const pole = document.getElementById('pole');
            const collaborateur = document.getElementById('collaborateur');
            const licence = document.getElementById('licence');
            const type = document.getElementById('type');
            const cout = document.getElementById('cout');
            const periodeCout = document.getElementById('periodeCout');
            const dateAchat = document.getElementById('dateAchat');
            const addButton = document.getElementById('addButton');
            const subscribeButton = document.getElementById('subscribeButton');

            if (!pole || !collaborateur || !licence || !type || !cout || !periodeCout || !dateAchat || !addButton || !subscribeButton) {
                console.warn("Certains √©l√©ments du formulaire sont manquants pour la v√©rification de validit√©.");
                return;
            }

            const coutValue = cout.value.replace(',', '.');
            const isCoutValid = !isNaN(parseFloat(coutValue)) && parseFloat(coutValue) > 0;

            const isPoleSelected = pole.value !== "" && pole.options[pole.selectedIndex] && !pole.options[pole.selectedIndex].textContent.startsWith('-- S√©lectionner');
            const isCollaborateurSelected = collaborateur.value !== "" && collaborateur.options[collaborateur.selectedIndex] && !collaborateur.options[collaborateur.selectedIndex].textContent.startsWith('-- S√©lectionner');
            const isLicenceSelected = licence.value !== "" && licence.options[licence.selectedIndex] && !licence.options[licence.selectedIndex].textContent.startsWith('-- S√©lectionner');
            const isTypeSelected = type.options.length > 0 && type.value !== "" && type.options[type.selectedIndex] && !type.options[type.selectedIndex].textContent.startsWith('-- S√©lectionner');
            const isPeriodeCoutSelected = periodeCout.value !== "" && periodeCout.options[periodeCout.selectedIndex] && !periodeCout.options[periodeCout.selectedIndex].textContent.startsWith('-- S√©lectionner');
            const isDateAchatValid = !!dateAchat.value;

            const isFormCompletelyValid = isPoleSelected && isCollaborateurSelected && isLicenceSelected && isTypeSelected && isCoutValid && isPeriodeCoutSelected && isDateAchatValid;

            if (isFormCompletelyValid) {
                addButton.disabled = false;
                const selectedTypeOption = type.options.length > 0 ? type.selectedOptions[0] : null;
                if (selectedTypeOption && selectedTypeOption.getAttribute('data-url')) {
                    subscribeButton.style.display = 'inline-block';
                } else {
                    subscribeButton.style.display = 'none';
                }
            } else {
                addButton.disabled = true;
                subscribeButton.style.display = 'none';
            }
        }

        function goToSubscriptionPage() {
            const licenceName = document.getElementById('licence').value;
            const typeName = document.getElementById('type').value;
            const collaborateurName = document.getElementById('collaborateur').value;
            const poleName = document.getElementById('pole').value;

            let toolUrl = '';
            const selectedLicenceData = typesParOutil[licenceName];
            if (selectedLicenceData) {
                const specificTypeData = selectedLicenceData.find(item => item.type === typeName);
                if (specificTypeData && specificTypeData.url) {
                    toolUrl = specificTypeData.url;
                } else if (selectedLicenceData[0] && selectedLicenceData[0].url) {
                    toolUrl = selectedLicenceData[0].url;
                }
            }
            if (!toolUrl) {
                toolUrl = 'https://example.com/souscription-generique';
                console.warn(`URL non trouv√©e pour ${licenceName} - ${typeName}. Utilisation d'une URL g√©n√©rique.`);
            }

            const url = `${toolUrl}?type=${encodeURIComponent(typeName)}&collaborateur=${encodeURIComponent(collaborateurName)}&pole=${encodeURIComponent(poleName)}`;

            alert(`Redirection vers la page de souscription pour ${licenceName} (${typeName}) pour ${collaborateurName} du p√¥le ${poleName}...\nURL: ${toolUrl}`);
            window.open(url, '_blank');
        }

        function telecharger() {
            const headers = ['P√¥le', 'Collaborateur', 'Licence', 'Type', 'Co√ªt', 'P√©riode', 'Date d\'achat', 'Date de renouvellement'];
            const data = licencesData.map(licence => [
                licence.pole,
                licence.collaborateur,
                licence.licence,
                licence.type,
                `${parseFloat(licence.cout).toFixed(2).replace('.', ',')} EUR`,
                licence.periodeCout === 'mois' ? 'Par mois' : 'Par ann√©e',
                licence.dateAchat,
                licence.dateRenouvellementAffichee
            ]);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'A4');

            doc.setFontSize(18);
            doc.text("Liste des Licences IA - Charlotte DELWARTE", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 14, 30);


            doc.autoTable({
                startY: 40,
                head: [headers],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [0, 119, 182] },
                styles: {
                    font: 'helvetica',
                    fontSize: 9,
                    cellPadding: 3,
                    valign: 'middle',
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 20, halign: 'right' },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 30 }
                },
                didParseCell: function(data) {
                    if (data.column.index === 4 && data.cell.section === 'body') {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [220, 53, 69];
                    }
                }
            });

            doc.save('liste_licences_ia.pdf');
            showToast('PDF g√©n√©r√© et t√©l√©charg√©.', 'success');
            console.log('PDF g√©n√©r√© et t√©l√©charg√©.');
        }

        function filterTableByPole() {
            renderLicencesTable();
        }


        document.addEventListener('DOMContentLoaded', async function() {
            console.log("Script JavaScript charg√© et d√©marr√©.");

            // --- Charger les composants externes (header et footer) ---
            await Promise.all([
                loadComponent("header.html", "header-placeholder"),
                loadComponent("footer.html", "footer-placeholder")
            ]);
            
            // --- Initialiser le dropdown et les liens actifs APR√àS le chargement du header ---
            initializeHeaderDropdown();
            updateActiveNavLinks();

            // --- √âl√©ments du DOM ---
            const loader = document.getElementById('loader');
            const mainElement = document.querySelector("main");
            const poleSelect = document.getElementById('pole');
            const collaborateurSelect = document.getElementById('collaborateur');
            const licenceSelect = document.getElementById('licence');
            const typeSelect = document.getElementById('type');
            const periodeCoutSelect = document.getElementById('periodeCout');
            const dateAchatInput = document.getElementById('dateAchat');
            const coutInput = document.getElementById('cout');
            const licenseForm = document.getElementById('licenseForm');
            const downloadButton = document.getElementById('downloadButton');
            const subscribeButton = document.getElementById('subscribeButton');
            const addButton = document.getElementById('addButton');
            const tablePoleFilter = document.getElementById('tablePoleFilter');

            // Masquer le loader imm√©diatement apr√®s le chargement des composants
            if (loader) {
                loader.style.display = 'none';
                loader.classList.add('hidden'); // Assure la transition CSS si elle existe sur hidden
            }
            // Rendre le main visible imm√©diatement
            if (mainElement) {
                mainElement.style.display = "block";
            }
            
            // D√©sactiver le bouton d'ajout par d√©faut
            if (addButton) {
                addButton.disabled = true;
            }

            // --- Remplissage initial des dropdowns ---
            if (poleSelect) {
                const poles = Object.keys(collaborateursParPole).sort();
                poles.forEach(pole => {
                    poleSelect.add(new Option(pole, pole));
                });
            }

            if (licenceSelect) {
                Object.keys(typesParOutil).sort().forEach(licence => {
                    licenceSelect.add(new Option(licence, licence));
                });
            }

            if (tablePoleFilter) {
                const availablePoles = Object.keys(collaborateursParPole).sort();
                availablePoles.forEach(pole => {
                    tablePoleFilter.add(new Option(pole, pole));
                });
            }

            // --- Attachement des √©couteurs d'√©v√©nements ---
            if (poleSelect) {
                poleSelect.addEventListener('change', function() {
                    updateCollaborators(this.value);
                    checkFormValidity();
                });
            }

            if (collaborateurSelect) {
                collaborateurSelect.addEventListener('change', checkFormValidity);
            }

            if (licenceSelect) {
                licenceSelect.addEventListener('change', function() {
                    updateTypes(this.value);
                    checkFormValidity();
                });
            }

            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    const selected = this.selectedOptions[0];
                    const periodeCout = periodeCoutSelect.value;
                    if (selected) {
                        document.getElementById('description').value = selected.getAttribute('data-description');
                        updateCostInput(selected, periodeCout);
                        if (selected.getAttribute('data-url')) {
                            subscribeButton.style.display = 'inline-block';
                        } else {
                            subscribeButton.style.display = 'none';
                        }
                    }
                    updateRenewalDate(dateAchatInput.value, periodeCout);
                    checkFormValidity();
                });
            }

            if (periodeCoutSelect) {
                periodeCoutSelect.addEventListener('change', function() {
                    const selectedTypeOption = typeSelect.options.length > 0 ? typeSelect.selectedOptions[0] : null;
                    const currentPeriod = this.value;
                    updateCostInput(selectedTypeOption, currentPeriod);
                    updateRenewalDate(dateAchatInput.value, currentPeriod);
                    checkFormValidity();
                });
            }

            if (dateAchatInput) {
                dateAchatInput.addEventListener('change', function() {
                    const periodeCout = periodeCoutSelect.value;
                    updateRenewalDate(this.value, periodeCout);
                    checkFormValidity();
                });
            }

            if (coutInput) {
                coutInput.addEventListener('input', function() {
                    checkFormValidity();
                    const coutValue = parseFloat(this.value.replace(',', '.'));
                    if (isNaN(coutValue) || coutValue <= 0) {
                        this.classList.add('cout-input-rouge');
                    } else {
                        this.classList.remove('cout-input-rouge');
                    }
                });
                coutInput.addEventListener('change', function() {
                    checkFormValidity();
                    const coutValue = parseFloat(this.value.replace(',', '.'));
                    if (isNaN(coutValue) || coutValue <= 0) {
                        this.classList.add('cout-input-rouge');
                    } else {
                        this.classList.remove('cout-input-rouge');
                    }
                });
            }

            if (licenseForm) {
                licenseForm.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const pole = document.getElementById('pole').value;
                    const collaborateur = document.getElementById('collaborateur').value;
                    const licence = document.getElementById('licence').value;
                    const type = document.getElementById('type').value;
                    let coutValue = document.getElementById('cout').value.replace(',', '.');
                    const cout = parseFloat(coutValue);
                    const periodeCout = document.getElementById('periodeCout').value;
                    const dateAchat = document.getElementById('dateAchat').value;
                    const dateRenouvellementAffichee = document.getElementById('dateRenouvellement').value;
                    const url = typeSelect.selectedOptions[0]?.getAttribute('data-url') || '#';

                    const isFormValid = pole && collaborateur && licence && type && !isNaN(cout) && cout > 0 && periodeCout && dateAchat;

                    if (isFormValid) {
                        const newLicence = {
                            pole,
                            collaborateur,
                            licence,
                            type,
                            cout,
                            periodeCout,
                            dateAchat,
                            dateRenouvellementAffichee,
                            url
                        };

                        licencesData.push(newLicence);
                        saveLicences();
                        renderLicencesTable();
                        showToast('Licence ajout√©e avec succ√®s !', 'success');

                        licenseForm.reset();
                        if(poleSelect) poleSelect.value = '';
                        if(collaborateurSelect) collaborateurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
                        if(licenceSelect) licenceSelect.value = '';
                        if(typeSelect) typeSelect.innerHTML = '';
                        document.getElementById('description').value = '';
                        document.getElementById('dateRenouvellement').value = '';
                    } else {
                        showToast("Veuillez remplir tous les champs obligatoires correctement.", 'error');
                    }
                    checkFormValidity();
                });
            }

            if (downloadButton) {
                downloadButton.addEventListener('click', telecharger);
            }

            if (subscribeButton) {
                subscribeButton.addEventListener('click', goToSubscriptionPage);
            }

            if (tablePoleFilter) {
                tablePoleFilter.addEventListener('change', filterTableByPole);
            }

            // --- Chargement initial des donn√©es et mise √† jour de l'UI ---
            loadLicences();
            if(poleSelect.value) {
                updateCollaborators(poleSelect.value);
            }
            if(licenceSelect.value) {
                updateTypes(licenceSelect.value);
            }
            checkFormValidity();
        });

        // =========================================================================
        // FONCTIONS GLOBALES POUR LE CHARGEMENT DES COMPOSANTS ET LE HEADER/DROPDOWN
        // (Ces fonctions doivent √™tre d√©finies une seule fois et globalement accessibles)
        // Elles ont √©t√© d√©plac√©es ici pour √©viter la duplication et assurer leur accessibilit√©.
        // =========================================================================

        // Fonction utilitaire pour charger les composants externes (header/footer)
        // Cette fonction doit √™tre d√©finie une seule fois dans votre code JavaScript principal,
        // id√©alement dans un fichier utilitaire commun si vous en avez un.
        /* C'est la m√™me que celle au-dessus, elle est red√©finie ici pour r√©f√©rence si besoin */
        // async function loadComponent(url, placeholderId) { /* ... */ }

        // Nouvelle fonction pour initialiser le dropdown, appel√©e APR√àS l'injection du header
        function initializeHeaderDropdown() {
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');

            if (toolsResourcesBtn && toolsResourcesContent) {
                // Supprime tout √©couteur de clic pr√©c√©dent pour √©viter la duplication
                toolsResourcesBtn.removeEventListener('click', handleDropdownClick); 
                window.removeEventListener('click', handleWindowClick);

                toolsResourcesBtn.addEventListener('click', handleDropdownClick);
                window.addEventListener('click', handleWindowClick);

                toolsResourcesContent.style.display = 'none';
                toolsResourcesBtn.setAttribute('aria-expanded', 'false');

            } else {
                console.warn("√âl√©ments du dropdown 'Outils & Ressources' non trouv√©s apr√®s injection. Le script ne peut pas initialiser le menu.");
            }
        }

        // Gestionnaire d'√©v√©nement pour le clic sur le bouton du dropdown
        function handleDropdownClick(event) {
            event.preventDefault(); 
            const toolsResourcesBtn = event.currentTarget; 
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');

            if (toolsResourcesContent.style.display === 'block') {
                toolsResourcesContent.style.display = 'none';
                toolsResourcesBtn.setAttribute('aria-expanded', 'false');
                toolsResourcesBtn.classList.remove('active');
            } else {
                toolsResourcesContent.style.display = 'block';
                toolsResourcesBtn.setAttribute('aria-expanded', 'true');
                toolsResourcesBtn.classList.add('active');
            }
        }

        // Gestionnaire d'√©v√©nement pour le clic sur la fen√™tre pour fermer le dropdown
        function handleWindowClick(event) {
            const toolsResourcesDropdown = document.getElementById('toolsResourcesDropdown'); 
            const toolsResourcesContent = document.getElementById('toolsResourcesContent');
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');

            // V√©rifie si le clic n'est pas √† l'int√©rieur du dropdown (bouton ou contenu)
            if (toolsResourcesDropdown && !toolsResourcesDropdown.contains(event.target)) {
                if (toolsResourcesContent && toolsResourcesContent.style.display === 'block') {
                    toolsResourcesContent.style.display = 'none';
                    if (toolsResourcesBtn) { 
                        toolsResourcesBtn.setAttribute('aria-expanded', 'false');
                        toolsResourcesBtn.classList.remove('active');
                    }
                }
            }
        }

        // Fonction pour g√©rer la classe 'active' sur les liens de navigation (appel√©e apr√®s l'injection)
        function updateActiveNavLinks() {
            const currentPath = window.location.pathname.split('/').pop();

            document.querySelectorAll('#header-placeholder nav > a').forEach(link => { 
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : ''; 
                const currentFileName = currentPath.replace('.html', '');

                const isCurrentPage = (linkFileName === currentFileName) || 
                                      (linkFileName === '' && currentFileName === 'index');

                if (isCurrentPage) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            const toolsResourcesContent = document.getElementById('toolsResourcesContent');
            const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');
            const dropdownLinks = toolsResourcesContent ? toolsResourcesContent.querySelectorAll('a') : [];

            let dropdownHasActiveLink = false;
            dropdownLinks.forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : '';
                const currentFileName = currentPath.replace('.html', '');

                const isCurrentSubPage = (linkFileName === currentFileName);

                if (isCurrentSubPage) {
                    link.classList.add('active'); 
                    dropdownHasActiveLink = true;
                } else {
                    link.classList.remove('active');
                }
            });

            if (toolsResourcesBtn) {
                if (dropdownHasActiveLink) {
                    toolsResourcesBtn.classList.add('active');
                } else {
                    if (toolsResourcesContent && toolsResourcesContent.style.display !== 'block') {
                        toolsResourcesBtn.classList.remove('active');
                    }
                }
            }
        }
    </script>
</body>
</html>
