<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Demande IA - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Styles pour masquer la page au démarrage afin d'éviter un "flash" de contenu non stylisé */
        body {
            opacity: 0; /* Commence masqué */
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            transition: opacity 0.3s ease-in; /* Transition pour une apparition douce */
            font-size: 0.95em;
        }
        main {
            display: none; /* Masqué par défaut */
        }
        /* --- Styles Généraux --- */
        .flex-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            padding: 40px 20px;
            flex-wrap: wrap;
        }
        /* --- Styles du Formulaire --- */
        .container {
            flex: 1 1 600px;
            max-width: 700px;
            background: white;
            padding: 40px 35px;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        }
        form label {
            display: block;
            margin-top: 20px;
            font-weight: 600;
            color: #444;
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            margin-top: 6px;
            background-color: #f9fafb;
        }
        /* Ajustement de la taille du champ Nom et Initiales */
        input[name="nom"] {
            max-width: 300px; /* Réduit la largeur du champ Nom */
        }
        input[name="emailPrefix"] {
            max-width: 150px; /* Réduit la largeur du champ Initiales */
        }
        input[name="date"] {
            max-width: 200px;
        }
        .email-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button {
            background-color: #0077b6;
            color: white;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #005f8a;
        }
        /* --- Styles du Récapitulatif et Tickets --- */
        .recap {
            flex: 0 1 320px;
            background: #e0e6ed; /* Nouvelle couleur pour plus de contraste */
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            max-height: 90vh; /* Limite la hauteur et ajoute un défilement si nécessaire */
            overflow-y: auto;
        }
        .recap h3 {
            margin-top: 0;
            color: #0077b6;
            margin-bottom: 10px;
        }
        /* Styles pour réduire la largeur des filtres du récapitulatif */
        #filtreChaine,
        #filtreAuteur { /* Marge sous le filtre Auteur pour l'espace */
            margin-bottom: 15px;
        }
        /* Les filtres du récapitulatif (sélecteurs) peuvent faire la moitié de leur largeur */
        .recap select {
            width: 100%; /* Par défaut à 100% */
            max-width: 160px; /* Limite à la moitié de la largeur du parent (~320px) */
            box-sizing: border-box; /* Inclure padding et border dans la largeur */
        }

        .ticket {
            position: relative;
            background: white;
            padding: 12px 14px;
            margin-bottom: 12px;
            border-left: 4px solid #0077b6; /* Couleur de bordure par défaut */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            font-size: 0.95em;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .ticket span {
            display: block;
            line-height: 1.4em;
        }
        /* --- Styles du Modal (Pop-up) --- */
        #modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        #modal.visible .modal-content {
            transform: translateY(0);
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #555;
            transition: color 0.2s ease;
        }
        .close-modal:hover {
            color: #000;
        }
        #modal-body {
            display: block;
            font-family: Arial, sans-serif;
            line-height: 25.6px;
            margin-top: 16px;
            margin-bottom: 25px;
            margin-left: 0px;
            margin-right: 0px;
            text-align: center;
            color: #444;
            font-size: 0.95em;
            white-space: pre-wrap; /* Préserve les retours à la ligne du texte */
            word-wrap: break-word; /* Gère les mots longs */
        }
        /* --- Media Queries pour Responsivité --- */
        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
            #modal-body {
                font-size: 0.9em;
                line-height: 1.5;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="flex-wrapper">
            <div class="container">
                <h2 style="text-align:center; color:#0077b6; margin-top: 0;">Formulaire de demande de production IA</h2>
                <form id="demandeIA">
                    <label for="nom">Nom :</label>
                    <input type="text" name="nom" required />

                    <label for="emailPrefix">Email :</label>
                    <div class="email-container">
                        <input type="text" name="emailPrefix" placeholder="initiales" required />
                        <span>@rtbf.be</span>
                    </div>

                    <label for="type">Type :</label>
                    <select name="type" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="vidéo">Vidéo</option>
                        <option value="audio">Audio</option>
                        <option value="image">Image</option>
                        <option value="voix off IA">Voix off IA</option>
                        <option value="autre">Autre</option>
                    </select>

                    <label for="support">Support :</label>
                    <select name="support" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="TV">TV</option>
                        <option value="Radio">Radio</option>
                        <option value="Web">Web</option>
                        <option value="RS">Réseaux sociaux</option>
                        <option value="autre">Autre</option>
                    </select>

                    <label for="chaine">Chaine :</label>
                    <select name="chaine" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="La Une">La Une</option>
                        <option value="Tipik">Tipik</option>
                        <option value="La Trois">La Trois</option>
                        <option value="La première">La première</option>
                        <option value="Classic 21">Classic 21</option>
                        <option value="vivacité">vivacité</option>
                        <option value="Musiq3">Musiq3</option>
                        <option value="Auvio">Auvio</option>
                    </select>

                    <label for="duree">Durée :</label>
                    <select name="duree" id="duree"></select>

                    <label for="date">Date :</label>
                    <input type="date" name="date" required />

                    <label for="description">Briefing :</label>
                    <textarea name="description" rows="4" required></textarea>

                    <button type="submit" id="submitBtn">Envoyer</button>
                </form>
            </div>

            <div class="recap">
                <h3>Récapitulatif des demandes</h3>
                
                <select id="filtreChaine" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Filtrer par chaîne</option>
                    <option value="La Une">La Une</option>
                    <option value="Tipik">Tipik</option>
                    <option value="La Trois">La Trois</option>
                    <option value="La première">La première</option>
                    <option value="Classic 21">Classic 21</option>
                    <option value="vivacité">vivacité</option>
                    <option value="Musiq3">Musiq3</option>
                    <option value="Auvio">Auvio</option>
                </select>
                
                <select id="filtreAuteur" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Trier par demandeur</option>
                    </select>
                
                <div id="recapList"></div>
            </div>
        </div>
    </main>

    <div id="modal">
        <div class="modal-content">
            <button class="close-modal" title="Fermer">&times;</button>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy"; // URL de votre fonction Netlify pour la gestion des données
        const SEND_REQUEST_URL = "/.netlify/functions/sendrequest"; // URL de votre fonction Netlify pour l'envoi d'e-mails

        // Fonction utilitaire pour s'assurer que l'élément parent de la notification a une position définie
        function ensureNotifParentPosition() {
            const demandeLink = document.querySelector("a.demandes");
            if (demandeLink) {
                const style = getComputedStyle(demandeLink);
                if (style.position === "static" || !style.position) {
                    demandeLink.style.position = "relative";
                }
            }
        }

        // Mapping des couleurs par chaîne pour la bordure des tickets
        const couleursParChaine = {
            'Classic 21': 'purple',
            'La Une': 'red',
            'Tipik': 'green',
            'La première': 'blue',
            'La Trois': 'mediumorchid',
            'Auvio': 'black',
            'vivacité': 'orange',
            'Musiq3': 'hotpink'
        };

        // Met à jour le nombre dans la bulle de notification (si elle existe)
        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) return; 
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                const demandes = await res.json();
                notif.textContent = demandes.length;
                notif.style.display = demandes.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de notifications :", e);
            }
        }

        // Fonction pour remplir le sélecteur d'auteurs dynamiquement depuis les données
        async function remplirFiltreAuteur() {
            const filtreAuteurSelect = document.getElementById("filtreAuteur");
            const selectedValue = filtreAuteurSelect.value; 

            filtreAuteurSelect.innerHTML = '<option value="">Trier par demandeur</option>'; // Mis à jour du texte
            
            let demandes = [];
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                const data = await res.json();
                demandes = Array.isArray(data) ? data : []; 
            } catch (err) {
                console.error("Erreur lors de la récupération des demandes pour les auteurs :", err);
                return; 
            }

            const auteurs = [...new Set(demandes.map(d => d.nom).filter(Boolean))].sort(); 

            auteurs.forEach(auteur => {
                const option = document.createElement("option");
                option.value = auteur;
                option.textContent = auteur;
                filtreAuteurSelect.appendChild(option);
            });

            if (selectedValue && [...auteurs, ''].includes(selectedValue)) { 
                filtreAuteurSelect.value = selectedValue;
            }
        }

        // Affiche les demandes dans le panneau de récapitulatif, en appliquant les filtres et le tri
        async function afficherDemandes() {
            const recapList = document.getElementById("recapList");
            const filtreChaine = document.getElementById("filtreChaine").value;
            const filtreAuteur = document.getElementById("filtreAuteur").value;

            let demandes = [];
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                const data = await res.json();
                demandes = Array.isArray(data) ? data : []; 
            } catch (err) {
                console.error("Erreur lors de la récupération des demandes :", err);
                demandes = []; 
            }

            // Application des filtres
            if (filtreChaine) {
                demandes = demandes.filter(d => d.chaine === filtreChaine);
            }
            if (filtreAuteur) { 
                demandes = demandes.filter(d => d.nom === filtreAuteur);
            }
            
            // Tri par date décroissante pour afficher la plus récente en premier
            demandes.sort((a, b) => new Date(b.date) - new Date(a.date));

            recapList.innerHTML = ""; // Vide la liste avant de la remplir avec les éléments filtrés

            // Crée et ajoute un ticket pour chaque demande filtrée
            demandes.forEach(d => {
                const couleur = couleursParChaine[d.chaine] || "#0077b6"; 
                const div = document.createElement("div");
                div.className = "ticket";
                div.style.borderLeftColor = couleur;
                div.innerHTML = `
                    <div style="display:flex; justify-content: space-between; align-items:center">
                        <span><strong>${d.nom}</strong></span>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:1.1em; font-weight: bold;">${d.type}</span>
                            <span>${d.duree}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                        <span style="color:${couleur}; font-weight: bold">${d.chaine}</span>
                        <small style="color:#666;">📅 ${d.date}</small>
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                        <div>${d.traite ? '<span style="color:green">✅ Traité</span>' : '<span style="color:#999">⏳ En attente</span>'}</div>
                        <div>
                            ${d.traite ? '' : `<button title="Marquer comme traité" data-id="${d.id}" class="btn-traite" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">✔️</button>`}
                            <button title="Supprimer" data-id="${d.id}" class="btn-supprimer" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">🗑️</button>
                        </div>
                    </div>
                `;

                // Attache les écouteurs d'événements aux boutons de suppression et de statut
                div.querySelector(".btn-supprimer")?.addEventListener("click", async e => {
                    e.stopPropagation(); 
                    if (confirm("Êtes-vous sûr de vouloir supprimer cette demande ?")) {
                         await supprimerDemande(d.id);
                    }
                });

                div.querySelector(".btn-traite")?.addEventListener("click", async e => {
                    e.stopPropagation(); 
                    await marquerTraite(d.id);
                });

                // Attache l'écouteur d'événement pour ouvrir le modal au clic sur le ticket
                div.addEventListener("click", () => {
                    const modal = document.getElementById("modal");
                    const modalBody = document.getElementById("modal-body");
                    modalBody.textContent = `
Nom: ${d.nom}
Email: ${d.email}
Type: ${d.type}
Support: ${d.support}
Chaîne: ${d.chaine}
Durée: ${d.duree}
Date: ${d.date}

Briefing:
${d.description}`;
                    modal.classList.add('visible');
                });

                recapList.appendChild(div);
            });
        }

        // Supprime une demande via l'API
        async function supprimerDemande(id) {
            console.log("Tentative de suppression de la demande avec l'ID:", id); 
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                let demandes = await res.json();
                
                const initialLength = demandes.length;
                const updatedDemandes = demandes.filter(d => d.id !== id); // Filtre la demande à supprimer
                
                if (updatedDemandes.length === initialLength) {
                    console.warn("Aucune demande trouvée avec cet ID pour la suppression:", id);
                    alert("La demande n'a pas été trouvée pour la suppression.");
                    return;
                }

                // Envoie le tableau de demandes mis à jour à votre fonction Netlify
                const updateRes = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "updateDemandeIA", demandes: updatedDemandes })
                });

                if (!updateRes.ok) { // Vérifie la réponse de la mise à jour
                    const errorText = await updateRes.text();
                    throw new Error(`Erreur HTTP lors de l'envoi de la mise à jour: ${updateRes.status} ${updateRes.statusText}. Détails: ${errorText}`);
                }
                const updateResult = await updateRes.json();
                if (!updateResult.success) { // Vérifie le succès renvoyé par votre fonction Netlify
                     throw new Error(`Échec de l'opération de suppression côté serveur: ${updateResult.message || "Aucun message."}`);
                }

                console.log("Demande supprimée avec succès, rafraîchissement..."); 
                afficherDemandes(); 
                mettreAJourBulleDemandes(); 
                remplirFiltreAuteur(); 
            } catch (e) {
                console.error("Erreur lors de la suppression de la demande :", e);
                alert("Une erreur est survenue lors de la suppression. Vérifiez la console pour plus de détails. Assurez-vous que votre fonction Netlify peut supprimer des entrées.");
            }
        }

        // Marque une demande comme traitée via l'API
        async function marquerTraite(id) {
            console.log("Tentative de marquer comme traité la demande avec l'ID:", id); 
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                let demandes = await res.json();
                
                const demande = demandes.find(d => d.id === id); 
                if (!demande) {
                    console.warn("Aucune demande trouvée avec cet ID pour le statut:", id);
                    alert("La demande n'a pas été trouvée pour le changement de statut.");
                    return;
                }
                demande.traite = true; // Met à jour le statut

                const updateRes = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "updateDemandeIA", demandes: demandes }) // Envoie toutes les demandes avec la modification
                });

                if (!updateRes.ok) { // Vérifie la réponse de la mise à jour
                    const errorText = await updateRes.text();
                    throw new Error(`Erreur HTTP lors de l'envoi de la mise à jour: ${updateRes.status} ${updateRes.statusText}. Détails: ${errorText}`);
                }
                const updateResult = await updateRes.json();
                if (!updateResult.success) { // Vérifie le succès renvoyé par votre fonction Netlify
                    throw new Error(`Échec de l'opération de marquage comme traité côté serveur: ${updateResult.message || "Aucun message."}`);
                }

                console.log("Demande marquée comme traitée avec succès, rafraîchissement..."); 
                afficherDemandes(); 
                mettreAJourBulleDemandes(); 
            } catch (e) {
                console.error("Erreur lors du marquage comme traité :", e);
                alert("Une erreur est survenue lors du changement de statut. Vérifiez la console pour plus de détails. Assurez-vous que votre fonction Netlify peut mettre à jour des entrées.");
            }
        }

        // -------------------------------------------------------------
        // LOGIQUE CRUCIALE DE CHARGEMENT ET D'INITIALISATION DE LA PAGE
        // -------------------------------------------------------------
        document.addEventListener("DOMContentLoaded", () => {
            fetch("header.html")
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Erreur HTTP: ${res.status} ${res.statusText}`);
                    }
                    return res.text();
                })
                .then(data => {
                    document.getElementById("header-placeholder").innerHTML = data;
                    ensureNotifParentPosition();
                    
                    document.body.style.opacity = "1";
                    document.querySelector("main").style.display = "block";

                    mettreAJourBulleDemandes(); 
                    remplirFiltreAuteur(); 
                    afficherDemandes(); 

                    const dureeSelect = document.getElementById("duree");
                    for (let i = 0; i <= 60; i++) {
                        const opt = document.createElement("option");
                        opt.value = `${i} sec`;
                        opt.textContent = `${i} sec`;
                        dureeSelect.appendChild(opt);
                    }

                    document.getElementById("demandeIA").addEventListener("submit", async e => {
                        e.preventDefault();
                        const data = new FormData(e.target);
                        const demande = {
                            id: "_" + Math.random().toString(36).substr(2, 9), 
                            nom: data.get("nom"), 
                            email: `${data.get("emailPrefix")}@rtbf.be`,
                            type: data.get("type"),
                            support: data.get("support"),
                            duree: data.get("duree"),
                            date: data.get("date"),
                            description: data.get("description"),
                            chaine: data.get("chaine"),
                            traite: false
                        };

                        try {
                            const response = await fetch(SEND_REQUEST_URL, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(demande)
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error(`Erreur HTTP: ${response.status} ${response.statusText}`, errorText);
                                alert(`Erreur lors de l'envoi de la demande: ${response.status} ${response.statusText}. Détails: ${errorText.substring(0, 200)}... (voir console pour plus)`);
                                return;
                            }

                            const result = await response.json();

                            if (result.success) {
                                alert(result.message || "Demande envoyée avec succès et mail transmis !");
                                e.target.reset();
                                afficherDemandes(); 
                                mettreAJourBulleDemandes(); 
                                remplirFiltreAuteur(); 
                            } else {
                                console.error("Erreur de la fonction Netlify (réponse JSON) :", result);
                                alert(`Erreur lors de l'envoi de la demande: ${result.message || "Réponse non réussie de la fonction Netlify."}`);
                            }
                        } catch (err) {
                            console.error("Erreur d'envoi du formulaire côté client :", err);
                            alert("Une erreur inattendue est survenue lors de l'envoi du formulaire. Vérifiez la console.");
                        }
                    });

                    document.getElementById("filtreChaine").addEventListener("change", afficherDemandes);
                    document.getElementById("filtreAuteur").addEventListener("change", afficherDemandes); 

                    document.querySelector(".close-modal").addEventListener("click", () => {
                        document.getElementById("modal").classList.remove('visible');
                    });
                    document.getElementById("modal").addEventListener("click", e => {
                        if (e.target.id === "modal") {
                            document.getElementById("modal").classList.remove('visible');
                        }
                    });

                })
                .catch(error => {
                    console.error("Erreur critique lors du chargement de header.html:", error);
                    document.body.style.opacity = "1";
                    document.querySelector("main").style.display = "block";
                    const errorDiv = document.createElement("div");
                    errorDiv.style.color = "red";
                    errorDiv.style.textAlign = "center";
                    errorDiv.style.marginTop = "20px";
                    errorDiv.textContent = "Impossible de charger l'en-tête de la page. Veuillez réessayer ou contacter l'administrateur.";
                    document.body.prepend(errorDiv); 
                });
        });
    </script>
</body>
</html>
