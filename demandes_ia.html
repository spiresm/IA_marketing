<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demande IA - Espace IA</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preload" href="header.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="footer.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="log_ia.png" as="image">
    <link rel="preload" href="Section-Clients-Logo-RTBF.png" as="image">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Variables CSS */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --grey-text: #555;
            --border-color: #ddd;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Utilisé dans le second code pour .main-container */
            --card-hover-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Ajouté pour consistance si besoin */
        }
        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-grey);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            opacity: 0; /* Pour l'animation d'apparition */
            transition: opacity 0.5s ease-in;
            overflow-x: hidden;
            overflow-y: auto;
        }
        body.show {
            opacity: 1; /* Révèle le body une fois la classe ajoutée par JavaScript */
        }
        main { 
            padding: 40px 20px; 
            flex-grow: 1; 
            overflow-y: visible;
        }
        .nav-wrapper { 
            background-color: var(--primary-blue); 
            width: 100%; 
            position: relative; 
            flex-shrink: 0; 
            padding: 5px 0; 
        }
        .menu-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 30px; 
            box-sizing: border-box; 
        }
        nav { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        nav a { 
            text-decoration: none; 
            color: white; 
            font-weight: bold; 
            font-size: 1.1em; 
            padding: 10px 18px; 
            border-radius: 8px; 
            transition: background 0.3s ease; 
            margin: 0 5px; 
            white-space: nowrap; 
            position: relative; 
        }
        nav a:hover { 
            background: rgba(255, 255, 255, 0.2); 
        }
        nav a.active { 
            background-color: white; 
            color: var(--primary-blue); 
        }
        .notif-bubble { 
            position: absolute; 
            top: 0px; 
            right: 0px; 
            background: red; 
            color: white; 
            border-radius: 50%; 
            padding: 2px 6px; 
            font-size: 12px; 
            font-weight: bold; 
            display: none; 
        }
        .main-container { 
            max-width: 960px; 
            margin: 25px auto; 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
        }
        .flex-wrapper { 
            display: flex; 
            gap: 30px; 
            align-items: flex-start; 
        }
        .form-container { 
            flex: 2; 
        }
        .form-container h2 { 
            text-align: center; 
            color: var(--dark-blue); 
            margin-top: 0; 
            margin-bottom: 20px; 
        }
        form label { 
            display: block; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: var(--grey-text); 
        }
        form input, form select, form textarea { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            font-size: 1em; 
            background-color: #f9fafb; 
            box-sizing: border-box; 
        }
        form select:disabled { 
            background-color: #e9ecef; 
            cursor: not-allowed; 
        }
        .email-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .email-container input { 
            max-width: 200px; 
        }
        button[type="submit"] { 
            width: 100%; 
            background-color: var(--primary-blue); 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            margin-top: 25px; 
            cursor: pointer; 
            transition: background-color 0.2s ease; 
        }
        button[type="submit"]:hover:not(:disabled) { 
            background-color: var(--dark-blue); 
        }
        button[type="submit"]:disabled { 
            background-color: #a0a0a0; 
            cursor: not-allowed; 
        }
        .recap-container { 
            flex: 1; 
            background: #f0f2f5; 
            padding: 20px; 
            border-radius: 12px; 
            color: var(--dark-blue); 
            align-self: stretch; 
        }
        .recap-container h3 { 
            margin-top: 0; 
            text-align: center; 
        }
        .recap-container select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border-color); 
        }
        .ticket { 
            background: white; 
            color: var(--grey-text); 
            padding: 15px; 
            margin-bottom: 10px; 
            border-left: 5px solid var(--primary-blue); 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            cursor: pointer; 
        }
        .ticket-header { 
            display: flex; 
            justify-content: space-between; 
            font-weight: bold; 
        }
        .ticket-body { 
            font-size: 0.9em; 
            margin-top: 5px; 
            color: #777; 
        }
        .ticket-actions { /* Styles pour les boutons "Traité" et "Supprimer" */
            display: flex;
            justify-content: flex-end; /* Aligne les boutons à droite */
            gap: 10px; /* Espace entre les boutons */
            margin-top: 10px;
        }
        .ticket-actions button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .ticket-actions button.btn-traite {
            color: green;
        }
        .ticket-actions button.btn-traite:hover {
            background-color: rgba(0, 128, 0, 0.1);
        }
        .ticket-actions button.btn-supprimer {
            color: #dc3545; /* Rouge pour supprimer */
        }
        .ticket-actions button.btn-supprimer:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Modal de détails (conservé du premier code pour plus de détails) */
        #modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none; /* Masqué par défaut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px 35px;
            width: 81%;
            max-width: 405px;
            max-height: 81vh;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            font-size: 0.95em;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        .modal-title {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }
        .modal-info-line {
            display: flex;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-wrap: wrap;
        }
        .modal-info-line strong {
            color: var(--primary-blue);
            min-width: 90px;
            margin-right: 10px;
        }
        .modal-info-line span {
            flex: 1;
            word-break: break-word;
        }
        .modal-info-line.description {
            flex-direction: column;
        }
        .modal-info-line.description strong {
            margin-bottom: 5px;
        }

        /* Modale d'information initiale */
        #initial-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Géré par JS */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
            overflow-y: auto;
            padding: 20px 0;
            box-sizing: border-box;
        }
        #initial-info-modal.hidden {
            display: none !important;
        }
        .info-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px 25px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            transform: scale(0.9);
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
        }
        .info-modal-content h2 {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .info-modal-content p {
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 20px;
            color: #333;
        }
        .info-modal-content p strong {
            color: var(--primary-blue);
        }
        .info-modal-content p em {
            color: #e60000;
            font-weight: bold;
            font-style: normal;
        }
        .info-modal-content button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-top: 15px;
        }
        .info-modal-content button:hover {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
        }

        /* Styles du Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            pointer-events: all;
        }
        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #loader .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loader p {
            color: var(--primary-blue);
            font-size: 1.1em;
        }

        /* Styles des messages Toast */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }
        .toast-message {
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 250px;
            text-align: center;
            font-weight: bold;
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-message.success {
            background-color: rgba(40, 167, 69, 0.9);
        }
        .toast-message.error {
            background-color: rgba(220, 53, 69, 0.9);
        }

        /* Media Queries */
        @media (max-width: 800px) { 
            .flex-wrapper { 
                flex-direction: column; 
            } 
            .main-container, .recap-container {
                max-width: 95%;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p>Chargement des demandes...</p>
    </div>

    <div id="initial-info-modal">
        <div class="info-modal-content">
            <h2>Bienvenue sur la page de Demande IA !</h2>
            <p>Ce formulaire vous permet de soumettre vos demandes de productions basées sur l'Intelligence Artificielle. Remplissez les champs requis (votre nom, email, le type et le support de la demande, la chaîne, la durée souhaitée et un briefing détaillé) pour que notre équipe puisse traiter votre requête efficacement.</p>
            <p>Sur la droite, vous trouverez un **récapitulatif** de toutes les demandes en cours et traitées, que vous pouvez filtrer par demandeur ou par chaîne. Vous pouvez également marquer une demande comme traitée ou la supprimer si nécessaire.</p>
            <button id="comprendaBtn">Compris !</button>
        </div>
    </div>

    <div id="header-placeholder">
        <div class="nav-wrapper">
            <div class="menu-container">
                <nav>
                    <a href="index.html">Accueil</a>
                    <a href="equipe.html">Équipe</a>
                    <a href="outils.html">Outils</a>
                    <a href="galerie.html">Prompts</a>
                    <a href="cas-usages.html">Workflows</a>
                    <a href="charte.html">Chartes</a>
                    <a href="faq.html">FAQ</a>
                    <a href="demandes_ia.html" class="active">Demandes<span class="notif-bubble" id="notif-count"></span></a>
                    <a href="gestion-license.html">Licenses</a>
                </nav>
            </div>
        </div>
    </div>

    <main>
        <div class="main-container">
            <div class="flex-wrapper">
                <div class="form-container">
                    <h2>Formulaire de demande</h2>
                    <form id="demandeIA">
                        <label for="poleSelect">Votre Pôle :</label>
                        <select id="poleSelect" required></select>
                        
                        <label for="nomSelect">Votre Nom :</label>
                        <select name="nom" id="nomSelect" required disabled></select>

                        <label for="emailPrefix">Votre Email :</label>
                        <div class="email-container">
                            <input type="text" name="emailPrefix" placeholder="initiales" required />
                            <span>@rtbf.be</span>
                        </div>

                        <label for="besoin">Type de besoin :</label>
                        <select name="besoin" id="besoin" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="production">Production</option>
                            <option value="formation">Formation</option>
                        </select>
                        
                        <div id="production-fields">
                             <label for="typeContenu">Type de contenu :</label>
                             <select name="typeContenu" id="typeContenu" required><option value="">-- Sélectionner --</option><option value="vidéo">Vidéo</option><option value="audio">Audio</option><option value="image">Image</option><option value="voix off IA">Voix off IA</option><option value="autre">Autre</option></select>
                             <label for="support">Support :</label> <select name="support" id="support" required><option value="">-- Sélectionner --</option><option value="TV">TV</option><option value="Radio">Radio</option><option value="Web">Web</option><option value="RS">Réseaux sociaux</option><option value="autre">Autre</option></select>
                             <label for="chaine">Chaîne :</label>
                             <select name="chaine" id="chaine" required></select>
                             <label for="duree">Durée :</label>
                             <select name="duree" id="duree" required></select>
                        </div>
                        <div id="formation-fields" class="hidden"> <label for="outils">Outil(s) souhaité(s) :</label>
                             <select name="outils" id="outils" required></select>
                        </div>

                        <label for="date">Date de besoin :</label>
                        <input type="date" name="date" required />
                        <label for="description">Briefing détaillé :</label>
                        <textarea name="description" rows="5" required></textarea>
                        <button type="submit" id="submitBtn">Envoyer la demande</button>
                    </form>
                </div>
                <div class="recap-container">
                    <h3>Récapitulatif des demandes</h3>
                    <select id="filtrePoleRecap"><option value="">Filtrer par pôle</option></select>
                    <select id="filtreNomRecap" disabled><option value="">Filtrer par nom</option></select>
                    <select id="filtreBesoin" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--border-color);">
                        <option value="">Filtrer par besoin</option>
                        <option value="production">Production</option>
                        <option value="formation">Formation</option>
                    </select>
                    <select id="filtreParChaine" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);"></select>

                    <div id="recapList"><p style="text-align:center; opacity:0.7;">Chargement...</p></div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder">
        <footer>
            <p>&copy; 2025 Espace IA. Tous droits réservés.</p>
        </footer>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" title="Fermer">&times;</button>
            <h4 class="modal-title">Détails de la demande</h4>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy"; // Pour les actions de suppression/update
        const SEND_REQUEST_URL = "/.netlify/functions/sendrequest"; // Pour l'envoi de la demande

        // Données complètes des profils, outils et chaînes
        const allProfiles = [
            { "id": "_tfzo5ckx8", "name": "Steeve PIRES MADEIRA", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/image_compressée (2).jpeg", "tools": ["ChatGPT", "Claude", "Midjourney", "Stable Diffusion", "Firefly", "Gemini", "Copilot", "Sora", "ElevenLabs"], "note": "ajouter staff aux équipes + lier profil aux demandeurs IA" },
            { "id": "_a0617pogh", "name": "Sabrina LECLERCQ", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/sabrina.png", "tools": ["ChatGPT", "Claude", "Midjourney", "DALL·E", "Stable Diffusion", "Firefly", "Runway ML"], "note": "" },
            { "id": "_zsdjsgpxk", "name": "Jeremy DEHERTOGH", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/Captain_America_Shield.webp", "tools": ["ChatGPT", "Midjourney", "Stable Diffusion", "Firefly", "Runway ML", "Gemini", "Copilot", "Sora"], "note": "" },
            { "id": "_xz380lwlz", "name": "Dominique LEFEVRE", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_th5j1y1ak", "name": "Joel VAN HOEF", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/joel.png", "tools": ["ChatGPT", "Midjourney", "Stable Diffusion", "Firefly", "Runway ML"], "note": "Hello Steeve,\nvoici mes suggestions :\nsignaler quelle est la limite maximale de poids du fichier à compresser.\ndonner la possibilité, dans la galerie, de mettre un commentaire\nrenommer \"Cas d'usage\" et \"tip\" en \"workflow\"\nMerci à toi\nJoël" },
            { "id": "_ko4axa9sq", "name": "Isabelle MARCHAL", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/isa.png", "tools": ["ChatGPT", "Midjourney", "Stable Diffusion", "Firefly"], "note": "" },
            { "id": "_170aetvaf", "name": "Susana GONCALVES VALERIO", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/susana.png", "tools": ["ChatGPT", "Midjourney", "Stable Diffusion", "Firefly"], "note": "" },
            { "id": "_qn2zeaz2v", "name": "Jimmy DEGREVE", "pole": "Pôle créa.", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/jimmy.png", "tools": ["ChatGPT", "Claude", "Midjourney", "Stable Diffusion", "Firefly"], "note": "" },
            { "id": "_25wpgzuws", "name": "Anne-Françoise LELEUX", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_8gnzie9nj", "name": "Baptiste TARTAS", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_gg0q68jwl", "name": "Béatrice MARLIER", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_m22sh68c7", "name": "Boris TEIRLYNCK", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_orwk7irk3", "name": "Charlotte DELWARTE", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_x5k53iyde", "name": "Delphine BENROUBI", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_a3pnsl406", "name": "Faiza BOUMEDIAN", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_padq9zuin", "name": "Geneviève DE BEAUFFORT", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_amq5aady5", "name": "Giovanni CASCONE", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_dny2qkk6g", "name": "Gregory KEPPENS", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_hi9o01e2o", "name": "Isabelle VERTUONGEN", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_2z5msputn", "name": "Jonathan LACROIX", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_gpn16nj1s", "name": "Jose ROJO", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_xc6h2qggw", "name": "Jose-Luis PENAFUERTE", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_01jyr1k2x", "name": "Mehdi HUSAIN", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_604cq06kb", "name": "Michael EVRARD", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_k6ukaf261", "name": "Nathalie AUBRY", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_di6y4hwzc", "name": "Patricia DAVIA", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_xlafbddqb", "name": "Pierre LERMIER", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_n9jr6sxvw", "name": "Pierre-Jean GILOUX", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_oo5nnduh6", "name": "Tyan HOOGSTOEL", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_cuhli6ncd", "name": "Vinciane LE MEN", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },
            { "id": "_w8aar4jmc", "name": "Virginie LONGE", "pole": "Pôle créa.", "photo": "", "tools": [], "note": "" },

            // CRM (existants et ajoutés)
            { "id": "_k8lx8629j", "name": "Yasmine AIT MASKOUR", "pole": "CRM", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/image_compressée (8).jpeg", "tools": ["ChatGPT", "Claude", "Perplexity", "Gemini", "Copilot", "Bard"], "note": "" },
            { "id": "_totdkatk7", "name": "Frédéric CARTON", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_9t6zyl805", "name": "Inès BERNOUX", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_w5fx89vnx", "name": "Noémie ROSSEY", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_meltem", "name": "Meltem SIVLIN", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_nadia", "name": "Nadia CURTO", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_noemie", "name": "Noemie GORISSEN", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_olivier", "name": "Olivier LEIDGENS", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_pierre", "name": "Pierre DUBOIS", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_romain", "name": "Romain LECLERCQ", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_vincent", "name": "Vincent CRABBE", "pole": "CRM", "photo": "", "tools": [], "note": "" },
            { "id": "_new_id_vitold", "name": "Vitold GRAND'HENRY", "pole": "CRM", "photo": "", "tools": [], "note": "" },

            // Communication (existants et ajoutés)
            { "id": "_xhfs9gepa", "name": "Elvis TCHANA", "pole": "Communication", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/test.jpeg", "tools": ["ChatGPT", "Claude"], "note": "" },
            { "id": "_c6418iedx", "name": "Aurore CRABBE", "pole": "Communication", "photo": "", "tools": [], "note": "" },
            { "id": "_ehc0rencs", "name": "Fabienne CULLUS", "pole": "Communication", "photo": "", "tools": [], "note": "" },
            { "id": "_ozmia7jjb", "name": "Marie NAUWELAERTS", "pole": "Communication", "photo": "", "tools": [], "note": "" },
            { "id": "_ixvy7pgyf", "name": "Régine CARPENTIER", "pole": "Communication", "photo": "", "tools": [], "note": "" },

            // Partenariats (existants et ajoutés)
            { "id": "_bkd9howgm", "name": "Naïm EL BOHALI", "pole": "Partenariats", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/image_compressée.jpeg", "tools": ["ChatGPT", "Midjourney", "Firefly", "Bard"], "note": "" },
            { "id": "_ws6aofg2t", "name": "Alinoe VANHAUDENHUYSE", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_ftr3a9zbv", "name": "Catherine CARA", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_p9lgsl1s3", "name": "Dominique CAFFIERS", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_l7evb4oy8", "name": "Fiona KOPEINIG", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_iq4c1roj2", "name": "Isabelle DELENS", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_rxbx2f6ru", "name": "Laura DONATELLO", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_b70wfmd1y", "name": "Marie-Rose ANGE", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },
            { "id": "_wuny9uyhe", "name": "Nathalie DE RIJCKE", "pole": "Partenariats", "photo": "", "tools": [], "note": "" },

            // Marketing digital (existants et ajoutés)
            { "id": "_fx585h9tt", "name": "Elise FONCK", "pole": "Marketing digital", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/image_compressée (9).jpeg", "tools": ["ChatGPT", "Claude", "Gemini", "Copilot"], "note": "" },
            { "id": "_mxb2zohnn", "name": "Gaëlle DEGEYE", "pole": "Marketing digital", "photo": "", "tools": [], "note": "" },
            { "id": "_t5siihk1m", "name": "Mathilde ARMILLAC", "pole": "Marketing digital", "photo": "", "tools": [], "note": "" },
            { "id": "_j7cl9l5ew", "name": "Morgane CARLY", "pole": "Marketing digital", "photo": "", "tools": [], "note": "" },
            { "id": "_infrhxcz2", "name": "Yasmine GHAZOUANE", "pole": "Marketing digital", "photo": "", "tools": [], "note": "" },
            { "id": "_0ifx4haae", "name": "Sara GARCIA", "pole": "Marketing digital", "photo": "", "tools": [], "note": "" },

            // Positionnement (existants et ajoutés)
            { "id": "_69pk2wxd2", "name": "Philippe BLANJEAN", "pole": "Positionnement", "photo": "https://raw.githubusercontent.com/spiresm/IA_marketing/main/uploads/image_compressée (1).jpeg", "tools": ["ChatGPT", "Midjourney", "DALL·E", "Firefly", "Runway ML", "Gemini"], "note": "" },
            { "id": "_w97whz7qy", "name": "Amelie DE LANGE", "pole": "Positionnement", "photo": "", "tools": [], "note": "" },
            { "id": "_9nvt36jt5", "name": "Samuel LALOUX", "pole": "Positionnement", "photo": "", "tools": [], "note": "" }
        ];

        const allTools = [
            "ChatGPT", "Claude", "Midjourney", "Stable Diffusion", "DALL·E", "Firefly",
            "Runway ML", "Gemini", "Copilot", "Sora", "ElevenLabs",
            "Adobe Premiere Pro", "Audacity", "Photoshop", "Illustrator", "Figma"
        ].sort();

        const allChaines = [
            "La Une", "Tipik", "La Trois", "La première", "Classic 21", "vivacité", "Musiq3", "Auvio", "Auvio Kids"
        ].sort();

        const couleursParChaine = {
            'Classic 21': 'purple',
            'La Une': 'red',
            'Tipik': 'green',
            'La Trois': 'mediumorchid',
            'La première': 'blue',
            'vivacité': 'orange',
            'Musiq3': 'hotpink',
            'Auvio': '#000000',
            'Auvio Kids': 'navy'
        };

        const HAS_SEEN_DEMANDES_INFO_MODAL = 'hasSeenDemandesInfoModal';

        // --- Références DOM ---
        const loader = document.getElementById("loader");
        const bodyElement = document.body;
        // mainElement est déjà géré par le sélecteur `main` dans les CSS
        const headerPlaceholder = document.getElementById("header-placeholder");
        const footerPlaceholder = document.getElementById("footer-placeholder");

        const initialInfoModal = document.getElementById("initial-info-modal");
        const comprenezBtn = document.getElementById("comprendaBtn");

        const demandeIAForm = document.getElementById("demandeIA");
        const poleSelect = document.getElementById("poleSelect"); // NOUVEAU
        const nomSelect = document.getElementById("nomSelect"); // Renommé
        const emailPrefixInput = document.querySelector('input[name="emailPrefix"]');
        const besoinSelect = document.getElementById('besoin');
        const productionFields = document.getElementById('production-fields'); // NOUVEAU
        const formationFields = document.getElementById('formation-fields'); // NOUVEAU
        const typeContenuSelect = document.getElementById('typeContenu');
        const supportSelect = document.getElementById('support');
        const chaineSelect = document.getElementById('chaine');
        const outilsSelect = document.getElementById('outils');
        const dureeSelect = document.getElementById('duree');
        const dateInput = document.querySelector('input[name="date"]');
        const descriptionTextarea = document.querySelector('textarea[name="description"]');
        const submitBtn = document.getElementById("submitBtn");

        const recapList = document.getElementById("recapList");
        const filtrePoleRecap = document.getElementById("filtrePoleRecap"); // NOUVEAU
        const filtreNomRecap = document.getElementById("filtreNomRecap"); // NOUVEAU
        const filtreBesoinSelect = document.getElementById("filtreBesoin");
        const filtreParChaineSelect = document.getElementById("filtreParChaine");

        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body");
        const closeModalBtn = document.querySelector("#modal .close-modal");

        const toastContainer = document.getElementById('toast-container');
        let allDemandes = []; // Tableau pour stocker les demandes

        // --- Fonctions utilitaires ---

        async function loadComponent(url, placeholderId) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    // Fallback to static content if fetch fails
                    console.warn(`Could not load ${url}, falling back to static content.`);
                    return; // Don't throw, just let the static content remain
                }
                document.getElementById(placeholderId).innerHTML = await res.text();
                console.log(`Composant ${url} chargé avec succès dans #${placeholderId}.`);
            } catch (error) {
                console.error(`Erreur lors du chargement de ${url}:`, error);
                // Optionally, add a user-facing error message here if the component is critical
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Force reflow for CSS transition
            void toast.offsetWidth;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        }

        function populateFormDropdowns() {
            // Remplir le select des pôles (formulaire)
            const poles = [...new Set(allProfiles.map(p => p.pole))].sort();
            poleSelect.innerHTML = '<option value="">-- Pôle --</option>';
            poles.forEach(pole => {
                poleSelect.add(new Option(pole, pole));
            });

            // Remplir le select des outils (formulaire)
            outilsSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            allTools.forEach(tool => {
                const option = document.createElement('option');
                option.value = tool;
                option.textContent = tool;
                outilsSelect.appendChild(option);
            });

            // Remplir le select des chaînes (formulaire)
            chaineSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            allChaines.forEach(chaine => {
                const option = document.createElement('option');
                option.value = chaine;
                option.textContent = chaine;
                chaineSelect.appendChild(option);
            });

            // Remplir le select des durées (formulaire)
            dureeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            for (let i = 0; i <= 60; i++) {
                const opt = document.createElement("option");
                opt.value = `${i} sec`;
                opt.textContent = `${i} sec`;
                dureeSelect.appendChild(opt);
            }
        }

        function updateNameSelect(targetPoleSelect, targetNameSelect, profilesData) {
            const selectedPole = targetPoleSelect.value;
            targetNameSelect.innerHTML = `<option value="">-- ${targetPoleSelect === poleSelect ? 'Votre nom' : 'Filtrer par nom'} --</option>`;
            targetNameSelect.disabled = !selectedPole;
            if (selectedPole) {
                profilesData.filter(p => p.pole === selectedPole).forEach(p => {
                    targetNameSelect.add(new Option(p.name, p.name));
                });
            }
        }
        
        function toggleFieldsBasedOnBesoin() {
            if (besoinSelect.value === 'formation') {
                productionFields.classList.add('hidden');
                formationFields.classList.remove('hidden');
                
                // Mettre à jour les attributs 'required'
                typeContenuSelect.removeAttribute('required');
                supportSelect.removeAttribute('required');
                chaineSelect.removeAttribute('required');
                dureeSelect.removeAttribute('required');
                outilsSelect.setAttribute('required', 'true');
            } else if (besoinSelect.value === 'production') {
                productionFields.classList.remove('hidden');
                formationFields.classList.add('hidden');

                // Mettre à jour les attributs 'required'
                typeContenuSelect.setAttribute('required', 'true');
                supportSelect.setAttribute('required', 'true');
                chaineSelect.setAttribute('required', 'true');
                dureeSelect.setAttribute('required', 'true');
                outilsSelect.removeAttribute('required');
            } else { // État initial ou si aucune sélection
                productionFields.classList.remove('hidden'); // Afficher production par défaut
                formationFields.classList.add('hidden');

                typeContenuSelect.setAttribute('required', 'true');
                supportSelect.setAttribute('required', 'true');
                chaineSelect.setAttribute('required', 'true');
                dureeSelect.setAttribute('required', 'true');
                outilsSelect.removeAttribute('required');
            }

            // Réinitialiser les valeurs des champs masqués pour éviter d'envoyer des données inutiles
            if (productionFields.classList.contains('hidden')) {
                typeContenuSelect.value = '';
                supportSelect.value = '';
                chaineSelect.value = '';
                dureeSelect.value = '';
            }
            if (formationFields.classList.contains('hidden')) {
                outilsSelect.value = '';
            }
        }

        async function afficherDemandes() {
            recapList.innerHTML = '<p class="loading-text" style="color:#777;">Chargement des demandes...</p>'; /* Message de chargement */

            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`Erreur HTTP! statut: ${res.status}`);
                }
                const responseData = await res.json();

                if (responseData.success && Array.isArray(responseData.data)) {
                    allDemandes = responseData.data;
                } else {
                    console.warn("La réponse de l'API n'est pas un tableau valide ou succès: false. Affichage des demandes vide.");
                    allDemandes = [];
                }
            } catch (err) {
                console.error("Erreur lors de la récupération des demandes :", err);
                recapList.innerHTML = '<p style="color: red; text-align: center;">Erreur lors du chargement des demandes. Vérifiez la console.</p>';
                showToast('Erreur lors du chargement des demandes.', 'error');
                return;
            }

            // Remplir les filtres de pôles et noms (récapitulatif)
            const polesDisponibles = [...new Set(allProfiles.map(p => p.pole))].sort();
            filtrePoleRecap.innerHTML = '<option value="">Filtrer par pôle</option>';
            polesDisponibles.forEach(pole => {
                filtrePoleRecap.add(new Option(pole, pole));
            });
            // Restaurer la valeur sélectionnée pour le filtre pôle
            filtrePoleRecap.value = filtrePoleRecap.dataset.currentValue || '';

            // Mettre à jour le filtre de nom en fonction du pôle sélectionné
            updateNameSelect(filtrePoleRecap, filtreNomRecap, allProfiles);
            // Restaurer la valeur sélectionnée pour le filtre nom
            filtreNomRecap.value = filtreNomRecap.dataset.currentValue || '';

            // Remplir le filtre de besoin
            const besoinsDisponibles = ["production", "formation"].sort();
            filtreBesoinSelect.innerHTML = '<option value="">Filtrer par besoin</option>';
            besoinsDisponibles.forEach(besoin => {
                const option = document.createElement('option');
                option.value = besoin;
                option.textContent = besoin.charAt(0).toUpperCase() + besoin.slice(1);
                filtreBesoinSelect.appendChild(option);
            });
            filtreBesoinSelect.value = filtreBesoinSelect.dataset.currentValue || '';

            // Remplir le filtre de chaîne
            filtreParChaineSelect.innerHTML = '<option value="">Filtrer par chaîne</option>';
            allChaines.forEach(chaine => {
                const option = document.createElement('option');
                option.value = chaine;
                option.textContent = chaine;
                filtreParChaineSelect.appendChild(option);
            });
            filtreParChaineSelect.value = filtreParChaineSelect.dataset.currentValue || '';
            
            let demandesFiltrees = allDemandes;
            const selectedFiltrePole = filtrePoleRecap.value;
            const selectedFiltreNom = filtreNomRecap.value;
            const selectedFiltreBesoin = filtreBesoinSelect.value;
            const selectedFiltreParChaine = filtreParChaineSelect.value;

            if (selectedFiltrePole) {
                demandesFiltrees = demandesFiltrees.filter(d => d.pole === selectedFiltrePole);
            }
            if (selectedFiltreNom) {
                demandesFiltrees = demandesFiltrees.filter(d => d.nom === selectedFiltreNom);
            }
            if (selectedFiltreBesoin) {
                demandesFiltrees = demandesFiltrees.filter(d => d.besoin === selectedFiltreBesoin);
            }
            if (selectedFiltreParChaine) {
                demandesFiltrees = demandesFiltrees.filter(d => d.chaine === selectedFiltreParChaine);
            }
            
            demandesFiltrees.sort((a, b) => new Date(b.date) - new Date(a.date));

            recapList.innerHTML = "";

            if (demandesFiltrees.length === 0) {
                recapList.innerHTML = '<p style="text-align: center; color: #777;">Aucune demande trouvée avec ces critères.</p>';
                return;
            }

            demandesFiltrees.forEach(d => {
                const couleur = couleursParChaine[d.chaine] || "#0077b6";
                const div = document.createElement("div");
                div.className = "ticket";
                div.style.borderLeftColor = couleur;
                
                let typeOuBesoinDisplay = '';
                let detailsComplementaires = '';

                if (d.besoin === 'formation') {
                    typeOuBesoinDisplay = `<span style="font-weight:normal; font-size:0.9em;">Formation</span>`;
                    detailsComplementaires = `<span>Outil(s): ${d.outils || 'N/A'}</span>`;
                } else {
                    typeOuBesoinDisplay = `<span style="font-weight:normal; font-size:0.9em;">${d.typeContenu || 'N/A'}</span>`;
                    detailsComplementaires = `<span>Chaîne: ${d.chaine || 'N/A'} - Durée: ${d.duree || 'N/A'}</span>`;
                }

                div.innerHTML = `
                    <div class="ticket-header">
                        <span>${d.nom || 'N/A'}</span>
                        ${typeOuBesoinDisplay}
                    </div>
                    <div class="ticket-body">
                        <span>Pôle: ${d.pole || 'N/A'}</span><br>
                        ${detailsComplementaires}<br>
                        <span>Date: ${d.date ? new Date(d.date).toLocaleDateString('fr-BE') : 'N/A'}</span><br>
                        <span>Statut: ${d.traite ? '✅ Traité' : '⏳ En attente'}</span>
                    </div>
                    <div class="ticket-actions">
                        ${d.traite ? '' : `<button title="Marquer comme traité" data-id="${d.id}" class="btn-traite">✔️</button>`}
                        <button title="Supprimer" data-id="${d.id}" class="btn-supprimer">🗑️</button>
                    </div>
                `;

                // Écouteurs d'événements pour les boutons du ticket
                div.querySelector(".btn-supprimer")?.addEventListener("click", async e => {
                    e.stopPropagation(); // Empêche l'ouverture de la modale de détails
                    if (confirm("Êtes-vous sûr de vouloir supprimer cette demande ?")) {
                        await supprimerDemande(d.id);
                    }
                });

                div.querySelector(".btn-traite")?.addEventListener("click", async e => {
                    e.stopPropagation(); // Empêche l'ouverture de la modale de détails
                    await marquerTraite(d.id);
                });

                // Écouteur d'événement pour l'ouverture de la modale de détails
                div.addEventListener("click", () => {
                    const formattedDate = d.date ? new Date(d.date).toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';

                    let modalBesoinInfo = `
                        <div class="modal-info-line"><strong>Besoin :</strong> <span>${d.besoin.charAt(0).toUpperCase() + d.besoin.slice(1) || 'N/A'}</span></div>
                    `;
                    let modalDureeInfo = '';

                    if (d.besoin === 'formation') {
                        modalBesoinInfo += `
                            <div class="modal-info-line"><strong>Outil(s) :</strong> <span>${d.outils || 'N/A'}</span></div>
                        `;
                    } else {
                        modalBesoinInfo += `
                            <div class="modal-info-line"><strong>Type de contenu :</strong> <span>${d.typeContenu || 'N/A'}</span></div>
                            <div class="modal-info-line"><strong>Support :</strong> <span>${d.support || 'N/A'}</span></div>
                            <div class="modal-info-line"><strong>Chaîne :</strong> <span>${d.chaine || 'N/A'}</span></div>
                        `;
                        modalDureeInfo = `<div class="modal-info-line"><strong>Durée :</strong> <span>${d.duree || 'N/A'}</span></div>`;
                    }

                    modalBody.innerHTML = `
                        <div class="modal-info-line"><strong>Nom :</strong> <span>${d.nom || 'N/A'}</span></div>
                        <div class="modal-info-line"><strong>Email :</strong> <span>${d.email || 'N/A'}</span></div>
                        <div class="modal-info-line"><strong>Pôle :</strong> <span>${d.pole || 'N/A'}</span></div>
                        ${modalBesoinInfo}
                        ${modalDureeInfo}
                        <div class="modal-info-line"><strong>Date :</strong> <span>${formattedDate}</span></div>
                        <div class="modal-info-line description"><strong>Briefing :</strong> <span>${d.description || 'N/A'}</span></div>
                        <div class="modal-info-line"><strong>Statut :</strong> <span>${d.traite ? '✅ Traité' : '⏳ En attente'}</span></div>
                    `;
                    modal.style.display = "flex";
                });

                recapList.appendChild(div);
            });
        }

        async function supprimerDemande(id) {
            try {
                const response = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "deleteDemande",
                        id: id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message || "Demande supprimée avec succès !", 'success');
                    afficherDemandes(); // Recharger la liste
                } else {
                    console.error("Échec de la suppression (réponse backend) :", result.message);
                    showToast(`Échec de la suppression : ${result.message || "Erreur inconnue."}`, 'error');
                }
            } catch(e) {
                console.error("Erreur lors de la suppression de la demande côté client :", e);
                showToast("Erreur lors de la suppression. Vérifiez la console pour plus de détails.", 'error');
            }
        }

        async function marquerTraite(id) {
            try {
                const response = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "updateDemandeIA",
                        id: id,
                        traite: true
                    })
                });

                const updateResult = await response.json();
                if (updateResult.success) {
                    showToast(updateResult.message || "Demande marquée comme traitée avec succès !", 'success');
                    afficherDemandes(); // Recharger la liste
                } else {
                    console.error("Erreur lors de la mise à jour du statut (réponse backend) :", updateResult.message);
                    showToast(`Échec de la mise à jour : ${updateResult.message || "Erreur inconnue."}`, 'error');
                }
            } catch(e) {
                console.error("Erreur lors du marquage comme traité :", e);
                showToast("Erreur lors du marquage. Voir la console pour plus de détails.", 'error');
            }
        }

        // --- Initialisation au chargement du DOM ---
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Demande IA: DOMContentLoaded, début de l'initialisation...");

            // Vérifie si la modale d'information initiale a déjà été vue.
            const hasSeenDemandesInfoModal = localStorage.getItem(HAS_SEEN_DEMANDES_INFO_MODAL) === 'true';

            if (!hasSeenDemandesInfoModal) {
                initialInfoModal.style.display = 'flex'; // Affiche la modale
            } else {
                initialInfoModal.classList.add('hidden'); // Cache la modale si déjà vue
                initialInfoModal.style.display = 'none'; // S'assure qu'elle est bien invisible
            }

            // Écouteurs d'événements pour la modale d'information initiale
            if (comprenezBtn) {
                comprenezBtn.addEventListener("click", () => {
                    initialInfoModal.classList.add('hidden');
                    initialInfoModal.style.display = "none";
                    localStorage.setItem(HAS_SEEN_DEMANDES_INFO_MODAL, 'true');
                });
            } else {
                console.warn("Bouton 'comprendaBtn' non trouvé pour la modale d'information initiale. Assurez-vous qu'il existe.");
            }

            // 1. Charger les composants principaux (Header et Footer) en parallèle
            // Utilisation d'une promesse.allSettled pour ne pas bloquer si un composant échoue
            await Promise.allSettled([
                loadComponent("header.html", "header-placeholder"),
                loadComponent("footer.html", "footer-placeholder")
            ]);
            
            // 2. Mettre à jour l'état actif du menu après le chargement du header (si le header est chargé dynamiquement)
            const currentPath = window.location.pathname.split('/').pop();
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop() : '';
                if (linkFileName === currentPath || (currentPath === "" && linkFileName === "index.html") || linkFileName === "demandes_ia.html") {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // 3. Remplir les sélecteurs dynamiques du formulaire et des filtres
            populateFormDropdowns(); // Remplir poleSelect, outilsSelect, chaineSelect, dureeSelect
            toggleFieldsBasedOnBesoin(); // Initialise l'affichage des champs production/formation
            
            // 4. Charger et afficher les demandes
            await afficherDemandes(); // Attendre que les demandes soient chargées avant de masquer le loader principal

            // 5. Cacher le loader de démarrage et révéler le contenu principal
            if (loader) {
                loader.classList.add("hidden");
                loader.addEventListener('transitionend', () => {
                    if (loader.classList.contains('hidden')) {
                        loader.style.display = 'none';
                    }
                }, { once: true });
            }
            bodyElement.classList.add("show");
            
            console.log("Demande IA: Initialisation terminée.");

            // --- Écouteurs d'événements pour le formulaire et les filtres de récap ---
            poleSelect.addEventListener('change', () => updateNameSelect(poleSelect, nomSelect, allProfiles));
            besoinSelect.addEventListener('change', toggleFieldsBasedOnBesoin);

            demandeIAForm.addEventListener("submit", async e => {
                e.preventDefault();
                const data = new FormData(e.target);
                const besoin = data.get("besoin");
                const selectedPoleName = poleSelect.value;
                const selectedPole = allProfiles.find(p => p.pole === selectedPoleName);


                const demande = {
                    id: "_" + Math.random().toString(36).substr(2, 9),
                    nom: data.get("nom"), // nomSelect.value
                    email: `${data.get("emailPrefix")}@rtbf.be`,
                    pole: selectedPoleName, // poleSelect.value
                    besoin: besoin,
                    date: data.get("date"),
                    description: data.get("description"),
                    traite: false
                };

                if (besoin === 'formation') {
                    demande.outils = data.get("outils");
                    // S'assurer que les champs de production sont vides pour la formation
                    demande.typeContenu = '';
                    demande.support = '';
                    demande.chaine = '';
                    demande.duree = '';
                } else { // production
                    demande.typeContenu = data.get("typeContenu");
                    demande.support = data.get("support");
                    demande.chaine = data.get("chaine");
                    demande.duree = data.get("duree");
                    // S'assurer que les champs de formation sont vides pour la production
                    demande.outils = '';
                }

                submitBtn.textContent = "Envoi en cours...";
                submitBtn.disabled = true;

                try {
                    const response = await fetch(SEND_REQUEST_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(demande)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Erreur HTTP: ${response.status} ${response.statusText}`, errorText);
                        showToast(`Erreur lors de l'envoi de la demande: ${response.status} ${response.statusText}`, 'error');
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message || "Demande envoyée avec succès !", 'success');
                        e.target.reset(); // Réinitialise le formulaire
                        poleSelect.value = ''; // Réinitialise le select du pôle
                        nomSelect.value = ''; // Réinitialise le select du nom
                        nomSelect.disabled = true; // Désactive le select du nom
                        besoinSelect.value = ''; // Réinitialise le select besoin
                        toggleFieldsBasedOnBesoin(); // Réapplique la logique de visibilité
                        afficherDemandes(); // Met à jour la liste des demandes
                    } else {
                        console.error("Échec de l'envoi (réponse backend) :", result.message);
                        showToast(`Échec de l'envoi : ${result.message || "Erreur inconnue."}`, 'error');
                    }
                } catch (e) {
                    console.error("Erreur lors de l'envoi de la demande côté client :", e);
                    showToast("Erreur lors de l'envoi. Vérifiez la console pour plus de détails.", 'error');
                } finally {
                    submitBtn.textContent = "Envoyer la demande";
                    submitBtn.disabled = false;
                }
            });

            filtrePoleRecap.addEventListener("change", () => {
                filtrePoleRecap.dataset.currentValue = filtrePoleRecap.value; // Stocker la valeur sélectionnée
                updateNameSelect(filtrePoleRecap, filtreNomRecap, allProfiles); // Mettre à jour le select nom du filtre
                filtreNomRecap.value = ''; // Réinitialiser le filtre nom lors du changement de pôle
                filtreNomRecap.dataset.currentValue = ''; // Stocker la valeur vide
                afficherDemandes();
            });

            filtreNomRecap.addEventListener("change", () => {
                filtreNomRecap.dataset.currentValue = filtreNomRecap.value; // Stocker la valeur sélectionnée
                afficherDemandes();
            });

            filtreBesoinSelect.addEventListener("change", () => {
                filtreBesoinSelect.dataset.currentValue = filtreBesoinSelect.value;
                afficherDemandes();
            });
            filtreParChaineSelect.addEventListener("change", () => {
                filtreParChaineSelect.dataset.currentValue = filtreParChaineSelect.value;
                afficherDemandes();
            });

            if (closeModalBtn) {
                closeModalBtn.addEventListener("click", () => {
                    modal.style.display = "none";
                });
            }

            if (modal) {
                modal.addEventListener("click", (e) => {
                    if (e.target.id === "modal") { // Si on clique en dehors du contenu de la modale
                        modal.style.display = "none";
                    }
                });
            }
        });
    </script>
</body>
</html>
