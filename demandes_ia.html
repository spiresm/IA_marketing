<!DOCTYPE html>
<html lang="fr">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Demande IA - Espace IA</title>
Â  <link rel="stylesheet" href="style.css" />
Â  <style>
Â  Â  /* Votre CSS interne, tel que vous l'avez fourni */
Â  Â  body {
Â  Â  Â  opacity: 0;
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: sans-serif;
Â  Â  Â  background-color: #f0f2f5;
Â  Â  Â  transition: opacity 0.3s ease-in;
Â  Â  }
Â  Â  main {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .flex-wrapper {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 20px;
Â  Â  Â  padding: 40px 20px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .container {
Â  Â  Â  flex: 1 1 600px;
Â  Â  Â  max-width: 700px;
Â  Â  Â  background: white;
Â  Â  Â  padding: 40px 35px;
Â  Â  Â  border-radius: 14px;
Â  Â  Â  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
Â  Â  }
Â  Â  form label {
Â  Â  Â  display: block;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #444;
Â  Â  }
Â  Â  form input, form select, form textarea {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 12px 14px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  font-size: 1em;
Â  Â  Â  margin-top: 6px;
Â  Â  Â  background-color: #f9fafb;
Â  Â  }
Â  Â  input[name="emailPrefix"], input[name="date"] {
Â  Â  Â  max-width: 200px;
Â  Â  }
Â  Â  .email-container {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  }
Â  Â  button {
Â  Â  Â  background-color: #0077b6;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 1em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-top: 15px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  background-color: #005f8a;
Â  Â  }
Â  Â  .recap {
Â  Â  Â  flex: 0 1 320px;
Â  Â  Â  background: #f9fafb;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 14px;
Â  Â  Â  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
Â  Â  Â  max-height: 90vh;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â  .recap h3 {
Â  Â  Â  margin-top: 0;
Â  Â  Â  color: #0077b6;
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .ticket {
Â  Â  Â  position: relative;
Â  Â  Â  background: white;
Â  Â  Â  padding: 12px 14px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  border-left: 4px solid #0077b6;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
Â  Â  Â  font-size: 0.95em;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 6px;
Â  Â  }
Â  Â  .ticket span {
Â  Â  Â  display: block;
Â  Â  Â  line-height: 1.4em;
Â  Â  }
Â  Â  #modal {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  Â  background: rgba(0,0,0,0.4);
Â  Â  Â  display: none;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 1000;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 20px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 400px;
Â  Â  Â  position: relative;
Â  Â  Â  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .close-modal {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 10px;
Â  Â  Â  right: 15px;
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  font-size: 1.5em;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="header-placeholder"></div>

Â  <main>
Â  Â  <div class="flex-wrapper">
Â  Â  Â  <div class="container">
Â  Â  Â  Â  <h2 style="text-align:center; color:#0077b6; margin-top: 0;">Formulaire de demande de production IA</h2>
Â  Â  Â  Â  <form id="demandeIA">
Â  Â  Â  Â  Â  <label for="nom">Nom :</label>
Â  Â  Â  Â  Â  <input type="text" name="nom" required />
Â  Â  Â  Â  Â  <label for="emailPrefix">Email :</label>
Â  Â  Â  Â  Â  <div class="email-container">
Â  Â  Â  Â  Â  Â  <input type="text" name="emailPrefix" placeholder="initiales" required />
Â  Â  Â  Â  Â  Â  <span>@rtbf.be</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <label for="type">Type :</label>
Â  Â  Â  Â  Â  <select name="type" required>
Â  Â  Â  Â  Â  Â  <option value="">-- SÃ©lectionner --</option>
Â  Â  Â  Â  Â  Â  <option value="vidÃ©o">VidÃ©o</option>
Â  Â  Â  Â  Â  Â  <option value="audio">Audio</option>
Â  Â  Â  Â  Â  Â  <option value="image">Image</option>
Â  Â  Â  Â  Â  Â  <option value="voix off IA">Voix off IA</option>
Â  Â  Â  Â  Â  Â  <option value="autre">Autre</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <label for="support">Support :</label>
Â  Â  Â  Â  Â  <select name="support" required>
Â  Â  Â  Â  Â  Â  <option value="">-- SÃ©lectionner --</option>
Â  Â  Â  Â  Â  Â  <option value="TV">TV</option>
Â  Â  Â  Â  Â  Â  <option value="Radio">Radio</option>
Â  Â  Â  Â  Â  Â  <option value="Web">Web</option>
Â  Â  Â  Â  Â  Â  <option value="RS">RÃ©seaux sociaux</option>
Â  Â  Â  Â  Â  Â  <option value="autre">Autre</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <label for="chaine">Chaine :</label>
Â  Â  Â  Â  Â  <select name="chaine" required>
Â  Â  Â  Â  Â  Â  <option value="">-- SÃ©lectionner --</option>
Â  Â  Â  Â  Â  Â  <option value="La Une">La Une</option>
Â  Â  Â  Â  Â  Â  <option value="Tipik">Tipik</option>
Â  Â  Â  Â  Â  Â  <option value="La Trois">La Trois</option>
Â  Â  Â  Â  Â  Â  <option value="La premiÃ¨re">La premiÃ¨re</option>
Â  Â  Â  Â  Â  Â  <option value="Classic 21">Classic 21</option>
Â  Â  Â  Â  Â  Â  <option value="vivacitÃ©">vivacitÃ©</option>
Â  Â  Â  Â  Â  Â  <option value="Musiq3">Musiq3</option>
Â  Â  Â  Â  Â  Â  <option value="Auvio">Auvio</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <label for="duree">DurÃ©e :</label>
Â  Â  Â  Â  Â  <select name="duree" id="duree"></select>
Â  Â  Â  Â  Â  <label for="date">Date :</label>
Â  Â  Â  Â  Â  <input type="date" name="date" required />
Â  Â  Â  Â  Â  <label for="description">Briefing :</label>
Â  Â  Â  Â  Â  <textarea name="description" rows="4" required></textarea>
Â  Â  Â  Â  Â  <button type="submit" id="submitBtn">Envoyer</button>
Â  Â  Â  Â  </form>
Â  Â  Â  </div>

Â  Â  Â  <div class="recap">
Â  Â  Â  Â  <h3>RÃ©capitulatif des demandes</h3>
Â  Â  Â  Â  <select id="filtreDuree" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc;">
Â  Â  Â  Â  Â  <option value="">Filtrer par durÃ©e</option>
Â  Â  Â  Â  Â  <option value="10 sec">10 sec</option>
Â  Â  Â  Â  Â  <option value="20 sec">20 sec</option>
Â  Â  Â  Â  Â  <option value="30 sec">30 sec</option>
Â  Â  Â  Â  Â  <option value="40 sec">40 sec</option>
Â  Â  Â  Â  Â  <option value="50 sec">50 sec</option>
Â  Â  Â  Â  Â  <option value="60 sec">60 sec</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input type="text" id="filtreNom" placeholder="Filtrer par nom" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc;" />
Â  Â  Â  Â  <select id="filtreDate" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
Â  Â  Â  Â  Â  <option value="">Trier par date</option>
Â  Â  Â  Â  Â  <option value="asc">Date croissante</option>
Â  Â  Â  Â  Â  <option value="desc">Date dÃ©croissante</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <div id="recapList"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </main>

Â  <div id="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <button class="close-modal" title="Fermer">&times;</button>
Â  Â  Â  <div class="modal-body" id="modal-body"></div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // REMARQUE : L'ID du Google Apps Script n'est PLUS nÃ©cessaire ici car toutes les requÃªtes passent par Netlify Functions.
Â  Â  // const SCRIPT_ID = 'AKfycbzY3tDLyDk_zrl6QV-v79Wt9Y-LDei5QltF0b2g869ahUQrEuXFhblO3YV4d_qKeKQ8';

Â  Â  // DÃ©finitions des URL pour les fonctions Netlify
Â  Â  // PROXY_URL gÃ¨re les GET pour la lecture de la feuille et les POST pour les actions "updateDemandeIA" (suppression/marquage traitÃ©)
Â  Â  const PROXY_URL = "/.netlify/functions/proxy";Â 
Â  Â  // SEND_REQUEST_URL est la fonction unique qui gÃ¨re l'envoi du formulaire (mail + ajout Ã  la feuille)
Â  Â  const SEND_REQUEST_URL = "/.netlify/functions/sendrequest";Â 

Â  Â  function ensureNotifParentPosition() {
Â  Â  Â  const demandeLink = document.querySelector("a.demandes");
Â  Â  Â  if (demandeLink) {
Â  Â  Â  Â  const style = getComputedStyle(demandeLink);
Â  Â  Â  Â  if (style.position === "static" || !style.position) {
Â  Â  Â  Â  Â  demandeLink.style.position = "relative";
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  fetch("header.html")
Â  Â  Â  .then(res => res.text())
Â  Â  Â  .then(data => {
Â  Â  Â  Â  document.getElementById("header-placeholder").innerHTML = data;
Â  Â  Â  Â  ensureNotifParentPosition();
Â  Â  Â  Â  document.body.style.opacity = "1";
Â  Â  Â  Â  document.querySelector("main").style.display = "block";
Â  Â  Â  Â  mettreAJourBulleDemandes(); // AppelÃ© au chargement initial
Â  Â  Â  });

Â  Â  const couleursParChaine = {
Â  Â  Â  'Classic 21': 'purple',
Â  Â  Â  'La Une': 'red',
Â  Â  Â  'Tipik': 'green',
Â  Â  Â  'La premiÃ¨re': 'blue',
Â  Â  Â  'La Trois': 'mediumorchid',
Â  Â  Â  'Auvio': 'black',
Â  Â  Â  'vivacitÃ©': 'orange',
Â  Â  Â  'Musiq3': 'hotpink'
Â  Â  };

Â  Â  async function mettreAJourBulleDemandes() {
Â  Â  Â  const notif = document.getElementById("notif-count");
Â  Â  Â  if (!notif) return;
Â  Â  Â  try {
Â  Â  Â  Â  // Utilise le PROXY pour la lecture des demandes existantes
Â  Â  Â  Â  const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
Â  Â  Â  Â  const demandes = await res.json();
Â  Â  Â  Â  notif.textContent = demandes.length;
Â  Â  Â  Â  notif.style.display = demandes.length > 0 ? "inline-block" : "none";
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erreur compteur :", e);
Â  Â  Â  }
Â  Â  }

Â  Â  async function afficherDemandes() {
Â  Â  Â  const recapList = document.getElementById("recapList");
Â  Â  Â  const filtreNom = document.getElementById("filtreNom").value.toLowerCase();
Â  Â  Â  const filtreDate = document.getElementById("filtreDate").value;
Â  Â  Â  const filtreDuree = document.getElementById("filtreDuree").value;

Â  Â  Â  let demandes = [];
Â  Â  Â  try {
Â  Â  Â  Â  // Utilise le PROXY pour la lecture des demandes existantes
Â  Â  Â  Â  const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
Â  Â  Â  Â  demandes = await res.json();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Erreur rÃ©cupÃ©ration :", err);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  demandes = demandes.filter(d => d.nom.toLowerCase().includes(filtreNom));
Â  Â  Â  if (filtreDuree) demandes = demandes.filter(d => d.duree === filtreDuree);
Â  Â  Â  if (filtreDate === "asc") demandes.sort((a,b) => new Date(a.date) - new Date(b.date));
Â  Â  Â  else if (filtreDate === "desc") demandes.sort((a,b) => new Date(b.date) - new Date(a.date));

Â  Â  Â  recapList.innerHTML = ""; // Ceci est nÃ©cessaire avant d'ajouter les Ã©lÃ©ments

Â  Â  Â  demandes.forEach(d => {
Â  Â  Â  Â  const couleur = couleursParChaine[d.chaine] || "#0077b6";
Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.className = "ticket";
Â  Â  Â  Â  div.style.borderLeftColor = couleur;
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <div style="display:flex; justify-content: space-between; align-items:center">
Â  Â  Â  Â  Â  Â  <span><strong>${d.nom}</strong></span>
Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center; gap:12px;">
Â  Â  Â  Â  Â  Â  Â  <span style="font-size:1.1em; font-weight: bold;">${d.type}</span>
Â  Â  Â  Â  Â  Â  Â  <span>${d.duree}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
Â  Â  Â  Â  Â  Â  <span style="color:${couleur}; font-weight: bold">${d.chaine}</span>
Â  Â  Â  Â  Â  Â  <small style="color:#666;">ğŸ“… ${d.date}</small>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 6px;">
Â  Â  Â  Â  Â  Â  <div>${d.traite ? '<span style="color:green">âœ… TraitÃ©</span>' : '<span style="color:#999">â³ En attente</span>'}</div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  ${d.traite ? '' : `<button title="Marquer comme traitÃ©" data-id="${d.id}" class="btn-traite" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">âœ”ï¸</button>`}
Â  Â  Â  Â  Â  Â  Â  <button title="Supprimer" data-id="${d.id}" class="btn-supprimer" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;

Â  Â  Â  Â  div.querySelector(".btn-supprimer")?.addEventListener("click", async e => {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  await supprimerDemande(d.id);
Â  Â  Â  Â  });

Â  Â  Â  Â  div.querySelector(".btn-traite")?.addEventListener("click", async e => {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  await marquerTraite(d.id);
Â  Â  Â  Â  });

Â  Â  Â  Â  div.addEventListener("click", () => {
Â  Â  Â  Â  Â  const modal = document.getElementById("modal");
Â  Â  Â  Â  Â  const modalBody = document.getElementById("modal-body");
Â  Â  Â  Â  Â  modalBody.textContent = `${d.nom} - ${d.type} - ${d.duree} - ${d.support} - ${d.chaine}
Date : ${d.date}

${d.description}`;
Â  Â  Â  Â  Â  modal.style.display = "flex";
Â  Â  Â  Â  });

Â  Â  Â  Â  recapList.appendChild(div);
Â  Â  Â  });
Â  Â  }

Â  Â  async function supprimerDemande(id) {
Â  Â  Â  try {
Â  Â  Â  Â  // RÃ©cupÃ©rer toutes les demandes (via PROXY)
Â  Â  Â  Â  let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
Â  Â  Â  Â  demandes = demandes.filter(d => d.id !== id);

Â  Â  Â  Â  // Envoyer la mise Ã  jour (via PROXY, qui reliera Ã  GAS)
Â  Â  Â  Â  await fetch(PROXY_URL, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ action: "updateDemandeIA", demandes })
Â  Â  Â  Â  });

Â  Â  Â  Â  afficherDemandes();
Â  Â  Â  Â  mettreAJourBulleDemandes();
Â  Â  Â  } catch(e) {
Â  Â  Â  Â  console.error("Erreur suppression :", e);
Â  Â  Â  }
Â  Â  }

Â  Â  async function marquerTraite(id) {
Â  Â  Â  try {
Â  Â  Â  Â  let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
Â  Â  Â  Â  const demande = demandes.find(d => d.id === id);
Â  Â  Â  Â  if (!demande) return;
Â  Â  Â  Â  demande.traite = true;

Â  Â  Â  Â  // Envoyer la mise Ã  jour (via PROXY, qui reliera Ã  GAS)
Â  Â  Â  Â  await fetch(PROXY_URL, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ action: "updateDemandeIA", demandes })
Â  Â  Â  Â  });

Â  Â  Â  Â  afficherDemandes();
Â  Â  Â  Â  mettreAJourBulleDemandes();
Â  Â  Â  } catch(e) {
Â  Â  Â  Â  console.error("Erreur marquer traitÃ© :", e);
Â  Â  Â  }
Â  Â  }

Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  const dureeSelect = document.getElementById("duree");
Â  Â  Â  for (let i=0; i<=60; i++) {
Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  opt.value = `${i} sec`;
Â  Â  Â  Â  opt.textContent = `${i} sec`;
Â  Â  Â  Â  dureeSelect.appendChild(opt);
Â  Â  Â  }

Â  Â  Â  document.getElementById("demandeIA").addEventListener("submit", async e => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const data = new FormData(e.target);
Â  Â  Â  Â  const demande = {
Â  Â  Â  Â  Â  id: "_" + Math.random().toString(36).substr(2, 9),
Â  Â  Â  Â  Â  nom: data.get("nom"),
Â  Â  Â  Â  Â  email: `${data.get("emailPrefix")}@rtbf.be`,
Â  Â  Â  Â  Â  type: data.get("type"),
Â  Â  Â  Â  Â  support: data.get("support"),
Â  Â  Â  Â  Â  duree: data.get("duree"),
Â  Â  Â  Â  Â  date: data.get("date"),
Â  Â  Â  Â  Â  description: data.get("description"),
Â  Â  Â  Â  Â  chaine: data.get("chaine"),
Â  Â  Â  Â  Â  traite: false
Â  Â  Â  Â  };

Â  Â  Â  Â  // Vous avez commentÃ© le champ d'upload, donc j'assume qu'il n'y a pas d'images Ã  traiter pour l'instant.
Â  Â  Â  Â  // Si vous le dÃ©commentez, il faudra implÃ©menter la lecture des fichiers ici.
Â  Â  Â  Â  // if (document.getElementById('imageUpload')?.files.length > 0) {
Â  Â  Â  Â  //Â  Â  Â const files = Array.from(document.getElementById('imageUpload').files);
Â  Â  Â  Â  //Â  Â  Â demande.images = [];
Â  Â  Â  Â  //Â  Â  Â for (const file of files) {
Â  Â  Â  Â  //Â  Â  Â  Â  Â demande.images.push(await readFileAsBase64(file));
Â  Â  Â  Â  //Â  Â  Â }
Â  Â  Â  Â  // }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // C'EST ICI LA MODIFICATION MAJEURE POUR ENVOYER LE FORMULAIRE VIA sendrequest
Â  Â  Â  Â  Â  const response = await fetch(SEND_REQUEST_URL, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(demande) // Envoyez l'objet 'demande' tel quel Ã  sendrequest.js
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // VÃ©rifiez la rÃ©ponse HTTP avant de tenter de la parser en JSON
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si la rÃ©ponse n'est pas OK (e.g., 404, 500), elle ne contiendra peut-Ãªtre pas de JSON valide.
Â  Â  Â  Â  Â  Â  Â  Â  // Lisez le texte de la rÃ©ponse pour obtenir plus d'informations.
Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await response.text();Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Erreur HTTP: ${response.status} ${response.statusText}`, errorText);
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Erreur lors de l'envoi de la demande: ${response.status} ${response.statusText}. DÃ©tails: ${errorText.substring(0, 200)}... (voir console pour plus)`);
Â  Â  Â  Â  Â  Â  Â  Â  return; // ArrÃªte l'exÃ©cution ici
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Seulement si la rÃ©ponse est OK, essayez de la parser en JSON
Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  if (result.success) { // VÃ©rifie la propriÃ©tÃ© 'success' de la rÃ©ponse JSON de Netlify Function
Â  Â  Â  Â  Â  Â  alert(result.message || "Demande envoyÃ©e avec succÃ¨s et mail transmis !");
Â  Â  Â  Â  Â  Â  e.target.reset();
Â  Â  Â  Â  Â  Â  afficherDemandes(); // RafraÃ®chit le rÃ©capitulatif
Â  Â  Â  Â  Â  Â  mettreAJourBulleDemandes(); // Met Ã  jour le compteur
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Erreur de la fonction Netlify (rÃ©ponse JSON) :", result);
Â  Â  Â  Â  Â  Â  alert(`Erreur lors de l'envoi de la demande: ${result.message || "RÃ©ponse non rÃ©ussie de la fonction Netlify."}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("Erreur d'envoi du formulaire cÃ´tÃ© client :", err);
Â  Â  Â  Â  Â  alert("Une erreur inattendue est survenue lors de l'envoi du formulaire. VÃ©rifiez la console.");
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  document.getElementById("filtreNom").addEventListener("input", afficherDemandes);
Â  Â  Â  document.getElementById("filtreDate").addEventListener("change", afficherDemandes);
Â  Â  Â  document.getElementById("filtreDuree").addEventListener("change", afficherDemandes);

Â  Â  Â  document.querySelector(".close-modal").addEventListener("click", () => {
Â  Â  Â  Â  document.getElementById("modal").style.display = "none";
Â  Â  Â  });
Â  Â  Â  document.getElementById("modal").addEventListener("click", e => {
Â  Â  Â  Â  if (e.target.id === "modal") {
Â  Â  Â  Â  Â  e.target.style.display = "none";
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  afficherDemandes(); // AppelÃ© au chargement initial pour afficher les demandes
Â  Â  Â  mettreAJourBulleDemandes(); // AppelÃ© au chargement initial pour la bulle
Â  Â  });

Â  Â  // Fonction utilitaire pour lire un fichier en Base64 (si vous rÃ©activez l'upload d'images)
Â  Â  /*
Â  Â  function readFileAsBase64(file) {
Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = () => resolve(reader.result);
Â  Â  Â  Â  Â  Â  reader.onerror = error => reject(error);
Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  });
Â  Â  }
Â  Â  */
Â  </script>
</body>
</html>
