

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Demande IA - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* ton CSS inchang√© */
        body {
            opacity: 0;
            margin: 0;
            font-family: sans-serif;
            background-color: #f0f2f5;
            transition: opacity 0.3s ease-in;
        }
        main {
            display: none;
        }
        .flex-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            padding: 40px 20px;
            flex-wrap: wrap;
        }
        .container {
            flex: 1 1 600px;
            max-width: 700px;
            background: white;
            padding: 40px 35px;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        }
        form label {
            display: block;
            margin-top: 20px;
            font-weight: 600;
            color: #444;
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            margin-top: 6px;
            background-color: #f9fafb;
        }
        input[name="emailPrefix"], input[name="date"] {
            max-width: 200px;
        }
        .email-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button {
            background-color: #0077b6;
            color: white;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #005f8a;
        }
        .recap {
            flex: 0 1 320px;
            background: #f9fafb;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            max-height: 90vh;
            overflow-y: auto;
        }
        .recap h3 {
            margin-top: 0;
            color: #0077b6;
            margin-bottom: 10px;
        }
        .ticket {
            position: relative;
            background: white;
            padding: 12px 14px;
            margin-bottom: 12px;
            border-left: 4px solid #0077b6;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            font-size: 0.95em;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .ticket span {
            display: block;
            line-height: 1.4em;
        }
        #modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="flex-wrapper">
            <div class="container">
                <h2 style="text-align:center; color:#0077b6; margin-top: 0;">Formulaire de demande de production IA</h2>
                <form id="demandeIA">
                    <label for="nom">Nom :</label>
                    <input type="text" name="nom" required />

                    <label for="emailPrefix">Email :</label>
                    <div class="email-container">
                        <input type="text" name="emailPrefix" placeholder="initiales" required />
                        <span>@rtbf.be</span>
                    </div>

                    <label for="type">Type :</label>
                    <select name="type" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="vid√©o">Vid√©o</option>
                        <option value="audio">Audio</option>
                        <option value="image">Image</option>
                        <option value="voix off IA">Voix off IA</option>
                        <option value="autre">Autre</option>
                    </select>

                    <label for="support">Support :</label>
                    <select name="support" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="TV">TV</option>
                        <option value="Radio">Radio</option>
                        <option value="Web">Web</option>
                        <option value="RS">R√©seaux sociaux</option>
                        <option value="autre">Autre</option>
                    </select>

                    <label for="chaine">Chaine :</label>
                    <select name="chaine" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="La Une">La Une</option>
                        <option value="Tipik">Tipik</option>
                        <option value="La Trois">La Trois</option>
                        <option value="La premi√®re">La premi√®re</option>
                        <option value="Classic 21">Classic 21</option>
                        <option value="vivacit√©">vivacit√©</option>
                        <option value="Musiq3">Musiq3</option>
                        <option value="Auvio">Auvio</option>
                    </select>

                    <label for="duree">Dur√©e :</label>
                    <select name="duree" id="duree"></select>

                    <label for="date">Date :</label>
                    <input type="date" name="date" required />

                    <label for="description">Briefing :</label>
                    <textarea name="description" rows="4" required></textarea>

                    <button type="submit" id="submitBtn">Envoyer</button>
                </form>
            </div>

            <div class="recap">
                <h3>R√©capitulatif des demandes</h3>
                <select id="filtreDuree" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Filtrer par dur√©e</option>
                    <option value="10 sec">10 sec</option>
                    <option value="20 sec">20 sec</option>
                    <option value="30 sec">30 sec</option>
                    <option value="40 sec">40 sec</option>
                    <option value="50 sec">50 sec</option>
                    <option value="60 sec">60 sec</option>
                </select>
                <input type="text" id="filtreNom" placeholder="Filtrer par nom" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc;" />
                <select id="filtreDate" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Trier par date</option>
                    <option value="asc">Date croissante</option>
                    <option value="desc">Date d√©croissante</option>
                </select>
                <div id="recapList"></div>
            </div>
        </div>
    </main>

    <div id="modal">
        <div class="modal-content">
            <button class="close-modal" title="Fermer">&times;</button>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        // REMARQUE : L'ID du Google Apps Script n'est PLUS n√©cessaire ici car toutes les requ√™tes passent par Netlify Functions.
        // const SCRIPT_ID = 'AKfycbzY3tDLyDk_zrl6QV-v79Wt9Y-LDei5QltF0b2g869ahUQrEuXFhblO3YV4d_qKeKQ8';

        // D√©finitions des URL pour les fonctions Netlify
        // PROXY_URL g√®re les GET pour la lecture de la feuille et les POST pour les actions "updateDemandeIA" (suppression/marquage trait√©)
        const PROXY_URL = "/.netlify/functions/proxy";
        // SEND_REQUEST_URL est la fonction unique qui g√®re l'envoi du formulaire (mail + ajout √† la feuille)
        const SEND_REQUEST_URL = "/.netlify/functions/sendrequest";

        function ensureNotifParentPosition() {
            const demandeLink = document.querySelector("a.demandes");
            if (demandeLink) {
                const style = getComputedStyle(demandeLink);
                if (style.position === "static" || !style.position) {
                    demandeLink.style.position = "relative";
                }
            }
        }

        fetch("header.html")
            .then(res => res.text())
            .then(data => {
                document.getElementById("header-placeholder").innerHTML = data;
                ensureNotifParentPosition();
                document.body.style.opacity = "1";
                document.querySelector("main").style.display = "block";
                mettreAJourBulleDemandes(); // Appel√© au chargement initial
            });

        const couleursParChaine = {
            'Classic 21': 'purple',
            'La Une': 'red',
            'Tipik': 'green',
            'La premi√®re': 'blue',
            'La Trois': 'mediumorchid',
            'Auvio': 'black',
            'vivacit√©': 'orange',
            'Musiq3': 'hotpink'
        };

        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) return;
            try {
                // Utilise le PROXY pour la lecture des demandes existantes
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                const demandes = await res.json();
                notif.textContent = demandes.length;
                notif.style.display = demandes.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur compteur :", e);
            }
        }

        async function afficherDemandes() {
            const recapList = document.getElementById("recapList");
            const filtreNom = document.getElementById("filtreNom").value.toLowerCase();
            const filtreDate = document.getElementById("filtreDate").value;
            const filtreDuree = document.getElementById("filtreDuree").value;

            let demandes = [];
            try {
                // Utilise le PROXY pour la lecture des demandes existantes
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                demandes = await res.json();
            } catch (err) {
                console.error("Erreur r√©cup√©ration :", err);
                return;
            }

            demandes = demandes.filter(d => d.nom.toLowerCase().includes(filtreNom));
            if (filtreDuree) demandes = demandes.filter(d => d.duree === filtreDuree);
            if (filtreDate === "asc") demandes.sort((a,b) => new Date(a.date) - new Date(b.date));
            else if (filtreDate === "desc") demandes.sort((a,b) => new Date(b.date) - new Date(a.date));

            recapList.innerHTML = ""; // Ceci est n√©cessaire avant d'ajouter les √©l√©ments

            demandes.forEach(d => {
                const couleur = couleursParChaine[d.chaine] || "#0077b6";
                const div = document.createElement("div");
                div.className = "ticket";
                div.style.borderLeftColor = couleur;
                div.innerHTML = `
                    <div style="display:flex; justify-content: space-between; align-items:center">
                        <span><strong>${d.nom}</strong></span>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:1.1em; font-weight: bold;">${d.type}</span>
                            <span>${d.duree}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                        <span style="color:${couleur}; font-weight: bold">${d.chaine}</span>
                        <small style="color:#666;">üìÖ ${d.date}</small>
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                        <div>${d.traite ? '<span style="color:green">‚úÖ Trait√©</span>' : '<span style="color:#999">‚è≥ En attente</span>'}</div>
                        <div>
                            ${d.traite ? '' : `<button title="Marquer comme trait√©" data-id="${d.id}" class="btn-traite" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">‚úîÔ∏è</button>`}
                            <button title="Supprimer" data-id="${d.id}" class="btn-supprimer" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;

                div.querySelector(".btn-supprimer")?.addEventListener("click", async e => {
                    e.stopPropagation();
                    await supprimerDemande(d.id);
                });

                div.querySelector(".btn-traite")?.addEventListener("click", async e => {
                    e.stopPropagation();
                    await marquerTraite(d.id);
                });

                div.addEventListener("click", () => {
                    const modal = document.getElementById("modal");
                    const modalBody = document.getElementById("modal-body");
                    modalBody.textContent = `${d.nom} - ${d.type} - ${d.duree} - ${d.support} - ${d.chaine}
Date : ${d.date}

${d.description}`;
                    modal.style.display = "flex";
                });

                recapList.appendChild(div);
            });
        }

        async function supprimerDemande(id) {
            try {
                // R√©cup√©rer toutes les demandes (via PROXY)
                let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
                demandes = demandes.filter(d => d.id !== id);

                // Envoyer la mise √† jour (via PROXY, qui reliera √† GAS)
                await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "updateDemandeIA", demandes })
                });

                afficherDemandes();
                mettreAJourBulleDemandes();
            } catch(e) {
                console.error("Erreur suppression :", e);
            }
        }

        async function marquerTraite(id) {
            try {
                let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
                const demande = demandes.find(d => d.id === id);
                if (!demande) return;
                demande.traite = true;

                // Envoyer la mise √† jour (via PROXY, qui reliera √† GAS)
                await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "updateDemandeIA", demandes })
                });

                afficherDemandes();
                mettreAJourBulleDemandes();
            } catch(e) {
                console.error("Erreur marquer trait√© :", e);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const dureeSelect = document.getElementById("duree");
            for (let i=0; i<=60; i++) {
                const opt = document.createElement("option");
                opt.value = `${i} sec`;
                opt.textContent = `${i} sec`;
                dureeSelect.appendChild(opt);
            }

            document.getElementById("demandeIA").addEventListener("submit", async e => {
                e.preventDefault();
                const data = new FormData(e.target);
                const demande = {
                    id: "_" + Math.random().toString(36).substr(2, 9),
                    nom: data.get("nom"),
                    email: `${data.get("emailPrefix")}@rtbf.be`,
                    type: data.get("type"),
                    support: data.get("support"),
                    duree: data.get("duree"),
                    date: data.get("date"),
                    description: data.get("description"),
                    chaine: data.get("chaine"),
                    traite: false
                };

                // Vous avez comment√© le champ d'upload, donc j'assume qu'il n'y a pas d'images √† traiter pour l'instant.
                // Si vous le d√©commentez, il faudra impl√©menter la lecture des fichiers ici.
                // if (document.getElementById('imageUpload')?.files.length > 0) {
                //      const files = Array.from(document.getElementById('imageUpload').files);
                //      demande.images = [];
                //      for (const file of files) {
                //          demande.images.push(await readFileAsBase64(file));
                //      }
                // }

                try {
                    // C'EST ICI LA MODIFICATION MAJEURE POUR ENVOYER LE FORMULAIRE VIA sendrequest
                    const response = await fetch(SEND_REQUEST_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(demande) // Envoyez l'objet 'demande' tel quel √† sendrequest.js
                    });

                    // V√©rifiez la r√©ponse HTTP avant de tenter de la parser en JSON
                    if (!response.ok) {
                        // Si la r√©ponse n'est pas OK (e.g., 404, 500), elle ne contiendra peut-√™tre pas de JSON valide.
                        // Lisez le texte de la r√©ponse pour obtenir plus d'informations.
                        const errorText = await response.text();
                        console.error(`Erreur HTTP: ${response.status} ${response.statusText}`, errorText);
                        alert(`Erreur lors de l'envoi de la demande: ${response.status} ${response.statusText}. D√©tails: ${errorText.substring(0, 200)}... (voir console pour plus)`);
                        return; // Arr√™te l'ex√©cution ici
                    }

                    // Seulement si la r√©ponse est OK, essayez de la parser en JSON
                    const result = await response.json();

                    if (result.success) { // V√©rifie la propri√©t√© 'success' de la r√©ponse JSON de Netlify Function
                        alert(result.message || "Demande envoy√©e avec succ√®s et mail transmis !");
                        e.target.reset();
                        afficherDemandes(); // Rafra√Æchit le r√©capitulatif
                        mettreAJourBulleDemandes(); // Met √† jour le compteur
                    } else {
                        console.error("Erreur de la fonction Netlify (r√©ponse JSON) :", result);
                        alert(`Erreur lors de l'envoi de la demande: ${result.message || "R√©ponse non r√©ussie de la fonction Netlify."}`);
                    }
                } catch (err) {
                    console.error("Erreur d'envoi du formulaire c√¥t√© client :", err);
                    alert("Une erreur inattendue est survenue lors de l'envoi du formulaire. V√©rifiez la console.");
                }
            });

            document.getElementById("filtreNom").addEventListener("input", afficherDemandes);
            document.getElementById("filtreDate").addEventListener("change", afficherDemandes);
            document.getElementById("filtreDuree").addEventListener("change", afficherDemandes);

            document.querySelector(".close-modal").addEventListener("click", () => {
                document.getElementById("modal").style.display = "none";
            });
            document.getElementById("modal").addEventListener("click", e => {
                if (e.target.id === "modal") {
                    e.target.style.display = "none";
                }
            });

            afficherDemandes(); // Appel√© au chargement initial pour afficher les demandes
            mettreAJourBulleDemandes(); // Appel√© au chargement initial pour la bulle
        });

        // Fonction utilitaire pour lire un fichier en Base64 (si vous r√©activez l'upload d'images)
        /*
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        */
    </script>
</body>
</html>
