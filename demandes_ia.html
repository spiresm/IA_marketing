// Ton HTML/CSS inchangé...

  <script>
    // Insère ici ton script ID Google Apps Script - REMOVED, NOT NEEDED CLIENT SIDE
    // const SCRIPT_ID = 'AKfycbzY3tDLyDk_zrl6QV-v79Wt9Y-LDei5QltF0b2g869ahUQrEuXFhblO3YV4d_qKeKQ8';

    // MODIFIÉ: BASE_URL pointe maintenant vers la fonction Netlify sendrequest
    const BASE_URL_NETLIFY_FUNCTIONS = "/.netlify/functions/"; // Base pour toutes les fonctions Netlify
    const SEND_REQUEST_URL = `${BASE_URL_NETLIFY_FUNCTIONS}sendrequest`; // URL de la fonction d'envoi de la demande
    const PROXY_URL = `${BASE_URL_NETLIFY_FUNCTIONS}proxy`; // URL de la fonction proxy existante pour la lecture


    function ensureNotifParentPosition() {
      const demandeLink = document.querySelector("a.demandes");
      if (demandeLink) {
        const style = getComputedStyle(demandeLink);
        if (style.position === "static" || !style.position) {
          demandeLink.style.position = "relative";
        }
      }
    }

    fetch("header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
        ensureNotifParentPosition();
        document.body.style.opacity = "1";
        document.querySelector("main").style.display = "block";
        mettreAJourBulleDemandes();
      });

    const couleursParChaine = {
      'Classic 21': 'purple',
      'La Une': 'red',
      'Tipik': 'green',
      'La première': 'blue',
      'La Trois': 'mediumorchid',
      'Auvio': 'black',
      'vivacité': 'orange',
      'Musiq3': 'hotpink'
    };

    async function mettreAJourBulleDemandes() {
      const notif = document.getElementById("notif-count");
      if (!notif) return;
      try {
        // UTILISE TOUJOURS LE PROXY POUR LA LECTURE des demandes
        const res = await fetch(`${PROXY_URL}?action=getDemandesIA`); 
        const demandes = await res.json();
        notif.textContent = demandes.length;
        notif.style.display = demandes.length > 0 ? "inline-block" : "none";
      } catch (e) {
        console.error("Erreur compteur :", e);
      }
    }

    async function afficherDemandes() {
      const recapList = document.getElementById("recapList");
      const filtreNom = document.getElementById("filtreNom").value.toLowerCase();
      const filtreDate = document.getElementById("filtreDate").value;
      const filtreDuree = document.getElementById("filtreDuree").value;

      let demandes = [];
      try {
        // UTILISE TOUJOURS LE PROXY POUR LA LECTURE des demandes
        const res = await fetch(`${PROXY_URL}?action=getDemandesIA`); 
        demandes = await res.json();
      } catch (err) {
        console.error("Erreur récupération :", err);
        return;
      }

      demandes = demandes.filter(d => d.nom.toLowerCase().includes(filtreNom));
      if (filtreDuree) demandes = demandes.filter(d => d.duree === filtreDuree);
      if (filtreDate === "asc") demandes.sort((a,b) => new Date(a.date) - new Date(b.date));
      else if (filtreDate === "desc") demandes.sort((a,b) => new Date(b.date) - new Date(a.date));

      recapList.innerHTML = "";

      demandes.forEach(d => {
        const couleur = couleursParChaine[d.chaine] || "#0077b6";
        const div = document.createElement("div");
        div.className = "ticket";
        div.style.borderLeftColor = couleur;
        div.innerHTML = `
          <div style="display:flex; justify-content: space-between; align-items:center">
            <span><strong>${d.nom}</strong></span>
            <div style="display:flex; align-items:center; gap:12px;">
              <span style="font-size:1.1em; font-weight: bold;">${d.type}</span>
              <span>${d.duree}</span>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
            <span style="color:${couleur}; font-weight: bold">${d.chaine}</span>
            <small style="color:#666;">📅 ${d.date}</small>
          </div>
          <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 6px;">
            <div>${d.traite ? '<span style="color:green">✅ Traité</span>' : '<span style="color:#999">⏳ En attente</span>'}</div>
            <div>
              ${d.traite ? '' : `<button title="Marquer comme traité" data-id="${d.id}" class="btn-traite" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">✔️</button>`}
              <button title="Supprimer" data-id="${d.id}" class="btn-supprimer" style="background:none; border:none; font-size:1.1em; cursor:pointer; padding:4px;">🗑️</button>
            </div>
          </div>
        `;

        div.querySelector(".btn-supprimer")?.addEventListener("click", async e => {
          e.stopPropagation();
          await supprimerDemande(d.id);
        });

        div.querySelector(".btn-traite")?.addEventListener("click", async e => {
          e.stopPropagation();
          await marquerTraite(d.id);
        });

        div.addEventListener("click", () => {
          const modal = document.getElementById("modal");
          const modalBody = document.getElementById("modal-body");
          modalBody.textContent = `${d.nom} - ${d.type} - ${d.duree} - ${d.support} - ${d.chaine}
Date : ${d.date}

${d.description}`;
          modal.style.display = "flex";
        });

        recapList.appendChild(div);
      });
    }

    async function supprimerDemande(id) {
      try {
        // Récupérer toutes les demandes (via proxy)
        let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
        demandes = demandes.filter(d => d.id !== id);

        // Envoyer la mise à jour (via sendrequest, qui reliera à GAS)
        await fetch(SEND_REQUEST_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "updateDemandeIA", demandes })
        });

        afficherDemandes();
        mettreAJourBulleDemandes();
      } catch(e) {
        console.error("Erreur suppression :", e);
      }
    }

    async function marquerTraite(id) {
      try {
        let demandes = await (await fetch(`${PROXY_URL}?action=getDemandesIA`)).json();
        const demande = demandes.find(d => d.id === id);
        if (!demande) return;
        demande.traite = true;

        // Envoyer la mise à jour (via sendrequest, qui reliera à GAS)
        await fetch(SEND_REQUEST_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "updateDemandeIA", demandes })
        });

        afficherDemandes();
        mettreAJourBulleDemandes();
      } catch(e) {
        console.error("Erreur marquer traité :", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const dureeSelect = document.getElementById("duree");
      for (let i=0; i<=60; i++) {
        const opt = document.createElement("option");
        opt.value = `${i} sec`;
        opt.textContent = `${i} sec`;
        dureeSelect.appendChild(opt);
      }

      document.getElementById("demandeIA").addEventListener("submit", async e => {
        e.preventDefault();
        const data = new FormData(e.target);
        const demande = {
          id: "_" + Math.random().toString(36).substr(2, 9),
          nom: data.get("nom"),
          email: `${data.get("emailPrefix")}@rtbf.be`,
          type: data.get("type"),
          support: data.get("support"),
          duree: data.get("duree"),
          date: data.get("date"),
          description: data.get("description"),
          chaine: data.get("chaine"),
          traite: false
        };

        try {
          // MODIFIÉ: UN SEUL APPEL À LA FONCTION NETLIFY sendrequest
          // Cette fonction (sendrequest) se chargera d'envoyer l'e-mail ET de relayer à Google Apps Script.
          const response = await fetch(SEND_REQUEST_URL, { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // L'objet 'demande' contient toutes les données.
            // La fonction sendrequest saura quoi en faire (e-mail + envoi à GAS avec action "updateDemandeIA")
            body: JSON.stringify(demande) // Envoyez l'objet demande directement
          });

            const result = await response.json();

          if (response.ok) {
            alert(result.message || "Demande envoyée avec succès et mail transmis !");
            e.target.reset();
            afficherDemandes();
            mettreAJourBulleDemandes();
          } else {
            console.error("Erreur de la fonction Netlify :", result);
            alert(`Erreur lors de l'envoi de la demande: ${result.message || response.statusText}`);
          }
        } catch (err) {
          console.error("Erreur d'envoi du formulaire côté client :", err);
          alert("Une erreur inattendue est survenue lors de l'envoi du formulaire.");
        }
      });

      document.getElementById("filtreNom").addEventListener("input", afficherDemandes);
      document.getElementById("filtreDate").addEventListener("change", afficherDemandes);
      document.getElementById("filtreDuree").addEventListener("change", afficherDemandes);

      document.querySelector(".close-modal").addEventListener("click", () => {
        document.getElementById("modal").style.display = "none";
      });
      document.getElementById("modal").addEventListener("click", e => {
        if (e.target.id === "modal") {
          e.target.style.display = "none";
        }
      });

      afficherDemandes();
      mettreAJourBulleDemandes();
    });
  </script>
</body>
</html>
