<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Demande IA - Espace IA</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CSS unifié pour l'ensemble du site */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --grey-text: #555;
            --border-color: #ddd;
        }

        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-grey);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            padding: 40px 20px;
            flex-grow: 1;
        }

        /* --- Barre de Navigation --- */
        .nav-wrapper {
            background-color: var(--primary-blue);
            width: 100%;
            position: relative;
            flex-shrink: 0;
            padding: 5px 0;
        }

        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 30px;
            box-sizing: border-box;
        }

        nav {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        nav a {
            text-decoration: none;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            padding: 10px 18px;
            border-radius: 8px;
            transition: background 0.3s ease;
            margin: 0 5px;
            white-space: nowrap;
            position: relative;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        nav a.active {
            background-color: white;
            color: var(--primary-blue);
        }
        
        .notif-bubble {
            position: absolute; top: 0px; right: 0px; background: red; color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold;
            display: none;
        }

        /* --- Conteneur principal --- */
        .main-container {
            max-width: 960px;
            margin: 25px auto;
            padding: 25px;
            box-sizing: border-box;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .flex-wrapper {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        /* --- Styles du Formulaire --- */
        .form-container {
            flex: 2;
        }
        .form-container h2 {
            text-align: center;
            color: var(--dark-blue);
            margin-top: 0;
            margin-bottom: 20px;
        }
        form label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--grey-text);
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            background-color: #f9fafb;
            box-sizing: border-box;
        }
        .email-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .email-container input {
            max-width: 200px;
        }
        button[type="submit"] {
            width: 100%;
            background-color: var(--primary-blue);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button[type="submit"]:hover:not(:disabled) {
            background-color: var(--dark-blue);
        }
        button[type="submit"]:disabled {
             background-color: #a0a0a0;
             cursor: not-allowed;
        }
        
        /* --- Styles du Récapitulatif --- */
        .recap-container {
            flex: 1;
            background: #f0f2f5;
            padding: 20px;
            border-radius: 12px;
            color: var(--dark-blue);
            align-self: stretch;
        }
        .recap-container h3 {
            margin-top: 0;
            text-align: center;
        }
        .recap-container select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .ticket {
            background: white;
            color: var(--grey-text);
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid var(--primary-blue);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .ticket-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .ticket-body {
            font-size: 0.9em;
            margin-top: 5px;
            color: #777;
        }
        
        /* --- Styles de la Modale --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 10px; right: 15px;
            background: none; border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #888;
        }
        
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            width: 100%;
        }

        @media (max-width: 800px) {
            .flex-wrapper {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div class="nav-wrapper">
        <div class="menu-container">
            <nav>
                <a href="index.html">Accueil</a>
                <a href="equipe.html">Équipe</a>
                <a href="outils.html">Outils</a>
                <a href="galerie.html">Prompts</a>
                <a href="cas-usages.html">Workflows</a>
                <a href="charte.html">Chartes</a>
                <a href="faq.html">FAQ</a>
                <a href="demandes_ia.html" class="active">Demandes<span class="notif-bubble" id="notif-count"></span></a>
                <a href="gestion-license.html">Licenses</a>
            </nav>
        </div>
    </div>

    <main>
        <div class="main-container">
            <div class="flex-wrapper">
                <div class="form-container">
                    <h2>Formulaire de demande</h2>
                    <form id="demandeIA">
                        <label for="nom">Votre Nom :</label>
                        <select name="nom" id="nom" required></select>
                        <label for="emailPrefix">Votre Email :</label>
                        <div class="email-container">
                            <input type="text" name="emailPrefix" placeholder="initiales" required />
                            <span>@rtbf.be</span>
                        </div>
                        <label for="besoin">Type de besoin :</label>
                        <select name="besoin" id="besoin" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="production">Production</option>
                            <option value="formation">Formation</option>
                        </select>
                        <div id="production-fields">
                             <label for="typeContenu">Type de contenu :</label>
                             <select name="typeContenu" id="typeContenu">
                                 <option value="">-- Sélectionner --</option>
                                 <option value="vidéo">Vidéo</option>
                                 <option value="audio">Audio</option>
                                 <option value="image">Image</option>
                                 <option value="voix off IA">Voix off IA</option>
                                 <option value="autre">Autre</option>
                             </select>
                             <label for="chaine">Chaîne :</label>
                             <select name="chaine" id="chaine">
                                 <option value="">-- Sélectionner --</option>
                                 <option value="La Une">La Une</option>
                                 <option value="Tipik">Tipik</option>
                             </select>
                        </div>
                        <div id="formation-fields">
                             <label for="outils">Outil(s) souhaité(s) :</label>
                             <select name="outils" id="outils"></select>
                        </div>
                        <label for="date">Date de besoin :</label>
                        <input type="date" name="date" required />
                        <label for="description">Briefing détaillé :</label>
                        <textarea name="description" rows="5" required></textarea>
                        <button type="submit" id="submitBtn">Envoyer la demande</button>
                    </form>
                </div>
                <div class="recap-container">
                    <h3>Récapitulatif des demandes</h3>
                    <select id="filtreNom"><option value="">Filtrer par nom</option></select>
                    <select id="filtreBesoin"><option value="">Filtrer par besoin</option></select>
                    <select id="filtreChaine"><option value="">Filtrer par chaîne</option></select>
                    <div id="recapList"><p style="text-align:center; opacity:0.7;">Chargement...</p></div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer-placeholder">
        <p>&copy; 2025 Espace IA. Tous droits réservés.</p>
    </footer>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const API_URL = "/.netlify/functions/demandes"; // Endpoint unique pour toutes les actions
        let allDemandes = [];

        // --- Références DOM ---
        const demandeIAForm = document.getElementById("demandeIA");
        const recapList = document.getElementById("recapList");
        const nomSelect = document.getElementById("nom");
        const besoinSelect = document.getElementById('besoin');
        const productionFields = document.getElementById('production-fields');
        const formationFields = document.getElementById('formation-fields');
        const filtreNomSelect = document.getElementById('filtreNom');
        const filtreBesoinSelect = document.getElementById('filtreBesoin');
        const filtreChaineSelect = document.getElementById('filtreChaine');
        
        // --- Données initiales (peut être remplacé par un fetch si nécessaire) ---
        const allProfiles = [ { "name": "Steeve PIRES MADEIRA" }, { "name": "Yasmine AIT MASKOUR" }, { name: "Sabrina LECLERCQ" }, { name: "Joel VAN HOEF"} /* etc. */ ].sort((a,b) => a.name.localeCompare(b.name));
        const allTools = [ "ChatGPT", "Claude", "Midjourney", "Firefly", "Runway ML", "ElevenLabs" ].sort();
        const allChaines = ["La Une", "Tipik", "La Trois", "La première", "Classic 21", "Vivacité", "Musiq3", "Auvio", "Auvio Kids"].sort();

        // --- Fonctions ---
        function populateDropdowns() {
            // Noms
            nomSelect.innerHTML = '<option value="">-- Sélectionner votre nom --</option>';
            filtreNomSelect.innerHTML = '<option value="">Filtrer par nom</option>';
            allProfiles.forEach(({ name }) => {
                nomSelect.add(new Option(name, name));
                filtreNomSelect.add(new Option(name, name));
            });

            // Outils
            const outilsSelect = document.getElementById('outils');
            outilsSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            allTools.forEach(tool => outilsSelect.add(new Option(tool, tool)));
            
            // Chaînes
            const chaineSelect = document.getElementById('chaine');
            chaineSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            filtreChaineSelect.innerHTML = '<option value="">Filtrer par chaîne</option>';
            allChaines.forEach(chaine => {
                 chaineSelect.add(new Option(chaine, chaine));
                 filtreChaineSelect.add(new Option(chaine, chaine));
            });
        }
        
        function toggleFieldsBasedOnBesoin() {
            const besoin = besoinSelect.value;
            productionFields.style.display = besoin === 'production' ? 'block' : 'none';
            formationFields.style.display = besoin === 'formation' ? 'block' : 'none';
            // Gérer l'attribut 'required' pour la validation
            document.querySelectorAll('#production-fields select').forEach(el => el.required = (besoin === 'production'));
            document.querySelector('#formation-fields select').required = (besoin === 'formation');
        }

        async function afficherDemandes() {
            recapList.innerHTML = '<p style="text-align:center; opacity:0.7;">Chargement...</p>';
            try {
                const response = await fetch(`${API_URL}?action=get`);
                if (!response.ok) throw new Error("Erreur de chargement des demandes.");
                allDemandes = await response.json();
                
                renderDemandes();
            } catch (error) {
                recapList.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
            }
        }

        function renderDemandes() {
            const filtreNom = filtreNomSelect.value;
            const filtreBesoin = filtreBesoinSelect.value;
            const filtreChaine = filtreChaineSelect.value;

            const demandesFiltrees = allDemandes.filter(d => {
                const nomMatch = !filtreNom || d.nom === filtreNom;
                const besoinMatch = !filtreBesoin || d.besoin === filtreBesoin;
                const chaineMatch = !filtreChaine || d.chaine === filtreChaine;
                return nomMatch && besoinMatch && chaineMatch;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            recapList.innerHTML = '';
            if (demandesFiltrees.length === 0) {
                recapList.innerHTML = '<p style="text-align:center; opacity:0.7;">Aucune demande correspondante.</p>';
                return;
            }

            demandesFiltrees.forEach(demande => {
                const ticket = document.createElement('div');
                ticket.className = 'ticket';
                ticket.innerHTML = `
                    <div class="ticket-header">
                        <span>${demande.nom}</span>
                        <span>${demande.besoin === 'production' ? demande.typeContenu : 'Formation'}</span>
                    </div>
                    <div class="ticket-body">
                        ${new Date(demande.date).toLocaleDateString('fr-FR')} - ${demande.traite ? '✅ Traité' : '⏳ En attente'}
                    </div>`;
                // Ajouter ici les event listeners pour la modale, suppression, etc.
                recapList.appendChild(ticket);
            });
        }
        
        // --- Initialisation et Écouteurs d'Événements ---
        populateDropdowns();
        toggleFieldsBasedOnBesoin();
        afficherDemandes();
        
        besoinSelect.addEventListener('change', toggleFieldsBasedOnBesoin);
        [filtreNomSelect, filtreBesoinSelect, filtreChaineSelect].forEach(filtre => {
            filtre.addEventListener('change', renderDemandes);
        });
        
        demandeIAForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             // Ajouter ici la logique de soumission du formulaire
             console.log("Formulaire soumis !");
        });
    });
    </script>
</body>
</html>
