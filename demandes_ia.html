<!-- ...header et nav identiques... -->

<div class="container">
  <h2>Formulaire de demande de production IA</h2>
  <form id="demandeIA" enctype="multipart/form-data">
    <!-- ...autres champs... -->
    <label>Images de référence :
      <input type="file" name="reference" accept="image/*" multiple>
    </label>
    <!-- ...autres champs... -->
    <button type="submit" id="submitBtn">Envoyer la demande</button>
  </form>
  <p id="confirmation"></p>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const select = document.getElementById("duree");
    for (let i = 0; i <= 60; i++) {
      const opt = document.createElement("option");
      opt.value = `${i} sec`;
      opt.textContent = `${i} sec`;
      select.appendChild(opt);
    }

    const form = document.getElementById("demandeIA");
    const button = document.getElementById("submitBtn");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      button.disabled = true;
      button.textContent = "Envoi...";

      const formData = new FormData(form);
      const files = form.querySelector('input[name="reference"]').files;
      const imagesBase64 = [];

      const emailPrefix = formData.get("emailPrefix").trim();
      const fullEmail = emailPrefix + "@rtbf.be";

      const data = {
        nom: formData.get("nom"),
        email: fullEmail,
        type: formData.get("type"),
        support: formData.get("support"),
        duree: formData.get("duree"),
        date: formData.get("date"),
        description: formData.get("description"),
        images: []
      };

      if (files.length > 0) {
        let loaded = 0;
        for (let file of files) {
          const reader = new FileReader();
          reader.onload = () => {
            imagesBase64.push(reader.result);
            loaded++;
            if (loaded === files.length) {
              data.images = imagesBase64;
              sendData(data);
            }
          };
          reader.onerror = () => alert("Erreur de lecture d’image.");
          reader.readAsDataURL(file);
        }
      } else {
        sendData(data);
      }

      async function sendData(payload) {
        try {
          const res = await fetch("/.netlify/functions/sendRequest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          try {
            const result = JSON.parse(text);
            document.getElementById("confirmation").textContent = result.message;
          } catch {
            document.getElementById("confirmation").textContent = "Erreur inconnue.";
          }
        } catch (err) {
          alert("Échec d'envoi : " + err.message);
        } finally {
          button.disabled = false;
          button.textContent = "Envoyer la demande";
        }
      }
    });
  });
</script>
