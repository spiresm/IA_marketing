const apiBase = window.location.origin + '/.netlify/functions/';
let allTips = [];
const galerieDiv = document.getElementById('galerie');
const errorDisplay = document.getElementById('error-display');
const filtreAuteurSelect = document.getElementById('filtre-auteur');
const filtreCategorieSelect = document.getElementById('filtre-categorie');
const filtreOutilSelect = document.getElementById('filtre-outil');

const previewTextInput = document.getElementById('preview-text');

const previewPanel = document.getElementById('previewPanel');
const previewPanelTitle = document.getElementById('previewPanelTitle');
const previewPanelContent = document.getElementById('previewPanelContent');
const closePreviewBtn = document.getElementById('closePreviewBtn');
const bodyElement = document.body;

document.addEventListener("DOMContentLoaded", () => {
    const headerPlaceholder = document.getElementById("header-placeholder");
    const footerPlaceholder = document.getElementById("footer-placeholder");
    const mainElement = document.querySelector("main");

    const loadComponent = async (url, placeholderId, errorMessage) => {
        console.log(`Attempting to load ${url} into #${placeholderId}`);
        try {
            const res = await fetch(url);
            if (!res.ok) {
                const errorDetail = await res.text();
                throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}. URL: ${url}. Response: ${errorDetail.substring(0, 200)}...`);
            }
            document.getElementById(placeholderId).innerHTML = await res.text();
            console.log(`${url} loaded successfully.`);
        } catch (error) {
            console.error(`Error loading ${url}:`, error);
            document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
        }
    };

    Promise.all([
        loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu"),
        loadComponent("footer.html", "footer-placeholder", "Erreur de chargement du pied de page")
    ])
    .then(() => {
        const activeLink = document.querySelector("nav a[href='galerie.html']");
        if (activeLink) {
            activeLink.classList.add("active");
        }
    })
    .catch(error => {
        console.error("General issue loading components:", error);
    })
    .finally(() => {
        bodyElement.classList.add("show");
        mainElement.classList.add("show");
        loadAndDisplayTips(); // Ceci doit se produire après le chargement des composants
    });

    if (window.location.search.includes('success=1')) {
        const msg = document.getElementById('success-message');
        msg.textContent = '✅ Tip/Prompt partagé avec succès vers la galerie !';
        msg.style.opacity = '1';
        setTimeout(() => msg.style.opacity = '0', 2000);
        setTimeout(() => window.history.replaceState(null, '', window.location.pathname), 2500);
    }

    // Le setupFilters sera appelé après le chargement des tips pour peupler les options
    // setupFilters();

    // --- Logique d'affichage de la bulle d'information (forcée à chaque chargement) ---
    const infoBubbleOverlay = document.getElementById("info-bubble-overlay");
    const infoBubbleCloseBtn = document.getElementById("info-bubble-close-btn");
    
    // Force la bulle à apparaître à chaque chargement pour le développement
    const hasSeenInfoBubble = false; 

    if (!hasSeenInfoBubble) {
        infoBubbleOverlay.classList.add('visible');
    }

    infoBubbleCloseBtn.addEventListener('click', () => {
        infoBubbleOverlay.classList.remove('visible');
        // localStorage.setItem('hasSeenGalerieInfoBubble', 'true'); // Commenté pour réapparition constante
    });

    // Optionnel: fermer la bulle si l'utilisateur clique en dehors d'elle
    infoBubbleOverlay.addEventListener('click', (event) => {
        if (event.target === infoBubbleOverlay) {
            infoBubbleOverlay.classList.remove('visible');
            // localStorage.setItem('hasSeenGalerieInfoBubble', 'true'); // Également commenté
        }
    });
    // --- Fin de la logique de la bulle d'information ---
});

// --- NOUVELLE FONCTION OU MODIFICATION DE LA FONCTION EXISTANTE POUR CRÉER UNE CARTE ---
function createTipCard(tip) {
    const carteDiv = document.createElement('div');
    carteDiv.className = 'carte';
    carteDiv.style.borderLeftColor = tip.couleurBordure || '#0077b6'; // Utilise une couleur par défaut si non définie

    const leftPanel = document.createElement('div');
    leftPanel.className = 'left-panel';

    // *** C'EST ICI QUE L'IMAGE EST AJOUTÉE À LA CARTE DE LA GALERIE ***
    if (tip.imageUrl) {
        const img = document.createElement('img');
        img.className = 'carte-image';
        img.src = tip.imageUrl;
        img.alt = `Image pour ${tip.titre || 'ce tip'}`;
        leftPanel.appendChild(img);
    } else {
        // Optionnel: Afficher un placeholder ou une icône si aucune image n'est disponible
        const placeholderDiv = document.createElement('div');
        placeholderDiv.style.width = '100%';
        placeholderDiv.style.height = '100%';
        placeholderDiv.style.backgroundColor = '#e0e0e0';
        placeholderDiv.style.display = 'flex';
        placeholderDiv.style.justifyContent = 'center';
        placeholderDiv.style.alignItems = 'center';
        placeholderDiv.style.color = '#777';
        placeholderDiv.style.fontSize = '0.8em';
        placeholderDiv.textContent = 'Pas d\'image';
        leftPanel.appendChild(placeholderDiv);
    }
    // ******************************************************************

    carteDiv.appendChild(leftPanel);

    const infosWrapper = document.createElement('div');
    infosWrapper.className = 'infos-wrapper';

    // Titre du tip
    const title = document.createElement('h4');
    title.className = 'tip-title';
    title.textContent = tip.titre;
    infosWrapper.appendChild(title);

    // Badge Outil
    if (tip.outil) {
        const outilBadge = document.createElement('span');
        outilBadge.className = 'outil-badge';
        outilBadge.textContent = tip.outil;
        infosWrapper.appendChild(outilBadge);
    }

    // Section Métadonnées
    const metadataSection = document.createElement('div');
    metadataSection.className = 'metadata-section';

    if (tip.auteur) {
        const auteurLabel = document.createElement('span');
        auteurLabel.className = 'metadata-label';
        auteurLabel.textContent = 'Auteur :';
        metadataSection.appendChild(auteurLabel);
        const auteurValue = document.createElement('span');
        auteurValue.className = 'metadata-value auteur-value';
        auteurValue.textContent = tip.auteur;
        metadataSection.appendChild(auteurValue);
    }

    if (tip.categorie) {
        const categorieLabel = document.createElement('span');
        categorieLabel.className = 'metadata-label';
        categorieLabel.textContent = 'Catégorie :';
        metadataSection.appendChild(categorieLabel);
        const categorieValue = document.createElement('span');
        categorieValue.className = 'metadata-value';
        categorieValue.textContent = tip.categorie;
        metadataSection.appendChild(categorieValue);
    }
    infosWrapper.appendChild(metadataSection);

    // Texte de prévisualisation (post-it)
    if (tip.previewText) {
        const previewPostIt = document.createElement('div');
        previewPostIt.className = 'preview-post-it';
        previewPostIt.textContent = tip.previewText;
        infosWrapper.appendChild(previewPostIt);
    }

    // Boutons d'action sur la carte
    const cardActions = document.createElement('div');
    cardActions.className = 'card-actions';

    const topButtonsGroup = document.createElement('div');
    topButtonsGroup.className = 'top-buttons-group';

    // Bouton Aperçu
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-content-btn';
    toggleBtn.textContent = 'Aperçu';
    toggleBtn.addEventListener('click', () => openPreviewPanel(tip));
    topButtonsGroup.appendChild(toggleBtn);

    // Bouton Copier le prompt (sur la carte, si un prompt existe)
    if (tip.prompt) {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copier-btn';
        copyBtn.textContent = 'Copier le prompt';
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(tip.prompt)
                .then(() => {
                    copyBtn.textContent = 'Copié !';
                    setTimeout(() => copyBtn.textContent = 'Copier le prompt', 2000);
                })
                .catch(err => console.error('Erreur de copie:', err));
        });
        topButtonsGroup.appendChild(copyBtn);
    }

    cardActions.appendChild(topButtonsGroup);

    // Bouton Supprimer (Corbeille)
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'supprimer-btn';
    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
    deleteBtn.title = 'Supprimer le tip';
    deleteBtn.addEventListener('click', () => deleteTip(tip._id)); // Assurez-vous que tip._id est disponible
    cardActions.appendChild(deleteBtn);

    infosWrapper.appendChild(cardActions);
    carteDiv.appendChild(infosWrapper);

    return carteDiv;
}

// --- Fonctions existantes ou à compléter ---

async function loadAndDisplayTips() {
    galerieDiv.innerHTML = '<div class="loader"></div> <p style="text-align: center;">Chargement des tips...</p>';
    errorDisplay.style.display = 'none';

    try {
        const response = await fetch(`${apiBase}get-tips`);
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status} ${response.statusText}`);
        }
        allTips = await response.json();
        console.log("Tips chargés:", allTips); // Vérifiez les données ici

        displayTips(allTips); // Affiche tous les tips au début
        populateFilters(); // Remplir les filtres après le chargement des tips
        setupFilters(); // Configure les écouteurs d'événements pour les filtres
    } catch (error) {
        console.error("Erreur lors du chargement des tips:", error);
        galerieDiv.innerHTML = ''; // Enlève le loader
        errorDisplay.textContent = `Impossible de charger les tips : ${error.message}`;
        errorDisplay.style.display = 'block';
    }
}

function displayTips(tipsToDisplay) {
    galerieDiv.innerHTML = ''; // Vide la galerie actuelle
    if (tipsToDisplay.length === 0) {
        galerieDiv.innerHTML = '<p style="text-align: center; color: #555;">Aucun tip ne correspond à votre recherche.</p>';
        return;
    }
    tipsToDisplay.forEach(tip => {
        const card = createTipCard(tip); // Utilise la nouvelle fonction
        galerieDiv.appendChild(card);
    });
}

function populateFilters() {
    const auteurs = new Set();
    const categories = new Set();
    const outils = new Set(); // S'assurer que 'outil' est géré

    allTips.forEach(tip => {
        if (tip.auteur) auteurs.add(tip.auteur);
        if (tip.categorie) categories.add(tip.categorie);
        if (tip.outil) outils.add(tip.outil); // Ajout de l'outil
    });

    filtreAuteurSelect.innerHTML = '<option value="">Tous les auteurs</option>';
    Array.from(auteurs).sort().forEach(auteur => {
        const option = document.createElement('option');
        option.value = auteur;
        option.textContent = auteur;
        filtreAuteurSelect.appendChild(option);
    });

    // Ne pas vider et recréer les options de catégorie si elles sont fixes dans le HTML
    // Si elles sont dynamiques, décommentez la ligne ci-dessous et adaptez
    // filtreCategorieSelect.innerHTML = '<option value="">Toutes les catégories</option>';
    // Array.from(categories).sort().forEach(cat => {
    //     const option = document.createElement('option');
    //     option.value = cat;
    //     option.textContent = cat;
    //     filtreCategorieSelect.appendChild(option);
    // });

    filtreOutilSelect.innerHTML = '<option value="">Tous les outils</option>';
    Array.from(outils).sort().forEach(outil => {
        const option = document.createElement('option');
        option.value = outil;
        option.textContent = outil;
        filtreOutilSelect.appendChild(option);
    });
}

function setupFilters() {
    const applyFilters = () => {
        const searchText = previewTextInput.value.toLowerCase();
        const selectedCategory = filtreCategorieSelect.value;
        const selectedAuthor = filtreAuteurSelect.value;
        const selectedTool = filtreOutilSelect.value; // Nouvelle variable

        const filteredTips = allTips.filter(tip => {
            const matchesText = !searchText ||
                (tip.previewText && tip.previewText.toLowerCase().includes(searchText)) ||
                (tip.titre && tip.titre.toLowerCase().includes(searchText)) ||
                (tip.description && tip.description.toLowerCase().includes(searchText)) ||
                (tip.prompt && tip.prompt.toLowerCase().includes(searchText));

            const matchesCategory = !selectedCategory || tip.categorie === selectedCategory;
            const matchesAuthor = !selectedAuthor || tip.auteur === selectedAuthor;
            const matchesTool = !selectedTool || tip.outil === selectedTool; // Nouveau filtre

            return matchesText && matchesCategory && matchesAuthor && matchesTool;
        });
        displayTips(filteredTips);
    };

    previewTextInput.addEventListener('input', applyFilters);
    filtreCategorieSelect.addEventListener('change', applyFilters);
    filtreAuteurSelect.addEventListener('change', applyFilters);
    filtreOutilSelect.addEventListener('change', applyFilters); // Écouteur pour le nouveau filtre
}


function openPreviewPanel(tip) {
    previewPanelTitle.textContent = `Aperçu : ${tip.titre || 'Sans titre'}`;
    previewPanelContent.innerHTML = '';

    // L'image dans le panneau de prévisualisation (à droite)
    if (tip.imageUrl) {
        const img = document.createElement('img');
        img.className = 'preview-panel-image'; // Optionnel: pour styliser l'image dans le panneau
        img.src = tip.imageUrl;
        img.alt = `Image pour ${tip.titre || 'ce tip'}`;
        previewPanelContent.appendChild(img);
    }

    // Afficher le previewText dans un cartouche jaune
    if (tip.previewText) {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'preview-text-card-yellow'; // Classe pour le cartouche jaune
        previewDiv.textContent = tip.previewText;
        previewPanelContent.appendChild(previewDiv);
    }

    // Afficher la description dans un cartouche bleu clair, sans le label "Description :"
    if (tip.description) {
        const descriptionPre = document.createElement('pre');
        descriptionPre.className = 'content-card-blue'; // Classe pour le cartouche bleu clair
        descriptionPre.textContent = tip.description;
        previewPanelContent.appendChild(descriptionPre);
    }

    // Afficher le prompt avec son style d'origine (fond gris clair)
    if (tip.prompt) {
        const promptHtml = document.createElement('p');
        promptHtml.innerHTML = `<strong>Prompt :</strong>`;
        previewPanelContent.appendChild(promptHtml);
        const promptPre = document.createElement('pre');
        promptPre.className = 'prompt-content-pre'; // Revenir à la classe de style d'origine
        promptPre.textContent = tip.prompt;
        previewPanelContent.appendChild(promptPre);

        // Ajouter le bouton "Copier le prompt" en dessous du prompt
        const copyPromptPanelBtn = document.createElement('button');
        copyPromptPanelBtn.className = 'copy-panel-btn';
        copyPromptPanelBtn.textContent = 'Copier le prompt';
        copyPromptPanelBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(tip.prompt)
                .then(() => {
                    copyPromptPanelBtn.textContent = 'Copié !';
                    setTimeout(() => copyPromptPanelBtn.textContent = 'Copier le prompt', 2000);
                })
                .catch(err => console.error('Erreur de copie:', err));
        });
        previewPanelContent.appendChild(copyPromptPanelBtn);
    }

    // Afficher l'exemple si disponible
    if (tip.exemple) {
        const exempleHtml = document.createElement('p');
        exempleHtml.innerHTML = `<strong>Exemple d'utilisation :</strong>`;
        previewPanelContent.appendChild(exempleHtml);
        const exemplePre = document.createElement('pre');
        exemplePre.className = 'content-card-blue'; // Utilise le même style que la description
        exemplePre.textContent = tip.exemple;
        previewPanelContent.appendChild(exemplePre);
    }

    previewPanel.classList.add('open');
    bodyElement.style.overflow = 'hidden'; // Empêche le défilement du body
}

closePreviewBtn.addEventListener('click', () => {
    previewPanel.classList.remove('open');
    bodyElement.style.overflow = ''; // Rétablit le défilement du body
});

// Assurez-vous que la fonction deleteTip est définie (vous ne l'avez pas fournie)
async function deleteTip(tipId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce tip ? Cette action est irréversible.')) {
        return;
    }

    try {
        const response = await fetch(`${apiBase}delete-tip`, {
            method: 'POST', // Ou 'DELETE' si votre API le supporte
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: tipId })
        });

        if (!response.ok) {
            throw new Error(`Erreur lors de la suppression: ${response.statusText}`);
        }

        const result = await response.json();
        console.log(result.message);

        // Recharger les tips après suppression réussie
        loadAndDisplayTips();

        const msg = document.getElementById('success-message');
        msg.textContent = '🗑️ Tip supprimé avec succès !';
        msg.style.opacity = '1';
        setTimeout(() => msg.style.opacity = '0', 2000);

    } catch (error) {
        console.error('Erreur lors de la suppression du tip:', error);
        errorDisplay.textContent = `Erreur lors de la suppression : ${error.message}`;
        errorDisplay.style.display = 'block';
    }
}
