<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cas d'usages - iMarketing</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --background-grey: #f0f2f5;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-grey); min-height: 100vh; display: flex; flex-direction: column; }
        main { padding: 40px 20px; flex-grow: 1; }
        .tool-logos-section { max-width: 960px; margin: 15px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); text-align: center; }
        .tool-logos-section h2 { color: var(--primary-blue); margin-bottom: 20px; }
        .tools-scroll-container { display: flex; align-items: center; position: relative; }
        .scroll-button { background-color: var(--primary-blue); color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 50%; font-size: 1.2em; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; }
        .scroll-button.left { left: 0; }
        .scroll-button.right { right: 0; }
        .tools-grid { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 15px; padding: 0 45px; scrollbar-width: none; }
        .tools-grid::-webkit-scrollbar { display: none; }
        .tool-card { flex: 0 0 auto; width: 80px; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
        .tool-card img { max-width: 50px; height: auto; margin-bottom: 8px; }
        .tool-card .tool-name { font-weight: bold; color: var(--dark-blue); font-size: 0.8em; }
        .filters-area-container { max-width: 960px; margin: 15px auto 25px; padding: 0 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .create-tip-button-container { max-width: 960px; margin: 0 auto 30px; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
        .create-tip-button { display: inline-flex; align-items: center; gap: 8px; background-color: var(--primary-blue); color: white; padding: 12px 25px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 1.1em; }
        .tip-count { background-color: var(--primary-blue); color: white; padding: 12px 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em; }
        .galerie-container { max-width: 960px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: var(--card-shadow); }
        #galerie { display: flex; flex-direction: column; gap: 20px; }
        .carte { background: #fff; border-left: 5px solid var(--primary-blue); border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); display: flex; padding: 15px; position: relative; }
        .infos-wrapper { flex-grow: 1; }
        .tip-title { font-size: 1.3em; color: var(--dark-blue); font-weight: bold; margin: 0 0 8px 0; }
        .outil-badge { background-color: #e0f2f7; color: var(--primary-blue); font-size: 0.85em; font-weight: bold; padding: 4px 8px; border-radius: 4px; margin-bottom: 10px; display: inline-block; }
        .metadata-section { display: grid; grid-template-columns: auto 1fr; gap: 2px 10px; font-size: 0.9em; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .metadata-label { font-weight: bold; }
        .metadata-value a { color: var(--primary-blue); text-decoration: none; font-weight: bold; }
        .card-actions { display: flex; align-items: center; gap: 10px; }
        .toggle-content-btn { background-color: var(--primary-blue); color: white; border: none; padding: 7px 14px; border-radius: 6px; cursor: pointer; }
        .supprimer-btn { background: none; border: none; color: #888; font-size: 1.3em; cursor: pointer; margin-left: auto; }
        .preview-panel { position: fixed; top: 0; right: -100%; width: 740px; max-width: 100%; height: 100%; background-color: #fff; box-shadow: -4px 0 15px rgba(0,0,0,0.1); transition: right 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        .preview-panel.open { right: 0; }
        .preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .preview-overlay.open { opacity: 1; visibility: visible; }
        .preview-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; }
        .preview-panel-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .close-preview-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .prompt-content-pre { background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; padding: 10px; white-space: pre-wrap; word-break: break-word; font-family: 'Courier New', monospace; }
        @media (max-width: 768px) { .scroll-button { display: none; } .tools-grid { padding: 0 15px; } }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="create-tip-button-container">
            <a href="creer-tip.html" class="create-tip-button">Créer un Tip</a>
            <div id="tipCount" class="tip-count"></div>
        </div>

        <div class="tool-logos-section">
            <h2>Outils Populaires</h2>
            <div class="tools-scroll-container">
                <button class="scroll-button left" id="scrollLeftBtn"><i class="fas fa-chevron-left"></i></button>
                <div id="tool-logos-grid" class="tools-grid"></div>
                <button class="scroll-button right" id="scrollRightBtn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="filters-area-container">
            <div id="filters">
                <input type="text" id="preview-text" placeholder="Rechercher un mot clé...">
                <select id="filtre-outil">
                    <option value="">Tous les outils</option>
                </select>
                <select id="filtre-tri-date">
                    <option value="recent" selected>Plus récent</option>
                    <option value="ancien">Plus ancien</option>
                </select>
            </div>
        </div>
        
        <div class="galerie-container">
            <div id="galerie"><p style="text-align: center;">Chargement des tips...</p></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
    <div id="previewOverlay" class="preview-overlay"></div>
    <div id="previewPanel" class="preview-panel">
        <div class="preview-panel-header">
            <h3 id="previewPanelTitle">Aperçu</h3>
            <button class="close-preview-btn" id="closePreviewBtn"><i class="fas fa-times"></i></button>
        </div>
        <div id="previewPanelContent" class="preview-panel-content"></div>
    </div>

    <script src="tools-data.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const apiBase = '/.netlify/functions/';
            let allTips = [];

            const dom = {
                header: document.getElementById('header-placeholder'),
                footer: document.getElementById('footer-placeholder'),
                galerie: document.getElementById('galerie'),
                outilFilter: document.getElementById('filtre-outil'),
                dateSort: document.getElementById('filtre-tri-date'),
                textFilter: document.getElementById('preview-text'),
                tipCount: document.getElementById('tipCount'),
                previewPanel: document.getElementById('previewPanel'),
                previewTitle: document.getElementById('previewPanelTitle'),
                previewContent: document.getElementById('previewPanelContent'),
                closePreviewBtn: document.getElementById('closePreviewBtn'),
                previewOverlay: document.getElementById('previewOverlay'),
                toolLogosGrid: document.getElementById('tool-logos-grid'),
                scrollLeftBtn: document.getElementById('scrollLeftBtn'),
                scrollRightBtn: document.getElementById('scrollRightBtn'),
            };

            const escapeHtml = (text) => text == null ? '' : String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);

            const applyFiltersAndSort = () => {
                let filtered = allTips.filter(tip => 
                    (!dom.outilFilter.value || tip.outil === dom.outilFilter.value) &&
                    (!dom.textFilter.value || (tip.previewText || '').toLowerCase().includes(dom.textFilter.value.toLowerCase()))
                );
                
                filtered.sort((a, b) => new Date(dom.dateSort.value === 'recent' ? b.dateCreation : a.dateCreation) - new Date(dom.dateSort.value === 'recent' ? a.dateCreation : b.dateCreation));
                
                displayTips(filtered);
            };

            const displayTips = (tips) => {
                dom.galerie.innerHTML = tips.length ? '' : '<p style="text-align: center;">Aucun tip ne correspond à vos filtres.</p>';
                tips.forEach(tip => {
                    const card = document.createElement('div');
                    card.className = 'carte';
                    card.dataset.id = tip.id;
                    // ERREUR CORRIGÉE : Affichage de la catégorie et bordure de couleur retirés
                    card.innerHTML = `
                        <div class="infos-wrapper">
                            <h3 class="tip-title">${escapeHtml(tip.titre)}</h3>
                            <span class="outil-badge">${escapeHtml(tip.outil)}</span>
                            <div class="metadata-section">
                                <span class="metadata-label">Auteur:</span>
                                <span class="metadata-value"><a href="equipe.html?auteur=${encodeURIComponent(tip.auteur)}">${escapeHtml(tip.auteur)}</a></span>
                                <span class="metadata-label">Date:</span>
                                <span class="metadata-value">${new Date(tip.dateCreation).toLocaleDateString('fr-FR')}</span>
                            </div>
                            <div class="card-actions">
                                <button class="toggle-content-btn">Détails</button>
                                <button class="supprimer-btn"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>`;
                    dom.galerie.appendChild(card);
                });
                attachCardEventListeners();
            };
            
            const openPreviewPanel = (tipId) => {
                const tip = allTips.find(t => t.id == tipId);
                if (!tip) return;
                dom.previewTitle.textContent = tip.titre;
                // ERREUR CORRIGÉE : Affichage de la catégorie retiré du panneau
                dom.previewContent.innerHTML = `
                    <h4>Description</h4>
                    <p>${escapeHtml(tip.description)}</p>
                    ${tip.promptText ? `<h4>Prompt</h4><pre class="prompt-content-pre">${escapeHtml(tip.promptText)}</pre>` : ''}
                `;
                dom.previewPanel.classList.add('open');
                dom.previewOverlay.classList.add('open');
            };

            const attachCardEventListeners = () => {
                dom.galerie.querySelectorAll('.carte').forEach(card => {
                    const tipId = card.dataset.id;
                    card.querySelector('.toggle-content-btn')?.addEventListener('click', () => openPreviewPanel(tipId));
                    card.querySelector('.supprimer-btn')?.addEventListener('click', () => confirmAndDeleteTip(tipId));
                });
            };
            
            const confirmAndDeleteTip = async (tipId) => {
                if (!confirm("Supprimer ce tip ?")) return;
                try {
                    const response = await fetch(`${apiBase}delete-tip`, { method: 'DELETE', body: JSON.stringify({ id: tipId }) });
                    if (!response.ok) throw new Error('Échec de la suppression');
                    await loadAndDisplayTips();
                } catch(err) { console.error(err); }
            };

            const init = async () => {
                // ERREUR CORRIGÉE : Toute la logique de `filtreCategorieSelect` est retirée.
                await Promise.all([
                    fetch('header.html').then(r => r.text()).then(html => dom.header.innerHTML = html),
                    fetch('footer.html').then(r => r.text()).then(html => dom.footer.innerHTML = html)
                ]);

                dom.outilFilter.innerHTML = '<option value="">Tous les outils</option>';
                [...new Set(toolsData.map(t => t.name))].sort().forEach(name => dom.outilFilter.add(new Option(name, name)));

                const createToolCard = (name, content) => {
                    const card = document.createElement('div');
                    card.className = 'tool-card';
                    card.innerHTML = content;
                    card.onclick = () => { dom.outilFilter.value = name; applyFiltersAndSort(); };
                    return card;
                };
                dom.toolLogosGrid.appendChild(createToolCard('', `<i class="fas fa-tools" style="font-size: 50px;"></i><span class="tool-name">Tous</span>`));
                toolsData.forEach(tool => dom.toolLogosGrid.appendChild(createToolCard(tool.name, `<img src="${tool.img}" alt="${tool.name}"><span class="tool-name">${tool.name}</span>`)));

                ['input', 'change'].forEach(evt => {
                    dom.textFilter.addEventListener(evt, applyFiltersAndSort);
                    dom.outilFilter.addEventListener(evt, applyFiltersAndSort);
                    dom.dateSort.addEventListener(evt, applyFiltersAndSort);
                });
                
                dom.closePreviewBtn.onclick = dom.previewOverlay.onclick = () => {
                    dom.previewPanel.classList.remove('open');
                    dom.previewOverlay.classList.remove('open');
                };

                dom.scrollLeftBtn.onclick = () => dom.toolLogosGrid.scrollBy({ left: -200, behavior: 'smooth' });
                dom.scrollRightBtn.onclick = () => dom.toolLogosGrid.scrollBy({ left: 200, behavior: 'smooth' });

                try {
                    const response = await fetch(`${apiBase}get-tips`);
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    allTips = (await response.json()).map(tip => ({...tip, dateCreation: tip.date_creation || tip.dateCreation}));
                    dom.tipCount.textContent = `${allTips.length} Tips`;
                    applyFiltersAndSort();
                } catch (error) {
                    dom.galerie.innerHTML = `<p style="color:red;text-align:center;">Erreur de chargement des données.</p>`;
                }
            };

            init();
        });
    </script>
</body>
</html>
