<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galerie des Tips et Prompts - iMarketing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS pour faciliter la gestion des couleurs */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: var(--background-grey);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.show {
            opacity: 1;
        }
        main {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1;
        }
        main.show {
            opacity: 1;
        }

        #header-placeholder {
            width: 100%;
        }

        /* Conteneur des contrôles en haut (filtres et boutons) */
        .header-controls-container {
            max-width: 960px;
            margin: 20px auto 25px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* Conteneur principal de la galerie (la "box" blanche) */
        .galerie-container {
            max-width: 960px;
            margin: 0px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        /* Conteneur des filtres et boutons d'action */
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        #filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex-grow: 1;
            min-width: 0;
        }
        
        #filters select,
        #filters input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9em;
            flex: 1;
            min-width: 120px;
            box-sizing: border-box; /* Important pour le padding */
        }
        #preview-text {
            min-width: 180px;
            max-width: 250px;
        }

        /* Styles pour les boutons d'action et "Créer un tip" */
        .action-buttons, .create-tip-button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }
        .create-tip-button-container {
            margin-top: 20px;
            margin-bottom: 30px;
            justify-content: center; /* Centrer le bouton */
        }

        .action-buttons a, .create-tip-button {
            background: var(--primary-blue);
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .create-tip-button {
            padding: 12px 25px;
            font-size: 1.1em;
        }

        .action-buttons a:hover, .create-tip-button:hover {
            background: var(--dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Galerie en colonne */
        #galerie {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px 0;
            position: relative;
            z-index: 1;
        }

        /* Styles pour chaque carte de tip */
        .carte {
            background: #fff;
            border-left: 5px solid transparent; /* Couleur définie par JS */
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            display: flex; /* Permet la disposition des éléments */
            align-items: flex-start; /* Aligne les éléments en haut */
            padding: 0;
            position: relative; 
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-left-color 0.2s ease;
            box-sizing: border-box;
            width: 100%;
            z-index: 1;
        }
        .carte:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        /* Conteneur pour toutes les informations textuelles sur la carte */
        .infos-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
            padding: 15px;
            width: 100%;
            position: relative; /* Pour positionner le post-it à l'intérieur */
        }

        .tip-title {
            font-size: 1.3em;
            color: var(--dark-blue);
            font-weight: bold;
            margin-bottom: 8px;
        }

        .outil-badge {
            background-color: #e0f2f7;
            color: var(--primary-blue);
            font-size: 0.85em;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            white-space: nowrap;
            text-transform: uppercase;
            align-self: flex-start;
        }

        /* Section des métadonnées (Auteur, Catégorie) */
        .metadata-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2px 10px;
            font-size: 0.9em;
            color: var(--grey-text);
            margin-bottom: 4px;
            padding-bottom: 2px;
            border-bottom: 1px solid #eee;
        }
        .metadata-label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
        .metadata-value {
            color: #666;
            word-break: break-word;
        }
        .metadata-value.auteur-value {
            font-size: 1em;
            color: #444;
            font-weight: normal;
        }

        /* Le texte de prévisualisation sur la carte (post-it) */
        .preview-post-it {
            position: absolute;
            top: 60px; /* Ajusté pour être plus bas */
            right: 15px; 
            background-color: var(--postit-yellow);
            color: #333;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1em;
            font-weight: bold;
            z-index: 2;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 150px; 
            transform: rotate(2deg);
        }

        /* Boutons d'action sur la carte */
        .card-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 15px;
            padding-top: 5px;
            width: 100%;
        }

        .top-buttons-group {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
            flex-wrap: wrap; 
        }

        /* Les icônes de vignettes en ligne */
        .card-preview-icons-inline {
            display: flex; /* Assurez-vous qu'il est visible quand il contient des icônes */
            gap: 5px; /* Espacement entre les icônes */
            margin-left: 10px; /* Espacement par rapport aux boutons */
        }
        .icon-vignette {
            color: #888; /* Couleur par défaut pour les icônes */
            font-size: 1.2em;
        }
        .icon-vignette[title="Contient une image"] {
            color: #4CAF50; /* Vert pour l'icône image */
        }
        /* Style pour l'icône PDF dans les vignettes de carte */
        .icon-vignette.pdf-thumbnail {
            width: 24px; /* Taille fixe pour la vignette PDF */
            height: 24px;
            object-fit: contain; /* Assure que l'image est contenue sans déformation */
            vertical-align: middle; /* Alignement avec le texte */
            border: 1px solid #ddd;
            border-radius: 3px;
        }


        /* Styles spécifiques pour le bouton "Copier le prompt" */
        .copier-btn {
            background-color: var(--light-blue);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .copier-btn:hover {
            background-color: var(--lighter-blue);
            transform: translateY(-1px);
        }

        .toggle-content-btn, .edit-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .toggle-content-btn:hover, .edit-btn:hover {
            background: var(--dark-blue);
            transform: translateY(-1px);
        }

        /* Styles pour le bouton supprimer (corbeille) */
        .supprimer-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.3em;
            cursor: pointer;
            transition: color 0.2s, transform 0.1s;
            padding: 0 5px;
            align-self: flex-start; 
            margin-top: 5px;
        }

        .supprimer-btn:hover {
            color: var(--error-text);
            transform: translateY(-1px);
        }

        #success-message {
            background-color: var(--success-bg);
            color: var(--success-text);
            border: 1px solid #c3e6cb;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Styles pour le loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message d'erreur */
        .error-message {
            text-align: center;
            color: var(--error-text);
            margin-top: 20px;
            padding: 15px;
            background-color: var(--error-bg);
            border: 1px solid #f5c6cb;
            border-radius: 8px;
        }

        /* Styles for the new right-side preview panel */
        .preview-panel {
            position: fixed;
            top: 0;
            right: -760px; /* Masqué par défaut */
            width: 740px;
            max-width: 90%;
            height: 100%;
            background-color: #fff;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .preview-panel.open {
            right: 0;
        }

        /* Overlay pour la fermeture au clic dans le vide */
        .preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Assombrir l'arrière-plan */
            z-index: 999; /* Juste en dessous du panneau, au-dessus du reste */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .preview-overlay.open {
            opacity: 1;
            visibility: visible;
        }


        .preview-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .preview-panel-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        .close-preview-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
            transition: color 0.2s;
        }

        .close-preview-btn:hover {
            color: #333;
        }

        .preview-panel-content {
            flex-grow: 1;
            font-size: 1em;
            line-height: 1.6;
            color: #444;
            font-weight: normal;
            /* Ajout pour gérer l'espacement des titres */
            padding-bottom: 20px; 
        }

        .preview-panel-content h4 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        /* Styles pour les images dans le panneau d'aperçu (vignette) */
        .preview-panel-image-container {
            text-align: center; /* Centrer l'image à l'intérieur de son conteneur */
            margin-bottom: 20px;
        }
        .preview-panel-image {
            max-width: 200px; /* Taille maximale pour une vignette */
            height: auto;
            display: inline-block; /* Pour que text-align: center fonctionne */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Styles pour le carré PDF cliquable dans le panneau latéral */
        .preview-panel-document-square-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centre le carré horizontalement */
            margin-bottom: 20px; /* Espace sous la section du document */
        }

        .preview-panel-pdf-square {
            display: flex;
            flex-direction: column; /* Icône et texte empilés */
            justify-content: center;
            align-items: center;
            width: 150px; /* Taille du carré augmentée */
            height: 150px; /* Taille du carré augmentée */
            background-color: #fcebeb; /* Fond rouge très clair */
            border: 1px solid #e0b4b8; /* Bordure rouge */
            border-radius: 12px; /* Corners plus arrondis */
            text-decoration: none;
            color: var(--error-text); /* Couleur du texte et de l'icône (rouge foncé) */
            font-weight: bold;
            font-size: 1.1em; /* Taille de police légèrement augmentée */
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            padding: 10px; /* Espacement interne */
            box-sizing: border-box;
            text-align: center; /* Centrer le texte */
        }

        .preview-panel-pdf-square:hover {
            background-color: #f7dcdc; /* Rouge légèrement plus foncé au survol */
            transform: translateY(-2px);
        }

        /* Styles pour l'image PDF à l'intérieur du carré */
        .preview-panel-pdf-square img {
            max-width: 80px; /* Taille de l'image PDF */
            max-height: 80px;
            object-fit: contain;
            margin-bottom: 8px; /* Espacement sous l'image */
        }
        
        .preview-panel-pdf-square .file-name {
            font-size: 0.8em; /* Plus petit pour le nom de fichier */
            color: #666; /* Couleur un peu plus discrète */
            word-break: break-all; /* Pour les noms de fichiers longs */
            max-height: 2.4em; /* Limite à 3 lignes de texte */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* Style du bouton "Télécharger" dans le carré PDF */
        .download-button {
            background-color: var(--error-text); /* Rouge du texte d'erreur */
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none; /* Pas de soulignement */
            margin-top: 10px; /* Espacement sous l'icône */
            transition: background-color 0.2s;
            display: inline-block; /* Pour le padding et les marges */
            white-space: nowrap; /* Empêche le retour à la ligne du texte */
        }

        .download-button:hover {
            background-color: #c02c3c; /* Rouge un peu plus foncé au survol */
        }

        /* Style pour le cartouche jaune du texte de prévisualisation dans le panneau de droite */
        .preview-text-card-yellow {
            background-color: var(--postit-yellow);
            color: #333;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.95em;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Style pour les cartouches bleus clairs pour Description, Exemple */
        .content-card-blue {
            background-color: var(--light-blue-card);
            color: var(--dark-blue);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.9em;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Style pour le prompt (revenir au style initial) */
        .prompt-content-pre {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: normal;
            margin-bottom: 15px;
        }

        /* Style pour le bouton Copier dans le panneau latéral */
        .copy-panel-btn {
            background-color: var(--light-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            margin-top: -10px;
            margin-bottom: 15px;
            align-self: flex-start;
        }

        .copy-panel-btn:hover {
            background-color: var(--lighter-blue);
            transform: translateY(-1px);
        }

        /* Media queries pour la responsivité */
        @media (max-width: 992px) {
            .preview-panel {
                width: 100%;
                right: -100%;
            }
            .preview-panel.open {
                right: 0;
            }
        }
        @media (max-width: 768px) {
            .filters-header {
                flex-direction: column;
                align-items: stretch;
            }
            #filters {
                flex-direction: column;
                gap: 15px;
            }
            #filters input, #filters select {
                min-width: unset;
                max-width: unset;
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
                width: 100%;
                justify-content: center;
            }
            .action-buttons a {
                width: 100%;
                text-align: center;
            }
            .infos-wrapper {
                padding: 15px;
                width: auto; 
            }
            .metadata-section {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            .card-actions {
                align-items: center;
            }
            .top-buttons-group {
                flex-direction: column;
                gap: 5px;
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            .toggle-content-btn, .copier-btn, .edit-btn {
                width: 100%;
                text-align: center;
            }
            .supprimer-btn {
                width: auto;
                align-self: center;
            }
            .create-tip-button-container {
                margin-top: 15px;
                margin-bottom: 20px;
            }
            .preview-post-it {
                position: static; /* Retire le positionnement absolu sur mobile */
                margin-top: 10px;
                max-width: unset;
                text-align: center;
                transform: none; /* Retire la rotation sur mobile */
                font-size: 1.1em;
            }
            /* Ajustements pour le carré PDF sur mobile */
            .preview-panel-pdf-square {
                width: 100px;
                height: 100px;
                font-size: 0.9em;
            }
            .preview-panel-pdf-square img { /* Cible l'image à l'intérieur */
                max-width: 60px;
                max-height: 60px;
            }
            .preview-panel-pdf-square .file-name {
                font-size: 0.7em;
            }
            .download-button {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }

        /* Styles pour le footer */
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            width: 100%;
        }

        footer p {
            margin: 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="loader" class="hidden">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <main>
        <h1>Bibliothèque de Cas d'Usages & Tips IA</h1>

        <div class="filters-search">
            <label for="search">Rechercher :</label>
            <input type="text" id="search" onkeyup="renderTips()" placeholder="Titre, description, prompt..." />

            <label for="filtre-outil">Outil :</label>
            <select id="filtre-outil" onchange="renderTips()">
                <option value="">Tous les outils</option>
            </select>

            <label for="filtre-categorie">Catégorie :</label>
            <select id="filtre-categorie" onchange="renderTips()">
                <option value="">Toutes les catégories</option>
            </select>
        </div>

        <div id="tips">
            <p style="text-align: center;">Chargement des tips...</p>
        </div>
    </main>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Créa**
    </footer>

    <script>
        // cas-usages.js

        let tipsData = [];
        let votesData = JSON.parse(localStorage.getItem('votesData') || '[]');

        const GET_TIPS_URL = "/.netlify/functions/get-tips"; 

        async function loadTips() {
            try {
                const response = await fetch(GET_TIPS_URL);

                if (!response.ok) {
                    throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                }

                const fetchedTips = await response.json();
                
                // --- LA CORRECTION FINALE ICI ---
                // S'assurer que chaque tip a une propriété 'date_creation' harmonisée
                tipsData = fetchedTips.map(tip => {
                    const mappedTip = { ...tip }; // Crée une copie du tip

                    // Détermine la date de création la plus fiable
                    if (tip.date_creation) {
                        mappedTip.date_creation_final = tip.date_creation;
                    } else if (tip.dateCreation) { // Si l'ancienne propriété dateCreation existe
                        mappedTip.date_creation_final = tip.dateCreation;
                    } else if (tip.date_ajout) { // Si l'ancienne propriété date_ajout existe
                        mappedTip.date_creation_final = tip.date_ajout;
                    } else {
                        // Fallback ultime : si aucune date n'est trouvée, utilise la date actuelle
                        console.warn(`Tip ID ${tip.id || 'Inconnu'} n'a pas de date de création définie. Utilisation de la date actuelle.`);
                        mappedTip.date_creation_final = new Date().toISOString();
                    }

                    // Assure des valeurs par défaut pour l'affichage si manquantes
                    mappedTip.titre = mappedTip.titre && mappedTip.titre.trim() !== '' ? mappedTip.titre : "Titre non spécifié";
                    mappedTip.auteur = mappedTip.auteur && mappedTip.auteur.trim() !== '' ? mappedTip.auteur : "Auteur inconnu";
                    mappedTip.description = mappedTip.description || '';
                    mappedTip.prompt = mappedTip.prompt || mappedTip.promptText || ''; // Gérer promptText comme fallback pour prompt

                    return mappedTip;
                });
                // --- FIN DE LA CORRECTION ---


                while (votesData.length < tipsData.length) votesData.push({ up: 0, down: 0 });
                localStorage.setItem('votesData', JSON.stringify(votesData));

                initFilters();
                renderTips();

            } catch (error) {
                console.error("Erreur lors du chargement des tips :", error);
                document.getElementById('tips').innerHTML = '<p style="color: red; text-align: center;">Impossible de charger les tips. Veuillez réessayer plus tard.</p>';
            } finally {
                // Cache le loader après le chargement des tips (réussite ou échec)
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function saveVotes() {
            localStorage.setItem('votesData', JSON.stringify(votesData));
        }

        function initFilters() {
            const outilSelect = document.getElementById("filtre-outil");
            const outils = [...new Set(tipsData.map(t => t.outil))].sort();
            outilSelect.innerHTML = '<option value="">Tous les outils</option>' + outils.map(o => `<option>${o}</option>`).join('');

            const categorieSelect = document.getElementById("filtre-categorie");
            if (categorieSelect) {
                const categories = [...new Set(tipsData.map(t => t.categorie))].sort();
                categorieSelect.innerHTML = '<option value="">Toutes les catégories</option>' + categories.map(c => `<option>${c}</option>`).join('');
            }
        }

        function renderTips() {
            const search = document.getElementById('search').value.toLowerCase();
            const outilFilter = document.getElementById('filtre-outil').value;
            const catFilter = document.getElementById('filtre-categorie').value;
            const container = document.getElementById('tips');
            container.innerHTML = '';

            // Trie les tips avant de les filtrer et les afficher
            const sortedTips = [...tipsData].sort((a, b) => {
                const dateA = new Date(a.date_creation_final); // Utilisez la date harmonisée
                const dateB = new Date(b.date_creation_final);
                return dateB.getTime() - dateA.getTime(); // Trie du plus récent au plus ancien (décroissant)
            });


            sortedTips.forEach((tip, i) => { // Utilisez sortedTips ici
                const haystack = (tip.titre + tip.description + tip.prompt + tip.auteur + tip.outil + tip.categorie).toLowerCase();
                if ((search && !haystack.includes(search)) || (outilFilter && tip.outil !== outilFilter) || (catFilter && tip.categorie !== catFilter)) {
                    return;
                }

                // Formatage de la date pour l'affichage
                const dateObj = new Date(tip.date_creation_final); // Utilisez la date harmonisée
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                const formattedDate = dateObj.toLocaleDateString('fr-FR', options);


                const div = document.createElement('div');
                div.className = 'tip';
                // La fonction toggleDetails devra être mise à jour pour gérer les ID
                // Pour l'instant, je vais laisser l'index, mais l'ID est plus robuste pour les votes persistants
                div.onclick = () => toggleDetails(div, tip, i); 

                // Ajout conditionnel des images
                // La propriété d'images dans le JSON est 'fileUrls' ou 'imageUrl' pour les nouveaux tips,
                // mais peut être 'images' pour les anciens. On doit gérer ça ici.
                let imagesHtml = '';
                if ((tip.fileUrls && tip.fileUrls.length > 0) || tip.imageUrl || (tip.images && tip.images.length > 0)) {
                    const sourceImages = tip.fileUrls || (tip.imageUrl ? [tip.imageUrl] : tip.images); // Combinaison des sources
                    if (sourceImages && sourceImages.length > 0) {
                        imagesHtml = `<div class="tip-images">${sourceImages.map(img => `<img src="${img}" alt="Image du tip" onclick="openLightbox('${img}', event)">`).join('')}</div>`;
                    }
                }

                div.innerHTML = `
                    <h2>${tip.titre}</h2>
                    <div class="tip-category">Outil : ${tip.outil} • Catégorie : ${tip.categorie} • Auteur : ${tip.auteur}</div>
                    <div class="tip-details">
                        <p>${tip.description}</p>
                        ${imagesHtml}
                        <div class="prompt-box">
                            <code id="prompt-${tip.id}" contenteditable>${tip.prompt}</code>
                            <button onclick="copierPrompt('prompt-${tip.id}', event)">📋</button>
                        </div>
                        <div class="metadata-section">
                            <span class="metadata-label">Date de création:</span>
                            <span class="metadata-value">${formattedDate}</span>
                        </div>
                        <div class="votes">
                            <button onclick="vote(${i}, 'up', event)">👍</button><span id="up-${i}">${votesData[i] ? votesData[i].up : 0}</span>
                            <button onclick="vote(${i}, 'down', event)">👎</button><span id="down-${i}">${votesData[i] ? votesData[i].down : 0}</span>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function vote(i, type, e) {
            e.stopPropagation();
            if (!votesData[i]) votesData[i] = { up: 0, down: 0 };
            votesData[i][type]++;
            document.getElementById(`${type}-${i}`).textContent = votesData[i][type];
            saveVotes();
        }

        function toggleDetails(el, tip, index) {
            const details = el.querySelector('.tip-details');
            if (el.classList.contains('active')) {
                hideAllDetails();
            } else {
                hideAllDetails();
                details.style.display = 'block';
                el.classList.add('active');
            }
        }

        function hideAllDetails() {
            document.querySelectorAll('.tip-details').forEach(d => {
                d.style.display = 'none';
                d.parentNode.classList.remove('active');
            });
        }

        function copierPrompt(id, e) {
            e.stopPropagation();
            const content = document.getElementById(id).textContent;
            navigator.clipboard.writeText(content).then(() => alert('Prompt copié !'));
        }

        function openLightbox(imageUrl, event) {
            event.stopPropagation();
            const lightbox = document.createElement('div');
            lightbox.id = 'lightbox';
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;
            lightbox.onclick = (e) => {
                if (e.target.id === 'lightbox') {
                    document.body.removeChild(lightbox);
                }
            };

            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border: 2px solid white;
                border-radius: 5px;
            `;
            img.onclick = (e) => e.stopPropagation();

            lightbox.appendChild(img);
            document.body.appendChild(lightbox);
        }

        document.addEventListener('click', (event) => {
            const isClickInsideTip = event.target.closest('.tip');
            const isClickOnLightbox = event.target.closest('#lightbox');

            if (!isClickInsideTip && !isClickOnLightbox) {
                hideAllDetails();
            }
        });

        // --- Fonctions globales de l'application ---
        document.addEventListener("DOMContentLoaded", () => {
            const headerPlaceholder = document.getElementById("header-placeholder");

            const loadComponent = async (url, placeholderId, errorMessage) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    document.getElementById(placeholderId).innerHTML = await res.text();
                } catch (error) {
                    console.error(`Error loading ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
                }
            };

            // Charger le header et ensuite les tips
            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
                .then(() => {
                    // Logic for active link in menu (if applicable for this header)
                    const path = location.pathname.split("/").pop();
                    const links = document.querySelectorAll("nav a");
                    links.forEach(link => {
                        if (path === "" || path === "index.html") {
                            if (link.getAttribute("href") === "index.html") {
                                link.classList.add("active");
                            }
                        } else if (link.getAttribute("href") === path) {
                            link.classList.add("active");
                        }
                    });

                    // Assurez-vous que la fonction pour la bulle de notification est définie
                    if (typeof mettreAJourBulleDemandes === 'function') {
                        mettreAJourBulleDemandes();
                    } else {
                        console.warn("mettreAJourBulleDemandes n'est pas définie globalement ou n'est pas encore chargée.");
                    }
                    
                    // Lance le chargement des tips une fois le DOM prêt et le header chargé
                    // et affiche le contenu.
                    loadTips().then(() => {
                        document.body.classList.add('show'); // Rendre le body visible
                        document.querySelector('main').classList.add('show'); // Rendre le main visible
                    }); 
                })
                .catch(error => {
                    console.error("Erreur générale lors du chargement des composants:", error);
                    // S'assurer que le loader se cache même en cas d'erreur de chargement de header
                    document.getElementById('loader').classList.add('hidden');
                    // Rendre le body et main visibles même si le header ne charge pas pour afficher l'erreur
                    document.body.classList.add('show');
                    document.querySelector('main').classList.add('show');
                });
        });

        // Cette fonction doit être définie si elle est utilisée par le header
        // Elle semble être dans un bloc `script` du header.html, ou un fichier js séparé.
        // Si elle n'est pas définie ici, elle causera une erreur.
        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                return;
            }
            // Exemple d'URL de proxy, à adapter si nécessaire
            const PROXY_URL = "/.netlify/functions/proxy"; 
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesArray = demandes.data || demandes;
                const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }
    </script>
</body>
</html>
