<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veille IA Marketing</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in; /* Transition plus douce */
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f0f4f8; /* Couleur de fond plus moderne */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.show {
            opacity: 1;
        }
        main {
            display: none; /* Main caché au début, sera affiché par le script */
            flex-grow: 1; /* Permet au main de prendre l'espace disponible */
        }
        main.show {
            display: block; /* S'assure que main devient visible */
        }
        #header-placeholder, #footer-placeholder {
            width: 100%;
        }

        /* Conteneur principal de la veille */
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* En-tête de la veille */
        .veille-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .veille-header h1 {
            color: #0077b6;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .veille-header p {
            color: #555;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        /* Filtres et recherche */
        .filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .filters select,
        .filters input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .filters select:focus,
        .filters input:focus {
            outline: none;
            border-color: #0077b6;
            box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.2);
        }
        .filters input {
            flex-grow: 1;
            max-width: 300px;
        }

        /* Grille des articles */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding-bottom: 20px; /* Espace avant le footer */
        }

        /* Carte d'article */
        .article-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            cursor: pointer;
            border: 1px solid #e0e0e0;
        }
        .article-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        .article-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        .article-card .content {
            padding: 18px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .article-card h3 {
            font-size: 1.3rem;
            color: #0077b6;
            margin: 0 0 10px;
            line-height: 1.3;
        }
        .article-card p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limite le texte à 3 lignes */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .article-card .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #888;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        .article-card .date,
        .article-card .source {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .article-card .source {
            font-weight: bold;
        }

        /* Boutons d'action */
        .button-group {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        .button-group button {
            background: #0077b6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 119, 182, 0.3);
            margin: 0 10px;
        }
        .button-group button:hover {
            background: #005f8a;
            transform: translateY(-2px);
        }
        .button-group button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 119, 182, 0.3);
        }

        /* Bouton "Partager un Tip" flottant */
        .share-tip-button {
            position: fixed;
            bottom: 90px; /* Ajusté pour être au-dessus du chatbot */
            right: 30px;
            background-color: #28a745; /* Vert pour le succès */
            color: white;
            padding: 15px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999; /* Au-dessus des autres éléments */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-tip-button:hover {
            background-color: #218838; /* Vert plus foncé au survol */
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .share-tip-button .fa-solid {
            font-size: 1.2em;
        }

        /* Loader pour l'ajout d'article */
        #add-article-loader {
            display: none;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        #add-article-loader .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #0077b6; /* Couleur de votre thème */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Popup pour le formulaire d'ajout/édition */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh; /* Limite la hauteur de la modale */
            overflow-y: auto; /* Ajoute un scroll si le contenu dépasse */
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }

        .modal-content h2 {
            color: #0077b6;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .modal-content input[type="text"],
        .modal-content input[type="url"],
        .modal-content textarea,
        .modal-content select {
            width: calc(100% - 20px); /* Adjust to account for padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-content button {
            background-color: #0077b6;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .modal-content button:hover {
            background-color: #005f8a;
        }

        /* Message de statut pour la modal */
        #modal-status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            display: none; /* Masqué par défaut */
        }

        #modal-status-message.success {
            background-color: #d4edda; /* Vert clair */
            color: #155724; /* Vert foncé */
        }

        #modal-status-message.error {
            background-color: #f8d7da; /* Rouge clair */
            color: #721c24; /* Rouge foncé */
        }

        /* Overlay de chargement pour la modal */
        #modal-loader-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        #modal-loader-overlay .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left-color: #0077b6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        #modal-loader-overlay p {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #555;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            .filters select,
            .filters input {
                width: calc(100% - 20px); /* Ajuste la largeur pour les petits écrans */
                margin: 0 auto;
            }
            .articles-grid {
                grid-template-columns: 1fr; /* Une seule colonne sur mobile */
            }
            .button-group button {
                width: calc(100% - 20px);
                margin-bottom: 10px;
            }
            .share-tip-button {
                bottom: 20px;
                right: 20px;
                padding: 12px 15px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="container">
            <div class="veille-header">
                <h1>Veille IA Marketing</h1>
                <p>Restez à jour avec les dernières actualités, innovations et outils en Intelligence Artificielle appliqués au Marketing.</p>
            </div>

            <div class="filters">
                <select id="categoryFilter">
                    <option value="">Toutes les catégories</option>
                    <option value="Actualités">Actualités</option>
                    <option value="Outils">Outils</option>
                    <option value="Stratégie">Stratégie</option>
                    <option value="Données">Données</option>
                    <option value="Éthique">Éthique</option>
                    <option value="Automatisation">Automatisation</option>
                    <option value="Personnalisation">Personnalisation</option>
                    <option value="Contenu">Contenu</option>
                </select>
                <input type="text" id="searchInput" placeholder="Rechercher par titre ou mot-clé...">
            </div>

            <div class="articles-grid" id="articles-list">
                </div>

            <div class="button-group">
                <button id="addArticleBtn">Ajouter un nouvel article</button>
                <button id="loadMoreBtn">Charger plus d'articles</button>
            </div>
            <div id="add-article-loader">
                <div class="spinner"></div>
            </div>
        </div>
        <a href="cas-usages.html" class="share-tip-button">
            <i class="fa-solid fa-lightbulb"></i> Partager un Tip
        </a>
    </main>

    <div id="footer-placeholder"></div>

    <div id="articleModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Ajouter un nouvel article</h2>
            <form id="articleForm">
                <label for="articleTitle">Titre de l'article:</label>
                <input type="text" id="articleTitle" required>

                <label for="articleCategory">Catégorie:</label>
                <select id="articleCategory" required>
                    <option value="">Sélectionner une catégorie</option>
                    <option value="Actualités">Actualités</option>
                    <option value="Outils">Outils</option>
                    <option value="Stratégie">Stratégie</option>
                    <option value="Données">Données</option>
                    <option value="Éthique">Éthique</option>
                    <option value="Automatisation">Automatisation</option>
                    <option value="Personnalisation">Personnalisation</option>
                    <option value="Contenu">Contenu</option>
                </select>

                <label for="articleSource">Source:</label>
                <input type="text" id="articleSource" required>

                <label for="articleUrl">URL de l'article:</label>
                <input type="url" id="articleUrl" required>

                <label for="articleImageUrl">URL de l'image (optionnel):</label>
                <input type="url" id="articleImageUrl">

                <label for="articleDescription">Description (optionnel):</label>
                <textarea id="articleDescription"></textarea>

                <button type="submit" id="submitArticleBtn">Ajouter l'article</button>
                <div id="modal-status-message"></div>
            </form>
            <div id="modal-loader-overlay">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>
        </div>
    </div>


    <script>
        const PROXY_URL = "/.netlify/functions/proxy"; // Point d'accès unique pour vos fonctions Netlify
        const ARTICLES_PER_LOAD = 9; // Nombre d'articles à charger à chaque fois
        let articles = []; // Tous les articles chargés
        let displayedArticlesCount = 0; // Compteur des articles actuellement affichés

        const articlesList = document.getElementById("articles-list");
        const categoryFilter = document.getElementById("categoryFilter");
        const searchInput = document.getElementById("searchInput");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const addArticleBtn = document.getElementById("addArticleBtn");
        const addArticleLoader = document.getElementById("add-article-loader");
        const mainElement = document.querySelector("main"); // Sélectionne l'élément main

        // Modal elements
        const articleModal = document.getElementById("articleModal");
        const closeButton = document.querySelector(".close-button");
        const articleForm = document.getElementById("articleForm");
        const modalTitle = document.getElementById("modalTitle");
        const submitArticleBtn = document.getElementById("submitArticleBtn");
        const modalStatusMessage = document.getElementById("modal-status-message");
        const modalLoaderOverlay = document.getElementById("modal-loader-overlay");

        let currentArticleId = null; // Pour l'édition: stocke l'ID de l'article en cours d'édition

        // Fonction pour normaliser les chaînes de caractères (minuscules, sans accents)
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        // Fonction pour afficher les messages de statut dans la modale
        function showModalStatus(message, type) {
            modalStatusMessage.textContent = message;
            modalStatusMessage.className = ''; // Réinitialise les classes
            modalStatusMessage.classList.add(type);
            modalStatusMessage.style.display = 'block';
            setTimeout(() => {
                modalStatusMessage.style.display = 'none';
            }, 3000); // Masque le message après 3 secondes
        }

        // Fonction pour générer le HTML d'une carte d'article
        function createArticleCard(article) {
            const card = document.createElement("div");
            card.className = "article-card";
            card.dataset.id = article.id; // Stocke l'ID de l'article pour l'édition/suppression

            // Fallback image URL if article.imageUrl is empty or invalid
            const imageUrl = (article.imageUrl && typeof article.imageUrl === 'string' && (article.imageUrl.startsWith('http') || article.imageUrl.startsWith('/') || article.imageUrl.startsWith('./') || article.imageUrl.startsWith('../'))) ? article.imageUrl : 'https://via.placeholder.com/300x180?text=Article';

            card.innerHTML = `
                <img src="${imageUrl}" alt="${article.title || 'Article Image'}" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x180?text=Erreur+image';">
                <div class="content">
                    <h3>${article.title || 'Titre Inconnu'}</h3>
                    <p>${article.description || 'Pas de description disponible.'}</p>
                    <div class="meta">
                        <span class="date"><i class="fa-solid fa-calendar-alt"></i> ${article.date || 'Date inconnue'}</span>
                        <span class="source"><i class="fa-solid fa-newspaper"></i> ${article.source || 'Source inconnue'}</span>
                    </div>
                </div>
            `;

            // Ajoute un écouteur de clic pour ouvrir l'URL de l'article
            card.addEventListener('click', () => {
                if (article.url) {
                    window.open(article.url, '_blank');
                } else {
                    alert('URL de l\'article non disponible.');
                }
            });

            return card;
        }

        // Fonction pour rendre les articles filtrés/recherchés et charger plus
        function renderArticles(articlesToRender, append = false) {
            if (!append) {
                articlesList.innerHTML = ""; // Vide la liste pour un nouveau rendu
                displayedArticlesCount = 0;
            }

            const category = normalizeString(categoryFilter.value);
            const searchTerm = normalizeString(searchInput.value);

            const filteredAndSearchedArticles = articlesToRender.filter(article => {
                const matchesCategory = !category || normalizeString(article.category).includes(category);
                const matchesSearch = !searchTerm ||
                                      normalizeString(article.title).includes(searchTerm) ||
                                      normalizeString(article.description).includes(searchTerm) ||
                                      normalizeString(article.source).includes(searchTerm);
                return matchesCategory && matchesSearch;
            });

            // Tri par date (du plus récent au plus ancien)
            filteredAndSearchedArticles.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;
            });

            // Afficher les articles par lots
            const articlesToAdd = filteredAndSearchedArticles.slice(displayedArticlesCount, displayedArticlesCount + ARTICLES_PER_LOAD);

            articlesToAdd.forEach(article => {
                articlesList.appendChild(createArticleCard(article));
            });

            displayedArticlesCount += articlesToAdd.length;

            // Gérer la visibilité du bouton "Charger plus"
            if (displayedArticlesCount < filteredAndSearchedArticles.length) {
                loadMoreBtn.style.display = "block";
            } else {
                loadMoreBtn.style.display = "none";
            }
             if (filteredAndSearchedArticles.length === 0) {
                articlesList.innerHTML = '<p style="text-align: center; color: #666; width: 100%;">Aucun article ne correspond à vos critères.</p>';
                loadMoreBtn.style.display = "none";
            }
        }

        // Charger tous les articles depuis le proxy
        async function fetchAllArticles() {
            try {
                const response = await fetch(`${PROXY_URL}?action=getArticles`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                articles = data; // Stocke tous les articles
                renderArticles(articles); // Affiche les premiers articles
            } catch (error) {
                console.error("Erreur lors du chargement des articles:", error);
                articlesList.innerHTML = `<p style="text-align: center; color: red;">Erreur lors du chargement des articles: ${error.message}</p>`;
                loadMoreBtn.style.display = "none";
            }
        }

        // --- Écouteurs d'événements ---
        categoryFilter.addEventListener("change", () => renderArticles(articles));
        searchInput.addEventListener("input", () => renderArticles(articles));
        loadMoreBtn.addEventListener("click", () => renderArticles(articles, true)); // true pour append

        addArticleBtn.addEventListener("click", () => {
            currentArticleId = null; // Réinitialise l'ID pour un nouvel ajout
            modalTitle.textContent = "Ajouter un nouvel article";
            submitArticleBtn.textContent = "Ajouter l'article";
            articleForm.reset(); // Vide le formulaire
            modalStatusMessage.style.display = 'none'; // Cache le message de statut
            articleModal.style.display = "flex"; // Affiche la modale
        });

        closeButton.addEventListener("click", () => {
            articleModal.style.display = "none";
        });

        window.addEventListener("click", (event) => {
            if (event.target == articleModal) {
                articleModal.style.display = "none";
            }
        });

        articleForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            modalLoaderOverlay.style.display = 'flex'; // Affiche le loader dans la modale

            const articleData = {
                id: currentArticleId, // Sera null pour un nouvel ajout, ou l'ID pour l'édition
                title: document.getElementById("articleTitle").value,
                category: document.getElementById("articleCategory").value,
                source: document.getElementById("articleSource").value,
                url: document.getElementById("articleUrl").value,
                imageUrl: document.getElementById("articleImageUrl").value,
                description: document.getElementById("articleDescription").value,
                date: new Date().toISOString().slice(0, 10) // Date actuelle au format AAAA-MM-JJ
            };

            const action = currentArticleId ? 'updateArticle' : 'addArticle';
            const method = 'POST'; // Toujours POST pour les opérations d'écriture via le proxy

            try {
                const response = await fetch(`${PROXY_URL}?action=${action}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(articleData),
                });

                const result = await response.json();
                if (result.success) {
                    showModalStatus(currentArticleId ? 'Article mis à jour avec succès !' : 'Article ajouté avec succès !', 'success');
                    // Recharger tous les articles pour s'assurer que la liste est à jour
                    await fetchAllArticles();
                    setTimeout(() => {
                        articleModal.style.display = "none";
                    }, 1000); // Ferme la modale après un court délai
                } else {
                    showModalStatus(`Erreur: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error("Erreur lors de l'opération sur l'article:", error);
                showModalStatus(`Erreur réseau/serveur: ${error.message}`, 'error');
            } finally {
                modalLoaderOverlay.style.display = 'none'; // Cache le loader
            }
        });

        // Fonction pour charger et insérer le contenu du header et footer
        async function loadComponent(url, placeholderId, errorMessage) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                document.getElementById(placeholderId).innerHTML = await res.text();
            } catch (error) {
                    console.error(`Erreur lors du chargement de ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
            }
        };

        // Fonction pour mettre à jour la bulle de notification
        async function mettreAJourBulleDemandes() {
            // L'ID doit correspondre à celui dans header.html
            const notif = document.getElementById('notification-badge'); 
            if (notif) {
                try {
                    const response = await fetch(`${PROXY_URL}?action=getDemandesCount`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const countData = await response.json();
                    if (countData && countData.count !== undefined) {
                        if (countData.count > 0) {
                            notif.textContent = countData.count;
                            notif.style.display = 'block';
                        } else {
                            notif.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error("Erreur lors de la mise à jour de la bulle de demandes:", error);
                    notif.style.display = 'none'; // Cacher la bulle en cas d'erreur
                }
            }
        }


        // Au chargement de la page
        window.addEventListener("load", async () => {
            // Charger le header et le footer en parallèle
            await Promise.all([
                loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu"),
                loadComponent("footer.html", "footer-placeholder", "Erreur de chargement du pied de page")
            ]);

            // Charger tous les articles disponibles (cette fonction affiche les articles)
            await fetchAllArticles();
            
            mettreAJourBulleDemandes(); // Met à jour la bulle de notification après que le header soit chargé

            // Rendre le corps visible après le chargement initial
            document.body.classList.add("show");
            if (mainElement) {
                mainElement.classList.add("show");
            }
        });
    </script>
</body>
</html>
