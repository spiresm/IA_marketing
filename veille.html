<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veille IA & Marketing - Espace IA</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preload" href="header.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="footer.html" as="fetch" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Variables CSS (dupliqu√©es ici pour l'exemple, id√©alement dans style.css) */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles g√©n√©raux pour l'animation d'apparition de la page */
        body {
            opacity: 0; /* Garde l'opacit√© √† 0 au d√©marrage pour l'animation */
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            background-color: var(--background-grey);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        body.show {
            opacity: 1; /* R√©v√®le le body une fois la classe ajout√©e */
        }
        main {
            opacity: 0; /* Garde l'opacit√© √† 0 au d√©marrage pour l'animation */
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1;
            max-width: 960px; /* Align√© avec les autres pages */
            margin: 0 auto;
        }
        main.show {
            opacity: 1; /* R√©v√®le main une fois la classe ajout√©e */
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex; /* Afficher par d√©faut pour le loader */
            justify-content: center;
            align-items: center;
            flex-direction: column; /* Centrer le texte et le spinner */
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            pointer-events: all;
        }
        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #loader .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loader p {
            color: var(--primary-blue);
            font-size: 1.1em;
        }


        #header-placeholder {
            width: 100%;
        }
        #footer-placeholder {
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--dark-blue);
            font-size: 2em;
        }

        /* Styles pour les contr√¥les (filtres, tri) */
        .controls-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .controls-container input[type="text"],
        .controls-container select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95em;
            flex-grow: 1;
            min-width: 180px;
            box-sizing: border-box;
        }

        /* Styles des cartes d'articles de veille */
        #veille-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 5px solid var(--primary-blue); /* Couleur par d√©faut */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .card h2 {
            margin: 0 0 10px 0;
            color: var(--dark-blue);
            font-size: 1.5em;
        }
        .card .meta-info {
            font-size: 0.9em;
            color: var(--grey-text);
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .card .meta-info strong {
            color: #333;
        }
        .tag {
            background: var(--light-blue-card);
            color: var(--primary-blue);
            padding: 0.3em 0.7em;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        .card p.description {
            font-size: 1em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }
        .card a.read-more {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .card a.read-more:hover {
            text-decoration: underline;
            color: var(--dark-blue);
        }
        .source {
            font-size: 0.85em;
            color: #777;
            margin-top: 10px;
            font-style: italic;
        }

        /* Message si aucun article */
        #no-articles-message {
            text-align: center;
            color: #555;
            margin-top: 30px;
            font-size: 1.1em;
            display: none; /* Masqu√© par d√©faut */
        }
        
        /* Message d'erreur chargement */
        #error-display {
            text-align: center;
            color: var(--error-text);
            margin-top: 20px;
            padding: 15px;
            background-color: var(--error-bg);
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            display: none;
        }


        /* Styles de pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .pagination button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .pagination button:hover:not(:disabled) {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
        }
        .pagination button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .pagination span {
            display: flex;
            align-items: center;
            font-size: 1em;
            color: #555;
            font-weight: bold;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            main {
                padding: 20px 10px;
            }
            h1 {
                font-size: 1.8em;
            }
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            .controls-container input[type="text"],
            .controls-container select {
                min-width: unset;
                width: 100%;
            }
            .card {
                padding: 1rem;
            }
            .card h2 {
                font-size: 1.3em;
            }
            .card .meta-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .tag {
                font-size: 0.75em;
            }
            .pagination button {
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p>Chargement de la veille...</p>
    </div>

    <div id="header-placeholder"></div>

    <main>
        <h1>üì∞ Veille IA & Marketing</h1>

        <div class="controls-container">
            <input type="text" id="search-input" placeholder="Rechercher par titre ou contenu..." />
            <select id="filter-tag">
                <option value="">Toutes les cat√©gories</option>
                <option value="Lancement de produit">Lancement de produit</option>
                <option value="Publication de mod√®le">Publication de mod√®le</option>
                <option value="Int√©gration de produit">Int√©gration de produit</option>
                <option value="Mise √† jour de produit">Mise √† jour de produit</option>
                <option value="Recherche">Recherche</option>
                <option value="√âthique IA">√âthique IA</option>
                <option value="R√©glementation">R√©glementation</option>
                <option value="Analyse de march√©">Analyse de march√©</option>
                </select>
            <select id="sort-order">
                <option value="recent">Plus r√©cent</option>
                <option value="oldest">Plus ancien</option>
            </select>
        </div>
        
        <div id="veille-container">
            <p id="initial-loading-message" style="text-align: center; color: #777;">Chargement des articles de veille...</p>
            <div id="error-display" class="error-message" style="display: none;"></div>
        </div>

        <div class="pagination">
            <button id="prev-page-btn" disabled><i class="fas fa-chevron-left"></i> Pr√©c√©dent</button>
            <span id="page-info">Page 1 de 1</span>
            <button id="next-page-btn" disabled>Suivant <i class="fas fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        const API_VEILLE_URL = "/.netlify/functions/getVeilleArticles"; // Adaptez si votre fonction Netlify est diff√©rente
        const ARTICLES_PER_PAGE = 5; // Nombre d'articles par page

        let allArticles = [];
        let currentPage = 1;

        const loader = document.getElementById("loader");
        const bodyElement = document.body;
        const mainElement = document.querySelector('main');
        const headerPlaceholder = document.getElementById("header-placeholder");
        const footerPlaceholder = document.getElementById("footer-placeholder");

        const veilleContainer = document.getElementById("veille-container");
        const initialLoadingMessage = document.getElementById("initial-loading-message");
        const errorDisplay = document.getElementById("error-display");

        const searchInput = document.getElementById("search-input");
        const filterTagSelect = document.getElementById("filter-tag");
        const sortOrderSelect = document.getElementById("sort-order");

        const prevPageBtn = document.getElementById("prev-page-btn");
        const nextPageBtn = document.getElementById("next-page-btn");
        const pageInfoSpan = document.getElementById("page-info");

        // --- Fonctions utilitaires ---

        /**
         * √âchappe les caract√®res HTML sp√©ciaux pour √©viter les XSS.
         * @param {string} text Le texte √† √©chapper.
         * @returns {string} Le texte √©chapp√©.
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            text = String(text);
            const map = {
                '&': '&amp;', // Correction: 'amp;' pour l'esperluette
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;' // Pour les apostrophes
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        /**
         * Fonction utilitaire pour charger des composants HTML via fetch.
         * @param {string} url - L'URL du composant HTML.
         * @param {string} placeholderId - L'ID de l'√©l√©ment o√π ins√©rer le HTML.
         * @returns {Promise<void>} Une promesse qui se r√©sout quand le composant est charg√©.
         */
        async function loadComponent(url, placeholderId) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const errorDetail = await res.text();
                    throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}. URL: ${url}. Response: ${errorDetail.substring(0, 200)}...`);
                }
                document.getElementById(placeholderId).innerHTML = await res.text();
                console.log(`Composant ${url} charg√© avec succ√®s dans #${placeholderId}.`);
            } catch (error) {
                console.error(`Erreur lors du chargement de ${url}:`, error);
                document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>Erreur de chargement du composant: ${url}. (${error.message})</p>`;
            }
        }

        /**
         * Cr√©e une carte d'article de veille.
         * @param {object} article Les donn√©es de l'article.
         * @returns {string} Le HTML de la carte.
         */
        function createArticleCard(article) {
            const articleDate = new Date(article.date);
            const formattedDate = articleDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Choisir une couleur de bordure bas√©e sur le tag ou par d√©faut
            let borderColor = '--primary-blue'; // Couleur par d√©faut
            switch(article.tag) {
                case 'Lancement de produit': borderColor = '#28a745'; break; // Vert
                case 'Publication de mod√®le': borderColor = '#007bff'; break; // Bleu
                case 'Int√©gration de produit': borderColor = '#ffc107'; break; // Jaune
                case 'Mise √† jour de produit': borderColor = '#17a2b8'; break; // Cyan
                case 'Recherche': borderColor = '#6f42c1'; break; // Violet
                case '√âthique IA': borderColor = '#dc3545'; break; // Rouge
                case 'R√©glementation': borderColor = '#fd7e14'; break; // Orange
                case 'Analyse de march√©': borderColor = '#6c757d'; break; // Gris
            }

            return `
                <div class="card" style="border-left-color: ${borderColor};">
                    <h2>${escapeHtml(article.titre || 'Titre inconnu')}</h2>
                    <div class="meta-info">
                        <strong>${formattedDate}</strong>
                        <span>‚Äî</span>
                        <em>${escapeHtml(article.sousTitre || '')}</em>
                        <span class="tag">${escapeHtml(article.tag || 'G√©n√©ral')}</span>
                    </div>
                    <p class="description">${escapeHtml(article.description || 'Pas de description disponible.')}</p>
                    <a href="${escapeHtml(article.url || '#')}" target="_blank" class="read-more">Lire l‚Äôarticle ‚Üí</a>
                    <p class="source">Source : ${escapeHtml(article.source || 'Inconnue')}</p>
                </div>
            `;
        }

        /**
         * Applique les filtres et le tri, puis affiche les articles.
         */
        function renderArticles() {
            let filteredArticles = [...allArticles];

            // 1. Filtrer par texte de recherche
            const searchText = searchInput.value.toLowerCase().trim();
            if (searchText) {
                filteredArticles = filteredArticles.filter(article =>
                    (article.titre && article.titre.toLowerCase().includes(searchText)) ||
                    (article.description && article.description.toLowerCase().includes(searchText)) ||
                    (article.sousTitre && article.sousTitre.toLowerCase().includes(searchText)) ||
                    (article.source && article.source.toLowerCase().includes(searchText)) ||
                    (article.tag && article.tag.toLowerCase().includes(searchText))
                );
            }

            // 2. Filtrer par tag
            const selectedTag = filterTagSelect.value;
            if (selectedTag) {
                filteredArticles = filteredArticles.filter(article => article.tag === selectedTag);
            }

            // 3. Trier
            const sortOrder = sortOrderSelect.value;
            filteredArticles.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortOrder === 'recent' ? dateB.getTime() - dateA.getTime() : dateA.getTime() - dateB.getTime();
            });

            // 4. G√©rer la pagination
            const totalPages = Math.ceil(filteredArticles.length / ARTICLES_PER_PAGE);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages; // Ajuster la page si les filtres r√©duisent le nombre
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
            const endIndex = startIndex + ARTICLES_PER_PAGE;
            const articlesToDisplay = filteredArticles.slice(startIndex, endIndex);

            // 5. Afficher les articles
            veilleContainer.innerHTML = ''; // Vider le conteneur
            if (articlesToDisplay.length === 0) {
                initialLoadingMessage.textContent = 'Aucun article ne correspond √† vos crit√®res de recherche.';
                initialLoadingMessage.style.display = 'block';
            } else {
                initialLoadingMessage.style.display = 'none';
                articlesToDisplay.forEach(article => {
                    veilleContainer.insertAdjacentHTML('beforeend', createArticleCard(article));
                });
            }

            // 6. Mettre √† jour l'√©tat de la pagination
            pageInfoSpan.textContent = `Page ${totalPages > 0 ? currentPage : 0} de ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        /**
         * Charge les articles de veille depuis l'API.
         */
        async function loadVeilleArticles() {
            initialLoadingMessage.style.display = 'block';
            errorDisplay.style.display = 'none';
            veilleContainer.innerHTML = ''; // Nettoyer pour le chargement initial

            try {
                const response = await fetch(API_VEILLE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Assurez-vous que les articles ont les propri√©t√©s minimales
                allArticles = data.map(article => ({
                    titre: article.title || article.Titre || 'Titre non sp√©cifi√©',
                    description: article.description || article.Description || 'Description non disponible.',
                    url: article.url || article.URL || '#',
                    date: article.date || article.Date || new Date().toISOString(), // Fallback pour la date
                    source: article.source || article.Source || 'Inconnue',
                    tag: article.tag || article.Tag || 'G√©n√©ral',
                    sousTitre: article.subTitle || article.SousTitre || ''
                }));
                
                renderArticles(); // Affiche les articles apr√®s le chargement
            } catch (error) {
                console.error("Erreur lors du chargement des articles de veille:", error);
                errorDisplay.textContent = `Erreur de chargement des articles: ${error.message}.`;
                errorDisplay.style.display = 'block';
                initialLoadingMessage.style.display = 'none'; // Cache le message de chargement
            } finally {
                // Le loader global sera cach√© par DOMContentLoaded
            }
        }

        // --- Initialisation au chargement du DOM ---
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Veille IA: DOMContentLoaded, d√©but de l'initialisation...");

            // Masquer la barre de d√©filement du body au d√©but pour une meilleure exp√©rience
            bodyElement.style.overflow = 'hidden';

            // 1. Charger le header et le footer
            await loadComponent("header.html", "header-placeholder");
            await loadComponent("footer.html", "footer-placeholder");

            // 2. Mettre √† jour l'√©tat actif du menu apr√®s le chargement du header
            const currentPath = window.location.pathname.split('/').pop();
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop() : '';
                if (linkFileName === currentPath || (currentPath === "" && linkFileName === "index.html")) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // 3. Charger les articles de veille
            await loadVeilleArticles();

            // 4. Mettre en place les √©couteurs d'√©v√©nements pour les filtres et le tri
            searchInput.addEventListener('input', () => { currentPage = 1; renderArticles(); });
            filterTagSelect.addEventListener('change', () => { currentPage = 1; renderArticles(); });
            sortOrderSelect.addEventListener('change', () => { currentPage = 1; renderArticles(); });
            prevPageBtn.addEventListener('click', () => { currentPage--; renderArticles(); });
            nextPageBtn.addEventListener('click', () => { currentPage++; renderArticles(); });

            // 5. Cacher le loader et r√©v√©ler le contenu principal
            if (loader) {
                loader.classList.add("hidden");
                // Attendre la fin de la transition d'opacit√© du loader avant de l'enlever compl√®tement
                loader.addEventListener('transitionend', () => {
                    if (loader.classList.contains('hidden')) {
                        loader.style.display = 'none';
                    }
                }, { once: true });
            }
            
            bodyElement.classList.add("show"); // R√©v√®le le body avec sa transition
            mainElement.classList.add("show"); // R√©v√®le main avec sa transition
            bodyElement.style.overflow = ''; // Restaurer le d√©filement du body une fois la page visible

            console.log("Veille IA: Initialisation termin√©e.");
        });
    </script>
</body>
</html>
