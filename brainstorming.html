<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brainstorming - Espace IA</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --background-grey: #f0f2f5;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --grey-text: #555;
            --border-color: #ccc;
            --error-text: #dc3545;
        }
        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-grey);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            padding: 40px 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }
        .nav-wrapper {
            background-color: var(--primary-blue);
            width: 100%;
            position: relative;
            flex-shrink: 0;
            padding: 5px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 30px;
            box-sizing: border-box;
        }
        nav { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        nav a { text-decoration: none; color: white; font-weight: bold; font-size: 1.1em; padding: 10px 18px; border-radius: 8px; transition: background 0.3s ease; margin: 0 5px; white-space: nowrap; position: relative; }
        nav a:hover, nav a.active { background-color: white; color: var(--primary-blue); }
        
        .content-section { 
            width: 100%; 
            padding: 25px; 
            box-sizing: border-box; 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
            position: relative; 
        }
        .content-section h2, .content-section h3 { 
            text-align: center; 
            color: var(--dark-blue); 
            margin-top: 0; 
            margin-bottom: 25px; 
        }

        /* Styles spécifiques à la page de brainstorming */
        .participant-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .participant-filters > div {
            flex: 1;
            min-width: 200px;
        }

        .participant-filters label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--grey-text);
        }

        .participant-filters input[type="text"],
        .participant-filters select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f9fafb;
            box-sizing: border-box;
        }
        
        .participant-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        /* Ajustement du select dans participant-selector pour ne pas prendre toute la largeur s'il y a un bouton */
        .participant-selector select {
            flex-grow: 1; 
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f9fafb;
            min-width: 180px;
        }
        .participant-selector button {
            padding: 10px 20px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .participant-selector button:hover {
            background-color: var(--dark-blue);
        }

        #brainstorming-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .participant-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .participant-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            position: relative; /* Pour le bouton de suppression */
        }
        .participant-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-blue);
        }
        .participant-header h3 {
            margin: 0;
            font-size: 1.4em;
            color: var(--dark-blue);
            text-align: left; /* Annule le text-align: center global */
            flex-grow: 1;
        }
        .remove-participant-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .remove-participant-btn:hover {
            opacity: 1;
        }

        .ideas-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            box-sizing: border-box; /* Inclure padding et border dans la largeur */
        }

        .media-upload-section {
            border: 2px dashed var(--light-blue);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            color: var(--grey-text);
            transition: border-color 0.2s, background-color 0.2s;
        }
        .media-upload-section:hover {
            border-color: var(--primary-blue);
            background-color: #f8fbff;
        }
        .media-upload-section p {
            margin: 0;
            font-size: 0.9em;
        }
        .media-upload-section i {
            font-size: 2em;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .media-preview img, .media-preview video, .media-preview audio {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .media-preview .file-name {
            font-size: 0.8em;
            color: var(--grey-text);
            word-break: break-all;
        }


        .save-brainstorm-btn {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
        }
        .save-brainstorm-btn:hover {
            background-color: var(--dark-blue);
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            main {
                padding: 20px 10px;
                gap: 20px;
            }
            .content-section {
                padding: 20px;
                border-radius: 0;
            }
            .participant-filters,
            .participant-selector {
                flex-direction: column;
                gap: 10px;
            }
            .participant-filters input[type="text"],
            .participant-filters select,
            .participant-selector select,
            .participant-selector button {
                width: 100%;
                min-width: unset;
            }
            #brainstorming-area {
                grid-template-columns: 1fr; /* Une seule colonne sur mobile */
                gap: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="nav-wrapper">
        <div class="menu-container">
            <nav>
                <a href="index.html">Accueil</a>
                <a href="equipe.html">Équipe</a>
                <a href="outils.html">Outils</a>
                <a href="galerie.html">Prompts</a>
                <a href="cas-usages.html">Workflows</a>
                <a href="charte.html">Chartes</a>
                <a href="faq.html">FAQ</a>
                <a href="demandes_ia.html">Demandes</a>
                <a href="gestion-license.html">Licenses</a>
                <a href="brainstorming.html" class="active">Brainstorming</a>
            </nav>
        </div>
    </div>

    <main>
        <section class="content-section">
            <h2>Session de Brainstorming</h2>
            <div class="participant-filters">
                <div>
                    <label for="filter-pole">Filtrer par Pôle :</label>
                    <select id="filter-pole">
                        <option value="all">Tous les pôles</option>
                        </select>
                </div>
                <div>
                    <label for="search-collaborator">Rechercher un collaborateur :</label>
                    <input type="text" id="search-collaborator" placeholder="Nom du collaborateur..." />
                </div>
            </div>
            
            <div class="participant-selector">
                <select id="participant-select">
                    <option value="">Sélectionner un participant...</option>
                    </select>
                <button id="add-participant-btn"><i class="fas fa-plus"></i> Ajouter au Brainstorm</button>
            </div>
            
            <div id="brainstorming-area">
                <p id="no-participant-msg" style="text-align: center; color: var(--grey-text);">
                    Ajoutez des participants ci-dessus pour commencer le brainstorming.
                </p>
            </div>
        </section>
    </main>
    
    <footer><p>&copy; 2025 Espace IA. Tous droits réservés.</p></footer>

    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const apiBase = './.netlify/functions/';
        let allProfils = []; // Stockera tous les profils bruts
        let currentParticipants = new Set(); // Stocke les IDs des participants actuellement dans le brainstorming

        // Éléments du DOM
        const filterPoleSelect = document.getElementById('filter-pole');
        const searchCollaboratorInput = document.getElementById('search-collaborator');
        const participantSelect = document.getElementById('participant-select');
        const addParticipantBtn = document.getElementById('add-participant-btn');
        const brainstormingArea = document.getElementById('brainstorming-area');
        const noParticipantMsg = document.getElementById('no-participant-msg');

        // Fonction d'échappement HTML pour le contenu et les attributs
        const escapeHtml = (text) => {
            if (text === null || text === undefined) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        };
        const escapeHtmlAttribute = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            let escaped = JSON.stringify(unsafe);
            if (escaped.startsWith('"') && escaped.endsWith('"')) {
                escaped = escaped.slice(1, -1);
            }
            return escaped.replace(/`/g, '\\`');
        };

        // Normalise une chaîne de caractères pour la recherche (minuscules, sans accents)
        const normalizeString = (str) => {
            return str ? String(str).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : '';
        };

        // Charge les profils depuis l'API Netlify et initialise les filtres
        async function loadProfils() {
            try {
                const response = await fetch(`${apiBase}getProfils`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allProfils = await response.json();
                populatePoleFilter(); // Remplit le filtre par pôle
                filterAndPopulateParticipants(); // Remplit le sélecteur de participants initial
            } catch (error) {
                console.error('Erreur chargement profils:', error);
                // Gérer l'erreur, par exemple afficher un message à l'utilisateur
            }
        }

        // Remplit le sélecteur de pôle
        function populatePoleFilter() {
            const poles = [...new Set(allProfils.map(p => p.pole).filter(Boolean))].sort();
            filterPoleSelect.innerHTML = '<option value="all">Tous les pôles</option>';
            poles.forEach(pole => {
                const option = document.createElement('option');
                option.value = pole;
                option.textContent = pole;
                filterPoleSelect.appendChild(option);
            });
        }

        // Filtre les profils et remplit le sélecteur de participants
        function filterAndPopulateParticipants() {
            const selectedPole = filterPoleSelect.value;
            const searchTerm = normalizeString(searchCollaboratorInput.value);

            const filteredProfils = allProfils.filter(profil => {
                const matchesPole = (selectedPole === 'all' || profil.pole === selectedPole);
                const matchesSearch = (!searchTerm || normalizeString(profil.name).includes(searchTerm));
                // Exclut les participants déjà ajoutés au brainstorming
                const notAlreadyAdded = !currentParticipants.has(profil.id);
                return matchesPole && matchesSearch && notAlreadyAdded;
            }).sort((a, b) => a.name.localeCompare(b.name)); // Trie par nom

            participantSelect.innerHTML = '<option value="">Sélectionner un participant...</option>';
            filteredProfils.forEach(profil => {
                const option = document.createElement('option');
                option.value = profil.id;
                option.textContent = profil.name;
                participantSelect.appendChild(option);
            });
        }

        // Ajoute un participant au brainstorming
        function addParticipantToBrainstorm() {
            const selectedProfilId = participantSelect.value;
            if (!selectedProfilId) {
                alert("Veuillez sélectionner un participant.");
                return;
            }

            const profilToAdd = allProfils.find(p => p.id === selectedProfilId);
            if (profilToAdd && !currentParticipants.has(profilToAdd.id)) {
                createParticipantCard(profilToAdd);
                currentParticipants.add(profilToAdd.id);
                participantSelect.value = ''; // Réinitialise le sélecteur
                filterAndPopulateParticipants(); // Met à jour le sélecteur pour retirer le participant ajouté
                updateNoParticipantMessage();
            } else {
                alert("Ce participant est déjà ajouté ou n'existe pas.");
            }
        }

        // Crée et affiche la carte d'un participant
        function createParticipantCard(profil) {
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.setAttribute('data-participant-id', profil.id); // Utile pour retrouver la carte

            // Utilise profil.photo ou un placeholder si absent
            const photoUrl = profil.photo || 'https://via.placeholder.com/60x60?text=Profil'; 

            card.innerHTML = `
                <div class="participant-header">
                    <img src="${escapeHtmlAttribute(photoUrl)}" alt="${escapeHtmlAttribute('Photo de ' + profil.name)}">
                    <h3>${escapeHtml(profil.name)}</h3>
                    <button class="remove-participant-btn" title="Retirer ce participant">&times;</button>
                </div>
                <div class="ideas-section">
                    <h4>Idées :</h4>
                    <textarea placeholder="Écrivez vos idées ici..."></textarea>
                </div>
                <div class="media-upload-section">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Glissez-déposez des fichiers ici ou cliquez pour uploader (images, vidéos, sons)</p>
                    <input type="file" multiple accept="image/*,video/*,audio/*" style="display:none;">
                    <div class="media-preview"></div>
                </div>
                <button class="save-brainstorm-btn">Enregistrer</button>
            `;

            // Ajout des écouteurs d'événements
            card.querySelector('.remove-participant-btn').addEventListener('click', () => {
                removeParticipantCard(profil.id);
            });

            const fileInput = card.querySelector('.media-upload-section input[type="file"]');
            const uploadArea = card.querySelector('.media-upload-section');
            const mediaPreview = card.querySelector('.media-preview');

            // Logique pour le drag & drop et le click
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--dark-blue)'; // Utiliser les variables CSS
                uploadArea.style.backgroundColor = '#e0f2f7'; // Couleur plus claire pour l'effet de survol
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--light-blue)';
                uploadArea.style.backgroundColor = 'transparent';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--light-blue)';
                uploadArea.style.backgroundColor = 'transparent';
                handleFiles(e.dataTransfer.files, mediaPreview);
            });
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files, mediaPreview);
            });

            card.querySelector('.save-brainstorm-btn').addEventListener('click', () => {
                saveParticipantData(profil.id, card);
            });

            brainstormingArea.appendChild(card);
            updateNoParticipantMessage();
        }

        // Gère les fichiers sélectionnés/droppés (frontend uniquement, pour l'aperçu)
        function handleFiles(files, mediaPreviewContainer) {
            // NOTE IMPORTANTE : L'UPLOAD RÉEL VERS UN STOCKAGE CLOUD (COMME CLOUDINARY, S3)
            // OU VOTRE PROPRE SERVEUR DOIT ÊTRE IMPLÉMENTÉ ICI.
            // POUR L'INSTANT, CECI AFFICHE SEULEMENT UN APERÇU LOCAL.

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = file.name;
                    mediaPreviewContainer.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = true;
                    video.preload = 'metadata'; // Charge juste assez pour obtenir la durée
                    mediaPreviewContainer.appendChild(video);
                } else if (file.type.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.src = URL.createObjectURL(file);
                    audio.controls = true;
                    mediaPreviewContainer.appendChild(audio);
                } else {
                    const p = document.createElement('p');
                    p.className = 'file-name';
                    p.textContent = `Fichier: ${file.name}`;
                    mediaPreviewContainer.appendChild(p);
                }
                // Optionnel: Ajoutez un indicateur de chargement et l'état de l'upload ici
            }
        }

        // Fonction pour enregistrer les données du participant (conceptuelle)
        function saveParticipantData(participantId, cardElement) {
            const ideas = cardElement.querySelector('.ideas-section textarea').value;
            const mediaFiles = []; // Ici, vous devriez récupérer les URLs des fichiers uploadés
                                   // après un upload réussi vers votre backend.

            console.log(`Enregistrement pour l'ID ${participantId}:`);
            console.log('Idées:', ideas);
            console.log('Fichiers médias (à implémenter le vrai upload):', mediaFiles);

            alert(`Idées pour ${participantId} enregistrées (simulé) !`);

            // Ici, vous enverriez ces données à une autre fonction Netlify (e.g., `saveBrainstormData`)
            // fetch(`${apiBase}saveBrainstormData`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ participantId, ideas, mediaUrls: mediaFiles })
            // }).then(response => {
            //     if (response.ok) console.log('Données sauvegardées !');
            //     else console.error('Erreur sauvegarde données brainstorming.');
            // });
        }

        // Retire une carte de participant
        function removeParticipantCard(id) {
            const cardToRemove = brainstormingArea.querySelector(`[data-participant-id="${id}"]`);
            if (cardToRemove) {
                if (confirm(`Voulez-vous vraiment retirer ${cardToRemove.querySelector('h3').textContent} du brainstorming ?`)) {
                    cardToRemove.remove();
                    currentParticipants.delete(id);
                    filterAndPopulateParticipants(); // Met à jour le sélecteur pour rajouter le participant
                    updateNoParticipantMessage();
                }
            }
        }

        // Met à jour le message "Ajouter des participants..."
        function updateNoParticipantMessage() {
            if (currentParticipants.size === 0) {
                noParticipantMsg.style.display = 'block';
            } else {
                noParticipantMsg.style.display = 'none';
            }
        }
        
        // Logique du menu actif (à copier depuis votre index.html ou un fichier commun)
        function setActiveNavLink() {
            const currentPath = window.location.pathname.split('/').pop() || "index.html";
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = new URL(link.href, window.location.origin).pathname.split('/').pop();
                link.classList.toggle("active", linkHref === currentPath);
            });
        }


        // Initialisation
        addParticipantBtn.addEventListener('click', addParticipantToBrainstorm);
        filterPoleSelect.addEventListener('change', filterAndPopulateParticipants);
        searchCollaboratorInput.addEventListener('input', filterAndPopulateParticipants); // Filtrer en temps réel
        
        await loadProfils(); // Charge les profils et initialise les filtres
        setActiveNavLink(); // Active le lien du menu
        updateNoParticipantMessage(); // Vérifie au chargement si des participants sont déjà là (non implémenté pour l'instant)
    });
    </script>
</body>
</html>
