<!DOCTYPE html>

<html lang="fr">

<head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Équipe</title>

    <link rel="stylesheet" href="style.css" />

    <style>

        body {

            opacity: 0;

            transition: opacity 0.3s ease-in;

            margin: 0;

            font-family: Arial, sans-serif;

            background: #f0f4f8;

        }

        main {

            display: none; /* Main caché au début, sera affiché par le script */

        }

        .container {

            max-width: 900px;

            margin: 40px auto;

            padding: 20px;

            background: #fff;

            border-radius: 20px;

            box-shadow: 0 4px 20px rgba(0,0,0,0.1);

        }

        .btn-creer {

            display: block;

            margin: 0 auto 30px;

            background: #0077b6;

            color: white;

            padding: 12px 24px;

            border-radius: 8px;

            text-decoration: none;

            font-weight: bold;

            width: fit-content;

            text-align: center;

            transition: background 0.2s ease;

        }

        .btn-creer:hover {

            background: #005f8a;

        }

        .filters {

            text-align: center;

            margin-bottom: 20px;

        }

        .filters select,

        .filters input {

            padding: 8px 12px;

            border-radius: 6px;

            border: 1px solid #ccc;

            font-size: 1rem;

            margin: 0 10px;

            transition: border-color 0.2s ease;

        }

        .filters select:focus,

        .filters input:focus {

            outline: none;

            border-color: #0077b6;

        }

        .grid {

            display: flex;

            flex-wrap: wrap;

            gap: 16px;

            justify-content: center ;

        }

        .vignette {

            background: white;

            border-radius: 12px;

            box-shadow: 0 6px 15px rgba(0,0,0,0.1);

            padding: 12px;

            width: 220px;

            position: relative;

            transition: transform 0.3s ease, box-shadow 0.3s ease;

            display: flex;

            flex-direction: column;

            align-items: center;

            justify-content: space-between;

            cursor: pointer;

        }

        .vignette:hover {

            transform: translateY(-6px);

            box-shadow: 0 10px 20px rgba(0,0,0,0.15);

        }

        .vignette img {

            width: 80px;

            height: 80px;

            border-radius: 50%;

            object-fit: cover;

            margin: 0 auto 8px;

            display: block;

        }

        .vignette h3 {

            margin: 8px 0 4px;

            font-size: 1.1rem;

            color: #0077b6;

            text-align: center;

        }

        .vignette .pole {

            font-size: 0.85rem;

            color: #555;

            text-align: center;

            margin-bottom: 6px;

        }

        .icon-bar {

            display: flex;

            justify-content: center;

            gap: 8px;

            margin-top: auto;

            padding-top: 10px;

        }

        .btn-edit,

        .btn-delete,

        .btn-note {

            background: #f0f0f0;

            border: 1px solid #ccc;

            border-radius: 6px;

            padding: 4px 8px;

            font-size: 0.9rem;

            color: #0077b6;

            cursor: pointer;

            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;

        }

        .btn-edit:hover,

        .btn-delete:hover,

        .btn-note:hover {

            background: #e0f3fc;

            border-color: #0077b6;

            color: #005f8a;

        }

        .btn-note {

            padding: 4px 8px;

        }

        .note-badge {

            position: absolute;

            top: 8px;

            right: 8px;

            background: #ffcb05;

            color: #000;

            font-size: 0.7rem;

            padding: 2px 6px;

            border-radius: 10px;

            font-weight: bold;

            display: none;

            z-index: 10;

        }

        .note-editor {

            max-height: 0;

            overflow: hidden;

            opacity: 0;

            transition: max-height 0.3s ease, opacity 0.3s ease;

            margin-top: 10px;

            width: 100%;

        }

        .note-editor.open {

            max-height: 300px;

            opacity: 1;

        }

        .note-editor textarea {

            width: calc(100% - 12px);

            min-height: 60px;

            border-radius: 6px;

            border: 1px solid #ccc;

            padding: 6px;

            font-size: 0.85rem;

            resize: vertical;

            box-sizing: border-box;

        }

        .note-editor .actions {

            display: flex;

            justify-content: space-between;

            gap: 4px;

            margin-top: 6px;

        }

        .note-editor .actions button {

            flex: 1;

            font-size: 0.8rem;

            border-radius: 4px;

            border: none;

            cursor: pointer;

            padding: 6px 8px;

            color: white;

            transition: background 0.2s ease;

        }

        .note-editor .save-note { background: #0077b6; }

        .note-editor .save-note:hover { background: #005f8a; }

        .note-editor .clear-note { background: #999; }

        .note-editor .clear-note:hover { background: #777; }

        .note-editor .close-note { background: #bbb; }

        .note-editor .close-note:hover { background: #999; }



        .side-panel {

            position: fixed;

            top: 0;

            right: 0;

            width: 340px;

            height: 100%;

            background: #f9f9f9;

            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);

            padding: 24px 20px;

            overflow-y: auto;

            transition: transform 0.3s ease;

            z-index: 1000;

            transform: translateX(100%);

            display: flex;

            flex-direction: column;

            gap: 16px;

        }

        .side-panel.show {

            transform: translateX(0);

        }

        .side-panel .close-panel {

            position: absolute;

            top: 12px;

            left: 12px;

            background: transparent;

            font-size: 24px;

            border: none;

            cursor: pointer;

            color: #333;

            z-index: 1001;

        }

        .side-panel h2 {

            margin-top: 0;

            color: #0077b6;

            font-size: 1.6rem;

            border-bottom: 2px solid #e0e0e0;

            padding-bottom: 10px;

            margin-bottom: 20px;

        }

        .side-panel ul {

            list-style: disc;

            padding-left: 20px;

            margin: 0;

        }

        .side-panel p {

            margin: 0 0 10px;

        }

        .side-panel .note-content {

            background: #fffbe6;

            padding: 10px 12px;

            border-left: 4px solid #ffcb05;

            border-radius: 6px;

            font-size: 0.95rem;

            margin-top: 15px;

        }

        /* Styles spécifiques pour la galerie dans le panneau latéral */

        .side-panel .gallery-section {

            margin-top: 20px;

            border-top: 1px solid #eee;

            padding-top: 15px;

        }

        .side-panel .gallery-section h3 {

            color: #0077b6;

            font-size: 1.2rem;

            margin-bottom: 10px;

        }

        .side-panel .gallery-images-container {

            display: flex;

            flex-wrap: wrap;

            gap: 10px;

            justify-content: center;

            margin-bottom: 10px;

            min-height: 100px;

            background-color: #e9f5ff;

            padding: 5px;

            border-radius: 8px;

        }

        .side-panel .gallery-images-container img {

            width: 100%;

            max-width: 150px;

            height: 100px;

            object-fit: cover;

            border-radius: 8px;

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

            border: 1px solid #ddd;

            cursor: pointer; /* Add cursor pointer to indicate clickability */

        }

        .side-panel .no-image-placeholder {

            text-align: center;

            color: #888;

            font-style: italic;

            font-size: 0.9rem;

            padding: 10px 0;

        }

        footer {

            text-align: center;

            margin-top: 4rem;

            font-size: 0.9rem;

            color: #888;

            padding-bottom: 20px;

        }

    </style>

</head>

<body>

    <div id="header-placeholder"></div>

    <main>

        <div class="container">

            <a href="profil.html" class="btn-creer">+ Créer un nouveau profil</a>

            <div class="filters">

                <select id="filterPole">

                    <option value="">Tous les pôles</option>

                    <option value="Pôle créa.">Pôle créa.</option>

                    <option value="CRM">CRM</option>

                    <option value="Communication">Communication</option>

                    <option value="Partenariats">Partenariats</option>

                    <option value="Marketing digital">Marketing digital</option>

                    <option value="Positionnement">Positionnement</option>

                </select>

                <input type="text" id="searchInput" placeholder="Rechercher un nom ou outil...">

            </div>

            <div class="grid" id="profil-list"></div>

        </div>

    </main>

    <div id="side-panel" class="side-panel">

        <button class="close-panel">×</button>

        <div id="panel-content"></div>

    </div>



    <footer>Mis à jour automatiquement le 2025-06-09</footer>



    <script>

        const PROXY_URL = "/.netlify/functions/proxy";

        let profils = [];

        let galleryPrompts = []; // Nouvelle variable globale pour stocker les prompts de la galerie



        const listContainer = document.getElementById("profil-list");

        const filterPole = document.getElementById("filterPole");

        const searchInput = document.getElementById("searchInput");

        const sidePanel = document.getElementById("side-panel");

        const panelContent = document.getElementById("panel-content");

        const closePanelBtn = document.querySelector(".close-panel");





        function normalizeString(str) {

            if (typeof str !== 'string') return '';

            return str.normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();

        }



        function renderProfils() {

            console.log("Équipe: Début du rendu des profils...");

            const selectedPole = normalizeString(filterPole.value);

            const searchQuery = normalizeString(searchInput.value);

            listContainer.innerHTML = "";



            const filteredProfils = profils.filter(p => {

                const poleNormalized = normalizeString(p.pole || '');

                const nameNormalized = normalizeString(p.name || '');

                const toolsNormalized = (Array.isArray(p.tools) ? p.tools : []).map(t => normalizeString(t));



                const matchPole = !selectedPole || poleNormalized === selectedPole;

                const matchSearch = !searchQuery || nameNormalized.includes(searchQuery) || toolsNormalized.some(tool => tool.includes(searchQuery));

                return matchPole && matchSearch;

            });



            if (filteredProfils.length === 0) {

                listContainer.innerHTML = '<p style="text-align: center; color: #666; width: 100%;">Aucun profil ne correspond à vos critères.</p>';

            }



            filteredProfils.forEach((p) => {

                const div = document.createElement("div");

                div.className = "vignette";

                div.dataset.id = p.id;



                const hasNote = (p.note || '').trim() !== '';



                div.innerHTML = `

                    <span class="note-badge" style="${hasNote ? 'display: inline-block;' : 'display: none;'}">Note</span>

                    <img src="${p.photo || 'https://via.placeholder.com/80x80?text=Profil'}" alt="${p.name || 'Profil'}" />

                    <h3>${p.name || 'Nom Inconnu'}</h3>

                    <div class="pole">${p.pole || 'Pôle Inconnu'}</div>

                    <div class="icon-bar">

                        <button class="btn-note" title="Note">🗒️</button>

                        <button class="btn-edit" title="Éditer">✏️</button>

                        <button class="btn-delete" title="Supprimer">🗑️</button>

                    </div>

                    <div class="note-editor">

                        <textarea>${p.note || ''}</textarea>

                        <div class="actions">

                            <button class="save-note">Enregistrer</button>

                            <button class="clear-note">Effacer</button>

                            <button class="close-note">Retour</button>

                        </div>

                    </div>

                `;

                const noteBadge = div.querySelector(".note-badge");

                const noteEditor = div.querySelector(".note-editor");

                const textarea = noteEditor.querySelector("textarea");



                div.querySelector(".btn-note").addEventListener("click", e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Note' pour", p.name);

                    document.querySelectorAll(".note-editor.open").forEach(el => {

                        if (el !== noteEditor) {

                            el.classList.remove("open");

                        }

                    });

                    noteEditor.classList.toggle("open");

                });



                div.querySelector(".save-note").addEventListener("click", async e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Enregistrer note' pour", p.name);

                    const content = textarea.value.trim();

                    try {

                        const res = await fetch(`${PROXY_URL}?action=updateProfil`, {

                            method: "POST",

                            headers: { "Content-Type": "application/json" },

                            body: JSON.stringify({ id: p.id, note: content })

                        });

                        const data = await res.json();

                        if (data.success) {

                            console.log("Équipe: Note enregistrée avec succès pour", p.name);

                            p.note = content;

                            noteBadge.style.display = content ? 'inline-block' : 'none';

                            noteEditor.classList.remove("open");

                        } else {

                            console.error("Équipe: Erreur lors de l'enregistrement de la note:", data.message);

                            alert("Erreur lors de l'enregistrement de la note : " + data.message);

                        }

                    } catch (error) {

                        console.error("Équipe: Erreur réseau/serveur lors de l'enregistrement de la note:", error);

                        alert("Erreur réseau/serveur lors de l'enregistrement de la note.");

                    }

                });



                div.querySelector(".clear-note").addEventListener("click", async e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Effacer note' pour", p.name);

                    textarea.value = "";

                    try {

                        const res = await fetch(`${PROXY_URL}?action=updateProfil`, {

                            method: "POST",

                            headers: { "Content-Type": "application/json" },

                            body: JSON.stringify({ id: p.id, note: "" })

                        });

                        const data = await res.json();

                        if (data.success) {

                            console.log("Équipe: Note effacée avec succès pour", p.name);

                            p.note = "";

                            noteBadge.style.display = 'none';

                            noteEditor.classList.remove("open");

                        } else {

                            console.error("Équipe: Erreur lors de l'effacement de la note:", data.message);

                            alert("Erreur lors de l'effacement de la note : " + data.message);

                        }

                    } catch (error) {

                        console.error("Équipe: Erreur réseau/serveur lors de l'effacement de la note:", error);

                        alert("Erreur réseau/serveur lors de l'effacement de la note.");

                    }

                });



                div.querySelector(".close-note").addEventListener("click", e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Retour note' pour", p.name);

                    textarea.value = p.note || '';

                    noteEditor.classList.remove("open");

                });



                div.querySelector(".btn-edit").addEventListener("click", e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Éditer' pour", p.name);

                    window.location.href = `profil.html?edit=${encodeURIComponent(p.id)}`;

                });



                div.querySelector(".btn-delete").addEventListener("click", async e => {

                    e.stopPropagation();

                    console.log("Équipe: Clic sur 'Supprimer' pour", p.name);

                    if (confirm(`Supprimer définitivement ${p.name} ?`)) {

                        try {

                            const res = await fetch(`${PROXY_URL}?action=deleteProfil`, {

                                method: "POST",

                                headers: { "Content-Type": "application/json" },

                                body: JSON.stringify({ id: p.id })

                            });

                            const data = await res.json();

                            if (data.success) {

                                console.log("Équipe: Profil supprimé avec succès:", p.name);

                                profils = profils.filter(profile => profile.id !== p.id);

                                // Re-charger les prompts pour s'assurer que les images sont à jour si le profil est supprimé

                                initPageData(); // Appel de la fonction globale d'initialisation

                            } else {

                                console.error("Équipe: Erreur lors de la suppression du profil:", data.message);

                                alert("Erreur lors de la suppression du profil : " + data.message);

                            }

                        } catch (error) {

                            console.error("Équipe: Erreur réseau/serveur lors de la suppression du profil:", error);

                            alert("Erreur réseau/serveur lors de la suppression du profil.");

                        }

                    }

                });



                // Écouteur pour ouvrir le panneau latéral (détails du profil)

                div.addEventListener("click", e => {

                    if (!e.target.closest(".icon-bar") && !e.target.closest(".note-editor")) {

                        console.log("Équipe: Ouverture du panneau latéral pour", p.name);

                        

                        let gallerySection = '';

                        const profilNameNormalized = normalizeString(p.name || '');



                        // Filtrer les prompts de la galerie par l'auteur (nom du profil)

                        // Nous nous basons sur galleryPrompts qui est déjà chargé.

                        const imagesByAuthor = galleryPrompts.filter(prompt => {

                            // Assurez-vous que prompt.auteur existe et est comparable

                            return normalizeString(prompt.auteur || '') === profilNameNormalized;

                        }).map(prompt => prompt.imageUrl).filter(Boolean); // Extrait seulement les URLs non vides



                        console.log(`DEBUG: Images de galerie trouvées pour "${p.name}" :`, imagesByAuthor);



                        if (imagesByAuthor.length > 0) {

                            // Nous allons montrer les 2 dernières images publiées par cet auteur.

                            const lastTwoImages = imagesByAuthor.slice(-2);

                            console.log("DEBUG: Les 2 dernières images sélectionnées pour l'affichage:", lastTwoImages);

                            

                            const imagesHtml = lastTwoImages.map(imgSrc => {

                                if (imgSrc && typeof imgSrc === 'string' && (imgSrc.startsWith('http') || imgSrc.startsWith('/') || imgSrc.startsWith('./') || imgSrc.startsWith('../'))) {

                                    // Make images clickable

                                    return `<a href="galerie.html?imageUrl=${encodeURIComponent(imgSrc)}" target="_blank"><img src="${imgSrc}" alt="Image de galerie du prompt" onerror="this.onerror=null;this.src='https://via.placeholder.com/150x100?text=Erreur+image';" title="Image: ${imgSrc}"></a>`;

                                } else {

                                    console.warn("DEBUG: URL d'image de galerie invalide détectée:", imgSrc);

                                    return `<img src="https://via.placeholder.com/150x100?text=Image+Invalide" alt="Image invalide" title="URL invalide: ${imgSrc}">`;

                                }

                            }).join('');



                            gallerySection = `

                                <div class="gallery-section">

                                    <h3>Derniers prompts partagés</h3>

                                    <div class="gallery-images-container">

                                        ${imagesHtml}

                                    </div>

                                </div>

                            `;                        } else {

                            console.log("DEBUG: Aucune image de galerie trouvée pour l'auteur :", p.name);

                            gallerySection = `

                                <div class="gallery-section">

                                    <h3>Derniers prompts partagés</h3>

                                    <p class="no-image-placeholder">Aucun prompt partagé par ${p.name} n'a été trouvé.</p>

                                    <p class="no-image-placeholder">

                                        <a href="prompt.html">Partager un prompt maintenant !</a>

                                    </p>

                                </div>

                            `;                        }



                        const toolsList = (Array.isArray(p.tools) ? p.tools : []).map(t => `<li>${t}</li>`).join('');



                        panelContent.innerHTML = `

                            <h2>${p.name || 'Nom Inconnu'}</h2>

                            <p><strong>Pôle :</strong> ${p.pole || '—'}</p>

                            <p><strong>Outils IA :</strong></p>

                            <ul>${toolsList}</ul>

                            ${hasNote ? `<div class="note-content"><strong>Note :</strong><br>${p.note}</div>` : ''}

                            ${gallerySection}

                        `;                        sidePanel.classList.add("show");

                    }

                });



                listContainer.appendChild(div);

            });

            console.log("Équipe: Rendu des profils terminé.");

        }



        closePanelBtn.addEventListener("click", () => {

            console.log("Équipe: Clic sur le bouton de fermeture du panneau.");

            sidePanel.classList.remove("show");

        });



        document.addEventListener("click", event => {

            if (sidePanel.classList.contains("show") && !sidePanel.contains(event.target) && !event.target.closest(".vignette")) {

                console.log("Équipe: Clic en dehors du panneau, fermeture.");

                sidePanel.classList.remove("show");

            }

        });



        filterPole.addEventListener("change", renderProfils);

        searchInput.addEventListener("input", renderProfils);



        async function mettreAJourBulleDemandes() {

            const notif = document.getElementById("notif-count");

            if (!notif) {

                console.warn("Équipe: L'élément 'notif-count' n'a pas été trouvé dans le header.");

                return;

            }

            try {

                console.log("Équipe: Tentative de récupération des demandes pour la bulle...");

                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);

                if (!res.ok) {

                    console.error(`Équipe: Erreur HTTP lors de la récupération des demandes: ${res.status}`);

                    throw new Error(`Erreur HTTP: ${res.status}`);

                }

                const demandes = await res.json();

                console.log("Équipe: Demandes récupérées pour la bulle:", demandes);

                notif.textContent = Array.isArray(demandes) ? demandes.length : 0;

                notif.style.display = (Array.isArray(demandes) && demandes.length > 0) ? "inline-block" : "none";

            } catch (e) {

                console.error("Équipe: Erreur mise à jour compteur de demandes :", e);

                notif.style.display = "none";

            }

        }



        // Nouvelle fonction pour charger tous les prompts de la galerie

        async function fetchGalleryPrompts() {

            console.log("Équipe: Tentative de récupération des prompts de la galerie...");

            try {

                // Assurez-vous que votre fonction Netlify 'proxy' peut gérer cette action

                // et qu'elle renvoie un tableau d'objets avec 'auteur' et 'imageUrl'.

                const res = await fetch(`${PROXY_URL}?action=getGalleryPrompts`);

                if (!res.ok) {

                    const errorText = await res.text();

                    throw new Error(`Erreur HTTP lors de la récupération des prompts de galerie: ${res.status} - ${errorText}`);

                }

                const data = await res.json();

                // Assurez-vous que 'data' est un tableau, sinon initialisez-le comme un tableau vide

                galleryPrompts = Array.isArray(data) ? data : [];

                console.log("Équipe: Prompts de la galerie chargés :", galleryPrompts.length, galleryPrompts);

            } catch (error) {

                console.error("Équipe: Erreur lors du chargement des prompts de la galerie :", error);

                galleryPrompts = []; // S'assurer que c'est un tableau même en cas d'erreur

            }

        }



        // Fonction d'initialisation principale qui charge toutes les données nécessaires

        async function initPageData() {

            try {

                // 1. Charger le header

                const headerResponse = await fetch("header.html");

                if (!headerResponse.ok) {

                    throw new Error(`Erreur HTTP lors du chargement du header pour Équipe: ${headerResponse.status}`);

                }

                const headerHtml = await headerResponse.text();

                const headerPlaceholder = document.getElementById("header-placeholder");

                if (headerPlaceholder) {

                    headerPlaceholder.innerHTML = headerHtml;

                } else {

                    console.error("Équipe: L'élément #header-placeholder n'a pas été trouvé.");

                }



                // 2. Charger les profils et les prompts de la galerie en parallèle

                // Utilisation de Promise.all pour charger les deux sets de données en même temps

                const [profilsResponse] = await Promise.all([

                    fetch(`${PROXY_URL}?action=getProfils`),

                    fetchGalleryPrompts() // Cette fonction met à jour galleryPrompts

                ]);



                if (!profilsResponse.ok) {

                    throw new Error(`Erreur HTTP lors de la récupération des profils: ${profilsResponse.status}`);

                }

                const profilsData = await profilsResponse.json();

                profils = Array.isArray(profilsData) ? profilsData : (profilsData.profils || []);

                console.log("Équipe: Profils chargés :", profils.length, profils);

                

                // 3. Afficher la page

                document.body.style.opacity = "1";

                const mainElement = document.querySelector("main");

                if (mainElement) {

                    mainElement.style.display = "block";

                } else {

                    console.error("Équipe: L'élément <main> n'a pas été trouvé.");

                }



                mettreAJourBulleDemandes();

                

                const path = location.pathname.split("/").pop();

                const links = document.querySelectorAll("nav a");

                links.forEach(link => {

                    if (link.getAttribute("href") === path) {

                        link.classList.add("active");

                    }

                });



                renderProfils(); // Rendre les profils initiaux avec les données de la galerie disponibles

            } catch (error) {

                console.error("Équipe: Erreur critique lors de l'initialisation de la page ou chargement des données :", error);

                document.getElementById("header-placeholder").innerHTML = "<p style='color:red;text-align:center'>Erreur de chargement du menu.</p>";

                const mainElement = document.querySelector("main");

                if (mainElement) {

                    mainElement.innerHTML = `<p style="text-align:center;color:red;padding:2rem">Impossible de charger les données : ${error.message}. Vérifiez la console pour plus de détails.</p>`;

                    mainElement.style.display = "block";

                } else {

                    document.body.innerHTML += `<p style="text-align:center;color:red;padding:2rem">Impossible de charger les données : ${error.message}. Vérifiez la console pour plus de détails.</p>`;

                }

                document.body.style.opacity = "1";

            }

        }



        // Appeler la fonction d'initialisation globale au chargement du DOM

        document.addEventListener("DOMContentLoaded", initPageData);

    </script>

</body>

</html>
