<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Ajoutez les variables CSS ici si style.css n'est pas utilisé pour cela */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: var(--background-grey);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.show {
            opacity: 1;
        }
        main {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1;
        }
        main.show {
            opacity: 1;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #header-placeholder {
            width: 100%;
        }

        .section {
            padding: 40px 20px;
            max-width: 900px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        
        .section h2 {
            color: var(--primary-blue);
            margin-bottom: 15px;
        }

        .section p {
            line-height: 1.6;
            color: var(--grey-text);
        }

        .footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            background-color: var(--dark-blue);
            color: white;
            font-size: 0.9em;
        }

        /* Styles pour la section des derniers ajouts - Option 1: Cartes Modernes */
        .latest-additions-section {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }

        .latest-additions-section h2 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 30px; /* Plus d'espace sous le titre */
        }

        .latest-additions-grid {
            display: grid; /* Utilisation de CSS Grid pour une meilleure flexibilité */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adaptatif */
            gap: 25px; /* Espace entre les cartes */
            justify-content: center;
            padding: 10px 0;
        }

        .addition-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color); /* Légère bordure pour un look plus fini */
        }

        .addition-card.cas-usage {
            border-left: 5px solid var(--light-blue); /* Barre colorée pour distinguer */
        }

        .addition-card.galerie {
            border-left: 5px solid var(--postit-yellow); /* Utilise ta variable jaune */
        }

        .addition-card:hover {
            transform: translateY(-5px); /* Effet de léger soulèvement */
            box-shadow: var(--card-hover-shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 1.8em;
            margin-right: 15px;
            color: var(--primary-blue);
        }

        .card-header h4 {
            margin: 0;
            color: var(--dark-blue);
            font-size: 1.2em;
            flex-grow: 1;
        }

        .addition-card p {
            font-size: 0.95em;
            line-height: 1.5;
            color: var(--grey-text);
            margin-bottom: 15px;
            flex-grow: 1; /* Permet au paragraphe de prendre l'espace disponible */
        }

        .addition-card .card-image-container {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .addition-card .card-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #888;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 15px;
        }

        .card-meta .category {
            font-style: italic;
            color: var(--primary-blue);
        }

        .card-meta .date {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <div class="section">
        <div class="tile">
            <h2>Bienvenue sur l’espace IA Marketing</h2>
            <p>
                Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien.
            </p>
        </div>
    </div>

    <div class="latest-additions-section">
        <h2>Derniers ajouts</h2>
        <div id="latest-additions-grid" class="latest-additions-grid">
            <p id="post-it-loading-message" style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
        </div>
    </div>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Créa**
    </footer>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy";
        const GET_TIPS_URL = "/.netlify/functions/get-tips";
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";    
        const apiBase = window.location.origin + '/.netlify/functions/';

        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                return;
            }
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesArray = demandes.data || demandes;
                const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const loader = document.getElementById("loader");
            const body = document.body;
            const headerPlaceholder = document.getElementById("header-placeholder");

            const loadComponent = async (url, placeholderId, errorMessage) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    document.getElementById(placeholderId).innerHTML = await res.text();
                } catch (error) {
                    console.error(`Erreur lors du chargement de ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
                }
            };

            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
            .then(() => {
                mettreAJourBulleDemandes();

                const path = location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");
                links.forEach(link => {
                    if (path === "" || path === "index.html") {
                        if (link.getAttribute("href") === "index.html") {
                            link.classList.add("active");
                        }
                    } else if (link.getAttribute("href") === path) {
                        link.classList.add("active");
                    }
                });

                loader.classList.add("hidden");
                body.classList.add("show");

                displayLatestAdditions();
            })
            .catch(error => {
                console.error("Erreur générale lors du chargement des composants :", error);
                loader.classList.add("hidden");
                body.classList.add("show");
            });
        });

        async function displayLatestAdditions() {
            const container = document.getElementById("latest-additions-grid");
            const loadingMessage = document.getElementById("post-it-loading-message");

            if (!container || !loadingMessage) {
                console.error("Conteneur ou message de chargement des derniers ajouts non trouvé !");
                return;
            }

            loadingMessage.style.display = 'block';
            container.innerHTML = '';

            try {
                const casUsagesResponse = await fetch(GET_TIPS_URL);
                if (!casUsagesResponse.ok) {
                    throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                }
                const casUsages = await casUsagesResponse.json();
                if (!Array.isArray(casUsages)) {
                    throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                }

                const promptsResponse = await fetch(GET_PROMPTS_URL);
                if (!promptsResponse.ok) {
                    throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                }
                const prompts = await promptsResponse.json();
                if (!Array.isArray(prompts)) {
                    throw new Error("Les données des prompts ne sont pas un tableau.");
                }
                
                loadingMessage.style.display = 'none';

                // Tri pour les cas d'usages
                casUsages.sort((a, b) => {
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    if (!dateA || isNaN(dateA.getTime())) {
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        return -1;
                    }
                    return dateB.getTime() - dateA.getTime();
                });

                // Tri pour les prompts de la galerie
                const imagePrompts = prompts.filter(item => item.imageUrl);
                imagePrompts.sort((a, b) => {
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    if (!dateA || isNaN(dateA.getTime())) {
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        return -1;
                    }
                    return dateB.getTime() - dateA.getTime();
                });

                const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;
                const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;

                const createCard = (item, type) => {
                    const card = document.createElement("div");
                    card.className = `addition-card ${type}`;

                    const header = document.createElement('div');
                    header.className = 'card-header';

                    const icon = document.createElement('i');
                    icon.className = type === 'cas-usage' ? 'fas fa-lightbulb icon' : 'fas fa-image icon';
                    header.appendChild(icon);

                    const title = document.createElement("h4");
                    title.textContent = item.titre;
                    header.appendChild(title);
                    card.appendChild(header);

                    if (type === 'galerie') {
                        if (item.imageUrl) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'card-image-container';
                            const img = document.createElement('img');
                            img.src = item.imageUrl;
                            img.alt = `Vignette de ${item.titre}`;
                            imgContainer.appendChild(img);
                            card.appendChild(imgContainer);
                        }
                        if (item.prompt) {
                            const promptText = document.createElement('p');
                            promptText.textContent = item.prompt.substring(0, 150) + (item.prompt.length > 150 ? '...' : '');
                            card.appendChild(promptText);
                        }
                    } else { // type === 'cas-usage'
                        const description = document.createElement("p");
                        description.textContent = item.description.substring(0, 150) + (item.description.length > 150 ? '...' : '');
                        card.appendChild(description);
                    }

                    const meta = document.createElement('div');
                    meta.className = 'card-meta';

                    const category = document.createElement("span");
                    category.className = "category";
                    category.textContent = type === 'cas-usage' ? "Cas d'usages" : "Galerie";
                    meta.appendChild(category);
                    
                    const date = document.createElement("span");
                    date.className = "date";
                    if (item.date_ajout) {
                        const d = new Date(item.date_ajout);
                        date.textContent = `Ajouté le ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                    } else {
                        date.textContent = `Date inconnue`;
                    }
                    meta.appendChild(date);
                    
                    card.appendChild(meta);

                    return card;
                };

                if (latestCasUsage) {
                    container.appendChild(createCard(latestCasUsage, 'cas-usage'));
                } else {
                    console.warn("Aucun cas d'usage trouvé pour l'affichage.");
                }

                if (latestGalerieItem) {
                    container.appendChild(createCard(latestGalerieItem, 'galerie'));
                } else {
                    console.warn("Aucun élément de galerie trouvé pour l'affichage.");
                }

                if (!latestCasUsage && !latestGalerieItem) {
                    container.innerHTML = "<p style='text-align: center; color: #777;'>Aucun ajout récent à afficher.</p>";
                }

            } catch (error) {
                console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                loadingMessage.textContent = "Erreur lors du chargement des derniers ajouts. Veuillez réessayer.";
                loadingMessage.style.color = 'red';
                loadingMessage.style.display = 'block';
            }
        }
    </script>
</body>
</html>
