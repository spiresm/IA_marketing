<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <section class="section welcome-section" style="display: none;">
        <h1>Bienvenue sur l'Espace IA Marketing</h1>
        <p>Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien. Explorez les différentes sections pour trouver des ressources, ajouter vos propres contributions ou poser des questions à notre chatbot IA intégré !</p>
    </section>

    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2>Bienvenue sur l'Espace IA Marketing</h2>
            </div>
            <div class="modal-body">
                <p>Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien. Explorez les différentes sections pour trouver des ressources, ajouter vos propres contributions ou poser des questions à notre chatbot IA intégré !</p>
                <button class="modal-button" id="confirmWelcome">Compris !</button>
            </div>
        </div>
    </div>


    <div class="latest-additions-section">
        <h2>Derniers ajouts</h2>
        <div id="latest-additions-grid" class="latest-additions-grid">
            <p id="post-it-loading-message" style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
        </div>
    </div>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Créa**
    </footer>

    <div id="chatbot-fab">
        <i class="fas fa-comment-dots"></i>
    </div>

    <div id="chatbot-container">
        <div id="chatbot-header">
            <h3>Assistant IA</h3>
            <button id="chatbot-toggle"><i class="fas fa-times"></i></button>
        </div>
        <div id="chatbot-body">
            <div id="chatbot-messages">
                <div class="message bot">Bonjour ! Comment puis-je vous aider aujourd'hui ?</div>
            </div>
            <div id="chatbot-loading" style="display:none;">L'IA réfléchit...</div>
        </div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Tapez votre message..." />
            <button id="chatbot-send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy";
        const GET_TIPS_URL = "/.netlify/functions/get-tips";
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";    
        
        // --- GLOBAL VARIABLES (accessible to all functions) ---
        let chatbotFab;
        let chatbotContainer;
        let chatbotToggle;
        let chatbotInput;
        let chatbotSendButton;
        let chatbotMessages;
        let chatbotLoading;

        // Modal elements
        let welcomeModal;
        let closeButton;
        let confirmWelcomeButton;

        // --- GLOBAL FUNCTIONS (accessible everywhere) ---

        // Helper function to append messages to the chatbot UI
        function appendMessage(text, ...classes) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', ...classes);
            messageDiv.textContent = text;
            if (chatbotMessages) { // Add a check to ensure chatbotMessages is defined
                chatbotMessages.appendChild(messageDiv);
            } else {
                console.warn("chatbotMessages element not found when trying to append message.");
            }
        }

        // Helper function to create an addition card
        const createCard = (item, type) => {
            const card = document.createElement("div");
            card.className = `addition-card ${type}`;

            const header = document.createElement('div');
            header.className = 'card-header';

            const icon = document.createElement('i');
            if (type === 'cas-usage') {
                icon.className = 'fas fa-lightbulb icon';
            } else if (type === 'galerie') {
                icon.className = 'fas fa-image icon';
            }
            // No icon for 'welcome-card' as it's now in a modal

            header.appendChild(icon);

            const title = document.createElement("h4");
            title.textContent = item.titre;
            header.appendChild(title);
            card.appendChild(header);

            if (type === 'galerie' && item.imageUrl) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'card-image-container';
                const img = document.createElement('img');
                img.src = item.imageUrl;
                img.alt = `Vignette de ${item.titre}`;
                imgContainer.appendChild(img);
                card.appendChild(imgContainer);
            }
            
            const descriptionElement = document.createElement("p");
            if (item.description) {
                descriptionElement.textContent = item.description.substring(0, 150) + (item.description.length > 150 ? '...' : '');
            } else if (item.prompt) {
                descriptionElement.textContent = item.prompt.substring(0, 150) + (item.prompt.length > 150 ? '...' : '');
            }
            card.appendChild(descriptionElement);

            const meta = document.createElement('div');
            meta.className = 'card-meta';

            const category = document.createElement("span");
            category.className = "category";
            if (type === 'cas-usage') {
                category.textContent = "Cas d'usages";
            } else if (type === 'galerie') {
                category.textContent = "Galerie";
            }
            meta.appendChild(category);
            
            const date = document.createElement("span");
            date.className = "date";
            if (item.date_ajout) {
                const d = new Date(item.date_ajout);
                date.textContent = `Ajouté le ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
            } else {
                date.textContent = `Date inconnue`;
            }
            meta.appendChild(date);
            
            card.appendChild(meta);

            return card;
        };

        // Function to display the latest additions (excluding the welcome card)
        async function displayLatestAdditions() {
            const container = document.getElementById("latest-additions-grid");
            const loadingMessage = document.getElementById("post-it-loading-message");

            if (!container || !loadingMessage) {
                console.error("Conteneur ou message de chargement des derniers ajouts non trouvé !");
                return;
            }

            loadingMessage.style.display = 'block';
            container.innerHTML = ''; // Clear container before adding cards

            try {
                const casUsagesResponse = await fetch(GET_TIPS_URL);
                if (!casUsagesResponse.ok) {
                    throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                }
                const casUsages = await casUsagesResponse.json();
                if (!Array.isArray(casUsages)) {
                    throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                }

                const promptsResponse = await fetch(GET_PROMPTS_URL);
                if (!promptsResponse.ok) {
                    throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                }
                const prompts = await promptsResponse.json();
                if (!Array.isArray(prompts)) {
                    throw new Error("Les données des prompts ne sont pas un tableau.");
                }
                
                loadingMessage.style.display = 'none';

                // Sort Case Studies
                casUsages.sort((a, b) => {
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    if (!dateA || isNaN(dateA.getTime())) {
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        return -1;
                    }
                    return dateB.getTime() - dateA.getTime();
                });

                // Sort Gallery Prompts
                const imagePrompts = prompts.filter(item => item.imageUrl);
                imagePrompts.sort((a, b) => {
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    if (!dateA || isNaN(dateA.getTime())) {
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        return -1;
                    }
                    return dateB.getTime() - dateA.getTime();
                });

                const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;
                const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;

                if (latestCasUsage) {
                    container.appendChild(createCard(latestCasUsage, 'cas-usage'));
                } else {
                    console.warn("Aucun cas d'usage trouvé pour l'affichage.");
                }

                if (latestGalerieItem) {
                    container.appendChild(createCard(latestGalerieItem, 'galerie'));
                } else {
                    console.warn("Aucun élément de galerie trouvé pour l'affichage.");
                }

                if (!latestCasUsage && !latestGalerieItem) { // Check if *any* dynamic cards were added
                    container.innerHTML = "<p style='text-align: center; color: #777;'>Aucun ajout récent à afficher.</p>";
                }

            } catch (error) {
                console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                loadingMessage.textContent = "Erreur lors du chargement des derniers ajouts. Veuillez réessayer.";
                loadingMessage.style.color = 'red';
                loadingMessage.style.display = 'block';
            }
        }

        // Function to update the notification bubble for IA demands
        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                return;
            }
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesArray = demandes.data || demandes;
                const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }

        // --- DOMContentLoaded Listener (main execution flow when the page is ready) ---
        document.addEventListener("DOMContentLoaded", () => {
            const loader = document.getElementById("loader");
            const body = document.body;
            const headerPlaceholder = document.getElementById("header-placeholder");

            // Initialize global chatbot variables after DOM is loaded
            chatbotFab = document.getElementById('chatbot-fab');
            chatbotContainer = document.getElementById('chatbot-container');
            chatbotToggle = document.getElementById('chatbot-toggle');
            chatbotInput = document.getElementById('chatbot-input');
            chatbotSendButton = document.getElementById('chatbot-send-button');
            chatbotMessages = document.getElementById('chatbot-messages');
            chatbotLoading = document.getElementById('chatbot-loading');

            // Initialize modal elements
            welcomeModal = document.getElementById('welcomeModal');
            closeButton = document.querySelector('.close-button');
            confirmWelcomeButton = document.getElementById('confirmWelcome');

            const loadComponent = async (url, placeholderId, errorMessage) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    document.getElementById(placeholderId).innerHTML = await res.text();
                } catch (error) {
                    console.error(`Erreur lors du chargement de ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
                }
            };

            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
            .then(() => {
                mettreAJourBulleDemandes();

                const path = location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");
                links.forEach(link => {
                    if (path === "" || path === "index.html") {
                        if (link.getAttribute("href") === "index.html") {
                            link.classList.add("active");
                        }
                    } else if (link.getAttribute("href") === path) {
                        link.classList.add("active");
                    }
                });

                loader.classList.add("hidden");
                body.classList.add("show");

                // Display the welcome modal immediately after the page is loaded and shown
                welcomeModal.style.display = 'block';

                // Call displayLatestAdditions AFTER header is loaded and DOM is fully ready
                displayLatestAdditions(); 
            })
            .catch(error => {
                console.error("Erreur générale lors du chargement des composants :", error);
                loader.classList.add("hidden");
                body.classList.add("show");
            });

            // --- Modal Logic ---
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                });
            }
            if (confirmWelcomeButton) {
                confirmWelcomeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                });
            }

            // Close the modal if user clicks outside of it
            window.addEventListener('click', (event) => {
                if (event.target === welcomeModal) {
                    welcomeModal.style.display = 'none';
                }
            });


            // --- Chatbot Logic ---
            // Open/close chatbot
            chatbotFab.addEventListener('click', () => {
                chatbotContainer.style.display = chatbotContainer.style.display === 'flex' ? 'none' : 'flex';
                if (chatbotContainer.style.display === 'flex') {
                    chatbotInput.focus();
                }
            });

            chatbotToggle.addEventListener('click', () => {
                chatbotContainer.style.display = 'none';
            });

            // Send message
            chatbotSendButton.addEventListener('click', sendMessage);
            chatbotInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            async function sendMessage() {
                const messageText = chatbotInput.value.trim();
                if (messageText === "") return;

                appendMessage(messageText, 'user');
                chatbotInput.value = '';
                chatbotLoading.style.display = 'block';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

                try {
                    const response = await fetch(`${PROXY_URL}?action=chatWithGPT`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: messageText })
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    appendMessage(data.reply, 'bot');
                } catch (error) {
                    console.error('Erreur lors de la communication avec le chatbot :', error);
                    appendMessage("Désolé, je n'ai pas pu communiquer avec l'IA. Veuillez réessayer.", 'bot', 'error-message');
                } finally {
                    chatbotLoading.style.display = 'none';
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                }
            }
        });
    </script>
</body>
</html>
