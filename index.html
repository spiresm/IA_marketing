<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Ajoutez les variables CSS ici si style.css n'est pas utilisé pour cela */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: var(--background-grey); /* Utilisation de la variable */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.show {
            opacity: 1;
        }
        main {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1;
        }
        main.show {
            opacity: 1;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #header-placeholder {
            width: 100%;
        }

        .section {
            padding: 40px 20px;
            max-width: 900px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow); /* Utilisation de la variable */
            text-align: center;
        }
        
        .section h2 {
            color: var(--primary-blue); /* Utilisation de la variable */
            margin-bottom: 15px;
        }

        .section p {
            line-height: 1.6;
            color: var(--grey-text); /* Utilisation de la variable */
        }

        .footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            background-color: var(--dark-blue); /* Utilisation de la variable */
            color: white;
            font-size: 0.9em;
        }

        /* Styles pour la section des derniers ajouts */
        .latest-additions-section {
            max-width: 900px;
            /* Changement ici: ajustement de la marge supérieure */
            margin: 20px auto; /* Moins de marge que 30px ou 40px pour la rapprocher */
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow); /* Utilisation de la variable */
            /* Suppression de la bordure ici, car elle sera dans le body ou une div englobante si besoin */
        }

        .latest-additions-section h2 {
            text-align: center;
            color: var(--primary-blue); /* Utilisation de la variable */
            margin-bottom: 25px;
        }

        .post-it-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 10px 0;
        }

        /* Styles pour chaque "Post-it" */
        .post-it-note {
            position: relative;
            background-color: var(--postit-yellow); /* Utilisation de la variable */
            color: #333;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Garder cette ombre spécifique ou utiliser une variable si vous en avez une pour les Post-it */
            font-size: 0.95em;
            width: 250px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: rotate(calc(var(--rotation, 0) * 1deg));
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
            cursor: pointer;
        }

        .post-it-note.cas-usage {
             background-color: var(--light-blue-card); /* Utilisation de la variable */
        }

        .post-it-note.galerie {
            background-color: var(--postit-yellow); /* Utilisation de la variable */
        }

        .post-it-note:nth-child(even) {
            --rotation: -2;
        }

        .post-it-note:nth-child(odd) {
            --rotation: 3;
        }

        .post-it-note:hover {
            transform: scale(1.03) rotate(0deg);
            box-shadow: var(--card-hover-shadow); /* Utilisation de la variable */
            z-index: 10;
        }

        .post-it-note h4 {
            margin-top: 0;
            color: var(--dark-blue); /* Utilisation de la variable */
            font-size: 1.1em;
            margin-bottom: 8px;
            text-align: left;
        }

        .post-it-note p {
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 0;
            flex-grow: 1;
            text-align: left;
            word-wrap: break-word;
        }

        .post-it-note .post-it-category {
            font-size: 0.8em;
            color: #666; /* Vous pouvez aussi utiliser une variable comme var(--grey-text) ici */
            margin-top: 10px;
            text-align: right;
            font-style: italic;
        }

        .post-it-note .post-it-date {
            font-size: 0.75em;
            color: #888; /* Vous pouvez aussi utiliser une variable plus claire ou une nuance de gris ici */
            text-align: right;
            margin-top: 5px;
        }

        .post-it-note .post-it-image-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .post-it-note .post-it-image-container img {
            max-width: 80%;
            height: auto;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <div class="section">
        <div class="tile">
            <h2>Bienvenue sur l’espace IA Marketing</h2>
            <p>
                Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien.
            </p>
        </div>
    </div>

    <div class="latest-additions-section">
        <h2>Derniers ajouts</h2>
        <div id="post-it-container" class="post-it-container">
            <p id="post-it-loading-message" style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
        </div>
    </div>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Créa**
    </footer>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy";
        const GET_TIPS_URL = "/.netlify/functions/get-tips";
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";    
        const apiBase = window.location.origin + '/.netlify/functions/';

        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                return;
            }
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesArray = demandes.data || demandes;
                const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const loader = document.getElementById("loader");
            const body = document.body;
            const headerPlaceholder = document.getElementById("header-placeholder");

            const loadComponent = async (url, placeholderId, errorMessage) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    document.getElementById(placeholderId).innerHTML = await res.text();
                } catch (error) {
                    console.error(`Erreur lors du chargement de ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
                }
            };

            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
            .then(() => {
                mettreAJourBulleDemandes();

                const path = location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");
                links.forEach(link => {
                    if (path === "" || path === "index.html") {
                        if (link.getAttribute("href") === "index.html") {
                            link.classList.add("active");
                        }
                    } else if (link.getAttribute("href") === path) {
                        link.classList.add("active");
                    }
                });

                loader.classList.add("hidden");
                body.classList.add("show");

                displayLatestAdditions();
            })
            .catch(error => {
                console.error("Erreur générale lors du chargement des composants :", error);
                loader.classList.add("hidden");
                body.classList.add("show");
            });
        });

        async function displayLatestAdditions() {
            const postItContainer = document.getElementById("post-it-container");
            const loadingMessage = document.getElementById("post-it-loading-message");
            if (!postItContainer || !loadingMessage) {
                console.error("Conteneur ou message de chargement des Post-it non trouvé !");
                return;
            }

            loadingMessage.style.display = 'block';
            postItContainer.innerHTML = '';

            try {
                const casUsagesResponse = await fetch(GET_TIPS_URL);
                if (!casUsagesResponse.ok) {
                    throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                }
                const casUsages = await casUsagesResponse.json();
                if (!Array.isArray(casUsages)) {
                    throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                }

                const promptsResponse = await fetch(GET_PROMPTS_URL);
                if (!promptsResponse.ok) {
                    throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                }
                const prompts = await promptsResponse.json();
                if (!Array.isArray(prompts)) {
                    throw new Error("Les données des prompts ne sont pas un tableau.");
                }
                
                loadingMessage.style.display = 'none';

                // --- DEBUT DE LA MODIFICATION POUR LE TRI DES CAS D'USAGES ---
                casUsages.sort((a, b) => {
                    // Tente de créer des objets Date à partir de date_ajout.
                    // Si date_ajout est manquante, null, ou invalide, dateA/B sera null ou "Invalid Date".
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    // Gérer les cas où les dates sont invalides ou manquantes
                    // Objectif : Placer les entrées sans date valide à la fin.
                    if (!dateA || isNaN(dateA.getTime())) {
                        // Si A est invalide, B est invalide -> leur ordre relatif n'importe pas (0)
                        // Si A est invalide, B est valide -> A est "plus ancien", le pousse vers la fin (1)
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        // Si B est invalide, A est valide -> B est "plus ancien", le pousse vers la fin (-1)
                        return -1;
                    }
                    
                    // Les deux dates sont valides, trier par ordre décroissant (le plus récent en premier)
                    return dateB.getTime() - dateA.getTime();
                });
                // --- FIN DE LA MODIFICATION POUR LE TRI DES CAS D'USAGES ---

                // Tri pour les prompts de la galerie (utilise la même logique robuste)
                const imagePrompts = prompts.filter(item => item.imageUrl); // Votre filtre existant
                imagePrompts.sort((a, b) => {
                    const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                    const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                    if (!dateA || isNaN(dateA.getTime())) {
                        return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                    }
                    if (!dateB || isNaN(dateB.getTime())) {
                        return -1;
                    }
                    return dateB.getTime() - dateA.getTime();
                });

                // Ne prenez que le dernier cas d'usage et le dernier élément de galerie APRÈS le tri
                const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;
                const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;

                const createPostIt = (item, type) => {
                    const postIt = document.createElement("div");
                    postIt.className = `post-it-note ${type}`;

                    const title = document.createElement("h4");
                    title.textContent = item.titre;

                    postIt.appendChild(title);

                    if (type === 'galerie') {
                        if (item.imageUrl) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'post-it-image-container';
                            const img = document.createElement('img');
                            img.src = item.imageUrl;
                            img.alt = `Vignette de ${item.titre}`;
                            imgContainer.appendChild(img);
                            postIt.appendChild(imgContainer);
                        }
                        if (item.prompt) {
                            const promptText = document.createElement('p');
                            promptText.className = 'post-it-prompt-text';
                            promptText.textContent = item.prompt.substring(0, 100) + (item.prompt.length > 100 ? '...' : '');    
                            postIt.appendChild(promptText);
                        }
                        const category = document.createElement("div");
                        category.className = "post-it-category";
                        category.textContent = `Catégorie: Galerie`;
                        postIt.appendChild(category);

                    } else { // type === 'cas-usage'
                        const description = document.createElement("p");
                        description.textContent = item.description;
                        postIt.appendChild(description);

                        const category = document.createElement("div");
                        category.className = "post-it-category";
                        category.textContent = `Catégorie: Cas d'usages`;
                        postIt.appendChild(category);
                    }
                    
                    const date = document.createElement("div");
                    date.className = "post-it-date";
                    if (item.date_ajout) { // Affiche la date si elle existe
                        const d = new Date(item.date_ajout);
                        // Utilise toLocaleDateString pour un format de date localisé (ex: 17/06/2025)
                        date.textContent = `Ajouté le: ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                    } else {
                        date.textContent = `Ajouté le: Date inconnue`; // Message si la date est absente ou invalide
                    }
                    postIt.appendChild(date);
                    return postIt;
                };

                if (latestCasUsage) {
                    postItContainer.appendChild(createPostIt(latestCasUsage, 'cas-usage'));
                } else {
                    console.warn("Aucun cas d'usage trouvé pour les Post-it.");
                }

                if (latestGalerieItem) {
                    postItContainer.appendChild(createPostIt(latestGalerieItem, 'galerie'));
                } else {
                    console.warn("Aucun élément de galerie trouvé pour les Post-it.");
                }

                if (!latestCasUsage && !latestGalerieItem) {
                    postItContainer.innerHTML = "<p style='text-align: center; color: #777;'>Aucun ajout récent à afficher.</p>";
                }

            } catch (error) {
                console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                loadingMessage.textContent = "Erreur lors du chargement des derniers ajouts. Veuillez réessayer.";
                loadingMessage.style.color = 'red';
                loadingMessage.style.display = 'block';
            }
        }
    </script>
</body>
</html>
