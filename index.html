errorDisplay.style.display = 'none';

            try {
                const response = await fetch(`${apiBase}getTips`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allTips = data.tips || [];

                populateFilters(allTips);
                filterAndDisplayTips(); // Affiche les tips après chargement et populage des filtres
            } catch (error) {
                console.error("Erreur lors du chargement des tips :", error);
                galerieDiv.innerHTML = ''; // Vide le loader
                errorDisplay.textContent = `Erreur lors du chargement des tips : ${error.message}. Veuillez réessayer.`;
                errorDisplay.style.display = 'block';
            }
        }

        function populateFilters(tips) {
            const auteurs = new Set();
            const outils = new Set();

            tips.forEach(tip => {
                if (tip.auteur) auteurs.add(tip.auteur);
                if (tip.outil) outils.add(tip.outil);
            });

            // Populate Auteur filter
            filtreAuteurSelect.innerHTML = '<option value="">Tous les auteurs</option>';
            Array.from(auteurs).sort().forEach(auteur => {
                const option = document.createElement('option');
                option.value = auteur;
                option.textContent = auteur;
                filtreAuteurSelect.appendChild(option);
            });

            // Populate Outil filter (if not hardcoded in HTML)
            // If you prefer to manage 'Outil' dynamically, uncomment and adjust:
            // filtreOutilSelect.innerHTML = '<option value="">Tous les outils</option>';
            // Array.from(outils).sort().forEach(outil => {
            //     const option = document.createElement('option');
            //     option.value = outil;
            //     option.textContent = outil;
            //     filtreOutilSelect.appendChild(option);
            // });
        }

        function setupFilters() {
            filtreAuteurSelect.addEventListener('change', filterAndDisplayTips);
            filtreCategorieSelect.addEventListener('change', filterAndDisplayTips);
            filtreOutilSelect.addEventListener('change', filterAndDisplayTips);
            previewTextInput.addEventListener('input', filterAndDisplayTips);
        }

        function filterAndDisplayTips() {
            const selectedAuteur = filtreAuteurSelect.value;
            const selectedCategorie = filtreCategorieSelect.value;
            const selectedOutil = filtreOutilSelect.value;
            const previewTextFilter = previewTextInput.value.toLowerCase();

            galerieDiv.innerHTML = ''; // Clear current tips
            errorDisplay.style.display = 'none'; // Hide error message initially

            const filteredTips = allTips.filter(tip => {
                const matchesAuteur = selectedAuteur === '' || tip.auteur === selectedAuteur;
                const matchesCategorie = selectedCategorie === '' || tip.categorie === selectedCategorie;
                const matchesOutil = selectedOutil === '' || tip.outil === selectedOutil;
                const matchesPreviewText = previewTextFilter === '' ||
                    (tip.previewText && tip.previewText.toLowerCase().includes(previewTextFilter)) ||
                    (tip.titre && tip.titre.toLowerCase().includes(previewTextFilter)); // Also search in title

                return matchesAuteur && matchesCategorie && matchesOutil && matchesPreviewText;
            });

            if (filteredTips.length === 0) {
                galerieDiv.innerHTML = '<p style="text-align: center; color: #555;">Aucun tip ne correspond à vos filtres.</p>';
                return;
            }

            filteredTips.forEach(tip => {
                galerieDiv.appendChild(createTipCard(tip));
            });
        }

        function getBorderColor(category) {
            switch (category) {
                case 'Marketing Digital': return '#FFC107'; // Jaune
                case 'Réseaux Sociaux': return '#2196F3'; // Bleu
                case 'SEO': return '#4CAF50'; // Vert
                case 'Contenu': return '#9C27B0'; // Violet
                case 'Publicité': return '#FF5722'; // Orange
                case 'Outils IA': return '#607D8B'; // Gris-bleu
                case 'Stratégie': return '#E91E63'; // Rose
                case 'Autre': return '#9E9E9E'; // Gris
                default: return '#ccc'; // Gris par défaut
            }
        }

        function createTipCard(tip) {
            const carte = document.createElement('div');
            carte.className = 'carte';
            carte.style.borderLeftColor = getBorderColor(tip.categorie); // Applique la couleur de bordure

            const infosWrapper = document.createElement('div');
            infosWrapper.className = 'infos-wrapper';

            const tipTitle = document.createElement('div');
            tipTitle.className = 'tip-title';
            tipTitle.textContent = tip.titre || 'Sans titre';
            infosWrapper.appendChild(tipTitle);

            if (tip.outil) {
                const outilBadge = document.createElement('span');
                outilBadge.className = 'outil-badge';
                outilBadge.textContent = tip.outil;
                infosWrapper.appendChild(outilBadge);
            }

            const metadataSection = document.createElement('div');
            metadataSection.className = 'metadata-section';

            metadataSection.innerHTML += `<span class="metadata-label">Auteur :</span><span class="metadata-value auteur-value">${tip.auteur || 'N/A'}</span>`;
            metadataSection.innerHTML += `<span class="metadata-label">Catégorie :</span><span class="metadata-value">${tip.categorie || 'N/A'}</span>`;
            if (tip.date) {
                const dateObj = new Date(tip.date);
                metadataSection.innerHTML += `<span class="metadata-label">Date :</span><span class="metadata-value">${dateObj.toLocaleDateString('fr-FR')}</span>`;
            }
            infosWrapper.appendChild(metadataSection);

            if (tip.description) {
                const descriptionDisplay = document.createElement('div');
                descriptionDisplay.className = 'text-display';
                descriptionDisplay.textContent = tip.description;
                infosWrapper.appendChild(descriptionDisplay);
            }

            const cardActions = document.createElement('div');
            cardActions.className = 'card-actions';

            const topButtonsGroup = document.createElement('div');
            topButtonsGroup.className = 'top-buttons-group';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-content-btn';
            toggleBtn.textContent = 'Aperçu complet';
            toggleBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Empêche le clic de se propager à la carte
                openPreviewPanel(tip);
            });
            topButtonsGroup.appendChild(toggleBtn);

            const copyPromptBtn = document.createElement('button');
            copyPromptBtn.className = 'copier-btn';
            copyPromptBtn.textContent = 'Copier le prompt';
            copyPromptBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                if (tip.prompt) {
                    navigator.clipboard.writeText(tip.prompt).then(() => {
                        showSuccessMessage('Prompt copié !');
                    }).catch(err => {
                        console.error('Erreur lors de la copie du prompt:', err);
                        showErrorMessage('Erreur lors de la copie.');
                    });
                } else {
                    showErrorMessage('Pas de prompt à copier pour ce tip.');
                }
            });
            topButtonsGroup.appendChild(copyPromptBtn);

            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = 'Éditer';
            editBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                window.location.href = `editer-tip.html?id=${tip.id}`;
            });
            topButtonsGroup.appendChild(editBtn);

            cardActions.appendChild(topButtonsGroup);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'supprimer-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.title = 'Supprimer ce tip';
            deleteBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                if (confirm('Êtes-vous sûr de vouloir supprimer ce tip ? Cette action est irréversible.')) {
                    deleteTip(tip.id);
                }
            });
            cardActions.appendChild(deleteBtn);

            infosWrapper.appendChild(cardActions);
            carte.appendChild(infosWrapper);

            // Ajoutez le "post-it" de prévisualisation si le texte existe
            if (tip.previewText) {
                const previewPostIt = document.createElement('div');
                previewPostIt.className = 'preview-post-it';
                previewPostIt.textContent = tip.previewText;
                carte.appendChild(previewPostIt);
            }

            return carte;
        }

        async function deleteTip(id) {
            try {
                const response = await fetch(`${apiBase}deleteTip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    showSuccessMessage('Tip supprimé avec succès !');
                    loadAndDisplayTips(); // Recharger les tips après suppression
                } else {
                    throw new Error(result.message || 'Échec de la suppression du tip.');
                }
            } catch (error) {
                console.error("Erreur lors de la suppression du tip :", error);
                showErrorMessage(`Erreur de suppression : ${error.message}`);
            }
        }

        function showSuccessMessage(message) {
            const msg = document.getElementById('success-message');
            msg.textContent = message;
            msg.style.opacity = '1';
            setTimeout(() => msg.style.opacity = '0', 2000);
        }

        function showErrorMessage(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => errorDisplay.style.display = 'none', 5000); // Cache après 5 secondes
        }
