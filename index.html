<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Variables CSS */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: var(--background-grey);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.show {
            opacity: 1;
        }
        main {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1;
        }
        main.show {
            opacity: 1;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #header-placeholder {
            width: 100%;
        }

        /* La section de bienvenue (ancienne) ne doit plus être visible */
        .section.welcome-section {
            display: none; 
        }
        
        .footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            background-color: var(--dark-blue);
            color: white;
            font-size: 0.9em;
        }

        /* Styles pour la section des derniers ajouts - Cartes Modernes */
        .latest-additions-section {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }

        .latest-additions-section h2 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 30px;
        }

        .latest-additions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            justify-content: center;
            padding: 10px 0;
        }

        .addition-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
            /* height: 420px; Supprimé ou commenté pour laisser la hauteur s'adapter au contenu */
            /* overflow: hidden; Supprimé, le contenu doit s'afficher entièrement */
        }

        .addition-card.cas-usage {
            border-left: 5px solid var(--light-blue);
        }

        .addition-card.galerie {
            border-left: 5px solid var(--postit-yellow);
        }

        .addition-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 1.8em;
            margin-right: 15px;
            color: var(--primary-blue);
        }

        .card-header h4 {
            margin: 0;
            color: var(--dark-blue);
            font-size: 1.2em;
            flex-grow: 1;
        }

        /* Modifications ici : Suppression des propriétés de troncature */
        .addition-card p {
            font-size: 0.9em; 
            line-height: 1.5;
            color: var(--grey-text);
            margin-bottom: 15px;
            flex-grow: 1; 
            /* max-height: 80px; Supprimé */
            /* overflow: hidden; Supprimé */
            /* text-overflow: ellipsis; Supprimé */
            /* display: -webkit-box; Supprimé */
            /* -webkit-line-clamp: 4; Supprimé */
            /* -webkit-box-orient: vertical; Supprimé */
        }

        /* Les ajustements spécifiques n'ont plus besoin des propriétés de troncature */
        .addition-card.cas-usage p {
            font-size: 0.95em; 
            /* max-height: 90px; Supprimé */
            /* -webkit-line-clamp: 4; Supprimé */
        }
        
        .addition-card.galerie p {
            /* max-height: 60px; Supprimé */
            /* -webkit-line-clamp: 3; Supprimé */
        }


        .addition-card .card-image-container {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
            flex-shrink: 0; 
        }

        .addition-card .card-image-container img {
            max-width: 100%;
            height: 200px; 
            object-fit: cover; 
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #888;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 15px;
            flex-shrink: 0; 
        }
        
        .card-meta div {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .card-meta .category {
            font-style: italic;
            color: var(--primary-blue);
        }

        .card-meta .date {
            font-weight: bold;
        }

        /* Styles pour les boutons "Voir..." */
        .view-button {
            display: block; 
            width: calc(100% - 20px); 
            padding: 10px;
            margin-top: auto; 
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 5px;
            text-align: center;
            text-decoration: none;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            flex-shrink: 0; 
        }

        .view-button:hover {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
        }

        /* Styles pour le Chatbot */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            background-color: #fff;
            display: none; 
            flex-direction: column;
            max-height: 80vh;
            overflow: hidden;
        }

        #chatbot-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 15px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        #chatbot-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        #chatbot-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }

        #chatbot-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        #chatbot-messages {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--light-blue);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.bot {
            align-self: flex-start;
            background-color: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        #chatbot-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: #fff;
        }

        #chatbot-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-right: 10px;
            font-size: 0.9em;
        }

        #chatbot-send-button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #chatbot-send-button:hover {
            background-color: var(--dark-blue);
        }

        #chatbot-loading {
            text-align: center;
            font-size: 0.9em;
            color: #777;
            padding: 5px;
        }
        #chatbot-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: background-color 0.3s ease;
        }

        #chatbot-fab:hover {
            background-color: var(--dark-blue);
        }

        /* Styles pour la Modale de Bienvenue */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            position: relative;
            text-align: center;
        }

        .modal-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin: -20px -20px 20px -20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-body p {
            line-height: 1.6;
            color: var(--grey-text);
            margin-bottom: 20px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 5px;
            right: 15px;
            cursor: pointer;
            z-index: 10;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .modal-button:hover {
            background-color: var(--dark-blue);
        }

        /* Styles ajoutés pour le formulaire de login */
        #login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            text-align: center;
            display: flex; /* Utilisation de flexbox pour centrer le contenu */
            flex-direction: column;
            justify-content: center;
            min-height: 400px; /* Hauteur minimale pour que le formulaire soit bien visible */
        }

        #login-container h2 {
            color: var(--primary-blue);
            margin-bottom: 25px;
        }

        #login-form label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            color: var(--grey-text);
            font-weight: bold;
        }

        #login-form input[type="text"],
        #login-form input[type="password"] {
            width: calc(100% - 20px); /* Ajustement pour le padding */
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box; /* Inclut padding et border dans la largeur */
        }

        #login-form button {
            background-color: var(--primary-blue);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #login-form button:hover {
            background-color: var(--dark-blue);
        }

        #login-message {
            margin-top: 15px;
            color: var(--error-text);
            font-weight: bold;
        }

        /* Cacher le contenu principal par défaut */
        #main-content-wrapper {
            display: none; /* Initialement caché */
        }
    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <main id="login-or-content-container">
        <div id="login-container">
            <h2>Accès à l'Espace IA</h2>
            <form id="login-form" method="post" action="login_process.php">
                <label for="username">Nom d'utilisateur :</label>
                <input type="text" id="username" name="username" required autocomplete="username">
                
                <label for="password">Mot de passe :</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
                
                <button type="submit">Se connecter</button>
            </form>
            <p id="login-message" style="color: red;"></p>
        </div>

        <div id="main-content-wrapper">
            <div id="welcomeModal" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <div class="modal-header">
                        <h2>Bienvenue sur l'Espace IA Marketing</h2>
                    </div>
                    <div class="modal-body">
                        <p>Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien. Explorez les différentes sections pour trouver des ressources, ajouter vos propres contributions ou poser des questions à notre chatbot IA intégré !</p>
                        <button class="modal-button" id="confirmWelcome">Compris !</button>
                    </div>
                </div>
            </div>

            <div class="latest-additions-section">
                <h2>Derniers ajouts</h2>
                <div id="latest-additions-grid" class="latest-additions-grid">
                    <p id="post-it-loading-message" style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
                </div>
            </div>

            <div id="chatbot-fab">
                <i class="fas fa-comment-dots"></i>
            </div>

            <div id="chatbot-container">
                <div id="chatbot-header">
                    <h3>Assistant IA</h3>
                    <button id="chatbot-toggle"><i class="fas fa-times"></i></button>
                </div>
                <div id="chatbot-body">
                    <div id="chatbot-messages">
                        <div class="message bot">Bonjour ! Comment puis-je vous aider aujourd'hui ?</div>
                    </div>
                    <div id="chatbot-loading" style="display:none;">L'IA réfléchit...</div>
                </div>
                <div id="chatbot-input-container">
                    <input type="text" id="chatbot-input" placeholder="Tapez votre message..." />
                    <button id="chatbot-send-button"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        Auteur : Steeve Pires Madeira / Marketing - R&D format
    </footer>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy";
        const GET_TIPS_URL = "/.netlify/functions/get-tips";
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";
        
        // Nouvelle constante pour vérifier l'état de connexion
        const CHECK_LOGIN_URL = "check_login.php"; // Le script que nous allons créer
        const LOGOUT_URL = "logout.php"; // Le script de déconnexion

        document.addEventListener("DOMContentLoaded", () => {
            const loader = document.getElementById("loader");
            const body = document.body;
            const headerPlaceholder = document.getElementById("header-placeholder");

            const loginContainer = document.getElementById('login-container');
            const mainContentWrapper = document.getElementById('main-content-wrapper'); // Nouveau conteneur pour le contenu principal
            const loginForm = document.getElementById('login-form');
            const loginMessage = document.getElementById('login-message');

            const welcomeModal = document.getElementById('welcomeModal');
            const closeButton = document.querySelector('.close-button');
            const confirmWelcomeButton = document.getElementById('confirmWelcome');

            const chatbotFab = document.getElementById('chatbot-fab');
            const chatbotContainer = document.getElementById('chatbot-container');
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSendButton = document.getElementById('chatbot-send-button');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const chatbotLoading = document.getElementById('chatbot-loading');

            function appendMessage(text, ...classes) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', ...classes);
                messageDiv.textContent = text;
                if (chatbotMessages) {
                    chatbotMessages.appendChild(messageDiv);
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight; // Auto-scroll
                } else {
                    console.warn("chatbotMessages element not found when trying to append message.");
                }
            }

            const createCard = (item, type) => {
                const card = document.createElement("div");
                card.className = `addition-card ${type}`;

                const header = document.createElement('div');
                header.className = 'card-header';

                const icon = document.createElement('i');
                if (type === 'cas-usage') {
                    icon.className = 'fas fa-lightbulb icon';
                } else if (type === 'galerie') {
                    icon.className = 'fas fa-image icon';
                } 
                header.appendChild(icon);

                const title = document.createElement("h4");
                title.textContent = item.titre;
                header.appendChild(title);
                card.appendChild(header);

                if (type === 'galerie' && item.imageUrl) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'card-image-container';
                    const img = document.createElement('img');
                    img.src = item.imageUrl;
                    img.alt = `Vignette de ${item.titre}`;
                    imgContainer.appendChild(img);
                    card.appendChild(imgContainer);
                }
                
                const descriptionElement = document.createElement("p");
                descriptionElement.textContent = item.description || item.prompt || '';
                card.appendChild(descriptionElement);

                const meta = document.createElement('div');
                meta.className = 'card-meta';

                if (item.auteur) {
                    const authorDiv = document.createElement("div");
                    authorDiv.innerHTML = `<strong>Auteur:</strong> ${item.auteur}`;
                    meta.appendChild(authorDiv);
                }

                const categoryDiv = document.createElement("div");
                categoryDiv.className = "category";
                if (type === 'cas-usage') {
                    categoryDiv.innerHTML = `<strong>Catégorie:</strong> Cas d'usages`;
                } else if (type === 'galerie') {
                    categoryDiv.innerHTML = `<strong>Catégorie:</strong> Galerie`;
                }
                meta.appendChild(categoryDiv);

                if (item.outil) {
                    const toolDiv = document.createElement("div");
                    toolDiv.innerHTML = `<strong>Outil:</strong> ${item.outil}`;
                    meta.appendChild(toolDiv);
                }
                
                const dateDiv = document.createElement("div");
                dateDiv.className = "date";
                if (item.date_ajout) {
                    const d = new Date(item.date_ajout);
                    dateDiv.textContent = `Ajouté le ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                } else {
                    dateDiv.textContent = `Date inconnue`;
                }
                meta.appendChild(dateDiv);
                
                card.appendChild(meta); 

                if (type === 'cas-usage') {
                    const button = document.createElement('a');
                    button.href = "cas-usages.html"; 
                    button.className = "view-button"; 
                    button.textContent = "Voir le cas d'usage";
                    card.appendChild(button);
                } else if (type === 'galerie') { 
                    const button = document.createElement('a');
                    button.href = "galerie.html"; 
                    button.className = "view-button"; 
                    button.textContent = "Voir la galerie";
                    card.appendChild(button);
                }

                return card;
            };

            async function displayLatestAdditions() {
                const container = document.getElementById("latest-additions-grid");
                const loadingMessage = document.getElementById("post-it-loading-message");

                if (!container || !loadingMessage) {
                    console.error("Conteneur ou message de chargement des derniers ajouts non trouvé !");
                    return;
                }

                loadingMessage.style.display = 'block';
                container.innerHTML = ''; 
                
                try {
                    const casUsagesResponse = await fetch(GET_TIPS_URL);
                    if (!casUsagesResponse.ok) {
                        throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                    }
                    const casUsages = await casUsagesResponse.json();
                    if (!Array.isArray(casUsages)) {
                        throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                    }

                    const promptsResponse = await fetch(GET_PROMPTS_URL);
                    if (!promptsResponse.ok) {
                        throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                    }
                    const prompts = await promptsResponse.json();
                    if (!Array.isArray(prompts)) {
                        throw new Error("Les données des prompts ne sont pas un tableau.");
                    }
                    
                    loadingMessage.style.display = 'none';

                    casUsages.sort((a, b) => {
                        const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                        const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                        if (!dateA || isNaN(dateA.getTime())) {
                            return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                        }
                        if (!dateB || isNaN(dateB.getTime())) {
                            return -1;
                        }
                        return dateB.getTime() - dateA.getTime();
                    });

                    const imagePrompts = prompts.filter(item => item.imageUrl);
                    imagePrompts.sort((a, b) => {
                        const dateA = a.date_ajout ? new Date(a.date_ajout) : null;
                        const dateB = b.date_ajout ? new Date(b.date_ajout) : null;

                        if (!dateA || isNaN(dateA.getTime())) {
                            return (!dateB || isNaN(dateB.getTime())) ? 0 : 1;
                        }
                        if (!dateB || isNaN(dateB.getTime())) {
                            return -1;
                        }
                        return dateB.getTime() - dateA.getTime();
                    });

                    const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;
                    const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;

                    if (latestCasUsage) {
                        container.appendChild(createCard(latestCasUsage, 'cas-usage'));
                    } else {
                        console.warn("Aucun cas d'usage trouvé pour l'affichage.");
                    }

                    if (latestGalerieItem) {
                        container.appendChild(createCard(latestGalerieItem, 'galerie'));
                    } else {
                        console.warn("Aucun élément de galerie trouvé pour l'affichage.");
                    }

                    if (!latestCasUsage && !latestGalerieItem) { 
                        const noAdditionsMessage = document.createElement('p');
                        noAdditionsMessage.style.textAlign = 'center';
                        noAdditionsMessage.style.color = '#777';
                        noAdditionsMessage.textContent = 'Aucun ajout récent à afficher.';
                        container.appendChild(noAdditionsMessage);
                    }

                } catch (error) {
                    console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                    loadingMessage.textContent = "Erreur lors du chargement des derniers ajouts. Veuillez réessayer.";
                    loadingMessage.style.color = 'red';
                    loadingMessage.style.display = 'block';
                }
            }

            async function mettreAJourBulleDemandes() {
                const notif = document.getElementById("notif-count");
                if (!notif) {
                    console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                    return;
                }
                try {
                    const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    const demandes = await res.json();
                    const demandesArray = demandes.data || demandes;
                    const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                    notif.textContent = demandesNonTraitees.length;
                    notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
                } catch (e) {
                    console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                    notif.style.display = "none";
                }
            }
            
            async function sendMessage() {
                const messageText = chatbotInput.value.trim();
                if (messageText === "") return;

                appendMessage(messageText, 'user');
                chatbotInput.value = '';
                chatbotLoading.style.display = 'block';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

                try {
                    const response = await fetch(`${PROXY_URL}?action=chatWithGPT`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: messageText })
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    appendMessage(data.reply, 'bot');
                } catch (error) {
                    console.error('Erreur lors de la communication avec le chatbot :', error);
                    appendMessage("Désolé, je n'ai pas pu communiquer avec l'IA. Veuillez réessayer.", 'bot', 'error-message');
                } finally {
                    chatbotLoading.style.display = 'none';
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                }
            }

            // --- Nouvelle fonction pour vérifier l'état de connexion ---
            async function checkLoginStatus() {
                try {
                    const response = await fetch(CHECK_LOGIN_URL);
                    const data = await response.json();
                    return data.loggedIn; // Retourne true ou false
                } catch (error) {
                    console.error("Erreur lors de la vérification du statut de connexion:", error);
                    return false; // En cas d'erreur, considérons l'utilisateur comme non connecté
                }
            }

            // --- Nouvelle fonction pour afficher le contenu approprié ---
            async function renderPage() {
                const loggedIn = await checkLoginStatus();

                if (loggedIn) {
                    loginContainer.style.display = 'none'; // Cache le formulaire de login
                    mainContentWrapper.style.display = 'block'; // Affiche le contenu principal
                    // Maintenant que l'utilisateur est connecté, on affiche la modale de bienvenue si besoin
                    if (welcomeModal) {
                        // On peut ajouter ici une logique pour ne l'afficher qu'une seule fois
                        // par exemple en utilisant localStorage:
                        if (!localStorage.getItem('welcomeModalShown')) {
                            welcomeModal.style.display = 'flex';
                            localStorage.setItem('welcomeModalShown', 'true');
                        }
                    }
                    displayLatestAdditions(); // Charge le contenu dynamique
                    mettreAJourBulleDemandes(); // Met à jour les notifications
                } else {
                    loginContainer.style.display = 'flex'; // Affiche le formulaire de login
                    mainContentWrapper.style.display = 'none'; // Cache le contenu principal
                    welcomeModal.style.display = 'none'; // S'assurer que la modale n'apparaît pas
                }

                loader.classList.add("hidden");
                body.classList.add("show");
            }

            // Gestion de la soumission du formulaire de connexion
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Empêche la soumission par défaut du formulaire

                    const formData = new FormData(loginForm);
                    try {
                        const response = await fetch(loginForm.action, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();

                        if (data.success) {
                            loginMessage.textContent = ''; // Efface les messages d'erreur
                            renderPage(); // Recharge la page pour afficher le contenu connecté
                        } else {
                            loginMessage.textContent = data.message || "Nom d'utilisateur ou mot de passe incorrect.";
                        }
                    } catch (error) {
                        console.error('Erreur lors de la connexion :', error);
                        loginMessage.textContent = "Une erreur est survenue. Veuillez réessayer.";
                    }
                });
            }


            // Load header component and handle page display
            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
            .then(() => {
                // Une fois le header chargé, on vérifie l'état de connexion et on rend la page
                renderPage();

                // Active les liens de navigation après le chargement du header
                const path = location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");
                links.forEach(link => {
                    if (path === "" || path === "index.html") {
                        if (link.getAttribute("href") === "index.html") {
                            link.classList.add("active");
                        }
                    } else if (link.getAttribute("href") === path) {
                        link.classList.add("active");
                    }
                });
            })
            .catch(error => {
                console.error("Erreur générale lors du chargement des composants :", error);
                loader.classList.add("hidden");
                body.classList.add("show");
                // Afficher le formulaire de connexion si le header ne charge pas
                loginContainer.style.display = 'flex';
                mainContentWrapper.style.display = 'none';
            });

            // Modal event listeners (ne s'activent que si l'utilisateur est connecté et que la modale s'affiche)
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                });
            }
            if (confirmWelcomeButton) {
                confirmWelcomeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                });
            }
            window.addEventListener('click', (event) => {
                if (event.target === welcomeModal) {
                    welcomeModal.style.display = 'none';
                }
            });

            // Chatbot event listeners
            if (chatbotFab) {
                chatbotFab.addEventListener('click', () => {
                    chatbotContainer.style.display = chatbotContainer.style.display === 'flex' ? 'none' : 'flex';
                    if (chatbotContainer.style.display === 'flex') {
                        chatbotInput.focus();
                    }
                });
            }

            if (chatbotToggle) {
                chatbotToggle.addEventListener('click', () => {
                    chatbotContainer.style.display = 'none';
                });
            }

            if (chatbotSendButton && chatbotInput) {
                chatbotSendButton.addEventListener('click', sendMessage);
                chatbotInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            } else {
                console.warn("Chatbot elements (send button or input) not found.");
            }

            // Gestion du bouton de déconnexion (à ajouter dans votre header.html ou ailleurs)
            // Exemple d'écouteur si vous ajoutez un bouton avec l'ID 'logout-button'
            const logoutButton = document.getElementById('logout-button'); // Supposons que vous ayez un tel bouton
            if (logoutButton) {
                logoutButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await fetch(LOGOUT_URL); // Appel au script de déconnexion
                        // Rediriger vers la page de login ou re-rendre la page pour afficher le formulaire
                        renderPage(); 
                    } catch (error) {
                        console.error('Erreur lors de la déconnexion :', error);
                        alert("Erreur lors de la déconnexion. Veuillez réessayer.");
                    }
                });
            }
        });

        async function loadComponent(url, placeholderId, errorMessage) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const html = await res.text();
                document.getElementById(placeholderId).innerHTML = html;
            } catch (e) {
                console.error(`${errorMessage}:`, e);
                document.getElementById(placeholderId).innerHTML = `<p style="color: red;">${errorMessage}</p>`;
            }
        }
    </script>
</body>
</html>
