<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.youtube.com"> <link rel="preload" href="header.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="footer.html" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="log_ia.png" as="image">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
    
    <style>
        /* Variables CSS (peuvent être déplacées dans style.css si elles sont génériques à tout le site) */
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --lighter-blue: #42A5F5;
            --background-grey: #f0f2f5;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --postit-yellow: #FFFAA0;
            --light-blue-card: #E0F2F7;
            --grey-text: #555;
            --border-color: #ddd;
        }

        /* Styles pour le fondu d'apparition de la page */
        body {
            opacity: 0; /* Garde l'opacité à 0 au démarrage pour l'animation */
            transition: opacity 0.5s ease-in; /* Transition douce pour l'apparition */
            margin: 0;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            background-color: var(--background-grey);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Empêche le défilement horizontal non désiré */
        }
        body.show {
            opacity: 1; /* Révèle le body une fois la classe ajoutée par JavaScript */
        }

        /* Styles du loader de démarrage */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9); /* Fond blanc semi-transparent */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Assure que le loader est au-dessus de tout */
            opacity: 1; /* Visible par défaut */
            transition: opacity 0.5s ease-out; /* Transition pour le cacher */
            pointer-events: all; /* Permet les interactions tant que le loader est là */
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none; /* Désactive les interactions une fois le loader caché */
        }
        
        /* Styles de base pour les placeholders et le footer */
        #header-placeholder {
            width: 100%;
        }
        .section.welcome-section {
            display: none; /* Assure que cette ancienne section est masquée */ 
        }
        .footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            background-color: var(--dark-blue);
            color: white;
            font-size: 0.9em;
        }

        /* Styles pour la section des derniers ajouts (cartes) */
        .latest-additions-section {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        .latest-additions-section h2 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 30px;
        }
        .latest-additions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            justify-content: center;
            padding: 10px 0;
        }
        .addition-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;  
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .addition-card.cas-usage {
            border-left: 5px solid var(--light-blue);
        }
        .addition-card.galerie {
            border-left: 5px solid var(--postit-yellow);
        }
        .addition-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-header .icon {
            font-size: 1.8em;
            margin-right: 15px;
            color: var(--primary-blue);
        }
        .card-header h4 {
            margin: 0;
            color: var(--dark-blue);
            font-size: 1.2em;
            flex-grow: 1;
        }
        .addition-card p {
            font-size: 0.9em;  
            line-height: 1.5;
            color: var(--grey-text);
            margin-bottom: 15px;
            flex-grow: 1;  
        }
        .addition-card .card-image-container {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;  
        }
        .addition-card .card-image-container img {
            max-width: 100%;
            height: 200px;  
            object-fit: cover;  
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Styles pour le petit lecteur vidéo YouTube intégré dans la carte */
        .card-small-video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* Ratio 16:9 */
            margin-top: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            border-radius: 5px;
            background-color: #000;
            flex-shrink: 0;
        }
        .card-small-video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5px;
        }
        .card-meta {
            display: flex;
            flex-wrap: wrap;  
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #888;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 15px;
            flex-shrink: 0;  
        }
        .card-meta div {
            margin-right: 10px;
            margin-bottom: 5px;
        }
        .card-meta .category {
            font-style: italic;
            color: var(--primary-blue);
        }
        .card-meta .date {
            font-weight: bold;
        }

        /* Styles pour les boutons "Voir..." */
        .view-button {
            display: block;  
            width: calc(100% - 0px);
            padding: 10px;
            margin-top: auto;  
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 5px;
            text-align: center;
            text-decoration: none;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            flex-shrink: 0;  
        }
        .view-button:hover {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
        }

        /* Styles pour le Chatbot */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            background-color: #fff;
            display: none; /* Masqué par défaut */
            flex-direction: column;
            max-height: 80vh;
            overflow: hidden;
        }
        #chatbot-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 15px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        #chatbot-header h3 {
            margin: 0;
            font-size: 1.1em;
        }
        #chatbot-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }
        #chatbot-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        #chatbot-messages {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.user {
            align-self: flex-end;
            background-color: var(--light-blue);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .message.bot {
            align-self: flex-start;
            background-color: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 2px;
        }
        #chatbot-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: #fff;
        }
        #chatbot-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-right: 10px;
            font-size: 0.9em;
        }
        #chatbot-send-button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #chatbot-send-button:hover {
            background-color: var(--dark-blue);
        }
        #chatbot-loading {
            text-align: center;
            font-size: 0.9em;
            color: #777;
            padding: 5px;
        }
        #chatbot-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        #chatbot-fab:hover {
            background-color: var(--dark-blue);
        }

        /* Styles pour la Modale de Bienvenue */
        .modal {
            display: none; /* Masqué par défaut par JS */
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            position: relative;
            text-align: center;
        }
        .modal-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin: -20px -20px 20px -20px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .modal-body p {
            line-height: 1.6;
            color: var(--grey-text);
            margin-bottom: 20px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 5px;
            right: 15px;
            cursor: pointer;
            z-index: 10;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .modal-button:hover {
            background-color: var(--dark-blue);
        }

        /* Media Queries pour la responsivité */
        @media (max-width: 768px) {
            .latest-additions-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 90%;
            }
            #chatbot-container {
                width: 90%;
                right: 5%;
                bottom: 10px;
            }
            #chatbot-fab {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <div class="modal-header">
                <h2>Bienvenue sur l'Espace IA Marketing</h2>
            </div>
            <div class="modal-body">
                <p>Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien. Explorez les différentes sections pour trouver des ressources, ajouter vos propres contributions ou poser des questions à notre chatbot IA intégré !</p>
                <button class="modal-button" id="confirmWelcome">Compris !</button>
            </div>
        </div>
    </div>

    <main> 
        <div class="latest-additions-section">
            <h2>Derniers ajouts</h2>
            <div id="latest-additions-grid" class="latest-additions-grid">
                <p style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div> 
    
    <div id="chatbot-fab">
        <i class="fas fa-comment-dots"></i>
    </div>

    <div id="chatbot-container">
        <div id="chatbot-header">
            <h3>Assistant IA</h3>
            <button id="chatbot-toggle"><i class="fas fa-times"></i></button>
        </div>
        <div id="chatbot-body">
            <div id="chatbot-messages">
                <div class="message bot">Bonjour ! Comment puis-je vous aider aujourd'hui ?</div>
            </div>
            <div id="chatbot-loading" style="display:none;">L'IA réfléchit...</div>
        </div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Tapez votre message..." />
            <button id="chatbot-send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // URLs des fonctions Netlify (ou de votre API backend)
        const PROXY_URL = "/.netlify/functions/proxy";
        const GET_TIPS_URL = "/.netlify/functions/get-tips";
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";
        
        // Références aux éléments DOM fréquemment utilisés
        const loader = document.getElementById("loader");
        const bodyElement = document.body;
        const headerPlaceholder = document.getElementById("header-placeholder");
        const footerPlaceholder = document.getElementById("footer-placeholder");
        const latestAdditionsGrid = document.getElementById("latest-additions-grid");

        // Références des éléments du chatbot
        const chatbotFab = document.getElementById('chatbot-fab');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSendButton = document.getElementById('chatbot-send-button');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotLoading = document.getElementById('chatbot-loading');

        // Références des éléments de la modale de bienvenue
        const welcomeModal = document.getElementById('welcomeModal');
        const closeButton = document.querySelector('#welcomeModal .close-button');
        const confirmWelcomeButton = document.getElementById('confirmWelcome');

        // Clé pour le localStorage afin de savoir si la modale a déjà été vue
        const HAS_SEEN_WELCOME_MODAL = 'hasSeenWelcomeModal';

        /**
         * Ajoute un message au corps du chatbot.
         * @param {string} text Le texte du message.
         * @param {string[]} classes Classes CSS supplémentaires pour le message.
         */
        function appendMessage(text, ...classes) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', ...classes);
            messageDiv.textContent = text;
            if (chatbotMessages) {
                chatbotMessages.appendChild(messageDiv);
                // Fait défiler vers le bas pour montrer le dernier message
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight; 
            } else {
                console.warn("L'élément chatbotMessages est introuvable. Impossible d'ajouter le message.");
            }
        }

        /**
         * Extrait l'ID d'une vidéo YouTube à partir de son URL.
         * @param {string} url L'URL de la vidéo YouTube.
         * @returns {string|null} L'ID de la vidéo ou null si non trouvé.
         */
        function getYouTubeVideoId(url) {
            let videoId = null;
            // Regex pour extraire l'ID de diverses URLs YouTube
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(youtubeRegex);
            if (match && match[1]) {
                videoId = match[1];
            }
            return videoId;
        }

        /**
         * Crée une carte pour les derniers ajouts (Cas d'usage ou Galerie).
         * @param {object} item Les données de l'élément (tip ou prompt).
         * @param {'cas-usage'|'galerie'} type Le type de carte à créer.
         * @returns {HTMLElement} L'élément div représentant la carte.
         */
        const createCard = (item, type) => {
            const card = document.createElement("div");
            card.className = `addition-card ${type}`;

            const header = document.createElement('div');
            header.className = 'card-header';

            const icon = document.createElement('i');
            if (type === 'cas-usage') {
                icon.className = 'fas fa-lightbulb icon'; // Icône pour les cas d'usage
            } else if (type === 'galerie') {
                icon.className = 'fas fa-image icon'; // Icône pour la galerie
            }   
            header.appendChild(icon);

            const title = document.createElement("h4");
            title.textContent = item.titre || "Titre non spécifié";
            header.appendChild(title);
            card.appendChild(header);
            
            const descriptionElement = document.createElement("p");
            // Priorise la description, sinon le texte du prompt, sinon une chaîne vide
            descriptionElement.textContent = item.description || item.promptText || item.prompt || ''; 
            card.appendChild(descriptionElement);

            // Vérifie s'il y a une URL YouTube valide et prend la première
            const firstYoutubeUrl = item.urls ? item.urls.find(url => getYouTubeVideoId(url)) : null;

            if (firstYoutubeUrl) {
                const youtubeId = getYouTubeVideoId(firstYoutubeUrl);
                // URL d'intégration YouTube avec paramètres pour une meilleure intégration
                const embedUrl = `https://www.youtube.com/embed/${youtubeId}?autoplay=0&controls=1&modestbranding=1&rel=0&showinfo=0`;
                
                const videoContainer = document.createElement('div');
                videoContainer.className = 'card-small-video-container';

                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.frameBorder = "0";
                iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                iframe.allowFullscreen = true;
                iframe.title = `Vidéo intégrée pour ${item.titre}`;
                iframe.onerror = () => {
                    console.error(`Erreur de chargement de l'iframe vidéo pour ${item.titre}, ID: ${youtubeId}`);
                    videoContainer.style.display = 'none'; // Masque le conteneur si la vidéo ne charge pas
                };

                videoContainer.appendChild(iframe);
                card.appendChild(videoContainer);
            }
            
            // Affiche l'image de la galerie seulement s'il n'y a pas de vidéo YouTube
            if (type === 'galerie' && item.imageUrl && !firstYoutubeUrl) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'card-image-container';
                const img = document.createElement('img');
                img.src = item.imageUrl;
                img.alt = `Vignette de ${item.titre}`;
                imgContainer.appendChild(img);
                card.appendChild(imgContainer);
            }
            
            const meta = document.createElement('div');
            meta.className = 'card-meta';

            // Ajout dynamique des informations (auteur, catégorie, outil, date)
            if (item.auteur) {
                const authorDiv = document.createElement("div");
                authorDiv.innerHTML = `<strong>Auteur:</strong> ${item.auteur}`;
                meta.appendChild(authorDiv);
            }

            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category";
            if (type === 'cas-usage') {
                categoryDiv.innerHTML = `<strong>Catégorie:</strong> Cas d'usages`;
            } else if (type === 'galerie') {
                categoryDiv.innerHTML = `<strong>Catégorie:</strong> Galerie`;
            }
            meta.appendChild(categoryDiv);

            if (item.outil) {
                const toolDiv = document.createElement("div");
                toolDiv.innerHTML = `<strong>Outil:</strong> ${item.outil}`;
                meta.appendChild(toolDiv);
            }
            
            const dateDiv = document.createElement("div");
            dateDiv.className = "date";
            const dateToUse = item.date_creation || item.dateCreation || item.date_ajout || item.date;
            if (dateToUse) {
                const d = new Date(dateToUse);
                dateDiv.textContent = `Ajouté le ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
            } else {
                dateDiv.textContent = `Date inconnue`;
            }
            meta.appendChild(dateDiv);
            
            card.appendChild(meta);  

            // Bouton "Voir le Tip" ou "Voir la galerie"
            const button = document.createElement('a');
            button.className = "view-button";  
            if (type === 'cas-usage') {
                button.href = "cas-usages.html"; // Lien vers la page de tous les cas d'usages
                button.textContent = "Voir le Tip";
            } else if (type === 'galerie') {  
                button.href = "galerie.html"; // Lien vers la page de la galerie complète
                button.textContent = "Voir la galerie";
            }
            card.appendChild(button);

            return card;
        };

        /**
         * Charge et affiche les derniers ajouts (Cas d'usage et Prompts de galerie).
         * Gère l'affichage d'un message de chargement spécifique à la section.
         */
        async function displayLatestAdditions() {
            const container = latestAdditionsGrid; // Utilisation de la référence globale
            // Affiche un message de chargement tant que les données ne sont pas prêtes
            container.innerHTML = '<p style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>'; 

            try {
                // Lance les deux requêtes de manière parallèle pour gagner du temps
                const [casUsagesResponse, promptsResponse] = await Promise.all([
                    fetch(GET_TIPS_URL),
                    fetch(GET_PROMPTS_URL)
                ]);

                // Vérifie les réponses HTTP
                if (!casUsagesResponse.ok) {
                    throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                }
                let casUsages = await casUsagesResponse.json();
                if (!Array.isArray(casUsages)) {
                    throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                }

                if (!promptsResponse.ok) {
                    throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                }
                let prompts = await promptsResponse.json();
                if (!Array.isArray(prompts)) {
                    throw new Error("Les données des prompts ne sont pas un tableau.");
                }
                
                // Nettoie le conteneur du message de chargement une fois les données reçues
                container.innerHTML = ''; 

                // Harmonise les données (URLs en tableau, dates en objets Date) pour les deux sources
                casUsages = casUsages.map(item => ({
                    ...item,
                    urls: Array.isArray(item.urls) ? item.urls : (typeof item.urls === 'string' && item.urls.startsWith('[') ? JSON.parse(item.urls) : (item.url ? [item.url] : [])),
                    effectiveDate: new Date(item.date_creation || item.dateCreation || item.date_ajout || item.date || new Date(0).toISOString())
                }));

                prompts = prompts.map(item => ({
                    ...item,
                    urls: Array.isArray(item.urls) ? item.urls : (typeof item.urls === 'string' && item.urls.startsWith('[') ? JSON.parse(item.urls) : (item.url ? [item.url] : [])),
                    effectiveDate: new Date(item.date_creation || item.dateCreation || item.date_ajout || item.date || new Date(0).toISOString())
                }));

                // Trie les deux listes par date (du plus récent au plus ancien)
                casUsages.sort((a, b) => b.effectiveDate.getTime() - a.effectiveDate.getTime());
                // Filtre les prompts pour ne garder que ceux avec une image ou vidéo (pour la galerie)
                const imagePrompts = prompts.filter(item => item.imageUrl || (item.urls && item.urls.some(url => getYouTubeVideoId(url))));
                imagePrompts.sort((a, b) => b.effectiveDate.getTime() - a.effectiveDate.getTime());

                let itemsDisplayed = 0; // Compteur d'éléments affichés

                const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;
                const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;

                // Ajoute le cas d'usage le plus récent
                if (latestCasUsage) {
                    container.appendChild(createCard(latestCasUsage, 'cas-usage'));
                    itemsDisplayed++;
                } else {
                    console.warn("Aucun cas d'usage trouvé pour l'affichage sur la page d'accueil.");
                }

                // Ajoute l'élément de galerie le plus récent si c'est pertinent (différent du cas d'usage si déjà un affiché, ou s'il n'y en avait pas)
                if (latestGalerieItem && (container.children.length < 2 || (latestCasUsage && latestGalerieItem.id !== latestCasUsage.id))) {
                    container.appendChild(createCard(latestGalerieItem, 'galerie'));
                    itemsDisplayed++;
                } else if (!latestGalerieItem) {
                    console.warn("Aucun élément de galerie trouvé pour l'affichage sur la page d'accueil.");
                }

                // Message si aucun ajout n'est disponible
                if (itemsDisplayed === 0) {
                    const noAdditionsMessage = document.createElement('p');
                    noAdditionsMessage.style.textAlign = 'center';
                    noAdditionsMessage.style.color = '#777';
                    noAdditionsMessage.textContent = 'Aucun ajout récent à afficher pour le moment.';
                    container.appendChild(noAdditionsMessage);
                }

            } catch (error) {
                console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                // Affiche un message d'erreur si le chargement échoue
                container.innerHTML = `<p style="text-align: center; color: red;">Erreur lors du chargement des derniers ajouts. Veuillez réessayer.</p>`;
            }
        }

        /**
         * Envoie un message au chatbot et affiche la réponse.
         */
        async function sendMessage() {
            const messageText = chatbotInput.value.trim();
            if (messageText === "") return;

            appendMessage(messageText, 'user'); // Affiche le message de l'utilisateur
            chatbotInput.value = ''; // Efface l'input
            chatbotLoading.style.display = 'block'; // Affiche l'indicateur de chargement

            try {
                const response = await fetch(`${PROXY_URL}?action=chatWithGPT`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const data = await response.json();
                appendMessage(data.reply, 'bot'); // Affiche la réponse de l'IA
            } catch (error) {
                console.error('Erreur lors de la communication avec le chatbot :', error);
                appendMessage("Désolé, je n'ai pas pu communiquer avec l'IA. Veuillez réessayer.", 'bot', 'error-message');
            } finally {
                chatbotLoading.style.display = 'none'; // Masque l'indicateur de chargement
            }
        }

        /**
         * Fonction utilitaire pour charger des composants HTML via fetch.
         * @param {string} url - L'URL du composant HTML.
         * @param {HTMLElement} placeholderElement - L'élément DOM où insérer le HTML.
         * @returns {Promise<void>} Une promesse qui se résout quand le composant est chargé.
         */
        async function loadComponent(url, placeholderElement) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const errorDetail = await res.text();
                    throw new Error(`Erreur HTTP! statut: ${res.status} - ${res.statusText}. URL: ${url}. Réponse: ${errorDetail.substring(0, 200)}...`);
                }
                placeholderElement.innerHTML = await res.text();
                console.log(`Composant ${url} chargé avec succès.`);
            } catch (error) {
                console.error(`Erreur lors du chargement de ${url}:`, error);
                placeholderElement.innerHTML = `<p style='color:red;text-align:center;'>Erreur de chargement du composant: ${url}. (${error.message})</p>`;
            }
        };

        // --- Initialisation au chargement du DOM ---
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Accueil: DOMContentLoaded, début de l'initialisation...");

            // Masquer la barre de défilement du body pour éviter les "sauts" pendant le chargement
            bodyElement.style.overflow = 'hidden';

            // Lance le chargement des composants statiques (header et footer) en parallèle
            const headerPromise = loadComponent("header.html", headerPlaceholder);
            const footerPromise = loadComponent("footer.html", footerPlaceholder);

            // Attend que le header et le footer soient chargés et insérés dans le DOM
            await Promise.all([headerPromise, footerPromise]);
            
            // Met à jour l'état actif du menu après le chargement du header
            const currentPath = window.location.pathname.split('/').pop();
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkFileName = linkHref ? linkHref.split('/').pop() : '';
                // Rend "index.html" actif si l'URL est la racine ou "index.html"
                if (linkFileName === currentPath || (currentPath === "" && linkFileName === "index.html")) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // Une fois que la structure principale (header, footer, squelette du main) est en place,
            // cache le loader global et révèle la page en appliquant la classe 'show' au body.
            if (loader) {
                loader.classList.add("hidden");
                // Attends la fin de la transition d'opacité du loader avant de le masquer complètement
                loader.addEventListener('transitionend', () => {
                    if (loader.classList.contains('hidden')) {
                        loader.style.display = 'none';
                    }
                }, { once: true });
            }
            
            bodyElement.classList.add("show"); // Active l'animation de fondu du body
            bodyElement.style.overflow = ''; // Restaure le défilement du body une fois la page visible

            // Charge et affiche les derniers ajouts de manière asynchrone APRES avoir révélé la page.
            // Cela permet un affichage plus rapide du contenu statique.
            displayLatestAdditions();

            console.log("Accueil: Initialisation du contenu principal terminée. Chargement des données dynamiques en cours.");

            // --- Logique de la Modale de Bienvenue ---
            const hasSeenWelcomeModal = localStorage.getItem(HAS_SEEN_WELCOME_MODAL) === 'true';

            // Affiche la modale si l'utilisateur ne l'a pas encore vue
            if (!hasSeenWelcomeModal && welcomeModal) {
                welcomeModal.style.display = 'flex'; // Utilise flex pour le centrage
            } else if (welcomeModal) {
                 welcomeModal.style.display = 'none'; // S'assure qu'elle est cachée si déjà vue
            }

            // Gestion des événements pour fermer la modale
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                    localStorage.setItem(HAS_SEEN_WELCOME_MODAL, 'true');
                });
            }
            if (confirmWelcomeButton) {
                confirmWelcomeButton.addEventListener('click', () => {
                    welcomeModal.style.display = 'none';
                    localStorage.setItem(HAS_SEEN_WELCOME_MODAL, 'true');
                });
            }
            if (welcomeModal) {
                // Ferme la modale si on clique en dehors du contenu de la modale
                welcomeModal.addEventListener('click', (event) => {
                    if (event.target === welcomeModal) {
                        welcomeModal.style.display = 'none';
                        localStorage.setItem(HAS_SEEN_WELCOME_MODAL, 'true');
                    }
                });
            }

            // --- Gestion des événements du chatbot ---
            if (chatbotFab) {
                chatbotFab.addEventListener('click', () => {
                    // Alterne l'affichage du conteneur du chatbot
                    chatbotContainer.style.display = chatbotContainer.style.display === 'flex' ? 'none' : 'flex';
                    if (chatbotContainer.style.display === 'flex') {
                        chatbotInput.focus(); // Met le focus sur l'input du chatbot s'il s'ouvre
                    }
                });
            }

            if (chatbotToggle) {
                chatbotToggle.addEventListener('click', () => {
                    chatbotContainer.style.display = 'none'; // Ferme le chatbot
                });
            }

            // Envoi de message via le bouton ou la touche Entrée
            if (chatbotSendButton && chatbotInput) {
                chatbotSendButton.addEventListener('click', sendMessage);
                chatbotInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            } else {
                console.warn("Éléments du chatbot (bouton d'envoi ou champ de saisie) introuvables.");
            }
        });
    </script>
</body>
</html>
