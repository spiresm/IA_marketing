<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Styles généraux pour l'animation d'apparition de la page */
        body {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh; /* Permet le défilement si le contenu dépasse la hauteur de la fenêtre */
            display: flex;
            flex-direction: column; /* Aide à la mise en page de l'en-tête, du contenu principal et du pied de page */
        }
        body.show {
            opacity: 1;
        }
        main {
            opacity: 0; /* Gardé pour une transition éventuelle du main si vous en ajoutez plus tard */
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
            flex-grow: 1; /* Permet au main de prendre l'espace disponible, poussant le footer vers le bas */
        }
        main.show {
            opacity: 1;
        }

        /* Styles de base pour le header, loader, etc., si non dans style.css */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #header-placeholder {
            width: 100%;
            /* Assurez-vous que le header importé ne contient pas de marges/padding indésirables */
        }

        .section {
            padding: 40px 20px;
            max-width: 900px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .section h2 {
            color: #0077b6;
            margin-bottom: 15px;
        }

        .section p {
            line-height: 1.6;
            color: #555;
        }

        .footer {
            margin-top: auto; /* Pousse le footer vers le bas */
            padding: 20px;
            text-align: center;
            background-color: #005f8a;
            color: white;
            font-size: 0.9em;
        }

        /* Styles pour la section des derniers ajouts */
        .latest-additions-section {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
        }

        .latest-additions-section h2 {
            text-align: center;
            color: #0077b6;
            margin-bottom: 25px;
        }

        .post-it-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 10px 0;
        }

        /* Styles pour chaque "Post-it" */
        .post-it-note {
            position: relative;
            background-color: var(--postit-yellow, #FFFAA0); /* Couleur jaune Post-it par défaut */
            color: #333;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 0.95em;
            width: 250px; /* Largeur fixe pour les Post-it */
            min-height: 150px; /* Hauteur minimale ajustée pour l'image et le texte */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: rotate(calc(var(--rotation, 0) * 1deg)); /* Rotation légère */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box; /* Inclure padding et border dans la largeur/hauteur */
            cursor: pointer; /* Indique qu'il est cliquable */
        }

        .post-it-note.cas-usage {
             background-color: #e0f2f7; /* Une couleur différente pour les cas d'usages */
        }

        .post-it-note.galerie {
            background-color: var(--postit-yellow, #FFFAA0); /* La couleur jaune par défaut pour la galerie */
        }

        .post-it-note:nth-child(even) {
            --rotation: -2; /* Alterner la rotation */
        }

        .post-it-note:nth-child(odd) {
            --rotation: 3; /* Alterner la rotation */
        }

        .post-it-note:hover {
            transform: scale(1.03) rotate(0deg); /* Agrandir et redresser au survol */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            z-index: 10; /* Assure qu'il est au-dessus des autres au survol */
        }

        .post-it-note h4 {
            margin-top: 0;
            color: #005f8a;
            font-size: 1.1em;
            margin-bottom: 8px;
            text-align: left;
        }

        .post-it-note p {
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 0;
            flex-grow: 1;
            text-align: left;
            word-wrap: break-word; /* Gérer les longs mots */
        }

        .post-it-note .post-it-category {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
            text-align: right;
            font-style: italic;
        }

        .post-it-note .post-it-date {
            font-size: 0.75em;
            color: #888;
            text-align: right;
            margin-top: 5px;
        }

        .post-it-note .post-it-image-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .post-it-note .post-it-image-container img {
            max-width: 80%;
            height: auto;
            border-radius: 3px;
        }

    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <div class="section">
        <div class="tile">
            <h2>Bienvenue sur l’espace IA Marketing</h2>
            <p>
                Cette plateforme collaborative vous permet de découvrir, partager et capitaliser sur les usages de l’intelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d’usage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralisé ici pour accompagner votre montée en compétence et faciliter l’adoption de l’IA au quotidien.
            </p>
        </div>
    </div>

    <div class="latest-additions-section">
        <h2>Derniers ajouts</h2>
        <div id="post-it-container" class="post-it-container">
            <p id="post-it-loading-message" style="text-align: center; color: #777;">Chargement des derniers ajouts...</p>
        </div>
    </div>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Créa**
    </footer>

    <script>
        const PROXY_URL = "/.netlify/functions/proxy"; // URL pour la Netlify Function qui récupère les données de Google Sheets
        const GET_TIPS_URL = "/.netlify/functions/get-tips"; // URL de votre fonction Netlify pour récupérer tous les tips (cas d'usages)
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts"; // CHANGÉ : Utilise getGalleryPrompts pour les prompts
        const apiBase = window.location.origin + '/.netlify/functions/'; // Pour les fonctions CRUD

        // Cette fonction sera appelée par le header pour mettre à jour la bulle
        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("Élément #notif-count non trouvé. La bulle de notification ne peut pas être mise à jour.");
                return;
            }
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesArray = demandes.data || demandes;
                const demandesNonTraitees = demandesArray.filter(d => d.traite === false || d.traite === "FALSE");
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise à jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const loader = document.getElementById("loader");
            const body = document.body;
            const headerPlaceholder = document.getElementById("header-placeholder");

            // Fonction pour charger le header
            const loadComponent = async (url, placeholderId, errorMessage) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    document.getElementById(placeholderId).innerHTML = await res.text();
                } catch (error) {
                    console.error(`Erreur lors du chargement de ${url}:`, error);
                    document.getElementById(placeholderId).innerHTML = `<p style='color:red;text-align:center;'>${errorMessage}: ${error.message}</p>`;
                }
            };

            // Charger le header et initialiser le reste
            loadComponent("header.html", "header-placeholder", "Erreur de chargement du menu")
            .then(() => {
                mettreAJourBulleDemandes();

                const path = location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");
                links.forEach(link => {
                    if (path === "" || path === "index.html") {
                        if (link.getAttribute("href") === "index.html") {
                            link.classList.add("active");
                        }
                    } else if (link.getAttribute("href") === path) {
                        link.classList.add("active");
                    }
                });

                loader.classList.add("hidden");
                body.classList.add("show");

                // Appeler la fonction pour afficher les Post-it une fois le DOM chargé
                displayLatestAdditions();
            })
            .catch(error => {
                console.error("Erreur générale lors du chargement des composants :", error);
                loader.classList.add("hidden");
                body.classList.add("show");
            });
        });

        // Fonction pour récupérer et afficher les derniers ajouts sous forme de Post-it
        async function displayLatestAdditions() {
            const postItContainer = document.getElementById("post-it-container");
            const loadingMessage = document.getElementById("post-it-loading-message");
            if (!postItContainer || !loadingMessage) {
                console.error("Conteneur ou message de chargement des Post-it non trouvé !");
                return;
            }

            loadingMessage.style.display = 'block';
            postItContainer.innerHTML = ''; // Nettoyer le conteneur avant d'ajouter les Post-it

            try {
                // Fetch cas d'usages
                const casUsagesResponse = await fetch(GET_TIPS_URL);
                if (!casUsagesResponse.ok) {
                    throw new Error(`Erreur lors du chargement des cas d'usages: ${casUsagesResponse.statusText}`);
                }
                const casUsages = await casUsagesResponse.json();
                if (!Array.isArray(casUsages)) {
                    throw new Error("Les données des cas d'usages ne sont pas un tableau.");
                }

                // Fetch prompts de la galerie (maintenant via getGalleryPrompts)
                const promptsResponse = await fetch(GET_PROMPTS_URL);
                if (!promptsResponse.ok) {
                    throw new Error(`Erreur lors du chargement des prompts de la galerie: ${promptsResponse.statusText}`);
                }
                const prompts = await promptsResponse.json();
                if (!Array.isArray(prompts)) {
                    throw new Error("Les données des prompts ne sont pas un tableau.");
                }
                
                loadingMessage.style.display = 'none';

                // Trouver le dernier cas d'usage
                casUsages.sort((a, b) => new Date(b.date_ajout) - new Date(a.date_ajout));
                const latestCasUsage = casUsages.length > 0 ? casUsages[0] : null;

                // Trouver le dernier prompt en image de la galerie
                const imagePrompts = prompts.filter(item => item.imageUrl); // Filtrer pour inclure uniquement les prompts avec une image
                imagePrompts.sort((a, b) => new Date(b.date_ajout) - new Date(a.date_ajout));
                const latestGalerieItem = imagePrompts.length > 0 ? imagePrompts[0] : null;


                // Fonction utilitaire pour créer un Post-it
                const createPostIt = (item, type) => {
                    const postIt = document.createElement("div");
                    postIt.className = `post-it-note ${type}`; // Ajoute une classe pour styliser différemment si besoin

                    const title = document.createElement("h4");
                    title.textContent = item.titre;

                    postIt.appendChild(title);

                    // Logique spécifique à la galerie (vignette et "chaine")
                    if (type === 'galerie') {
                        if (item.imageUrl) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'post-it-image-container';
                            const img = document.createElement('img');
                            img.src = item.imageUrl;
                            img.alt = `Vignette de ${item.titre}`;
                            imgContainer.appendChild(img);
                            postIt.appendChild(imgContainer);
                        }
                        // Pour la "chaine", j'utilise `item.prompt`.
                        if (item.prompt) {
                            const promptText = document.createElement('p');
                            promptText.className = 'post-it-prompt-text';
                            // Limite la longueur du prompt pour qu'il tienne dans le Post-it
                            promptText.textContent = item.prompt.substring(0, 100) + (item.prompt.length > 100 ? '...' : ''); 
                            postIt.appendChild(promptText);
                        }
                        const category = document.createElement("div");
                        category.className = "post-it-category";
                        category.textContent = `Catégorie: Galerie`; // Force la catégorie pour la galerie
                        postIt.appendChild(category);

                    } else { // Pour les cas d'usages
                        const description = document.createElement("p");
                        description.textContent = item.description; // Contenu du post-it pour les cas d'usages
                        postIt.appendChild(description);

                        const category = document.createElement("div");
                        category.className = "post-it-category";
                        category.textContent = `Catégorie: Cas d'usages`; // Force la catégorie pour les cas d'usages
                        postIt.appendChild(category);
                    }
                    
                    const date = document.createElement("div");
                    date.className = "post-it-date";
                    if (item.date_ajout) {
                        const d = new Date(item.date_ajout);
                        date.textContent = `Ajouté le: ${d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                    }
                    postIt.appendChild(date);
                    return postIt;
                };

                // Ajouter le dernier cas d'usage
                if (latestCasUsage) {
                    postItContainer.appendChild(createPostIt(latestCasUsage, 'cas-usage'));
                } else {
                    console.warn("Aucun cas d'usage trouvé pour les Post-it.");
                }

                // Ajouter le dernier élément de la galerie
                if (latestGalerieItem) {
                    postItContainer.appendChild(createPostIt(latestGalerieItem, 'galerie'));
                } else {
                    console.warn("Aucun élément de galerie trouvé pour les Post-it.");
                }

                if (!latestCasUsage && !latestGalerieItem) {
                    postItContainer.innerHTML = "<p style='text-align: center; color: #777;'>Aucun ajout récent à afficher.</p>";
                }

            } catch (error) {
                console.error("Erreur lors de la récupération ou de l'affichage des derniers ajouts:", error);
                loadingMessage.textContent = "Erreur lors du chargement des derniers ajouts. Veuillez réessayer.";
                loadingMessage.style.color = 'red';
                loadingMessage.style.display = 'block';
            }
        }
    </script>
</body>
</html>
