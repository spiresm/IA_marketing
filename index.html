<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" /> </head>
<body>

    <div class="nav-wrapper">
        <div class="menu-container">
            <nav>
                <a href="index.html" class="active">Accueil</a>
                <a href="equipe.html">Équipe</a>
                <a href="outils.html">Outils</a>
                <a href="galerie.html">Prompts</a>
                <a href="cas-usages.html">Workflows</a>
                <a href="charte.html">Chartes</a>
                <a href="faq.html">FAQ</a>
                <a href="demandes_ia.html">Demandes</a>
                <a href="gestion-license.html">Licenses</a>
            </nav>
        </div>
    </div>

    <main>
        <section class="veille-section-container">
            <div class="veille-header">
                <h3>Veille IA & Marketing</h3>
                <div class="post-it-note">
                    <i class="fas fa-robot post-it-icon"></i>
                    <p>
                        <strong>Veille Automatisée</strong>
                        Générée par un workflow n8n.
                    </p>
                </div>
            </div>

            <div class="veille-carousel-wrapper">
                <div class="veille-scroll-container">
                    <div id="veille-articles-grid" class="veille-grid"></div>
                </div>
                <button class="scroll-arrow left" id="veille-scroll-left"><i class="fas fa-chevron-left"></i></button>
                <button class="scroll-arrow right" id="veille-scroll-right"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section class="content-section">
            <h2>Derniers ajouts</h2>
            <div id="latest-additions-grid" class="latest-additions-grid"></div>
        </section>

        <section class="news-ticker-section content-section">
            <div class="news-ticker-container"><div class="news-ticker-content" id="newsTickerContent"></div></div>
            <a href="#" class="message-button">Laisser un message</a>
        </section>
    </main>

    <footer id="footer-placeholder"><p>&copy; 2025 Espace IA. Tous droits réservés.</p></footer>

    <script>
    document.addEventListener("DOMContentLoaded", () => {

        // --- FONCTIONS D'ÉCHAPPEMENT (doivent être globales ou définies ici pour les templates HTML) ---
        // Fonction pour le contenu textuel normal (NE PAS ENCODER LES APOSTROPHES ICI)
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' };
            return String(text).replace(/[&<>"']/g, m => map[m] || m);
        }

        // Fonction robuste pour échapper les chaînes destinées aux attributs HTML
        function escapeHtmlAttribute(unsafe) {
            if (typeof unsafe !== 'string') {
                return '';
            }
            let escaped = JSON.stringify(unsafe);
            if (escaped.startsWith('"') && escaped.endsWith('"')) {
                escaped = escaped.slice(1, -1);
            }
            return escaped.replace(/`/g, '\\`');
        }
        // --- FIN FONCTIONS D'ÉCHAPPEMENT ---


        // =========================================================================
        // SECTION 1 : CARROUSEL DE VEILLE
        // =========================================================================
        async function loadAndInitVeille() {
            const grid = document.getElementById('veille-articles-grid');
            if (!grid) return;
            try {
                // Utilisation de l'API Netlify Function pour getVeilleArticles (si vous en avez une)
                // Ou chargement direct si c'est un fichier statique comme veille-articles.json
                const response = await fetch('/.netlify/functions/getVeilleArticles'); // Adaptez l'URL si nécessaire
                if (!response.ok) throw new Error(`Fichier introuvable (statut: ${response.status})`);
                const articles = await response.json();
                if (!articles || articles.length === 0) {
                    grid.innerHTML = '<p style="padding: 20px; text-align: center;">Aucun article de veille.</p>';
                    return;
                }
                grid.innerHTML = articles.map(article => `
                    <div class="veille-card">
                        <div class="card-meta-info">
                            <span class="meta-tag"><i class="fas fa-calendar-alt"></i> ${escapeHtml(article.date || 'Date')}</span>
                            <span class="meta-tag"><i class="fas fa-newspaper"></i> ${escapeHtml(article.source || 'Source')}</span>
                            <span class="meta-tag"><i class="fas fa-tag"></i> ${escapeHtml(article.tag || 'Tag')}</span>
                        </div>
                        <h4>⚡ ${escapeHtml(article.titre || 'Titre')}</h4>
                        <div class="card-content"><p>${escapeHtml(article.resume || 'Résumé')}</p></div>
                        <div class="card-footer"><a href="${escapeHtmlAttribute(article.url || '#')}" target="_blank" class="view-article-button">Lire l’article</a></div>
                    </div>
                `).join('');
                initVeilleCarousel();
            } catch (error) {
                console.error("Erreur chargement veille:", error);
                grid.innerHTML = `<p style="padding: 20px; text-align: center; color: var(--error-text);">Impossible de charger les articles.</p>`;
            }
        }

        function initVeilleCarousel() {
            const grid = document.getElementById('veille-articles-grid');
            const prevButton = document.getElementById('veille-scroll-left');
            const nextButton = document.getElementById('veille-scroll-right');
            const scrollContainer = grid.parentElement;
            if (!grid || !prevButton || !nextButton || !scrollContainer) return;
            const cards = grid.querySelectorAll('.veille-card');
            if (cards.length <= 1) { // Pas besoin de carrousel si 1 seule carte ou moins
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
                return;
            }
            prevButton.style.display = 'flex';
            nextButton.style.display = 'flex';
            let currentIndex = 0;
            // Ne pas appliquer de transition directe sur la grille pour le scroll-snap
            // La transition sera gérée par le scroll-behavior: smooth; du parent

            const updateCarousel = () => {
                // Sur les petits écrans, le scroll-snap gère ça
                if (window.innerWidth <= 768) {
                    // Cacher les boutons de navigation manuelle sur mobile si scroll-snap est actif
                    prevButton.style.display = 'none';
                    nextButton.style.display = 'none';
                    grid.style.transform = 'none'; // Assurer que la transformation n'interfère pas
                    return;
                } else {
                    // Afficher les boutons sur les grands écrans
                    prevButton.style.display = 'flex';
                    nextButton.style.display = 'flex';
                }

                // Pour les grands écrans, gérer le défilement par transformation
                const offset = -currentIndex * scrollContainer.clientWidth;
                grid.style.transform = `translateX(${offset}px)`;
                prevButton.disabled = currentIndex === 0;
                nextButton.disabled = currentIndex >= cards.length - 1;
            };

            nextButton.addEventListener('click', () => { if (currentIndex < cards.length - 1) { currentIndex++; updateCarousel(); }});
            prevButton.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateCarousel(); }});

            // Gérer le redimensionnement de la fenêtre
            window.addEventListener('resize', () => {
                // Réinitialise la position pour éviter des problèmes de calculs
                currentIndex = 0; // Réinitialise à la première carte au redimensionnement
                updateCarousel();
            });

            // Appel initial
            updateCarousel();
        };


        // =========================================================================
        // SECTION 2 : DERNIERS AJOUTS
        // =========================================================================
        const getYouTubeVideoId = (url) => {
            if (!url) return null;
            const match = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        };
        const formatteDate = (dateString) => {
            if (!dateString) return 'Date inconnue';
            try { return new Date(dateString).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' }); }
            catch (e) { return 'Date invalide'; }
        };
        const createCard = (item, type) => {
            const card = document.createElement("div");
            card.className = 'addition-card';
            // Pour le clic sur la carte, on stocke l'ID et le type pour ouvrir le panneau latéral de détail
            card.dataset.id = item.id;
            card.dataset.type = type; // 'galerie' ou 'cas-usage'

            const mainCardTitle = type === 'galerie' ? 'Dernier prompt partagé' : 'Dernier workflow partagé';
            let mediaHtml = '';
            const youtubeVideoId = getYouTubeVideoId(item.firstVideoUrl); // Utilisez firstVideoUrl si c'est la prop que vous avez
            // Sinon, ajustez pour récupérer la première URL de vidéo ou image appropriée
            if (youtubeVideoId) {
                mediaHtml = `<div class="card-image-container"><img src="https://i.ytimg.com/vi/${youtubeVideoId}/hqdefault.jpg" alt="${escapeHtmlAttribute('Vignette pour ' + item.titre)}"></div>`;
            } else if (item.imageUrl && item.imageUrl !== 'NO_IMAGE_PLACEHOLDER') {
                mediaHtml = `<div class="card-image-container"><img src="${escapeHtmlAttribute(item.imageUrl)}" alt="${escapeHtmlAttribute('Vignette pour ' + item.titre)}"></div>`;
            } else if (item.fileUrls && item.fileUrls.length > 0) { // Si fileUrls existe et pas de imageUrl
                const firstFile = item.fileUrls[0];
                const fileExtension = firstFile.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                    mediaHtml = `<div class="card-image-container"><img src="${escapeHtmlAttribute(firstFile)}" alt="${escapeHtmlAttribute('Vignette pour ' + item.titre)}"></div>`;
                } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                    // Si c'est une vidéo hébergée, vous pourriez afficher une icône ou un poster
                    mediaHtml = `<div class="card-image-container" style="display:flex;justify-content:center;align-items:center;"><i class="fas fa-video fa-3x" style="color:#ccc;"></i></div>`;
                }
            }


            const toolBadge = item.outil && item.outil !== 'Non spécifié' ? `<span class="outil-badge">${escapeHtml(item.outil)}</span>` : '';

            card.innerHTML = `
                <div class="card-content-wrapper">
                    <h4>${escapeHtml(mainCardTitle)}</h4>
                    <div class="card-top-meta">${toolBadge}</div>
                    <div class="card-subtitle">${escapeHtml(item.titre)}</div>
                    ${mediaHtml}
                    <div class="card-meta">
                        <span class="meta-line"><strong>Auteur:</strong> ${escapeHtml(item.auteur)}</span>
                        <span class="meta-line"><strong>Créé le:</strong> ${formatteDate(item.date)}</span>
                    </div>
                    <a href="${type === 'cas-usage' ? 'cas-usages.html' : 'galerie.html'}" class="view-button">Voir plus</a>
                </div>
            `;
            // Attache l'écouteur de clic pour ouvrir le panneau latéral de détail
            card.addEventListener('click', (event) => {
                // Empêcher l'ouverture du panneau si le clic vient d'un bouton d'action interne
                if (event.target.closest('.view-button')) { // Ajoutez d'autres classes de boutons si elles existent sur ces cartes
                    return;
                }
                // Ici, on pourrait ouvrir un panneau latéral général avec les détails de l'item
                // Pour l'exemple, nous allons juste loguer
                console.log(`Ouverture du panneau pour l'item ID: ${card.dataset.id}, Type: ${card.dataset.type}`);
                // Vous devrez implémenter la fonction openGenericPanel(item, type)
                // Pour l'instant, on redirige vers la page de la galerie/workflow concernée
                window.location.href = `${card.dataset.type === 'cas-usage' ? 'cas-usages.html' : 'galerie.html'}?id=${card.dataset.id}`;
            });
            return card;
        };

        async function displayLatestAdditions() {
            const container = document.getElementById("latest-additions-grid");
            if (!container) return;
            container.innerHTML = '<p style="text-align:center;">Chargement des derniers ajouts...</p>';
            const GET_TIPS_URL = "/.netlify/functions/get-tips";
            const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";
            try {
                const [tipsResponse, promptsResponse] = await Promise.all([
                    fetch(GET_TIPS_URL).catch(e => ({ok: false, json: () => Promise.resolve([])})),
                    fetch(GET_PROMPTS_URL).catch(e => ({ok: false, json: () => Promise.resolve([])}))
                ]);
                let tips = tipsResponse.ok ? await tipsResponse.json() : [];
                let prompts = promptsResponse.ok ? await promptsResponse.json() : [];
                const normalizeItem = (item) => ({
                    ...item,
                    titre: item.titre || "Titre",
                    auteur: item.auteur || "Inconnu",
                    date: item.date_creation || item.dateCreation || new Date().toISOString(),
                    outil: item.outil || "Non spécifié",
                    imageUrl: item.imageUrl, // Conserve imageUrl tel quel
                    fileUrls: item.fileUrls || [], // Conserve fileUrls
                    // firstVideoUrl: (Array.isArray(item.urls) ? item.urls : []).find(url => getYouTubeVideoId(url)) // Si besoin de la première vidéo
                });
                tips = tips.map(normalizeItem).sort((a, b) => new Date(b.date) - new Date(a.date));
                prompts = prompts.map(normalizeItem).sort((a, b) => new Date(b.date) - new Date(a.date));
                container.innerHTML = '';
                let itemsToDisplay = [];
                if (prompts.length > 0) itemsToDisplay.push({ item: prompts[0], type: 'galerie' });
                if (tips.length > 0) itemsToDisplay.push({ item: tips[0], type: 'cas-usage' });

                if (itemsToDisplay.length > 0) {
                    itemsToDisplay.forEach(({ item, type }) => container.appendChild(createCard(item, type)));
                } else {
                    container.innerHTML = '<p style="text-align:center;">Aucun ajout récent.</p>';
                }
            } catch (error) {
                container.innerHTML = `<p style="color: var(--error-text);text-align:center;">Erreur de chargement des derniers ajouts.</p>`;
            }
        }


        // =========================================================================
        // SECTION 3 : BANDEAU D'ACTUALITÉS (News Ticker)
        // =========================================================================
        async function loadNewsTicker() {
            const newsTickerContent = document.getElementById('newsTickerContent');
            if (!newsTickerContent) return;
            const NEWS_DATA_PATH = 'news-data.json'; // Assurez-vous que ce fichier existe
            try {
                const response = await fetch(NEWS_DATA_PATH);
                if (!response.ok) throw new Error('Fichier news introuvable.');
                const newsItems = await response.json();
                if (newsItems.length > 0) {
                    // Répéter le contenu pour un défilement continu
                    const fullTextHtml = newsItems.map(item => `<span class="news-item">${escapeHtml(item.title)}</span>`).join(' &nbsp; • &nbsp; ');
                    newsTickerContent.innerHTML = fullTextHtml + ' &nbsp; • &nbsp; ' + fullTextHtml; // Dupliquer pour un effet de boucle
                } else {
                    newsTickerContent.innerHTML = '<span>Aucune actualité à afficher.</span>';
                }
            } catch (error) {
                console.error("Erreur chargement news ticker:", error);
                newsTickerContent.innerHTML = '<span>Impossible de charger les actualités.</span>';
            }
        }

        // =========================================================================
        // SECTION 4 : LOGIQUE DU MENU ACTIF
        // =========================================================================
        function setActiveNavLink() {
            const currentPath = window.location.pathname.split('/').pop() || "index.html";
            document.querySelectorAll('nav a').forEach(link => {
                const linkHref = new URL(link.href, window.location.origin).pathname.split('/').pop();
                link.classList.toggle("active", linkHref === currentPath);
            });
        }

        // =========================================================================
        // APPEL DE TOUTES LES FONCTIONS LORS DU CHARGEMENT DU DOM
        // =========================================================================
        loadAndInitVeille();
        displayLatestAdditions();
        loadNewsTicker();
        setActiveNavLink(); // S'assure que le lien "Accueil" est actif
    });
    </script>

</body>
</html>
