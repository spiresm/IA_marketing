<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* CSS sp√©cifique au loader et au corps de page */
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); /* Fond blanc semi-transparent */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5em;
            font-family: Arial, sans-serif;
            color: #0077b6; /* Couleur du texte du loader */
            z-index: 9999; /* Assure que le loader est au-dessus de tout */
            opacity: 1; /* Initialement visible */
            transition: opacity 0.5s ease-out; /* Transition douce pour la disparition */
        }

        #loader.hidden {
            opacity: 0; /* Rend le loader transparent */
            pointer-events: none; /* Emp√™che les clics sur l'√©l√©ment transparent */
        }

        /* Styles g√©n√©raux du body et du layout */
        body {
            /* L'opacit√© initiale de 0 sur le body n'est plus n√©cessaire car le loader couvre tout */
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f2f4f8;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Le body sera visible une fois le loader disparu, donc pas besoin d'une opacit√© initiale ici */
        }

        /* Le CSS pour les sections et les tuiles est conserv√© */
        .section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 40px 20px;
            flex-grow: 1;
        }

        .tile {
            background-color: #ffffff;
            width: 100%;
            max-width: 900px;
            border-left: 8px solid #0077b6;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .tile h2 {
            margin-top: 0;
            color: #0077b6;
        }

        .tile p {
            color: #555;
            line-height: 1.6;
        }

        /* CSS pour le bloc ChatGPT */
        .chatgpt-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 50px;
        }
        .chatgpt-box {
            width: 100%;
            max-width: 650px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 119, 182, 0.1);
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            align-items: center;
        }
        .chatgpt-box h3 {
            margin: 0;
            font-size: 1.2rem;
            text-align: center;
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .chatgpt-box h3::before {
            content: "üí¨";
            font-size: 1.2rem;
        }
        .chatgpt-box textarea {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }
        .chatgpt-box .btn {
            padding: 12px 30px;
            background-color: #0077b6;
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .chatgpt-box .btn:hover {
            background-color: #005f8c;
        }
        #reponse {
            white-space: pre-wrap;
            background: #f4faff;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #cce5ff;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #333;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Style pour le footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 0.85rem;
            margin-top: auto;
        }
    </style>
</head>
<body>
    <div id="loader">
        Chargement...
    </div>

    <div id="header-placeholder"></div>

    <div class="section">
        <div class="tile">
            <h2>Bienvenue sur l‚Äôespace IA Marketing</h2>
            <p>
                Cette plateforme collaborative vous permet de d√©couvrir, partager et capitaliser sur les usages de l‚Äôintelligence artificielle au sein de notre organisation. Que vous cherchiez des outils, des prompts, des cas d‚Äôusage inspirants ou que vous souhaitiez contribuer avec vos propres astuces, tout est centralis√© ici pour accompagner votre mont√©e en comp√©tence et faciliter l‚Äôadoption de l‚ÄôIA au quotidien.
            </p>

            <div class="chatgpt-wrapper">
                <div class="chatgpt-box">
                    <h3>Discuter avec ChatGPT</h3>
                    <textarea id="user-input" rows="4" placeholder="Pose ta question ici..."></textarea>
                    <button class="btn" onclick="envoyer()">Envoyer</button>
                    <pre id="reponse"></pre>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Auteur : **Steeve Pires Madeira / Marketing - Equipe Cr√©a**
    </footer>

    <script>
        // URL pour la Netlify Function qui r√©cup√®re les donn√©es de Google Sheets
        const PROXY_URL = "/.netlify/functions/proxy";

        // Cette fonction sera appel√©e par le header pour mettre √† jour la bulle
        async function mettreAJourBulleDemandes() {
            const notif = document.getElementById("notif-count");
            if (!notif) {
                console.warn("√âl√©ment #notif-count non trouv√©. La bulle de notification ne peut pas √™tre mise √† jour.");
                return;
            }
            try {
                const res = await fetch(`${PROXY_URL}?action=getDemandesIA`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const demandes = await res.json();
                const demandesNonTraitees = demandes.filter(d => !d.traite);
                notif.textContent = demandesNonTraitees.length;
                notif.style.display = demandesNonTraitees.length > 0 ? "inline-block" : "none";
            } catch (e) {
                console.error("Erreur lors de la mise √† jour du compteur de demandes :", e);
                notif.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetch("header.html")
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.text();
                })
                .then(data => {
                    document.getElementById("header-placeholder").innerHTML = data;

                    // Assurez-vous que le lien des demandes est positionn√© relativement pour la bulle
                    const demandeLink = document.querySelector("a.demandes");
                    if (demandeLink && (getComputedStyle(demandeLink).position === "static" || !getComputedStyle(demandeLink).position)) {
                        demandeLink.style.position = "relative";
                    }

                    // Une fois le header charg√© et inject√©, on peut mettre √† jour la bulle
                    mettreAJourBulleDemandes();

                    // Logique pour marquer le lien "Accueil" comme actif dans le menu
                    const path = location.pathname.split("/").pop();
                    const links = document.querySelectorAll("nav a");
                    links.forEach(link => {
                        if (path === "" || path === "index.html") {
                            if (link.getAttribute("href") === "index.html") {
                                link.classList.add("active");
                            }
                        } else if (link.getAttribute("href") === path) {
                            link.classList.add("active");
                        }
                    });

                    // MASQUER LE LOADER ICI, UNE FOIS QUE TOUT EST CHARG√â (header inclus)
                    const loader = document.getElementById('loader');
                    if (loader) {
                        loader.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error("Erreur lors du chargement de header.html:", error);
                    document.getElementById("header-placeholder").innerHTML =
                        "<p style='color:red;text-align:center'>Erreur de chargement du menu</p>";
                    // S'assurer que le corps de la page devient visible m√™me en cas d'erreur
                    const loader = document.getElementById('loader');
                    if (loader) {
                        loader.classList.add('hidden');
                    }
                });
        });

        async function envoyer() {
            const userMessage = document.getElementById("user-input").value;
            // Afficher un message de chargement
            document.getElementById("reponse").textContent = "Chargement de la r√©ponse...";

            try {
                const response = await fetch("/.netlify/functions/chat-clean", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMessage })
                });

                const text = await response.text();
                let data;

                try {
                    data = JSON.parse(text);
                } catch (e) {
                    document.getElementById("reponse").textContent = "‚ùå Erreur : r√©ponse non JSON\n" + text;
                    console.error("Erreur de parsing JSON de la r√©ponse de chat-clean:", e, text);
                    return;
                }

                if (data.error) {
                    document.getElementById("reponse").textContent = `‚ùå Erreur API : ${data.error}`;
                    console.error("Erreur renvoy√©e par l'API chat-clean:", data.error);
                } else {
                    document.getElementById("reponse").textContent = data.reply || "‚úÖ Pas de r√©ponse g√©n√©r√©e.";
                }
            } catch (networkError) {
                document.getElementById("reponse").textContent = `‚ùå Erreur r√©seau ou fonction Netlify inaccessible: ${networkError.message}`;
                console.error("Erreur r√©seau ou fonction Netlify inaccessible:", networkError);
            }
        }
    </script>
</body>
</html>
