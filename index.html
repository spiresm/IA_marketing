<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Espace IA</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #0077b6;
            --dark-blue: #005f8a;
            --light-blue: #64B5F6;
            --background-grey: #f0f2f5;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --grey-text: #555;
            --border-color: #ccc;
            --error-text: #dc3545;
            /* NOUVEAU: Nouvelle couleur pour le fond du bandeau d'actualités */
            --news-ticker-bg: #e0f2f7; /* Un bleu très clair et doux, presque blanc-bleu */
            --news-ticker-text-color: var(--dark-blue); /* Texte plus foncé pour le contraste */
        }
        /* NOUVEAU: Forces la scrollbar pour éviter les décalages latéraux */
        html {
            overflow-y: scroll; 
        }

        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-grey);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; 
        }

        main {
            padding: 40px 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        /* Les styles du nav-wrapper et du menu-container sont dans header.html */
        /* Tous les styles liés au header, nav, dropdown doivent être dans header.html */

        #header-placeholder {
            min-height: 60px; /* Adaptez à la hauteur réelle de votre header pour éviter les sauts */
            background-color: var(--primary-blue); /* Couleur de fond de votre header */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* NOUVEAU: Styles pour le placeholder du footer */
        #footer-placeholder {
            min-height: 60px; /* Adaptez à la hauteur réelle de votre footer pour éviter les sauts */
            background-color: #333; /* Couleur de fond de votre footer */
            display: flex;
            justify-content: center;
            align-items: center;
            color: white; /* Couleur du texte par default */
        }

        .content-section { 
            max-width: 960px; 
            width: 100%; 
            margin: 0 auto; 
            padding: 25px; 
            box-sizing: border-box; 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
            position: relative; 
        }
        
        /* NOUVEAU : Style générique pour les titres de section */
        .section-title {
            text-align: center;
            color: var(--dark-blue);
            margin-top: 0;
            margin-bottom: 25px; /* Marge par défaut pour les titres de section */
            font-size: 2em; /* Exemple: taille plus grande pour les titres de section principaux */
            font-weight: 700; /* Gras */
        }
        /* Pour le titre de la veille, ajustez spécifiquement */
        .veille-header .section-title {
            font-size: 1.6em; /* Plus petit pour la veille car il y a aussi un post-it */
            margin-bottom: 0; /* Pas de marge en bas si le post-it est juste en dessous */
        }


        .veille-section-container { padding: 0; background: none; box-shadow: none; max-width: 100%; }
        
        .veille-header {
            max-width: 960px;
            margin: 0 auto 15px auto;
            position: relative;
            padding-top: 15px;
        }
        /* Styles du h3 original déplacés ou adaptés à .section-title */
        /* .veille-header h3 { 
             text-align: center; 
             color: var(--dark-blue); 
             margin: 0;
        } */
        .post-it-note {
            position: absolute;
            top: 0;
            right: -25px;
            background-color: #fffbdd;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.15);
            z-index: 101;
            max-width: 230px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-left: 5px solid #ffeb3b;
            transform: rotate(3deg) translateZ(0);
        }
        .post-it-note .post-it-icon { font-size: 1.5em; color: var(--primary-blue); margin-top: 2px; }
        .post-it-note p { margin: 0; font-size: 0.9em; color: #5c5c5c; line-height: 1.4; }
        .post-it-note strong { color: #333; display: block; margin-bottom: 4px; }
        
        .veille-carousel-wrapper { max-width: 960px; margin: 0 auto; position: relative; }
        .veille-scroll-container { width: 100%; overflow: hidden; border-radius: 12px; background: #fff; min-height: 320px; display: flex; align-items: center; justify-content: center; }
        .veille-grid { display: flex; transition: transform 0.5s ease-in-out; width: 100%; }
        .veille-card { flex: 0 0 100%; box-sizing: border-box; padding: 30px 70px; display: flex; flex-direction: column; min-height: 320px; }
        .veille-card .card-meta-info { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; font-size: 0.9em; color: var(--grey-text); }
        .veille-card .meta-tag { display: flex; align-items: center; gap: 6px; background-color: #f0f2f5; padding: 5px 10px; border-radius: 15px; }
        .veille-card h4 { text-align: left; font-size: 1.6em; color: var(--dark-blue); margin: 0 0 10px 0; }
        .veille-card .card-content { text-align: left; flex-grow: 1; }
        .veille-card .card-content p { font-size: 1.05em; line-height: 1.6; margin: 0; color: var(--grey-text); }
        .veille-card .card-footer { margin-top: 25px; }

        /* Style généralisé pour les boutons d'action */
        .action-button {
            display: inline-flex; /* Utilisation de flex pour centrer l'icône et le texte */
            align-items: center;
            gap: 8px; /* Espace entre l'icône et le texte */
            padding: 12px 22px; /* Padding comme les autres boutons */
            background-color: var(--primary-blue); /* Couleur de fond cohérente */
            color: white;
            text-decoration: none; /* Important pour les liens qui agissent comme des boutons */
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em; /* Coordonné avec les liens de navigation */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .action-button:hover {
            background-color: var(--dark-blue); /* Effet de survol cohérent */
            transform: translateY(-2px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        .action-button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Applique le style .action-button au bouton de veille et message */
        .veille-card .view-article-button,
        .message-button { /* AJOUTÉ: applique action-button au message-button */
            display: inline-flex; /* Assure que les styles inline-flex sont prioritaires */
        }
        /* Le .message-button aura aussi la classe .action-button */
        .message-button {
             margin-left: auto; /* Pousse le bouton à droite dans son conteneur flex */
        }


        .scroll-arrow { background-color: rgba(255, 255, 255, 0.9); color: var(--primary-blue); border: 1px solid #ddd; width: 45px; height: 45px; cursor: pointer; border-radius: 50%; font-size: 1.4em; position: absolute; top: 50%; transform: translateY(-50%); z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s ease; display: none; align-items: center; justify-content: center; }
        .scroll-arrow:hover { background-color: var(--primary-blue); color: white; transform: translateY(-50%) scale(1.1); }
        .scroll-arrow.left { left: 15px; }
        .scroll-arrow.right { right: 15px; }
        .scroll-arrow:disabled { opacity: 0.4; cursor: not-allowed; transform: translateY(-50%); }

        /* Styles pour le bandeau d'actualités (flux RSS) */
        .news-ticker-section.content-section { /* AJOUTÉ .content-section ici pour les styles de base */
            display: flex;
            align-items: center;
            position: relative;
            background-color: var(--news-ticker-bg); /* Utilisation de la variable */
            color: var(--news-ticker-text-color); /* Utilisation de la variable */
            padding: 15px 25px; /* Padding ajusté */
            box-sizing: border-box; /* S'assure que padding et border sont inclus dans la largeur */
        }
        .news-ticker-container { 
            flex-grow: 1; 
            overflow: hidden; 
            margin-right: 15px; 
        }
        .news-ticker-content { 
            display: flex; 
            white-space: nowrap; 
            animation: ticker 40s linear infinite; 
        }
        .news-ticker-content .news-item { /* Ajouté pour styler chaque item dans le ticker */
            margin-right: 50px; /* Espace entre les items */
        }
        .news-ticker-content .news-item-text { /* Ajouté pour styler le texte du titre */
            font-weight: bold;
        }
        .news-ticker-content .news-item-meta { /* Ajouté pour styler les meta infos (auteur, pôle) */
            font-style: italic;
            margin-left: 8px; /* Espace entre le titre et les méta-infos */
            color: var(--grey-text); /* Couleur du texte des méta-infos */
        }

        @keyframes ticker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        
        /* --- STYLES "DERNIERS AJOUTS" --- */        
        .latest-additions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }        
        .addition-card {             
            background: #fff;             
            border-radius: 12px;             
            box-shadow: var(--card-shadow);             
            display: flex;             
            flex-direction: column;             
            transition: transform 0.2s ease, box-shadow 0.2s ease;             
            overflow: hidden;             
            position: relative;           
        }        
        .addition-card:hover {             
            transform: translateY(-5px);             
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);           
        }
        .card-link-wrapper {           
            text-decoration: none;             
            color: inherit;             
            display: flex;             
            flex-direction: column;
            height: 100%;           
        }          
        .card-content-wrapper { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }          
        .addition-card h4 {           
            font-size: 1.3em;           
            color: var(--dark-blue);           
            margin: 0 0 10px 0;           
            font-weight: bold;           
            text-align: left;        
        }        
        .card-top-meta {           
            display: flex;           
            justify-content: flex-start;           
            width: 100%;           
            margin-bottom: 15px;        
        }        
        .outil-badge { background-color: #e9ecef; color: #495057; font-size: 0.8em; padding: 5px 12px; border-radius: 15px; }          
        .addition-card .card-subtitle { font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 15px; text-align: left;}        
        .addition-card .card-image-container { width: 100%; padding-bottom: 56.25%; position: relative; overflow: hidden; border-radius: 8px; margin-bottom: 15px; background-color: #eee; }        
        .addition-card .card-image-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }        
        .addition-card .card-meta { display: flex; flex-direction: column; gap: 8px; font-size: 0.9em; color: var(--grey-text); flex-grow: 1; margin-bottom: 15px; }        
        .addition-card .meta-line { display: flex; align-items: center; gap: 8px; text-align: left; }        
        .addition-card .view-button {              
            display: none;          
        }            
        .profile-circle {           
            position: absolute;           
            top: 15px;             
            right: 15px;             
            width: 45px;             
            height: 45px;             
            border-radius: 50%;           
            overflow: hidden;           
            border: 2px solid var(--primary-blue);             
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);           
            z-index: 10;             
            background-color: #eee;             
            display: flex;           
            align-items: center;           
            justify-content: center;        
        }
        .profile-circle img {           
            width: 100%;           
            height: 100%;           
            object-fit: cover;          
        }
        footer { background-color: #333; color: white; text-align: center; padding: 20px; margin-top: auto; width: 100%; }
        @media (max-width: 768px) {           
            main { padding: 20px 0; }           
            .content-section, .veille-carousel-wrapper { border-radius: 0; }           
            .veille-header { padding: 15px 15px 0 15px; }           
            .post-it-note { position: static; transform: none; margin: 15px auto 0 auto; max-width: 90%; }           
            .scroll-arrow { display: none; }           
            .veille-carousel-wrapper { width: 100%; }           
            .veille-scroll-container {                     
                overflow-x: auto;                     
                scroll-snap-type: x mandatory;                     
                border-radius: 0;           
            }           
            .veille-card {               
                scroll-snap-align: center;               
                width: 90%;               
                flex: 0 0 90%;               
                padding: 25px;           
            }           
            .veille-grid { gap: 15px; padding: 0 5%; transform: none !important; }           
            .profile-circle {               
                top: 10px;                 
                right: 10px;                 
                width: 40px;                 
                height: 40px;               
            }
            /* Styles mobile pour le bandeau d'actualités et le bouton */
            .news-ticker-section.content-section {
                flex-direction: column;
                padding: 15px;
            }
            .news-ticker-container {
                margin-right: 0;
                margin-bottom: 15px;
                width: 100%;
            }
            /* Les boutons mobiles hériteront aussi de action-button */
            .action-button {
                width: 100%;
                justify-content: center;
            }
        }    
    </style>
</head>
<body>
    <div id="header-placeholder"></div>
    <main>        
        <section class="veille-section-container">            
            <div class="veille-header">                
                <h3 class="section-title">Veille IA & Marketing</h3> <div class="post-it-note">                    
                    <i class="fas fa-robot post-it-icon"></i>                    
                    <p>                        
                        <strong>Veille Automatisée</strong>                        
                        Générée par un workflow n8n.                    
                    </p>                
                </div>            
            </div>                          
            <div class="veille-carousel-wrapper">                
                <div class="veille-scroll-container">                    
                    <div id="veille-articles-grid" class="veille-grid"></div>                
                </div>                
                <button class="scroll-arrow left" id="veille-scroll-left"><i class="fas fa-chevron-left"></i></button>                
                <button class="scroll-arrow right" id="veille-scroll-right"><i class="fas fa-chevron-right"></i></button>            
            </div>        
        </section>
        
        <section class="content-section">             
            <h2 class="section-title">Derniers ajouts</h2> <div id="latest-additions-grid" class="latest-additions-grid"></div>        
        </section>
        
        <section class="news-ticker-section content-section">             
            <div class="news-ticker-container">
                <div class="news-ticker-content" id="newsTickerContent"></div>
            </div>             
            <a href="/admin-news.html" class="action-button"><i class="fas fa-comment-dots"></i> Laisser un message</a> </section>    
    </main>        
    <footer id="footer-placeholder"><p>&copy; 2025 Espace IA. Tous droits réservés.</p></footer>
    
    <script>    
    // Variables pour les couleurs des pôles, comme dans admin-news.html
    const defaultColorsByPole = {
        "Pôle créa.": "#FF69B4", // Rose vif
        "CRM": "#E55C5C", // Rouge doux
        "Communication": "#0077b6", // Bleu principal
        "Partenariats": "#FF9933", // Orange vif
        "Marketing digital": "#8A2BE2", // Mauve / Bleu Violet
        "Positionnement": "#20B2AA", // Vert Mer clair
        "Staff": "#A9A9A9", // Gris neutre
        "Autre": "#808080" // Gris foncé
    };

    // Fonction utilitaire pour charger les composants externes (header/footer)
    async function loadComponent(url, placeholderId) {
        try {
            const res = await fetch(url);
            if (!res.ok) {
                console.error(`Could not load ${url}, status: ${res.status}`);
                document.getElementById(placeholderId).innerHTML = `<p style="color:red; text-align:center;">Erreur chargement: ${url}</p>`;
                return;
            }
            document.getElementById(placeholderId).innerHTML = await res.text();
        } catch (error) {
            console.error(`Error loading ${url}:`, error);
            document.getElementById(placeholderId).innerHTML = `<p style="color:red; text-align:center;">Erreur chargement: ${url}</p>`;
        }
    }

    // Fonction pour initialiser le dropdown
    function initializeHeaderDropdown() {
        const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');
        const toolsResourcesContent = document.getElementById('toolsResourcesContent');

        if (toolsResourcesBtn && toolsResourcesContent) {
            toolsResourcesBtn.removeEventListener('click', handleDropdownClick); 
            window.removeEventListener('click', handleWindowClick);

            toolsResourcesBtn.addEventListener('click', handleDropdownClick);
            window.addEventListener('click', handleWindowClick);

            toolsResourcesContent.style.display = 'none';
            toolsResourcesBtn.setAttribute('aria-expanded', 'false');
        } else {
            console.warn("Éléments du dropdown 'Outils & Ressources' non trouvés après injection. Le script ne peut pas initialiser le menu.");
        }
    }

    // Gestionnaire d'événement pour le clic sur le bouton du dropdown
    function handleDropdownClick(event) {
        event.preventDefault();         
        const toolsResourcesBtn = event.currentTarget;          
        const toolsResourcesContent = document.getElementById('toolsResourcesContent');

        if (toolsResourcesContent.style.display === 'block') {             
            toolsResourcesContent.style.display = 'none';             
            toolsResourcesBtn.setAttribute('aria-expanded', 'false');             
            toolsResourcesBtn.classList.remove('active');         
        } else {             
            toolsResourcesContent.style.display = 'block';             
            toolsResourcesBtn.setAttribute('aria-expanded', 'true');             
            toolsResourcesBtn.classList.add('active');         
        }    
    }

    // Gestionnaire d'événement pour le clic sur la fenêtre pour fermer le dropdown
    function handleWindowClick(event) {         
        const toolsResourcesDropdown = document.getElementById('toolsResourcesDropdown');          
        const toolsResourcesContent = document.getElementById('toolsResourcesContent');         
        const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');

        if (toolsResourcesDropdown && !toolsResourcesDropdown.contains(event.target)) {             
            if (toolsResourcesContent && toolsResourcesContent.style.display === 'block') {                 
                toolsResourcesContent.style.display = 'none';                 
                if (toolsResourcesBtn) {                     
                    toolsResourcesBtn.setAttribute('aria-expanded', 'false');                     
                    toolsResourcesBtn.classList.remove('active');                 
                }             
            }         
        }    
    }

    // Fonction pour gérer la classe 'active' sur les liens de navigation
    function updateActiveNavLinks() {         
        const currentPath = window.location.pathname.split('/').pop();

        // 1. Désactive tous les liens actifs existants dans le header injecté         
        document.querySelectorAll('#header-placeholder nav a.active').forEach(link => {             
            link.classList.remove('active');         
        });

        // 2. Active le lien de navigation principal correspondant à la page actuelle         
        let currentMainLinkFound = false;         
        document.querySelectorAll('#header-placeholder nav > a').forEach(link => {               
            const linkHref = link.getAttribute('href');             
            const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : '';             
            const currentFileName = currentPath.replace('.html', '').replace('', 'index');  

            const isCurrentPageMatch = (linkFileName === currentFileName) || (linkFileName === '' && currentFileName === 'index');
            if (isCurrentPageMatch) {                     
                link.classList.add("active");                   
                currentMainLinkFound = true;             
            }         
        });

        // 3. Gère l'état actif du bouton "Outils & Ressources" et de ses sous-liens         
        const toolsResourcesContent = document.getElementById('toolsResourcesContent');         
        const toolsResourcesBtn = document.getElementById('toolsResourcesBtn');         
        const dropdownLinks = toolsResourcesContent ? toolsResourcesContent.querySelectorAll('a') : [];

        let dropdownSublinkIsActive = false;         
        dropdownLinks.forEach(link => {             
            const linkHref = link.getAttribute('href');             
            const linkFileName = linkHref ? linkHref.split('/').pop().replace('.html', '') : '';             
            const currentFileName = currentPath.replace('.html', '').replace('', 'index');  

            const isCurrentSubPageMatch = (linkFileName === currentFileName);
            if (isCurrentSubPageMatch) {                     
                link.classList.add('active');                     
                dropdownSublinkIsActive = true;               
                if (toolsResourcesBtn) {                     
                    toolsResourcesBtn.classList.add('active');                     
                    currentMainLinkFound = true;                 
                }             
            }         
        });

        // Si aucune page principale ni aucune sous-page du dropdown n'est la page active,         
        // s'assurer que le bouton du dropdown n'est pas actif (à moins qu'il ne soit ouvert).         
        if (!currentMainLinkFound && toolsResourcesBtn) {             
            toolsResourcesBtn.classList.remove('active');         
        }    
    }

    // =========================================================================    
    // SECTION 1 : CARROUSEL DE VEILLE    
    // =========================================================================    
    async function loadAndInitVeille() {         
        const grid = document.getElementById('veille-articles-grid');         
        if (!grid) return;         
        console.log("loadAndInitVeille: Starting fetch for veille-articles.json");         
        try {             
            const response = await fetch('veille-articles.json');               
            console.log("veille-articles.json fetch status:", response.status, response.ok);             
            if (!response.ok) throw new Error(`Fichier introuvable (statut: ${response.status})`);             
            const articles = await response.json();             
            console.log("Veille articles data:", articles);
            
            if (!articles || articles.length === 0) {                 
                grid.innerHTML = '<p style="padding: 20px; text-align: center;">Aucun article de veille.</p>';                 
                return;             
            }             
            grid.innerHTML = articles.map(article => `                
                <div class="veille-card">                    
                    <div class="card-meta-info">                        
                        <span class="meta-tag"><i class="fas fa-calendar-alt"></i> ${article.date || 'Date'}</span>                        
                        <span class="meta-tag"><i class="fas fa-newspaper"></i> ${article.source || 'Source'}</span>                        
                        <span class="meta-tag"><i class="fas fa-tag"></i> ${article.tag || 'Tag'}</span>                    
                    </div>                    
                    <h4>⚡ ${article.titre || 'Titre'}</h4>                    
                    <div class="card-content"><p>${article.resume || 'Résumé'}</p></div>                    
                    <div class="card-footer"><a href="${article.url || '#'}" target="_blank" class="action-button">Lire l’article</a></div>                
                </div>            
            `).join(''); // Utilisation de .action-button ici
            initVeilleCarousel();         
        } catch (error) {             
            console.error("Erreur chargement veille:", error);             
            grid.innerHTML = `<p style="padding: 20px; text-align: center; color: var(--error-text);">Impossible de charger les articles.</p>`;         
        }    
    }

    function initVeilleCarousel() {         
        const grid = document.getElementById('veille-articles-grid');         
        const prevButton = document.getElementById('veille-scroll-left');         
        const nextButton = document.getElementById('veille-scroll-right');         
        const scrollContainer = grid.parentElement;         
        if (!grid || !prevButton || !nextButton || !scrollContainer) return;         
        const cards = grid.querySelectorAll('.veille-card');         
        if (cards.length <= 1) return;         
        prevButton.style.display = 'flex';         
        nextButton.style.display = 'flex';         
        let currentIndex = 0;         
        grid.style.transition = 'transform 0.5s ease-in-out';         
        const updateCarousel = () => {             
            const offset = -currentIndex * scrollContainer.clientWidth;             
            grid.style.transform = `translateX(${offset}px)`;             
            prevButton.disabled = currentIndex === 0;             
            nextButton.disabled = currentIndex >= cards.length - 1;         
        };         
        nextButton.addEventListener('click', () => { if (currentIndex < cards.length - 1) { currentIndex++; updateCarousel(); }});         
        prevButton.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateCarousel(); }});         
        window.addEventListener('resize', () => {             
            if (window.innerWidth > 768) {                 
                grid.style.transition = 'none';                   
                updateCarousel();                 
                setTimeout(() => { grid.style.transition = 'transform 0.5s ease-in-out'; }, 50);             
            } else {                 
                grid.style.transform = 'none';             
            }         
        });         
        if (window.innerWidth > 768) updateCarousel();    
    }        
    
    // =========================================================================    
    // SECTION 2 : DERNIERS AJOUTS    
    // =========================================================================    
    const escapeHtml = (text) => {         
        if (text === null || text === undefined) return '';         
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };         
        return String(text).replace(/[&<>"']/g, m => map[m]);    
    };    
    const getYouTubeVideoId = (url) => {         
        if (!url) return null;         
        const match = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);         
        return match ? match[1] : null;    
    };    
    const formatteDate = (dateString) => {         
        if (!dateString) return 'Date inconnue';         
        try { return new Date(dateString).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' }); }           
        catch (e) { return 'Date invalide'; }    
    };

    // Fonction de création de carte avec gestion améliorée des images de profil et titres
    const createCard = (item, type) => {
        const card = document.createElement("div");
        card.className = 'addition-card';
        const mainCardTitle = type === 'galerie' ? 'Dernier prompt partagé' : 'Dernier workflow partagé';
        let mediaHtml = '';
        const youtubeVideoId = item.firstVideoUrl ? getYouTubeVideoId(item.firstVideoUrl) : null;
        if (youtubeVideoId) {
            mediaHtml = `<div class="card-image-container"><img src="https://i.ytimg.com/vi/${youtubeVideoId}/hqdefault.jpg" alt="Vignette pour ${escapeHtml(item.titre || '')}"></div>`;
        } else if (item.imageUrl && item.imageUrl !== 'NO_IMAGE_PLACEHOLDER') {
            mediaHtml = `<div class="card-image-container"><img src="${escapeHtml(item.imageUrl)}" alt="Vignette pour ${escapeHtml(item.titre || '')}"></div>`;
        }
        const toolBadge = item.outil && item.outil !== 'Non spécifié' ? `<span class="outil-badge">${escapeHtml(item.outil)}</span>` : '';
        
        const profileImgSrc = item.profileImageUrl || 'https://via.placeholder.com/45/0077b6/FFFFFF?text=P';

        card.innerHTML = `            
            <a href="${type === 'cas-usage' ? 'cas-usages.html' : 'galerie.html'}" class="card-link-wrapper">                
                <div class="card-content-wrapper">                    
                    <h4>${mainCardTitle}</h4>                    
                    <div class="profile-circle">                        
                        <img src="${profileImgSrc}" alt="Profil de ${escapeHtml(item.auteur || '')}">                    
                    </div>                    
                    <div class="card-top-meta">${toolBadge}</div>                    
                    <div class="card-subtitle">${escapeHtml(item.titre || '')}</div>                    
                    ${mediaHtml}                    
                    <div class="card-meta">                        
                        <span class="meta-line"><strong>Auteur:</strong> ${escapeHtml(item.auteur || '')}</span>                        
                        <span class="meta-line"><strong>Créé le:</strong> ${formatteDate(item.date)}</span>                    
                    </div>                
                </div>            
            </a>        
        `;        
        return card;    
    };

    async function displayLatestAdditions() {         
        const container = document.getElementById("latest-additions-grid");         
        if (!container) return;         
        container.innerHTML = '<p>Chargement...</p>';         
        const GET_TIPS_URL = "/.netlify/functions/get-tips";         
        const GET_PROMPTS_URL = "/.netlify/functions/getGalleryPrompts";         
        const GET_PROFILS_URL = "/.netlify/functions/getProfils";

        console.log("displayLatestAdditions: Starting fetch for tips, prompts, profils.");         
        try {             
            const [tipsResponse, promptsResponse, profilsResponse] = await Promise.all([                 
                fetch(GET_TIPS_URL).catch(e => { console.error("GET_TIPS_URL failed:", e); return {ok: false, json: () => Promise.resolve([])}; }),                 
                fetch(GET_PROMPTS_URL).catch(e => { console.error("GET_PROMPTS_URL failed:", e); return {ok: false, json: () => Promise.resolve([])}; }),                 
                fetch(GET_PROFILS_URL).catch(e => { console.error("GET_PROFILS_URL failed:", e); return {ok: false, json: () => Promise.resolve([])}; })             
            ]);             
            console.log("API responses received. Tips OK:", tipsResponse.ok, "Prompts OK:", promptsResponse.ok, "Profils OK:", profilsResponse.ok);
            
            let tips = tipsResponse.ok ? await tipsResponse.json() : [];             
            let prompts = promptsResponse.ok ? await promptsResponse.json() : [];             
            let profils = profilsResponse.ok ? await profilsResponse.json() : [];
            
            const profilsMap = new Map();             
            profils.forEach(p => {                 
                if (p.name) {                     
                    profilsMap.set(p.name.toLowerCase().trim(), p);                 
                }             
            });
            
            // Tri secondaire pour assurer la stabilité
            const sortByDateAndId = (a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);

                // Tri primaire par date (du plus récent au plus ancien)
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB.getTime() - dateA.getTime();
                }

                // Tri secondaire par ID (si les dates sont identiques)
                // Cela suppose que 'id' est bien présent et est une chaîne ou peut être converti
                return (a.id || '').localeCompare(b.id || ''); 
            };

            const normalizeItem = (item) => {                 
                const normalizedAuteur = (item.auteur || '').toLowerCase().trim();                 
                const profilCorrespondant = profilsMap.get(normalizedAuteur);                               
                let resolvedProfileImageUrl = 'https://via.placeholder.com/45/0077b6/FFFFFF?text=P'; 
                // Priorité à l'image de profil trouvée dans la liste des profils
                if (profilCorrespondant && profilCorrespondant.photo) { // Assurez-vous que le champ est 'photo' ou 'profileImageUrl'
                    resolvedProfileImageUrl = profilCorrespondant.photo;
                } else if (item.profileImageUrl) { // Fallback si l'image vient directement de l'item (moins probable)
                    resolvedProfileImageUrl = item.profileImageUrl;
                }
                
                return {                     
                    id: item.id, // Inclure l'ID pour le tri secondaire
                    titre: item.titre || "Titre inconnu",                     
                    auteur: item.auteur || "Inconnu",                     
                    date: item.date_creation || item.dateCreation || item.Date || "", // Gérer plusieurs noms de champ pour la date
                    outil: item.outil || "Non spécifié",                     
                    imageUrl: item.imageUrl || (Array.isArray(item.fileUrls) && item.fileUrls.length > 0 ? item.fileUrls[0] : 'NO_IMAGE_PLACEHOLDER'),                     
                    firstVideoUrl: (Array.isArray(item.urls) ? item.urls : []).find(url => getYouTubeVideoId(url)),
                    profileImageUrl: resolvedProfileImageUrl // Image de profil résolue
                };             
            };

            const normalizedTips = tips.map(normalizeItem).sort(sortByDateAndId);             
            const normalizedPrompts = prompts.map(normalizeItem).sort(sortByDateAndId);             
            
            container.innerHTML = ''; // Clear "Chargement..."             
            
            let itemsToDisplay = [];             
            if (normalizedPrompts.length > 0) itemsToDisplay.push({ item: normalizedPrompts[0], type: 'galerie' });             
            if (normalizedTips.length > 0) itemsToDisplay.push({ item: normalizedTips[0], type: 'cas-usage' });
            
            if (itemsToDisplay.length > 0) {                 
                itemsToDisplay.forEach(({ item, type }) => container.appendChild(createCard(item, type)));             
            } else {                 
                container.innerHTML = '<p style="text-align: center;">Aucun ajout récent pour le moment.</p>';             
            }             
            console.log("Latest additions displayed.");         
        } catch (error) {             
            console.error("Erreur de chargement des derniers ajouts:", error);             
            container.innerHTML = `<p style="text-align: center; color: var(--error-text);">Erreur de chargement des derniers ajouts.</p>`;         
        }    
    }
    
    // =========================================================================    
    // SECTION 3 : BANDEAU D'ACTUALITÉS    
    // =========================================================================    
    async function loadNewsTicker() {         
        const newsTickerContent = document.getElementById('newsTickerContent');         
        if (!newsTickerContent) return;         
        const NEWS_DATA_PATH = 'news-data.json'; // MODIFIÉ : Pointe vers le fichier JSON statique
        console.log("loadNewsTicker: Starting fetch for news data JSON file.");         
        try {             
            const response = await fetch(`/${NEWS_DATA_PATH}?t=${Date.now()}`); // Ajout du cache-busting
            console.log("News data JSON fetch status:", response.status, response.ok);             
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error(`Fichier d'actualités introuvable à la racine de votre déploiement.`);
                }
                throw new Error(`Erreur lors de la récupération du flux d'actualités (statut: ${response.status}).`);             
            }
            
            const newsItems = await response.json();             
            console.log("News ticker data:", newsItems);
            
            if (newsItems.length > 0) {                 
                const fullTextHtml = newsItems.map(item => {
                    // Assurez-vous que 'pole' et 'author' existent dans vos données de flux RSS
                    const poleColor = defaultColorsByPole[item.pole] || defaultColorsByPole['Autre'];
                    return `<span class="news-item">
                                <span class="news-item-text">${escapeHtml(item.title || '')}</span>
                                <span class="news-item-meta" style="color: ${poleColor};">(${escapeHtml(item.collaborateur || 'Inconnu')} - ${escapeHtml(item.pole || 'Autre')})</span>
                            </span>`;
                }).join(' &nbsp; • &nbsp; ');
                newsTickerContent.innerHTML = fullTextHtml + ' &nbsp; • &nbsp; ' + fullTextHtml; // Dupliquer pour un défilement continu

                // Redémarrer l'animation si le contenu change
                newsTickerContent.style.animation = 'none';
                void newsTickerContent.offsetWidth; // Force reflow
                newsTickerContent.style.animation = 'ticker 40s linear infinite';

            } else {                 
                newsTickerContent.innerHTML = '<span>Aucune actualité récente.</span>';             
            }             
            console.log("News ticker displayed.");         
        } catch (error) {             
            console.error("Erreur chargement news ticker:", error);             
            newsTickerContent.innerHTML = `<span style="color: var(--error-text);">Impossible de charger les actualités : ${error.message}</span>`; // Affiche l'erreur pour débogage
        }    
    }        
    
    // Le DOMContentLoaded global qui appelle toutes les fonctions
    document.addEventListener("DOMContentLoaded", async () => {         
        console.log("DOMContentLoaded fired.");
        
        // Charger les composants (header et footer) et initialiser le dropdown/nav         
        await Promise.all([             
            loadComponent("header.html", "header-placeholder"),             
            loadComponent("footer.html", "footer-placeholder")         
        ]);
        
        initializeHeaderDropdown();         
        updateActiveNavLinks(); 
        
        // =========================================================================         
        // APPEL DE TOUTES LES FONCTIONS SPÉCIFIQUES À INDEX.HTML         
        // =========================================================================         
        console.log("Calling content loading functions for index.html.");         
        loadAndInitVeille();           
        displayLatestAdditions();         
        loadNewsTicker();         
        console.log("Content loading functions called. Check console for fetch statuses.");    
    });
    </script>
</body>
</html>
