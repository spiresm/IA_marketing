<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galerie - Espace IA</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    body.show {
      opacity: 1;
    }
    main {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    main.show {
      opacity: 1;
    }
    #header-placeholder {
      width: 100%;
    }

    .galerie-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
    }

    #filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      flex-grow: 1;
      min-width: 0;
    }

    #filters input,
    #filters select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9em;
      flex: 1;
      min-width: 120px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-buttons a {
      background: #0077b6;
      color: white;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .action-buttons a:hover {
      background: #005f8a;
    }

    #galerie {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      padding: 20px 0;
    }

    .carte {
      background: #fff;
      border-left: 5px solid #0077b6;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.2s ease;
    }

    .carte:hover {
      transform: translateY(-5px);
    }

    .carte img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
      border-bottom: 1px solid #eee;
    }

    .texte-col {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .outil-highlight {
      background-color: #e0f7ff;
      color: #0077b6;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      margin-bottom: 10px;
      align-self: flex-start;
    }

    .infos {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .infos strong {
      color: #333;
    }

    .chaine-color {
      padding: 2px 6px;
      border-radius: 3px;
      color: white;
      font-size: 0.9em;
    }

    .prompt-texte {
      font-size: 0.9em;
      color: #444;
      margin-bottom: 15px;
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .copier-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: auto;
      transition: background-color 0.2s;
    }

    .copier-btn:hover {
      background-color: #218838;
    }

    .supprimer-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .supprimer-btn:hover {
      background: rgba(255, 0, 0, 0.9);
    }

    #success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <div class="galerie-container">
      <div id="success-message"></div>

      <div class="filters-header">
        <div id="filters">
          <input type="text" id="filtre-nom" placeholder="mots clés" />
          <select id="filtre-outil">
            <option value="">Tous les outils</option>
            <option>Midjourney</option>
            <option>DALL·E</option>
            <option>Stable Diffusion</option>
            <option>Adobe Firefly</option>
            <option>Runway</option>
            <option>ChatGPT</option>
          </select>
          <select id="filtre-chaine">
            <option value="">Toutes les chaînes</option>
            <option>La Une</option>
            <option>Tipik</option>
            <option>La Trois</option>
            <option>La première</option>
            <option>Classic 21</option>
            <option>vivacité</option>
            <option>Musiq3</option>
            <option>Auvio</option>
          </select>
          <select id="filtre-tri">
            <option value="recent">Plus récent</option>
            <option value="ancien">Plus ancien</option>
          </select>
        </div>
        <div class="action-buttons">
          <a href="prompts.html">➕ Archiver un prompt</a>
          <a href="compresseur.html">✂️ Compresser une image</a>
        </div>
      </div>

      <div id="galerie">
        <p>Chargement des prompts...</p>
      </div>
    </div>
  </main>

  <script>
    const apiBase = window.location.origin + '/.netlify/functions/';
    const branch = 'main';
    let tousLesPrompts = []; // Stocke tous les prompts récupérés

    // Fonction pour charger le header
    document.addEventListener("DOMContentLoaded", () => {
      const headerPlaceholder = document.getElementById("header-placeholder");
      const mainElement = document.querySelector("main");
      const bodyElement = document.body;

      fetch("header.html")
        .then(res => res.ok ? res.text() : Promise.reject(res))
        .then(data => {
          headerPlaceholder.innerHTML = data;
          bodyElement.classList.add("show");
          mainElement.classList.add("show");

          document.querySelectorAll("nav a").forEach(link => {
            if (link.getAttribute("href") === "galerie.html") {
              link.classList.add("active");
            }
          });
          
          // APRES le chargement du header et du DOM
          chargerEtAfficherPrompts(); // Appel de la fonction pour charger et afficher les prompts
        })
        .catch(error => { // Capture l'erreur de fetch
          console.error("Erreur de chargement du menu:", error);
          headerPlaceholder.innerHTML = "<p style='color:red;text-align:center'>Erreur de chargement du menu</p>";
          bodyElement.classList.add("show");
          mainElement.classList.add("show");
          
          // Tente quand même de charger les prompts même si le header a échoué
          chargerEtAfficherPrompts(); 
        });

      // Gérer l'affichage du message de succès si un prompt vient d'être partagé
      if (window.location.search.includes('success=1')) {
        const msg = document.getElementById('success-message');
        msg.textContent = '✅ Prompt partagé avec succès vers la galerie !';
        msg.style.opacity = '1';
        setTimeout(() => msg.style.opacity = '0', 2000);
        // Supprime le paramètre de succès de l'URL après l'affichage du message
        setTimeout(() => window.history.replaceState(null, '', window.location.pathname), 2500); 
      }
    });

    // --- Nouvelle fonction pour charger et afficher les prompts ---
    async function chargerEtAfficherPrompts() {
      const galerieDiv = document.getElementById('galerie');
      galerieDiv.innerHTML = '<p>Chargement des prompts...</p>'; // Message de chargement

      try {
        // Appel de votre fonction Netlify getGalleryPrompts
        const response = await fetch(`${apiBase}getGalleryPrompts`);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
        }
        
        const prompts = await response.json();
        tousLesPrompts = prompts; // Stocke les prompts pour le filtrage
        
        console.log("Prompts récupérés :", prompts);

        if (prompts.length === 0) {
          galerieDiv.innerHTML = '<p>Aucun prompt trouvé pour le moment.</p>';
        } else {
          afficherPrompts(prompts); // Affiche tous les prompts au départ
          setupFiltres(); // Met en place les listeners des filtres après le chargement initial
        }

      } catch (error) {
        console.error("Erreur lors du chargement des prompts de la galerie:", error);
        galerieDiv.innerHTML = `<p style="color:red;">Erreur lors du chargement des prompts : ${error.message}</p>`;
      }
    }

    // Fonction pour afficher les prompts dans la galerie
    function afficherPrompts(prompts) {
      const galerieDiv = document.getElementById('galerie');
      galerieDiv.innerHTML = ''; // Vide la galerie avant d'ajouter les prompts

      if (prompts.length === 0) {
        galerieDiv.innerHTML = '<p>Aucun prompt ne correspond aux filtres.</p>';
        return;
      }

      prompts.forEach(prompt => {
        const carte = document.createElement('div');
        carte.className = 'carte';
        // Ajout d'un dataset pour l'ID du prompt si besoin pour suppression
        // Utilise Date.now() ou un hash si prompt.id ou prompt.fileName n'est pas garanti
        carte.dataset.promptId = prompt.id || (prompt.texte ? btoa(prompt.texte).substring(0,10) : `no-id-${Math.random().toString(36).substring(2, 9)}`); 

        const img = document.createElement('img');
        img.src = prompt.imageUrl || `https://via.placeholder.com/180x150?text=No_Image`;
        img.alt = prompt.titre || 'Prompt Image';
        img.onerror = function() { // Gère les erreurs de chargement d'image
          this.onerror = null; // Empêche la boucle infinie
          this.src = `https://via.placeholder.com/180x150?text=Image_Non_Dispo`;
        };
        carte.appendChild(img);

        const texteCol = document.createElement('div');
        texteCol.className = 'texte-col';

        const outilHighlight = document.createElement('span');
        outilHighlight.className = 'outil-highlight';
        outilHighlight.textContent = prompt.outil || 'N/A';
        texteCol.appendChild(outilHighlight);

        const infos = document.createElement('p');
        infos.className = 'infos';
        infos.innerHTML = `
          <strong>Auteur :</strong> ${prompt.auteur || 'Inconnu'}<br>
          <strong>Chaîne :</strong> <span class="chaine-color" style="background-color:${getChaineColor(prompt.chaine)};">${prompt.chaine || 'N/A'}</span><br>
          <strong>Date :</strong> ${prompt.date ? new Date(prompt.date).toLocaleDateString('fr-FR') : 'N/A'}
        `;
        texteCol.appendChild(infos);

        const promptTexte = document.createElement('p');
        promptTexte.className = 'prompt-texte';
        // CORRECTION MAJEURE: Utilise prompt.texte au lieu de prompt.prompt
        promptTexte.textContent = prompt.texte || 'Aucun texte de prompt.'; 
        texteCol.appendChild(promptTexte);

        const copierBtn = document.createElement('button');
        copierBtn.className = 'copier-btn';
        copierBtn.textContent = 'Copier le prompt';
        copierBtn.onclick = () => {
          // CORRECTION: Copie prompt.texte au lieu de prompt.prompt
          navigator.clipboard.writeText(prompt.texte || '').then(() => { 
            alert('Prompt copié !');
          }).catch(err => {
            console.error('Erreur de copie:', err);
          });
        };
        texteCol.appendChild(copierBtn);

        // Bouton de suppression (si vous voulez gérer la suppression depuis la galerie)
        const supprimerBtn = document.createElement('button');
        supprimerBtn.className = 'supprimer-btn';
        supprimerBtn.innerHTML = '&times;'; // Symbole "x"
        supprimerBtn.title = "Supprimer ce prompt";
        supprimerBtn.onclick = async (e) => {
          e.stopPropagation(); // Empêche de déclencher d'autres événements sur la carte
          if (confirm('Êtes-vous sûr de vouloir supprimer ce prompt ?')) {
            try {
              // Utilisez l'ID généré si l'original n'est pas présent
              const promptToDeleteId = prompt.id || (prompt.texte ? btoa(prompt.texte).substring(0,10) : null);
              if (!promptToDeleteId) {
                  alert("Impossible de supprimer : ID de prompt introuvable.");
                  return;
              }
              const deleteResponse = await fetch(`${apiBase}deletePrompt?id=${promptToDeleteId}`, {
                method: 'DELETE'
              });
              if (deleteResponse.ok) {
                alert('Prompt supprimé avec succès !');
                chargerEtAfficherPrompts(); // Recharge la galerie après suppression
              } else {
                const errorData = await deleteResponse.json();
                alert(`Échec de la suppression: ${errorData.message}`);
              }
            } catch (delError) {
              console.error("Erreur lors de la suppression:", delError);
              alert("Erreur réseau ou interne lors de la tentative de suppression.");
            }
          }
        };
        carte.appendChild(supprimerBtn);


        carte.appendChild(texteCol);
        galerieDiv.appendChild(carte);
      });
    }

    // Fonction pour attribuer une couleur à chaque chaîne (personnalisez si besoin)
    function getChaineColor(chaine) {
      switch (chaine) {
        case 'La Une': return '#FF5733';
        case 'Tipik': return '#33FF57';
        case 'La Trois': return '#3357FF';
        case 'La première': return '#FF33A1';
        case 'Classic 21': return '#57FF33';
        case 'vivacité': return '#A133FF';
        case 'Musiq3': return '#33A1FF';
        case 'Auvio': return '#FFBD33';
        default: return '#6c757d'; // Couleur par défaut
      }
    }


    // --- Fonctions de filtrage et de tri ---
    function filtrerEtTrierPrompts() {
      const filtreNom = document.getElementById('filtre-nom').value.toLowerCase();
      const filtreOutil = document.getElementById('filtre-outil').value;
      const filtreChaine = document.getElementById('filtre-chaine').value;
      const filtreTri = document.getElementById('filtre-tri').value;

      let promptsFiltres = [...tousLesPrompts]; // Commence avec tous les prompts

      if (filtreNom) {
        promptsFiltres = promptsFiltres.filter(prompt =>
          (prompt.titre && prompt.titre.toLowerCase().includes(filtreNom)) ||
          // CORRECTION: Recherche aussi dans prompt.texte pour le filtre par nom
          (prompt.texte && prompt.texte.toLowerCase().includes(filtreNom)) 
        );
      }
      if (filtreOutil) {
        promptsFiltres = promptsFiltres.filter(prompt => prompt.outil === filtreOutil);
      }
      if (filtreChaine) {
        promptsFiltres = promptsFiltres.filter(prompt => prompt.chaine === filtreChaine);
      }

      // Tri
      promptsFiltres.sort((a, b) => {
        // Gérer le cas où la date n'est pas présente pour éviter "Invalid Date"
        const dateA = a.date ? new Date(a.date) : new Date(0); // Utilise une date de référence si non présente
        const dateB = b.date ? new Date(b.date) : new Date(0); // Utilise une date de référence si non présente

        if (filtreTri === 'recent') {
          return dateB - dateA; // Du plus récent au plus ancien
        } else { // 'ancien'
          return dateA - dateB; // Du plus ancien au plus récent
        }
      });

      afficherPrompts(promptsFiltres);
    }

    // Met en place les event listeners pour les filtres
    function setupFiltres() {
        document.getElementById('filtre-nom').addEventListener('input', filtrerEtTrierPrompts);
        document.getElementById('filtre-outil').addEventListener('change', filtrerEtTrierPrompts);
        document.getElementById('filtre-chaine').addEventListener('change', filtrerEtTrierPrompts);
        document.getElementById('filtre-tri').addEventListener('change', filtrerEtTrierPrompts);
    }

  </script>
</body>
</html>
